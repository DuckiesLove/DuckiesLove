<!-- ===== TalkKink – rescue UI for question + score rail (no overlay required) ===== -->
<script>
(() => {
  // ---------- helpers ----------
  const log = (...a) => console.log("[TK rail]", ...a);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const debounce = (fn, ms = 120) => { let id; return (...x) => { clearTimeout(id); id = setTimeout(() => fn(...x), ms); }; };

  async function waitFor(sel, { root = document, timeout = 8000, step = 80 } = {}) {
    const t0 = performance.now();
    while (performance.now() - t0 < timeout) {
      const el = root.querySelector(sel);
      if (el) return el;
      await sleep(step);
    }
    return null;
  }

  // ---------- CSS (right-rail, horizontal chips, no scroll) ----------
  const CSS = `
    #tkScoreRail { position: sticky; top: 88px; margin-left: auto; width: min(520px, 42vw); z-index: 3; }
    #tkScoreRail .tk-card { border:1px solid rgba(0,255,255,.2); border-radius:14px; background:rgba(12,20,28,.65);
      backdrop-filter: blur(6px); box-shadow:0 0 0 1px rgba(0,255,255,.08), 0 18px 40px rgba(0,0,0,.35); padding:12px 14px; }
    #tkScoreRail h3 { margin:0 0 8px 0; font:600 14px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial; letter-spacing:.02em;
      color:#cfefff; text-shadow:0 0 8px rgba(0,180,255,.35); }
    .tk-row { display:flex; gap:8px; overflow:auto; scrollbar-width:none; }
    .tk-row::-webkit-scrollbar { display:none; }
    .tk-chip { display:inline-flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.12); border-radius:12px;
      background:rgba(20,28,36,.82); padding:8px 10px; font:500 13px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial; color:#e9f7ff; white-space:nowrap; }
    .tk-pip { width:22px; height:22px; border-radius:50%; display:grid; place-items:center; font:700 12px/1 system-ui;
      color:#00131a; box-shadow:0 0 0 2px rgba(0,0,0,.35) inset; }
    .pip-0{background:#8ed6ff}.pip-1{background:#ff4d5f}.pip-2{background:#ffca2b}.pip-3{background:#71e27c}.pip-4{background:#35d06a}.pip-5{background:#09c15a}
    @media (max-width: 1200px){ #tkScoreRail{position:static;width:100%;margin-top:12px} }
  `;
  if (!document.getElementById("tk-rail-css")) {
    const st = document.createElement("style");
    st.id = "tk-rail-css";
    st.textContent = CSS;
    document.head.appendChild(st);
  }

  // ---------- Start: find & click ----------
  function findStartButton() {
    const C = [...document.querySelectorAll('button, [role="button"], a, [onclick]')];
    const el = C.find(n => {
      const t = (n.innerText || n.textContent || "").trim().toLowerCase();
      const a = (n.getAttribute("aria-label") || "").toLowerCase();
      const id = (n.id || "").toLowerCase();
      const cls = (n.className || "").toLowerCase();
      return /(start|begin|launch).*(survey|quiz)|^start$/.test(t)
          || /(start|begin).*(survey|quiz)/.test(a)
          || /start/.test(id) || /start/.test(cls);
    });
    return el || null;
  }

  async function ensureSurveyStarted() {
    const anySel = !!document.querySelector('#categoryPanel input[type="checkbox"]:checked');
    if (!anySel) { log("no category selected yet"); return false; }

    if (getQuestionContainer(true)) { log("question already visible"); return true; }

    const start = findStartButton();
    if (start) {
      start.click();
      log("clicked Start");
      await sleep(150);
      return !!getQuestionContainer(true);
    }
    log("Start button not found (may already be started)");
    return !!getQuestionContainer(true);
  }

  // ---------- Question container: detect + unhide ----------
  function getQuestionContainer(visibleOnly = false) {
    const app = document.querySelector('#surveyApp') || document.querySelector('main') || document.body;
    if (!app) return null;

    // Look for a region containing the active question (buttons 0..5 OR Next/Skip OR a “Giving/Receiving” pill header)
    const candidates = [...app.querySelectorAll('section, div')].filter(el => {
      const txt = (el.textContent || "").toLowerCase();
      const hasPills = /(giving|receiving|general)/.test(txt);
      const hasScoreBtns = /\b0\b.*\b1\b.*\b2\b.*\b3\b.*\b4\b.*\b5\b/.test(txt);
      const hasNav = /(next|skip|back)/.test(txt);
      return (hasPills && hasNav) || hasScoreBtns || hasNav;
    });

    let best = null;
    for (const el of candidates) {
      const r = el.getBoundingClientRect();
      const vis = r.width > 300 && r.height > 120;
      if (!visibleOnly || vis) { best = el; break; }
    }
    return best;
  }

  function unhide(el) {
    if (!el) return;
    if (el.hasAttribute("hidden")) el.removeAttribute("hidden");
    if (el.style && el.style.display === "none") el.style.display = "";
    el.setAttribute("aria-hidden", "false");
  }

  // ---------- Right scoring rail (one instance) ----------
  function chip(n, label, extra = "") {
    const d = document.createElement("div");
    d.className = "tk-chip";
    d.innerHTML = `<span class="tk-pip pip-${n}">${n}</span><span>${label}${extra ? " — " + extra : ""}</span>`;
    return d;
  }

  function mountRailBeside(container) {
    if (!container || !container.parentElement) return null;

    // Make sure we only keep ONE rail
    const rails = [...document.querySelectorAll("#tkScoreRail")];
    rails.slice(1).forEach(n => n.remove());

    let rail = document.getElementById("tkScoreRail");
    if (!rail) {
      rail = document.createElement("aside");
      rail.id = "tkScoreRail";
      rail.innerHTML = `
        <div class="tk-card">
          <h3>How to score</h3>
          <div class="tk-row" id="tkRow"></div>
        </div>`;
    }
    // Place immediately after the question container so it sits on the right column
    if (rail.previousElementSibling !== container) {
      container.parentElement.insertBefore(rail, container.nextSibling);
    }

    const row = rail.querySelector("#tkRow");
    row.replaceChildren(
      chip(0, "Brain did a cartwheel", "skipped for now 😅"),
      chip(1, "Hard Limit", "full stop / non-negotiable"),
      chip(2, "Soft Limit", "willing to try; safety & aftercare"),
      chip(3, "Curious / context-dependent", "needs discussion"),
      chip(4, "Comfortable / enjoy"),
      chip(5, "Favorite / enthusiastic yes")
    );
    return rail;
  }

  // ---------- main placement loop ----------
  const place = debounce(async () => {
    log("place: tick");

    const started = await ensureSurveyStarted();
    if (!started) { log("waiting: select a category and/or click Start"); return; }

    const qc = getQuestionContainer(false);
    if (!qc) { log("question container not found yet"); return; }

    unhide(qc);
    mountRailBeside(qc);
    log("rail mounted");
  }, 120);

  // wire-up
  window.addEventListener("load", place);
  const mo = new MutationObserver(place);
  mo.observe(document.body, { childList: true, subtree: true });
  window.addEventListener("resize", place);
  document.addEventListener("change", e => {
    if (e.target && e.target.matches('#categoryPanel input[type="checkbox"]')) place();
  });

  log("booted (overlay disabled)");
})();
</script>
