<!-- ===== TalkKink ‚Äì rescue UI for question + score rail (no overlay required) ===== -->
<script>
(() => {
  const $  = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const log = (...a) => console.log('[TK FIX]', ...a);

  // 0) Basic guard: make sure we're on the survey page
  const app = $('#surveyApp') || $('main[aria-live="polite"]') || document.body;
  if (!app) return log('No #surveyApp/main found ‚Äì nothing to do.');

  // 1) If the real app draws its own question card later, we‚Äôll hide our placeholder.
  const hidePlaceholderWhenRealCardAppears = (placeholder) => {
    const mo = new MutationObserver(() => {
      const realCard = $('[data-role="question"], .question-card, section[aria-label="Question"]');
      if (realCard) {
        placeholder.style.display = 'none';
        log('Real question card detected; placeholder hidden.');
      }
    });
    mo.observe(app, { childList: true, subtree: true });
  };

  // 2) Ensure we have a visible question card *placeholder* (so the page isn‚Äôt blank)
  let q = $('#tkQuestionCard');
  if (!q) {
    q = document.createElement('section');
    q.id = 'tkQuestionCard';
    q.setAttribute('aria-label', 'Question');
    q.style.cssText = `
      max-width: 950px; margin: 24px auto; padding: 18px 22px;
      border-radius: 14px; background:#0b1016; color:#d9eefc;
      border: 1px solid #193648;
      box-shadow: 0 0 0 2px rgba(0,177,255,.10) inset;
    `;
    q.innerHTML = `
      <h3 style="margin:0 0 12px;font-size:22px;letter-spacing:.2px">
        Giving: Rate interest/comfort (0‚Äì5)
      </h3>
      <div id="tkScale" style="display:flex;gap:10px;flex-wrap:wrap"></div>
      <div style="opacity:.75;margin-top:10px;font-size:14px">
        (If you don‚Äôt see your normal question UI yet, select a category on the left and start the survey.)
      </div>
    `;
    const progress = app.querySelector('[role="progressbar"]') || app.firstElementChild;
    (progress?.parentElement || app).appendChild(q);
    hidePlaceholderWhenRealCardAppears(q);
  }

  // 3) Render simple 0‚Äì5 buttons in the placeholder (only if empty)
  const scale = $('#tkScale', q);
  if (scale && !scale.childElementCount) {
    ['0', '1', '2', '3', '4', '5'].forEach(n => {
      const btn = document.createElement('button');
      btn.textContent = n;
      btn.className = 'tkPill';
      btn.title = `Pick ${n}`;
      btn.onclick = () => {
        scale.querySelectorAll('.tkPill').forEach(b => b.classList.toggle('active', b === btn));
      };
      scale.appendChild(btn);
    });
  }

  // 4) Add a compact right-side ‚ÄúHow to score‚Äù rail (no overlay)
  let rail = $('#tkScoreRail');
  if (!rail) {
    rail = document.createElement('aside');
    rail.id = 'tkScoreRail';
    rail.setAttribute('aria-label', 'How to score');
    rail.style.cssText = `
      position: fixed; right: 24px; top: 140px; z-index: 3;
      width: 360px; max-height: 70vh; overflow:auto;
      padding: 14px; border: 1px solid #193648; border-radius: 14px;
      background: #0b1016; color:#d9eefc;
      box-shadow: 0 0 16px rgba(0,0,0,.35);
    `;
    const rows = [
      ['0', 'Brain did a cartwheel ‚Äî skipped for now ü•≤'],
      ['1', 'Hard Limit ‚Äî full stop / no-go (non-negotiable)'],
      ['2', 'Soft Limit ‚Äî willing to try with strong boundaries & safety checks'],
      ['3', 'Curious / context-dependent ‚Äî needs clear negotiation'],
      ['4', 'Comfortable / enjoy ‚Äî generally a yes'],
      ['5', 'Favorite / enthusiastic yes ‚Äî green light'],
    ];
    rail.innerHTML = `
      <h4 style="margin:0 0 10px;font-weight:700;letter-spacing:.2px">How to score</h4>
      <ul id="tkLegend" style="list-style:none;margin:0;padding:0;display:grid;gap:10px">
        ${rows.map(([n, t]) => `
          <li style="display:flex;gap:10px;align-items:center">
            <span style="
              flex:0 0 28px;height:28px;display:inline-grid;place-items:center;
              border-radius:50%;background:#0d141a;border:1px solid #244b5e;color:#cfeeff;
              font-weight:700">${n}</span>
            <span style="line-height:1.35">${t}</span>
          </li>`).join('')}
      </ul>`;
    document.body.appendChild(rail);
  }

  // 5) Minimal styles for the pill buttons
  if (!$('#tkPillStyles')) {
    const st = document.createElement('style'); st.id = 'tkPillStyles';
    st.textContent = `
      .tkPill{
        min-width:44px;height:44px;border-radius:10px;border:1px solid #244b5e;
        background:#0a0f14;color:#def;cursor:pointer;
        font:600 16px/1 ui-sans-serif,system-ui;
        box-shadow:0 0 0 0 rgba(0,190,255,.0) inset;
        transition:box-shadow .15s,border-color .15s
      }
      .tkPill:hover{border-color:#38c1ff}
      .tkPill.active{box-shadow:0 0 0 2px rgba(0,190,255,.35) inset;border-color:#38c1ff}
      /* Hide rail on narrow screens so it doesn't cover content */
      @media (max-width: 1100px){ #tkScoreRail{ display:none } }
    `;
    document.head.appendChild(st);
  }

  // 6) Helpful log + a quick sanity check
  const categoriesSelected = $$('#categoryPanel input[type="checkbox"]:checked').length ||
                             $$('.category-list input[type="checkbox"]:checked').length;
  log('Rescue applied.',
      'Categories selected:', categoriesSelected,
      'Placeholder:', !!q, 'Rail:', !!rail);
})();
</script>
