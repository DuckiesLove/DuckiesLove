<!doctype html>
<html lang="en">
<head>
  <!-- TK rescue: clear stale caches and overlays before we load styles/scripts -->
  <script>
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) {
          try {
            await r.unregister();
          } catch {}
        }
      }
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
    } catch {}
    try {
      const style = document.createElement('style');
      style.textContent = `#overlay, .overlay, [data-overlay], .tk-overlay { display:none !important; }
         body { opacity:1 !important; }`;
      document.head.appendChild(style);
    } catch {}
    try {
      const u = new URL(location.href);
      if (!u.searchParams.has('nuke')) {
        u.searchParams.set('nuke', Date.now());
        location.replace(u);
      }
    } catch {}
  })();
  </script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talk Kink Survey â€” Prototype</title>
<style>
  /* --- global box model so borders/padding don't cause overflow --- */
  *,*::before,*::after{ box-sizing:border-box }

  :root{
    --bg: #081017;
    --panel: #0f1f28;
    --ink: #e7f7ff;
    --ink-dim: #a5c7d2;
    --edge: rgba(132,255,255,.25);
    --glow: 0 0 0.75rem rgba(88, 241, 255, .25);
    --accent: #58f1ff;

    --left: 360px;    /* left column */
    --right: 420px;   /* right column */
    --gap: 24px;      /* column gap */
    --radius: 16px;
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:16px/1.4 system-ui, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }

  .container{max-width:1300px; margin:0 auto; padding:24px 18px 64px}

  h1#title{
    margin: 0 0 12px;                 /* tighter so the right panel appears above the fold */
    text-align:center;
    font-size: clamp(28px, 6vw, 64px);
    font-weight: 800;
    letter-spacing:.5px;
    text-shadow: 0 0 18px rgba(88,241,255,.38);
  }

  .theme-row{
    display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin: 0 0 10px;
  }
  .chip{
    background:rgba(255,255,255,.03); border:1px solid var(--edge);
    padding:7px 12px; border-radius:999px; color:var(--ink); cursor:pointer;
    transition:transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .chip:hover{ transform:translateY(-1px); background:rgba(255,255,255,.05); border-color:rgba(132,255,255,.45) }
  .chip.active{ box-shadow: var(--glow); background:rgba(88,241,255,.1); border-color:rgba(132,255,255,.55) }

  /* CTAs */
  .cta-grid{
    display:grid;
    grid-template-columns: var(--left) 1fr var(--right);
    gap: var(--gap);
    margin: 36px 0 32px;
  }
  #ctaStack{ grid-column: 2 / span 1; display:grid; gap:10px }
  .btn{
    border:1px solid var(--edge); background:rgba(255,255,255,.03); color:var(--ink);
    padding:14px 18px; border-radius:999px; text-align:center; font-weight:700;
    box-shadow: var(--glow); cursor:pointer; transition:transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(132,255,255,.45); }

  /* 3 columns */
  .tk-columns{ display:grid; grid-template-columns: var(--left) 1fr var(--right); gap: var(--gap); align-items:start }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.03));
    border:1px solid var(--edge); border-radius:var(--radius); box-shadow: var(--glow);
  }
  .card > .card-hd{
    padding:14px 16px; border-bottom:1px solid rgba(132,255,255,.12); color:var(--ink);
    font-size: clamp(18px, 2.6vw, 24px); font-weight:800; letter-spacing:.3px;
  }
  .card > .card-bd{ padding:14px 16px 16px }

  .progress-wrap{
    display:flex; flex-direction:column; gap:6px; margin-bottom:12px;
  }
  .progress-label{
    font-weight:700; color:var(--ink-dim);
    font-size: clamp(13px, 1.8vw, 15px);
  }
  .progress-track{
    position:relative; height:10px; border-radius:999px;
    background:rgba(255,255,255,.06); overflow:hidden;
    border:1px solid rgba(132,255,255,.2);
  }
  .progress-fill{
    position:absolute; inset:0; width:0%; border-radius:999px;
    background: var(--accent); box-shadow:0 0 0.5rem rgba(88,241,255,.6);
    transition: width .25s ease;
  }

  /* left categories */
  .tk-left{ max-height: calc(100vh - 170px); overflow:auto }  /* a bit taller, still fits viewport */
  .cat-list{ list-style:none; margin:0; padding:0 }
  .cat-item{
    display:flex; align-items:center; gap:12px; padding:12px 14px; margin:8px 12px;
    border-radius:12px; background:rgba(255,255,255,.02); border:1px solid rgba(132,255,255,.14); color:var(--ink);
  }
  .cat-item input{ accent-color: var(--accent) }

  /* middle card */
  #surveyMain.card{ width:100%; max-width:none; margin-inline:0; font-size:0.95rem }
  #surveyMain .lead{ color: var(--ink-dim); font-size: clamp(15px, 2vw, 18px) }
  #surveyMain .scale-heading{
    margin-top:6px;
    font-size: clamp(15px, 2vw, 20px);
    font-weight:800;
  }

  /* --- FIT-BETTER rating box --- */
  .rating-wrap{
    background: rgba(255,255,255,.03);
    border: 1px solid var(--edge);
    border-radius: 14px;
    padding:12px;
    margin-top: 8px;
  }
  .scale-title{ font-weight:700; color:var(--ink-dim); margin-bottom:8px }

  /* Key change: flex + equal-width pills that shrink as needed. No overflow. */
  .scale-row{
    display:flex; gap:10px; align-items:stretch; width:100%;
    min-width: 0;            /* allow shrink inside grid cell */
  }
  .pill{
    flex: 1 1 0;             /* equal columns; can shrink */
    min-width: 0;            /* let text/radio wrap within */
    display:flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 6px; border-radius:12px;
    border:1px solid var(--edge); background:rgba(255,255,255,.03);
    cursor:pointer; user-select:none;
    transition: background .15s ease, transform .15s ease, border-color .15s ease;
  }
  .pill:hover{ background: rgba(255,255,255,.06); border-color: rgba(132,255,255,.45); transform: translateY(-1px);}
  .pill input{ width:16px; height:16px; margin:0; accent-color: var(--accent); }
  .pill.active{ background: rgba(88,241,255,.18); border-color: rgba(132,255,255,.6); box-shadow: 0 0 0.45rem rgba(88,241,255,.45); }

  /* right guard: raise header so first guard card is visible without scrolling on laptops */
  .tk-right{ max-height: calc(100vh - 170px); overflow:auto } /* internal scroll only when needed */
  .tk-right .card-hd{ position:sticky; top:0; background:linear-gradient(180deg, rgba(8,16,23,.9), rgba(8,16,23,.7)); backdrop-filter: blur(2px); z-index:2 }

  .guard-list{ display:flex; flex-direction:column; gap:10px; padding:10px }
  .guard-item{
    display:flex; gap:14px; align-items:flex-start;
    padding:12px; border-radius:14px; background:rgba(255,255,255,.03); border:1px solid var(--edge);
  }
  .badge{
    width:34px; height:34px; min-width:34px; display:grid; place-items:center;
    border-radius:999px; font-weight:800; color:#04141b; background:#58f1ff;
  }
  .badge.bad-1{ background:#ff6b6b}
  .badge.bad-2{ background:#ffd166}
  .badge.bad-3{ background:#6fd3ff}
  .badge.bad-4{ background:#72ffb3}

  @media (max-width: 1160px){ :root{ --right: 360px; --left: 320px } }
  @media (max-width: 980px){
    .cta-grid{ display:block }
    .tk-columns{ grid-template-columns: 1fr }
    .tk-left,.tk-right{ max-height:none; overflow:visible }
  }

  .hidden{ display:none !important }

  .download-wrap{ margin: 16px auto 28px; display:flex; justify-content:center; }
  .download-wrap .btn{ width:min(320px,100%); }
</style>
</head>
<body>
  <div class="container">
    <h1 id="title">Talk Kink Survey</h1>

    <div class="theme-row" id="themeRow">
      <button class="chip active" data-theme="dark">Dark</button>
      <button class="chip" data-theme="lipstick">Lipstick</button>
      <button class="chip" data-theme="forest">Forest</button>
      <button class="chip" data-theme="glow">Blue Glow</button>
    </div>

    <div class="cta-grid">
      <div></div>
      <nav id="ctaStack">
        <button type="button" class="btn" id="startSurveyBtn" disabled aria-disabled="true">Start Survey</button>
        <a class="btn" href="https://talkkink.org/KinkSurveyPage/index.html#analysis">Individual Kink Analysis</a>
        <a class="btn" href="https://talkkink.org/KinkSurveyPage/index.html#compatibility">Compatibility Page</a>
      </nav>
      <div></div>
    </div>

    <div id="downloadWrap" class="download-wrap hidden">
      <button type="button" class="btn" id="downloadBtn">Download Survey</button>
    </div>

    <section class="tk-columns">
      <!-- LEFT -->
      <aside class="card tk-left" id="catCard">
        <div class="card-hd">Categories</div>
        <div class="card-bd">
          <ul id="catList" class="cat-list" aria-label="Kink categories"></ul>
        </div>
      </aside>

      <!-- MIDDLE -->
      <main class="card" id="surveyMain" aria-live="polite">
        <div class="card-hd">
          <div class="progress-wrap hidden" id="progressWrap" aria-live="polite">
            <div class="progress-label" id="progressLabel">Loading progressâ€¦</div>
            <div class="progress-track" id="progressTrack" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0 of 0 answered">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
          <div class="lead" id="questionCategory">Loading categoryâ€¦</div>
          <div class="scale-heading" id="questionPrompt">Loading questionâ€¦</div>
        </div>
        <div class="card-bd">
          <div class="rating-wrap" role="group" aria-labelledby="scaleTitle">
            <div id="scaleTitle" class="scale-title">Rate interest/comfort (0â€“5)</div>
            <div class="scale-row" id="scaleRow"></div>
          </div>
        </div>
      </main>

      <!-- RIGHT -->
      <aside class="card tk-right">
        <div class="card-hd">Rate interest/comfort (0â€“5)</div>
        <div class="guard-list card-bd">
          <div class="guard-item">
            <div class="badge">0</div>
            <div><strong>Brain did a cartwheel</strong> â€” skipped for now ðŸ¥²</div>
          </div>
          <div class="guard-item">
            <div class="badge bad-1">1</div>
            <div><strong>Hard Limit</strong> â€” full stop / non-negotiable</div>
          </div>
          <div class="guard-item">
            <div class="badge bad-2">2</div>
            <div><strong>Soft Limit</strong> â€” willing to try; strong boundaries &amp; safety checks</div>
          </div>
          <div class="guard-item">
            <div class="badge bad-3">3</div>
            <div><strong>Curious / context-dependent</strong> â€” okay with discussion; needs clear negotiation</div>
          </div>
          <div class="guard-item">
            <div class="badge bad-4">4</div>
            <div><strong>Comfortable / enjoy</strong> â€” generally a yes; normal precautions &amp; check-ins</div>
          </div>
          <div class="guard-item">
            <div class="badge">5</div>
            <div><strong>Favorite / enthusiastic yes</strong> â€” happily into it; green-light</div>
          </div>
        </div>
      </aside>
    </section>

  </div>

<script>
/* themes (cosmetic) */
const themeChips = Array.from(document.querySelectorAll('.chip'));
const rootStyle = document.documentElement?.style;
const THEME_KEY = 'tkSurveyTheme';
const THEMES = {
  dark: {
    bg: '#081017',
    panel: '#0f1f28',
    ink: '#e7f7ff',
    inkDim: '#a5c7d2',
    edge: 'rgba(132,255,255,.25)',
    accent: '#58f1ff',
    glow: '0 0 0.75rem rgba(88, 241, 255, .25)'
  },
  lipstick: {
    bg: '#000000',
    panel: '#12050b',
    ink: '#ffe8f2',
    inkDim: '#f7aacd',
    edge: 'rgba(255,77,166,.42)',
    accent: '#ff4da6',
    glow: '0 0 0.75rem rgba(255,77,166,.32)'
  },
  forest: {
    bg: '#000000',
    panel: '#04140b',
    ink: '#e7fff0',
    inkDim: '#a7d8b6',
    edge: 'rgba(56,245,155,.32)',
    accent: '#38f59b',
    glow: '0 0 0.75rem rgba(56,245,155,.26)'
  },
  glow: {
    bg: '#040c12',
    panel: '#0b1e2b',
    ink: '#e5f6ff',
    inkDim: '#9ecbe1',
    edge: 'rgba(0,234,255,.36)',
    accent: '#00eaff',
    glow: '0 0 0.75rem rgba(0,234,255,.28)'
  }
};

function applyTheme(name, { persist = true } = {}) {
  const themeName = THEMES[name] ? name : 'dark';
  const theme = THEMES[themeName];
  if (rootStyle) {
    rootStyle.setProperty('--bg', theme.bg);
    rootStyle.setProperty('--panel', theme.panel);
    rootStyle.setProperty('--ink', theme.ink);
    rootStyle.setProperty('--ink-dim', theme.inkDim);
    rootStyle.setProperty('--edge', theme.edge);
    rootStyle.setProperty('--accent', theme.accent);
    rootStyle.setProperty('--glow', theme.glow);
  }
  if (document.body) {
    document.body.classList.remove('theme-dark', 'theme-lipstick', 'theme-forest', 'theme-glow');
    document.body.classList.add(`theme-${themeName}`);
  }
  themeChips.forEach(chip => {
    chip.classList.toggle('active', chip.dataset.theme === themeName);
  });
  if (persist) {
    try {
      localStorage.setItem(THEME_KEY, themeName);
    } catch (_) {}
  }
}

themeChips.forEach(chip => {
  chip.addEventListener('click', () => {
    const themeName = chip.dataset.theme;
    applyTheme(themeName);
  });
});

let initialTheme = 'dark';
try {
  const stored = localStorage.getItem(THEME_KEY);
  if (stored && THEMES[stored]) {
    initialTheme = stored;
  }
} catch (_) {}
applyTheme(initialTheme, { persist: false });

/* categories */
const catTargets = [
  '/data/categories.json',
  '/kinksurvey/data/categories.json',
  '/KinkSurveyPage/data/categories.json'
];
const startSurveyBtn = document.getElementById('startSurveyBtn');
const selectedCategories = new Set();
const DEFAULT_PRE_SURVEY_MESSAGE = 'Select one or more categories on the left, then press Start Survey to begin.';
let preSurveyMessage = DEFAULT_PRE_SURVEY_MESSAGE;
let surveyStarted = false;

function normalizeCategoryName(value){
  return String(value ?? '').trim().toLowerCase();
}

function updateStartSurveyState(){
  if(!startSurveyBtn) return;
  const hasSelection = selectedCategories.size > 0;
  if(hasSelection){
    startSurveyBtn.disabled = false;
    startSurveyBtn.removeAttribute('aria-disabled');
  }else{
    startSurveyBtn.disabled = true;
    startSurveyBtn.setAttribute('aria-disabled', 'true');
  }
}

function handleCategoryChange(event){
  const name = event.target.dataset.name ?? '';
  if(event.target.checked){
    selectedCategories.add(name);
  }else{
    selectedCategories.delete(name);
  }
  updateStartSurveyState();
  if(!surveyStarted){
    preSurveyMessage = DEFAULT_PRE_SURVEY_MESSAGE;
    renderQuestion();
  }
}

async function loadCategories(){
  let data = null;
  for(const path of catTargets){
    try{ const r = await fetch(path,{cache:'no-store'}); if(r.ok){ data = await r.json(); break; } }catch(e){}
  }
  if(!data){
    data = ["Appearance Play","Behavioral Play","Body Fluids and Functions","Body Modification",
            "Body Part / Fetish Play","Body Part Torture","Bondage and Suspension","Breath Play",
            "Breeding","Chastity Devices","Communication","Consent & Safewords"];
  }
  const normalize = v => typeof v === 'string' ? v : (v?.name ?? String(v));
  const ul = document.getElementById('catList');
  ul.innerHTML = '';
  selectedCategories.clear();
  (Array.isArray(data)?data.map(normalize):[]).forEach(name=>{
    const li = document.createElement('li');
    li.className = 'cat-item';
    li.innerHTML = `<input type="checkbox" aria-label="${name}"><span>${name}</span>`;
    const input = li.querySelector('input');
    input.dataset.name = name;
    input.addEventListener('change', handleCategoryChange);
    ul.appendChild(li);
  });
  updateStartSurveyState();
}
loadCategories();

/* 0â€“5 pills: equal width, never overflow */
const scaleRow = document.getElementById('scaleRow');
const questionCategoryEl = document.getElementById('questionCategory');
const questionPromptEl = document.getElementById('questionPrompt');
const progressWrap = document.getElementById('progressWrap');
const progressLabel = document.getElementById('progressLabel');
const progressTrack = document.getElementById('progressTrack');
const progressFill = document.getElementById('progressFill');
const downloadWrap = document.getElementById('downloadWrap');
const downloadBtn = document.getElementById('downloadBtn');

const scaleInputs = [];
const scaleLabels = [];
for(let v=0; v<=5; v++){
  const lab = document.createElement('label');
  lab.className = 'pill';
  lab.innerHTML = `<input type="radio" name="score" value="${v}" aria-label="Score ${v}"><span>${v}</span>`;
  const input = lab.querySelector('input');
  input.addEventListener('change', ()=>handleScore(Number(input.value)));
  scaleLabels.push(lab);
  scaleInputs.push(input);
  scaleRow.appendChild(lab);
}

const questionTargets = [
  '/KinkSurveyPage/data/kinks.json',
  '/kinksurvey/data/kinks.json',
  '/data/kinks.json'
];

let allQuestions = [];
let questionList = [];
let currentQuestionIndex = 0;
const answers = new Map();

function normalizeQuestions(data){
  const categories = Array.isArray(data?.categories) ? data.categories : [];
  const result = [];
  categories.forEach((cat, catIndex)=>{
    const catName = String(cat?.category ?? cat?.name ?? cat?.title ?? `Category ${catIndex+1}`);
    const items = Array.isArray(cat?.items) ? cat.items : [];
    items.forEach((item, itemIndex)=>{
      if(item?.type && item.type !== 'scale') return;
      const baseId = String(item?.id ?? `${catIndex}-${itemIndex}`);
      const label = String(item?.label ?? item?.text ?? item?.title ?? 'Survey question');
      const roles = Array.isArray(item?.roles) && item.roles.length ? [item.roles[0]] : [null];
      roles.forEach((role, roleIndex)=>{
        const roleSlug = role ? role.toLowerCase().replace(/[^a-z0-9]+/g,'-') : `role${roleIndex}`;
        result.push({
          id: `${baseId}-${roleSlug}`,
          category: catName,
          prompt: role ? `${role}: ${label}` : label
        });
      });
    });
  });
  return result;
}

function fallbackQuestions(){
  return [
    { id:'fallback-appearance-giving', category:'Appearance Play', prompt:'Giving: Choosing my partnerâ€™s outfit for the day or a scene' },
    { id:'fallback-appearance-receiving', category:'Appearance Play', prompt:'Receiving: Selecting their underwear, lingerie, or base layers' },
    { id:'fallback-protocol', category:'Protocol and Ritual', prompt:'Giving: Offering makeup, polish, or accessories as part of ritual or play' },
    { id:'fallback-impact', category:'Impact Play', prompt:'Giving: Hair pulling intensity preferences' },
    { id:'fallback-voyeurism', category:'Voyeurism/Exhibitionism', prompt:'Receiving: Exhibition scenes with a small audience' }
  ];
}

async function loadQuestions(){
  for(const path of questionTargets){
    try{
      const res = await fetch(path,{cache:'no-store'});
      if(res.ok){
        const json = await res.json();
        const normalized = normalizeQuestions(json);
        if(normalized.length){
          return normalized;
        }
      }
    }catch(e){}
  }
  return fallbackQuestions();
}

function startSurvey(){
  if(selectedCategories.size === 0){
    preSurveyMessage = 'Select at least one category to start the survey.';
    surveyStarted = false;
    renderQuestion();
    return;
  }

  if(!allQuestions.length){
    preSurveyMessage = 'Survey questions are still loading. Please try again in a moment.';
    surveyStarted = false;
    renderQuestion();
    return;
  }

  const normalizedSelected = new Set([...selectedCategories].map(normalizeCategoryName));
  const filtered = allQuestions.filter(q=>normalizedSelected.has(normalizeCategoryName(q.category)));

  if(!filtered.length){
    preSurveyMessage = 'No survey questions are available for the selected categories. Try a different selection.';
    surveyStarted = false;
    renderQuestion();
    return;
  }

  surveyStarted = true;
  questionList = filtered;
  currentQuestionIndex = 0;
  answers.clear();
  preSurveyMessage = DEFAULT_PRE_SURVEY_MESSAGE;
  renderQuestion();
  const surveyMain = document.getElementById('surveyMain');
  if(surveyMain){
    surveyMain.scrollIntoView({behavior:'smooth', block:'start'});
  }
}

if(startSurveyBtn){
  startSurveyBtn.addEventListener('click', startSurvey);
}

function updateProgress(total, completed){
  const percent = total ? Math.min(100, (completed / total) * 100) : 0;
  progressFill.style.width = `${percent}%`;
  progressTrack.setAttribute('aria-valuenow', percent.toFixed(1));
  progressTrack.setAttribute('aria-valuetext', `${completed} of ${total} answered`);
}

function resetScaleState(disabled){
  scaleInputs.forEach((input, idx)=>{
    input.checked = false;
    input.disabled = !!disabled;
    scaleLabels[idx].classList.remove('active');
  });
}

function renderQuestion(){
  if(!surveyStarted){
    progressWrap.classList.add('hidden');
    questionCategoryEl.textContent = 'Survey not started';
    questionPromptEl.textContent = preSurveyMessage;
    progressLabel.textContent = 'Waiting to start';
    resetScaleState(true);
    downloadWrap.classList.add('hidden');
    updateProgress(0,0);
    return;
  }

  const total = questionList.length;
  const completed = answers.size;

  if(!total){
    progressWrap.classList.add('hidden');
    questionCategoryEl.textContent = 'No survey questions available.';
    questionPromptEl.textContent = 'Please adjust your category selection or try again later.';
    resetScaleState(true);
    downloadWrap.classList.add('hidden');
    updateProgress(0,0);
    return;
  }

  progressWrap.classList.remove('hidden');
  updateProgress(total, completed);

  if(currentQuestionIndex >= total){
    questionCategoryEl.textContent = 'Survey complete';
    questionPromptEl.textContent = 'You have answered all available questions.';
    resetScaleState(true);
    progressLabel.textContent = `Survey complete â€¢ ${total} questions`;
    updateProgress(total, total);
    downloadWrap.classList.remove('hidden');
    return;
  }

  downloadWrap.classList.add('hidden');
  resetScaleState(false);

  const current = questionList[currentQuestionIndex];
  questionCategoryEl.textContent = current.category;
  questionPromptEl.textContent = current.prompt;
  progressLabel.textContent = `Question ${currentQuestionIndex + 1} of ${total}`;

  const existingScore = answers.get(current.id);
  if(existingScore != null){
    scaleInputs.forEach((input, idx)=>{
      if(Number(input.value) === existingScore){
        input.checked = true;
        scaleLabels[idx].classList.add('active');
      }
    });
  }
}

function handleScore(value){
  if(!surveyStarted || !questionList.length || currentQuestionIndex >= questionList.length) return;
  const current = questionList[currentQuestionIndex];
  answers.set(current.id, value);
  if(currentQuestionIndex < questionList.length - 1){
    currentQuestionIndex++;
  }else{
    currentQuestionIndex = questionList.length;
  }
  renderQuestion();
}

const loadedScripts = new Set();
function loadScript(url){
  return new Promise((resolve, reject)=>{
    if(!url){
      reject(new Error('Missing script URL'));
      return;
    }
    if(loadedScripts.has(url)){
      resolve();
      return;
    }
    const doc = document;
    if(!doc){
      reject(new Error('Document is not available'));
      return;
    }
    const existing = doc.querySelector(`script[src="${url}"]`);
    if(existing){
      const done = ()=>{
        loadedScripts.add(url);
        resolve();
      };
      if(existing.readyState === 'complete' || existing.readyState === 'loaded'){
        done();
        return;
      }
      existing.addEventListener('load', done, { once:true });
      existing.addEventListener('error', ()=>reject(new Error(`Failed to load script: ${url}`)), { once:true });
      return;
    }
    const script = doc.createElement('script');
    script.src = url;
    script.async = true;
    script.defer = true;
    script.onload = ()=>{
      loadedScripts.add(url);
      resolve();
    };
    script.onerror = ()=>reject(new Error(`Failed to load script: ${url}`));
    doc.head.appendChild(script);
  });
}

let jsPDFLoader = null;
async function ensureJsPDF(){
  if(window.jspdf && window.jspdf.jsPDF){
    window.jsPDF = window.jspdf.jsPDF;
    return window.jspdf.jsPDF;
  }
  if(jsPDFLoader) return jsPDFLoader;
  const sources = [
    '../js/vendor/jspdf.umd.min.js',
    '/js/vendor/jspdf.umd.min.js',
    'https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js'
  ];
  jsPDFLoader = (async()=>{
    for(const url of sources){
      try{
        await loadScript(url);
        if(window.jspdf && window.jspdf.jsPDF) break;
      }catch(err){
        console.warn('Failed to load jsPDF from', url, err);
      }
    }
    if(!(window.jspdf && window.jspdf.jsPDF)){
      throw new Error('jsPDF failed to load');
    }
    window.jsPDF = window.jspdf.jsPDF;
    return window.jspdf.jsPDF;
  })();
  return jsPDFLoader;
}

downloadBtn.addEventListener('click', async ()=>{
  if(!surveyStarted || !questionList.length || answers.size < questionList.length) return;
  const grouped = new Map();
  const order = [];
  questionList.forEach(q=>{
    if(!grouped.has(q.category)){
      grouped.set(q.category, []);
      order.push(q.category);
    }
    const score = answers.has(q.id) ? answers.get(q.id) : '(no response)';
    grouped.get(q.category).push({prompt:q.prompt, score});
  });

  const originalText = downloadBtn.textContent;
  downloadBtn.textContent = 'Preparing PDFâ€¦';
  downloadBtn.setAttribute('aria-busy', 'true');
  downloadBtn.disabled = true;
  try{
    const jsPDFCtor = await ensureJsPDF();
    const doc = new jsPDFCtor({ unit:'pt', format:'letter', putOnlyUsedFonts:true });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const marginX = 56;
    const headerTop = 54;
    const contentWidth = pageWidth - marginX * 2;
    const lineHeight = 18;
    const accent = [88,241,255];
    const bodyColor = [231,247,255];
    const muted = [165,199,210];
    const background = [8,16,23];
    const stamp = new Date().toLocaleString();
    let cursorY = headerTop + 72;

    const paintPage = ()=>{
      doc.setFillColor(...background);
      doc.rect(0, 0, pageWidth, pageHeight, 'F');
      doc.setTextColor(...bodyColor);
    };

    const renderFirstHeader = ()=>{
      paintPage();
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(28);
      doc.setTextColor(...accent);
      doc.text('Talk Kink Survey', marginX, headerTop);
      doc.setFontSize(18);
      doc.text('Responses', marginX, headerTop + 28);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(...muted);
      doc.text(`Exported ${stamp}`, pageWidth - marginX, headerTop + 4, { align:'right' });
      doc.setFontSize(12);
      doc.text('Complete answers grouped by category.', marginX, headerTop + 48);
      doc.setTextColor(...bodyColor);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(12);
    };

    const renderContinuationHeader = ()=>{
      paintPage();
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(...accent);
      doc.text('Talk Kink Survey â€” Responses (continued)', marginX, headerTop);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(...muted);
      doc.text(stamp, pageWidth - marginX, headerTop, { align:'right' });
      doc.setTextColor(...bodyColor);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(12);
      cursorY = headerTop + 28;
    };

    const ensureSpace = amount=>{
      const needed = cursorY + amount;
      const limit = pageHeight - 56;
      if(needed > limit){
        doc.addPage();
        renderContinuationHeader();
      }
    };

    renderFirstHeader();

    order.forEach(category=>{
      const entries = grouped.get(category) || [];
      if(!entries.length) return;
      ensureSpace(32);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(...accent);
      doc.text(String(category || '').toUpperCase(), marginX, cursorY);
      cursorY += 22;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(12);
      doc.setTextColor(...bodyColor);
      entries.forEach(item=>{
        const score = item.score == null ? '(no response)' : item.score;
        const bullet = `â€¢ [${score}] ${item.prompt}`;
        const lines = doc.splitTextToSize(bullet, contentWidth);
        lines.forEach(line=>{
          ensureSpace(lineHeight);
          doc.text(line, marginX, cursorY);
          cursorY += lineHeight;
        });
        cursorY += 6;
      });
      cursorY += 6;
    });

    ensureSpace(32);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(...muted);
    doc.text('Scores range from 0 (hard limit) to 5 (enthusiastic yes).', marginX, cursorY);
    cursorY += 14;
    doc.text('Generated for personal reference â€” TalkKink.org', marginX, cursorY);

    const filename = 'talkkink-survey-results.pdf';
    if(typeof doc.save === 'function'){
      doc.save(filename);
    }else{
      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(url);
        a.remove();
      },0);
    }
  }catch(err){
    console.error('Failed to generate survey PDF', err);
    alert('Could not generate the survey PDF. Please try again.');
  }finally{
    downloadBtn.disabled = false;
    downloadBtn.textContent = originalText;
    downloadBtn.removeAttribute('aria-busy');
  }
});

(async ()=>{
  allQuestions = await loadQuestions();
  questionList = [];
  currentQuestionIndex = 0;
  answers.clear();
  surveyStarted = false;
  preSurveyMessage = DEFAULT_PRE_SURVEY_MESSAGE;
  renderQuestion();
})();
</script>
</body>
</html>
