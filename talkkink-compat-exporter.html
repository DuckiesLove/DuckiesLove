<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TalkKink Compatibility Exporter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
    --tk-bg: #0b0b0c;
    --tk-cyan: #14e3e9;
    --tk-cyan-rgb: 20,227,233;
    --tk-ink: #f7f7f7;
    --page-pad: 16px;
    --maxw: 1200px;
  }
  html,body{height:100%;background:var(--tk-bg);margin:0}
  body{display:flex;justify-content:center}
  .page{
    width:100%;
    max-width:var(--maxw);
    padding: clamp(12px,2vw,24px);
    box-sizing:border-box;
  }

  /* Headline & subtitle centered, with outlined/glow text */
  .hx{
    margin:0;
    text-align:center;
    color: var(--tk-cyan);
    letter-spacing:.5px;
    /* multi-direction glow outline (safe in PDF html2canvas too) */
    text-shadow:
      0 0 2px rgba(var(--tk-cyan-rgb),.9),
      0 0 6px rgba(var(--tk-cyan-rgb),.6),
      -1px 0 0 rgba(0,0,0,.9), 1px 0 0 rgba(0,0,0,.9),
      0 -1px 0 rgba(0,0,0,.9), 0 1px 0 rgba(0,0,0,.9),
      -1px -1px 0 rgba(0,0,0,.9), 1px 1px 0 rgba(0,0,0,.9);
  }
  .h1{font: 800 clamp(28px, 5vw, 56px) system-ui}
  .h2{font: 800 clamp(22px, 4.2vw, 40px) system-ui; margin-top:.35em}
  .sub{
    text-align:center; color:#b7ffff; opacity:.85;
    margin:.25rem 0 .75rem 0; font: 500 clamp(12px,1.6vw,16px) system-ui
  }
  .rule{height:3px;background:var(--tk-cyan);opacity:.75;margin:.35rem auto 1rem auto;width:100%}

  /* Table: centered, fills width, no extra white bands */
  table.compat{
    width:100%; border-collapse:separate; border-spacing:0;
    background:rgba(0,0,0,.35); color:var(--tk-ink);
    box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
  }
  table.compat caption{display:none}
  table.compat thead th{
    position:sticky; top:0; z-index:2;
    background:#0f1214; color: var(--tk-cyan);
    font: 700 clamp(12px,1.7vw,18px) system-ui;
    padding: .7rem .7rem; border-bottom:1px solid rgba(255,255,255,.08);
    text-shadow:
      0 0 2px rgba(var(--tk-cyan-rgb),.7),
      0 0 6px rgba(var(--tk-cyan-rgb),.4);
  }
  table.compat td{
    font: 500 clamp(12px,1.5vw,18px) system-ui;
    padding:.75rem .7rem; border-bottom:1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.02);
  }
  table.compat tr:nth-child(odd) td{background: rgba(255,255,255,.035)}
  table.compat .num{ text-align:center; font-variant-numeric: tabular-nums }
  table.compat .flag{ text-align:center }
  table.compat .label{ word-break: break-word }

  /* Tighten the Flag column (4%), gift space to the label */
  table.compat colgroup col.label{ width: 56% }
  table.compat colgroup col.pa{ width: 12% }
  table.compat colgroup col.match{ width: 16% }
  table.compat colgroup col.flag{ width: 4% }
  table.compat colgroup col.pb{ width: 12% }

  /* Remove accidental duplicate header row if an upstream script injects again */
  table.compat thead tr + tr{ display:none !important }

  /* Download button (optional) */
  .bar{display:flex;justify-content:center;margin:1rem 0}
  .btn{
    background:linear-gradient(0deg, rgba(var(--tk-cyan-rgb),.18), rgba(var(--tk-cyan-rgb),.28));
    color:#001a1c; font: 700 15px system-ui; border:1px solid rgba(var(--tk-cyan-rgb),.55);
    border-radius: 12px; padding:.6rem 1rem; cursor:pointer
  }
  .btn:active{ transform: translateY(1px) }
  </style>
</head>
<body>
<div class="page" id="tk-root">
  <h1 class="hx h1">TalkKink Compatibility</h1>
  <div class="sub" id="tk-ts">Generated: —</div>
  <div class="rule"></div>
  <h2 class="hx h2">Behavioral Play</h2>

  <!-- Your compatibility table; the colgroup keeps widths in sync with PDF -->
  <table class="compat" id="compatTable">
    <colgroup>
      <col class="label"><col class="pa"><col class="match"><col class="flag"><col class="pb">
    </colgroup>
    <thead>
      <tr>
        <th>Item</th><th>Partner A</th><th>Match</th><th>Flag</th><th>Partner B</th>
      </tr>
    </thead>
    <tbody id="compatBody"><!-- rows injected by your app; leave empty in template --></tbody>
  </table>

  <div class="bar">
    <button class="btn" id="downloadPdfBtn">Download PDF</button>
  </div>
</div>

<script>
(() => {
  const tsEl = document.getElementById('tk-ts');
  if (tsEl) tsEl.textContent = `Generated: ${new Date().toLocaleString()}`;
})();
</script>
<script>
(() => {
  /* =========================================================
     TalkKink — Classic Compatibility PDF (clean 5-column)
     - Nukes previous exporter + click handlers
     - Clears cached rows so fallback actually takes effect
     - Ignores the live table unless you enable it explicitly
     - Renders: Item | Partner A | Match | Flag | Partner B
     - Flag is a drawn triangle (no "&&†")
     ========================================================= */

  // 0) Kill any previous handlers and API
  const kill = (sel) => {
    const el = document.querySelector(sel);
    if (!el) return;
    const clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);
  };
  ['#downloadPdfBtn', '#btnDownloadPdf'].forEach(kill);
  delete window.TKPDF;

  // 1) Purge stale caches that override your changes
  try {
    ['talkkink:compatRows','tk_compat.rows','tk_compat_rows','talkkink:survey','talkkink:mine','talkkink:partner']
      .forEach(k => localStorage.removeItem(k));
  } catch(e) {}
  // Also neutralize any old globals
  window.talkkinkCompatRows = undefined;
  if (window.TKCompatPDF && typeof window.TKCompatPDF.notifyRowsUpdated === 'function') {
    window.TKCompatPDF.notifyRowsUpdated([]);
  }

  // 2) Theme + page constants
  const THEME = {
    bg: [10,10,12],
    fg: [233,238,240],
    cyan: [48,231,231],
    grid: [255,255,255, 0.10],
    zebra: [255,255,255, 0.035],
    headerLine: [255,255,255, 0.16],
  };
  const PAGE = { mTop: 24, mLeft: 18, mRight: 18, mBottom: 18 };

  // 3) Load jsPDF + AutoTable (fresh, no storage)
  let _lib;
  function loadJsPDF(){
    if (_lib) return Promise.resolve(_lib);
    const load = src => new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = src + (src.includes('?')?'&':'?') + 'tk=' + Date.now();
      s.async = true; s.onload = res; s.onerror = () => rej(new Error('Failed '+src));
      document.head.appendChild(s);
    });
    return load('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js')
      .then(()=>load('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js'))
      .then(()=>{ _lib = window.jspdf || window.jsPDF || window.jspdf_umd; if(!_lib||!_lib.jsPDF) throw new Error('jsPDF missing'); return _lib;});
  }

  // 4) Data source — FORCE a clean dataset (no live scrape)
  //    If you want to use your own rows, set window.talkkinkCompatRows to an array of:
  //    [item, partnerA, match%, flag(boolean or symbol), partnerB]
  function pickRows() {
    if (Array.isArray(window.talkkinkCompatRows) && window.talkkinkCompatRows.length) {
      return window.talkkinkCompatRows.map(([item,a,m,f,b]) => [
        String(item||''), String(a??''), String(m||'100%'), (f ? '▶' : '▶'), String(b??'')
      ]);
    }
    // Fallback to what’s visibly in your screenshot (structure-only demo).
    // Replace/extend these lines with your real rows if you want them baked in:
    return [
      ['Attitude toward funishment vs serious correction', '3', '100%', '▶', '3'],
      ['Preferred style of discipline strict vs lenient',     '4', '100%', '▶', '4'],
      ['Use of behavior contracts or rule agreements',        '2', '100%', '▶', '2'],
      ['Assigning corner time or time outs',                  '0', '100%', '▶', '0'],
      ['Lecturing or scolding to modify behavior',            '4', '100%', '▶', '4'],
      ['Playful punishments that still reinforce rules',      '3', '100%', '▶', '3'],
      ['Removing privileges phone TV sweets',                 '2', '100%', '▶', '2'],
      ['Writing lines or apology letters as correction',      '1', '100%', '▶', '1'],
      ['Being placed in the corner or given a time out',      '5', '100%', '▶', '5'],
      ['Getting scolded or lectured for correction',          '5', '100%', '▶', '5'],
      ['Having privileges revoked phone TV',                  '3', '100%', '▶', '3'],
      ['Receiving playful funishments for minor rule',        '2', '100%', '▶', '2'],
      ['Writing lines or apology letters when misbehaving',   '4', '100%', '▶', '4'],
    ];
  }

  // 5) Glow text helper for outlined headings
  function glow(doc, txt, x, y, size, main, glow) {
    doc.setFont('helvetica','bold'); doc.setFontSize(size);
    doc.setTextColor(glow[0], glow[1], glow[2]);
    [[0.7,0.7],[-0.7,0.7],[0.7,-0.7],[-0.7,-0.7]].forEach(([dx,dy])=>{
      doc.text(txt, x+dx, y+dy, { baseline:'alphabetic', align:'center' });
    });
    doc.setTextColor(main[0], main[1], main[2]);
    doc.text(txt, x, y, { baseline:'alphabetic', align:'center' });
  }

  // 6) Build the PDF (single, clean)
  async function buildPdf(filename='talkkink-compatibility-results.pdf'){
    const { jsPDF } = await loadJsPDF();
    const rows = pickRows();

    const doc = new jsPDF({ unit:'pt', format:'letter', compress:true });
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();

    // Background
    doc.setFillColor(...THEME.bg); doc.rect(0,0,W,H,'F');

    // Title + timestamp
    const y1 = PAGE.mTop + 38;
    glow(doc,'TalkKink Compatibility', W/2, y1, 46, THEME.fg, THEME.cyan);
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.setTextColor(180,235,235);
    doc.text('Generated: ' + new Date().toLocaleString(), W/2, y1+22, { align:'center' });

    // Divider
    doc.setDrawColor(...THEME.cyan); doc.setLineWidth(2);
    doc.line(PAGE.mLeft, y1+30, W-PAGE.mRight, y1+30);

    // Section
    const y2 = y1 + 74;
    glow(doc,'Behavioral Play', W/2, y2, 36, THEME.fg, THEME.cyan);

    // Table columns — slim Flag
    const totalW = W - PAGE.mLeft - PAGE.mRight;
    const colW = [0.58,0.12,0.12,0.06,0.12].map(p => Math.floor(totalW*p));

    // Render
    doc.autoTable({
      head: [['Item','Partner A','Match','Flag','Partner B']],
      body: rows,
      startY: y2 + 20,
      margin: { top: PAGE.mTop, left: PAGE.mLeft, right: PAGE.mRight, bottom: PAGE.mBottom },
      tableWidth: totalW,
      styles: {
        font: 'helvetica', fontSize: 12,
        textColor: THEME.fg,
        lineColor: THEME.grid, lineWidth: 0.6,
        cellPadding: { top:6,right:6,bottom:6,left:8 },
        halign: 'left', valign: 'middle'
      },
      headStyles: {
        fillColor: null,
        textColor: THEME.cyan,
        fontStyle: 'bold',
        lineColor: THEME.headerLine,
        lineWidth: 1.2,
        halign: 'left'
      },
      alternateRowStyles: { fillColor: THEME.zebra },
      columnStyles: {
        0:{ cellWidth: colW[0], halign:'left'   },
        1:{ cellWidth: colW[1], halign:'center' },
        2:{ cellWidth: colW[2], halign:'center' },
        3:{ cellWidth: colW[3], halign:'center' },
        4:{ cellWidth: colW[4], halign:'center' },
      },
      didParseCell: (h) => {
        // Force clean Flag symbol (no "&&†")
        if (h.section==='body' && h.column.index===3) h.cell.text = ['▶'];
      },
      willDrawCell: (h) => {
        // Draw triangle icon instead of text
        if (h.section==='body' && h.column.index===3) {
          const { x,y,width,height } = h.cell;
          const cx = x + width/2 - 4;
          const cy = y + height/2;
          const c  = THEME.cyan;
          doc.setFillColor(c[0],c[1],c[2]); doc.setDrawColor(c[0],c[1],c[2]);
          doc.triangle(cx-6, cy-6, cx-6, cy+6, cx+9, cy, 'F');
          h.cell.text = [''];
        }
      }
    });

    doc.save(filename);
  }

  // 7) Public API + single binding (no double loads)
  window.TKPDF = {
    download: () => buildPdf().catch(e => { console.error('[TKPDF]', e); alert('PDF export failed. See console.'); })
  };
  const bind = sel => {
    const b = document.querySelector(sel);
    if (!b) return false;
    b.addEventListener('click', e => { e.preventDefault(); window.TKPDF.download(); });
    return true;
  };
  bind('#downloadPdfBtn') || bind('#btnDownloadPdf');

  console.log('[TKPDF] Clean classic exporter installed. Old generator removed, caches cleared.');
})();
</script>
</body>
</html>
