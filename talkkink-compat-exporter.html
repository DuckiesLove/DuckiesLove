<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TalkKink Compatibility Exporter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
    --tk-bg: #0b0b0c;
    --tk-cyan: #14e3e9;
    --tk-cyan-rgb: 20,227,233;
    --tk-ink: #f7f7f7;
    --page-pad: 16px;
    --maxw: 1200px;
  }
  html,body{height:100%;background:var(--tk-bg);margin:0}
  body{display:flex;justify-content:center}
  .page{
    width:100%;
    max-width:var(--maxw);
    padding: clamp(12px,2vw,24px);
    box-sizing:border-box;
  }

  /* Headline & subtitle centered, with outlined/glow text */
  .hx{
    margin:0;
    text-align:center;
    color: var(--tk-cyan);
    letter-spacing:.5px;
    /* multi-direction glow outline (safe in PDF html2canvas too) */
    text-shadow:
      0 0 2px rgba(var(--tk-cyan-rgb),.9),
      0 0 6px rgba(var(--tk-cyan-rgb),.6),
      -1px 0 0 rgba(0,0,0,.9), 1px 0 0 rgba(0,0,0,.9),
      0 -1px 0 rgba(0,0,0,.9), 0 1px 0 rgba(0,0,0,.9),
      -1px -1px 0 rgba(0,0,0,.9), 1px 1px 0 rgba(0,0,0,.9);
  }
  .h1{font: 800 clamp(28px, 5vw, 56px) system-ui}
  .h2{font: 800 clamp(22px, 4.2vw, 40px) system-ui; margin-top:.35em}
  .sub{
    text-align:center; color:#b7ffff; opacity:.85;
    margin:.25rem 0 .75rem 0; font: 500 clamp(12px,1.6vw,16px) system-ui
  }
  .rule{height:3px;background:var(--tk-cyan);opacity:.75;margin:.35rem auto 1rem auto;width:100%}

  /* Table: centered, fills width, no extra white bands */
  table.compat{
    width:100%; border-collapse:separate; border-spacing:0;
    background:rgba(0,0,0,.35); color:var(--tk-ink);
    box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
  }
  table.compat caption{display:none}
  table.compat thead th{
    position:sticky; top:0; z-index:2;
    background:#0f1214; color: var(--tk-cyan);
    font: 700 clamp(12px,1.7vw,18px) system-ui;
    padding: .7rem .7rem; border-bottom:1px solid rgba(255,255,255,.08);
    text-shadow:
      0 0 2px rgba(var(--tk-cyan-rgb),.7),
      0 0 6px rgba(var(--tk-cyan-rgb),.4);
  }
  table.compat td{
    font: 500 clamp(12px,1.5vw,18px) system-ui;
    padding:.75rem .7rem; border-bottom:1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.02);
  }
  table.compat tr:nth-child(odd) td{background: rgba(255,255,255,.035)}
  table.compat .num{ text-align:center; font-variant-numeric: tabular-nums }
  table.compat .flag{ text-align:center }
  table.compat .label{ word-break: break-word }

  /* Tighten the Flag column (4%), gift space to the label */
  table.compat colgroup col.label{ width: 56% }
  table.compat colgroup col.pa{ width: 12% }
  table.compat colgroup col.match{ width: 16% }
  table.compat colgroup col.flag{ width: 4% }
  table.compat colgroup col.pb{ width: 12% }

  /* Remove accidental duplicate header row if an upstream script injects again */
  table.compat thead tr + tr{ display:none !important }

  /* Download button (optional) */
  .bar{display:flex;justify-content:center;margin:1rem 0}
  .btn{
    background:linear-gradient(0deg, rgba(var(--tk-cyan-rgb),.18), rgba(var(--tk-cyan-rgb),.28));
    color:#001a1c; font: 700 15px system-ui; border:1px solid rgba(var(--tk-cyan-rgb),.55);
    border-radius: 12px; padding:.6rem 1rem; cursor:pointer
  }
  .btn:active{ transform: translateY(1px) }
  </style>
</head>
<body>
<div class="page" id="tk-root">
  <h1 class="hx h1">TalkKink Compatibility</h1>
  <div class="sub" id="tk-ts">Generated: —</div>
  <div class="rule"></div>
  <h2 class="hx h2">Behavioral Play</h2>

  <!-- Your compatibility table; the colgroup keeps widths in sync with PDF -->
  <table class="compat" id="compatTable">
    <colgroup>
      <col class="label"><col class="pa"><col class="match"><col class="flag"><col class="pb">
    </colgroup>
    <thead>
      <tr>
        <th>Item</th><th>Partner A</th><th>Match</th><th>Flag</th><th>Partner B</th>
      </tr>
    </thead>
    <tbody id="compatBody"><!-- rows injected by your app; leave empty in template --></tbody>
  </table>

  <div class="bar">
    <button class="btn" id="downloadPdfBtn">Download PDF</button>
  </div>
</div>

<script>
(() => {
  const tsEl = document.getElementById('tk-ts');
  if (tsEl) tsEl.textContent = `Generated: ${new Date().toLocaleString()}`;
})();
</script>
<script>
(() => {
  /* =========================================================
     TalkKink — Simple Compatibility PDF (classic layout)
     Kills old generator, installs window.TKPDF.download(opts)
     Matches the screenshot: 5 columns, slim Flag, outlined titles
     ========================================================= */

  // 0) Hard-kill old bindings & APIs
  const killOld = (sel) => {
    const btn = document.querySelector(sel);
    if (!btn) return;
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
  };
  killOld('#downloadPdfBtn');
  killOld('#btnDownloadPdf');
  delete (window.TKPDF);

  // 1) Constants (colors roughly matching your UI)
  const THEME = {
    bg: [10,10,12],
    fg: [233,238,240],
    cyan: [48,231,231],
    grid: [255,255,255, 0.08],
    grid2: [255,255,255, 0.14],
    zebra: [255,255,255, 0.03],
    headerLine: [255,255,255, 0.14],
  };
  const PAGE = { mTop: 22, mLeft: 14, mRight: 14, mBottom: 18 };

  // 2) Lazy-load jsPDF + AutoTable (no localStorage usage; avoid tracking-prevention issues)
  let _lib;
  async function loadJsPDF() {
    if (_lib) return _lib;
    const load = (src) => new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = src + (src.includes('?') ? '&' : '?') + 'tk=' + Date.now();
      s.async = true;
      s.onload = res;
      s.onerror = () => rej(new Error('Failed to load: ' + src));
      document.head.appendChild(s);
    });
    await load('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
    await load('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js');
    _lib = window.jspdf || window.jsPDF || window.jspdf_umd || window.jspdfUmd || window.jspdfumd;
    // Normalize to UMD handle
    if (_lib && _lib.jsPDF) _lib = _lib;
    else if (window.jspdf && window.jspdf.jsPDF) _lib = window.jspdf;
    else throw new Error('jsPDF not available after load');
    return _lib;
  }

  // 3) Source selection
  //    - Prefer a live table on the page (exactly as user sees).
  //    - Else fallback to any in-memory rows (talkkinkCompatRows).
  //    - Else last-resort demo shape so the exporter never crashes.
  function scrapeLiveTable() {
    const tbl = document.querySelector('table');
    if (!tbl) return null;
    // Expect head: Item, Partner A, Match, Flag, Partner B
    const rows = [];
    const get = (cell) => (cell?.innerText || cell?.textContent || '').replace(/\s+/g,' ').trim();
    tbl.querySelectorAll('tbody tr').forEach(tr => {
      const tds = Array.from(tr.children).filter(el => el.matches('td,th'));
      if (!tds.length) return;
      const item = get(tds[0]);
      const a    = get(tds[1]);
      const match= get(tds[2]);
      let   flag = get(tds[3]);
      const b    = get(tds[4]);
      // Clean weird “&&†” etc.
      if (!flag || /&|†|gt;|lt;|[A-Za-z%]+/.test(flag)) flag = '▶';
      rows.push([item, a, match, flag, b]);
    });
    return rows.length ? rows : null;
  }

  function pickRows() {
    // 1) Live table first
    const live = scrapeLiveTable();
    if (live) return live;

    // 2) Global memory
    if (Array.isArray(window.talkkinkCompatRows) && window.talkkinkCompatRows.length) {
      return window.talkkinkCompatRows.map(r => {
        const [item,a,match,flag,b] = r;
        return [String(item||''), String(a??''), String(match??''), (flag? '▶':'▶'), String(b??'')];
      });
    }

    // 3) Last-resort sample (shouldn’t trigger in your flow)
    return [
      ['Sample item', '3', '100%', '▶', '3'],
      ['Another sample', '4', '100%', '▶', '4'],
    ];
  }

  // 4) Outlined/glow text helper (shadow + main)
  function drawGlowText(doc, text, x, y, size, mainRGB, glowRGB) {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(size);
    // Soft “glow” (draw a few blurred offsets)
    doc.setTextColor(glowRGB[0], glowRGB[1], glowRGB[2]);
    const offsets = [[0.6,0.6],[-0.6,0.6],[0.6,-0.6],[-0.6,-0.6]];
    offsets.forEach(o => doc.text(text, x+o[0], y+o[1], { baseline: 'alphabetic', renderingMode: 'fill' }));
    // Main text
    doc.setTextColor(mainRGB[0], mainRGB[1], mainRGB[2]);
    doc.text(text, x, y, { baseline: 'alphabetic' });
  }

  // 5) Build the PDF
  async function buildPdf(filename = 'talkkink-compatibility-results.pdf') {
    const data = pickRows();
    const { jsPDF } = await loadJsPDF();

    const doc = new jsPDF({ unit: 'pt', format: 'letter', compress: true }); // 612x792
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    // Background
    doc.setFillColor(...THEME.bg);
    doc.rect(0,0,pageW,pageH,'F');

    // Title block
    const title = 'TalkKink Compatibility';
    const generated = `Generated: ${new Date().toLocaleString()}`;
    const h1Y = PAGE.mTop + 36;
    drawGlowText(doc, title, pageW/2, h1Y, 44, THEME.fg, THEME.cyan);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(180, 235, 235);
    doc.text(generated, pageW/2, h1Y + 20, { align: 'center' });

    // Cyan divider
    doc.setDrawColor(...THEME.cyan);
    doc.setLineWidth(2);
    doc.line(PAGE.mLeft, h1Y + 28, pageW - PAGE.mRight, h1Y + 28);

    // Section heading
    const secY = h1Y + 70;
    drawGlowText(doc, 'Behavioral Play', pageW/2, secY, 36, THEME.fg, THEME.cyan);

    // Table
    const head = [['Item','Partner A','Match','Flag','Partner B']];
    const body = data;

    // Column widths (percent of printable width)
    const totalW = pageW - PAGE.mLeft - PAGE.mRight;
    const colW = [0.58, 0.12, 0.12, 0.06, 0.12].map(p => Math.floor(totalW * p));

    doc.autoTable({
      head,
      body,
      startY: secY + 18,
      margin: { top: PAGE.mTop, left: PAGE.mLeft, right: PAGE.mRight, bottom: PAGE.mBottom },
      tableWidth: totalW,
      styles: {
        fillColor: null,
        textColor: THEME.fg,
        lineColor: THEME.grid,
        lineWidth: 0.6,
        font: 'helvetica',
        fontSize: 12,
        cellPadding: { top: 6, right: 6, bottom: 6, left: 8 },
        halign: 'left',
        valign: 'middle'
      },
      headStyles: {
        fillColor: null,
        textColor: THEME.cyan,
        fontStyle: 'bold',
        lineColor: THEME.headerLine,
        lineWidth: 1.2,
        halign: 'left'
      },
      columnStyles: {
        0: { cellWidth: colW[0], halign: 'left'  },
        1: { cellWidth: colW[1], halign: 'center'},
        2: { cellWidth: colW[2], halign: 'center'},
        3: { cellWidth: colW[3], halign: 'center'},
        4: { cellWidth: colW[4], halign: 'center'},
      },
      alternateRowStyles: { fillColor: THEME.zebra },
      didParseCell: (hook) => {
        // Normalize Flag column visuals
        if (hook.section === 'body' && hook.column.index === 3) {
          const txt = (hook.cell.raw || '').toString().trim();
          if (!txt || /&|†|gt;|lt;|[A-Za-z%]+/.test(txt)) hook.cell.text = ['▶'];
          else hook.cell.text = [txt];
        }
      },
      willDrawCell: (hook) => {
        // Draw triangle icon for Flag (optional: we already print '▶'; this makes it sturdier)
        if (hook.section === 'body' && hook.column.index === 3) {
          const { x, y, height, width } = hook.cell;
          const pad = 8;
          const cx = x + width/2 - 4; // little left for isosceles look
          const cy = y + height/2;
          doc.setFillColor(48,231,231);
          doc.setDrawColor(48,231,231);
          doc.triangle(cx-6, cy-6, cx-6, cy+6, cx+8, cy, 'F');
          hook.cell.text = ['']; // hide text; we drew the icon
        }
      },
      didDrawPage: (data) => {
        // Footer page numbers (optional)
        const str = `Page ${doc.internal.getNumberOfPages()}`;
        doc.setFontSize(9); doc.setTextColor(180, 235, 235);
        doc.text(str, pageW - PAGE.mRight, pageH - 10, { align: 'right' });
      }
    });

    doc.save(filename);
  }

  // 6) Expose the public API and bind the click
  window.TKPDF = {
    download: async (opts = {}) => {
      try {
        await buildPdf(opts.filename || 'talkkink-compatibility-results.pdf');
      } catch (e) {
        console.error('[TKPDF] Export failed:', e);
        alert('PDF export failed. See console for details.');
      }
    }
  };

  // 7) One clear, single binding (no double load)
  const bind = (sel) => {
    const btn = document.querySelector(sel);
    if (!btn) return false;
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      window.TKPDF.download();
    }, { once: false });
    return true;
  };
  bind('#downloadPdfBtn') || bind('#btnDownloadPdf');

  console.log('[TKPDF] Classic exporter installed (old generator disabled).');
})();
</script>
</body>
</html>
