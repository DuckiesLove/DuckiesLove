<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TalkKink Compatibility Exporter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
    --tk-bg: #0b0b0c;
    --tk-cyan: #14e3e9;
    --tk-cyan-rgb: 20,227,233;
    --tk-ink: #f7f7f7;
    --page-pad: 16px;
    --maxw: 1200px;
  }
  html,body{height:100%;background:var(--tk-bg);margin:0}
  body{display:flex;justify-content:center}
  .page{
    width:100%;
    max-width:var(--maxw);
    padding: clamp(12px,2vw,24px);
    box-sizing:border-box;
  }

  /* Headline & subtitle centered, with outlined/glow text */
  .hx{
    margin:0;
    text-align:center;
    color: var(--tk-cyan);
    letter-spacing:.5px;
    /* multi-direction glow outline (safe in PDF html2canvas too) */
    text-shadow:
      0 0 2px rgba(var(--tk-cyan-rgb),.9),
      0 0 6px rgba(var(--tk-cyan-rgb),.6),
      -1px 0 0 rgba(0,0,0,.9), 1px 0 0 rgba(0,0,0,.9),
      0 -1px 0 rgba(0,0,0,.9), 0 1px 0 rgba(0,0,0,.9),
      -1px -1px 0 rgba(0,0,0,.9), 1px 1px 0 rgba(0,0,0,.9);
  }
  .h1{font: 800 clamp(28px, 5vw, 56px) system-ui}
  .h2{font: 800 clamp(22px, 4.2vw, 40px) system-ui; margin-top:.35em}
  .sub{
    text-align:center; color:#b7ffff; opacity:.85;
    margin:.25rem 0 .75rem 0; font: 500 clamp(12px,1.6vw,16px) system-ui
  }
  .rule{height:3px;background:var(--tk-cyan);opacity:.75;margin:.35rem auto 1rem auto;width:100%}

  /* Table: centered, fills width, no extra white bands */
  table.compat{
    width:100%; border-collapse:separate; border-spacing:0;
    background:rgba(0,0,0,.35); color:var(--tk-ink);
    box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
  }
  table.compat caption{display:none}
  table.compat thead th{
    position:sticky; top:0; z-index:2;
    background:#0f1214; color: var(--tk-cyan);
    font: 700 clamp(12px,1.7vw,18px) system-ui;
    padding: .7rem .7rem; border-bottom:1px solid rgba(255,255,255,.08);
    text-shadow:
      0 0 2px rgba(var(--tk-cyan-rgb),.7),
      0 0 6px rgba(var(--tk-cyan-rgb),.4);
  }
  table.compat td{
    font: 500 clamp(12px,1.5vw,18px) system-ui;
    padding:.75rem .7rem; border-bottom:1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.02);
  }
  table.compat tr:nth-child(odd) td{background: rgba(255,255,255,.035)}
  table.compat .num{ text-align:center; font-variant-numeric: tabular-nums }
  table.compat .flag{ text-align:center }
  table.compat .label{ word-break: break-word }

  /* Tighten the Flag column (4%), gift space to the label */
  table.compat colgroup col.label{ width: 56% }
  table.compat colgroup col.pa{ width: 12% }
  table.compat colgroup col.match{ width: 16% }
  table.compat colgroup col.flag{ width: 4% }
  table.compat colgroup col.pb{ width: 12% }

  /* Remove accidental duplicate header row if an upstream script injects again */
  table.compat thead tr + tr{ display:none !important }

  /* Download button (optional) */
  .bar{display:flex;justify-content:center;margin:1rem 0}
  .btn{
    background:linear-gradient(0deg, rgba(var(--tk-cyan-rgb),.18), rgba(var(--tk-cyan-rgb),.28));
    color:#001a1c; font: 700 15px system-ui; border:1px solid rgba(var(--tk-cyan-rgb),.55);
    border-radius: 12px; padding:.6rem 1rem; cursor:pointer
  }
  .btn:active{ transform: translateY(1px) }
  </style>
</head>
<body>
<div class="page" id="tk-root">
  <h1 class="hx h1">TalkKink Compatibility</h1>
  <div class="sub" id="tk-ts">Generated: —</div>
  <div class="rule"></div>
  <h2 class="hx h2">Behavioral Play</h2>

  <!-- Your compatibility table; the colgroup keeps widths in sync with PDF -->
  <table class="compat" id="compatTable">
    <colgroup>
      <col class="label"><col class="pa"><col class="match"><col class="flag"><col class="pb">
    </colgroup>
    <thead>
      <tr>
        <th>Item</th><th>Partner A</th><th>Match</th><th>Flag</th><th>Partner B</th>
      </tr>
    </thead>
    <tbody id="compatBody"><!-- rows injected by your app; leave empty in template --></tbody>
  </table>

  <div class="bar">
    <button class="btn" id="downloadPdfBtn">Download PDF</button>
  </div>
</div>

<script>
;(() => {
  // --------- ONE-TIME GUARD (prevents double binding / double render)
  if (window.__TKPDF_BOUND__) return; window.__TKPDF_BOUND__ = true;

  // --------- Centered timestamp
  const ts = new Date().toLocaleString();
  const tsEl = document.getElementById('tk-ts');
  if (tsEl) tsEl.textContent = `Generated: ${ts}`;

  // --------- jsPDF loader (UMD) + autotable
  async function loadJsPDF(){
    if (window.jspdf?.jsPDF && window.jspdf?.autoTable) return window.jspdf.jsPDF;
    const add = (src) => new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = src; s.crossOrigin = 'anonymous'; s.referrerPolicy='no-referrer';
      s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
    });
    // core then plugin
    if (!window.jspdf?.jsPDF)
      await add('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
    if (!window.jspdf?.autoTable)
      await add('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js');
    return window.jspdf.jsPDF;
  }

  // --------- Outline/glow text helper for the PDF titles
  function glowText(doc, txt, x, y, opts={}){
    const { glowRGB=[20,227,233], ink=[0,0,0], r=0.55 } = opts;
    doc.setTextColor(...ink);
    const offs = [[-r,0],[r,0],[0,-r],[0,r],[-r,-r],[r,-r],[-r,r],[r,r]];
    offs.forEach(([dx,dy]) => doc.text(txt, x+dx, y+dy, {align:'center'}));
    doc.setTextColor(...glowRGB);
    doc.text(txt, x, y, {align:'center'});
  }

  // --------- Build the PDF (single pass; no duplicate headers)
  async function downloadPdf(){
    const jsPDF = await loadJsPDF();
    const doc = new jsPDF({unit:'pt', format:'letter'}); // 612 x 792
    const W = doc.internal.pageSize.getWidth();
    const M = { top: 64, right: 40, bottom: 56, left: 40 };
    const CYAN = [20,227,233];

    // dark background (optional)
    doc.setFillColor(10,10,12); doc.rect(0,0,W,doc.internal.pageSize.getHeight(),'F');

    // Title + timestamp (outlined / centered)
    doc.setFont('helvetica','bold'); doc.setFontSize(34);
    glowText(doc, 'TalkKink Compatibility', W/2, M.top, { glowRGB: CYAN, r:.8 });
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.setTextColor(183,255,255);
    doc.text(`Generated: ${new Date().toLocaleString()}`, W/2, M.top+18, {align:'center'});

    // Section header
    doc.setFont('helvetica','bold'); doc.setFontSize(26);
    glowText(doc, 'Behavioral Play', W/2, M.top+56, { glowRGB: CYAN, r:.7 });

    // Table data: pull from the live DOM to ensure it matches what you see.
    const rows = [];
    document.querySelectorAll('#compatTable tbody tr').forEach(tr=>{
      const cells = [...tr.children].map(td=>td.textContent.trim());
      if (cells.length) rows.push(cells);
    });

    const head = [['Item','Partner A','Match','Flag','Partner B']];

    // Column widths in % (tight flag, more label) – matches CSS colgroup
    const COLW = [0.56, 0.12, 0.16, 0.04, 0.12]; // sums to 1.0
    const tableWidth = W - (M.left + M.right);

    doc.autoTable({
      head, body: rows,
      startY: M.top + 76,
      theme:'grid',
      styles:{
        font:'helvetica', fontSize:11, textColor:[247,247,247],
        fillColor:[12,12,13], lineColor:[60,66,72], lineWidth:.4,
        cellPadding: 6
      },
      headStyles:{
        fillColor:[15,18,20], textColor: CYAN, fontStyle:'bold', lineColor:[60,66,72]
      },
      alternateRowStyles:{ fillColor:[20,22,25] },
      willDrawCell: data => {
        // prevent duplicate header injection – nothing to do here for UMD,
        // but we keep hook in case future plugins try to re-add rows.
      },
      columnStyles: {
        0:{ cellWidth: tableWidth * COLW[0], halign:'left'  },
        1:{ cellWidth: tableWidth * COLW[1], halign:'center'},
        2:{ cellWidth: tableWidth * COLW[2], halign:'center'},
        3:{ cellWidth: tableWidth * COLW[3], halign:'center'},
        4:{ cellWidth: tableWidth * COLW[4], halign:'center'},
      },
      didDrawPage: (data)=>{
        // page footer (optional)
        const p = `${doc.internal.getNumberOfPages()}`;
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.setTextColor(160,200,200);
        doc.text(`Page ${p}`, W - M.right, doc.internal.pageSize.getHeight() - 26, {align:'right'});
      }
    });

    doc.save('talkkink-compatibility-results.pdf');
  }

  // --------- Bind button ONCE (prevents double export)
  const btn = document.getElementById('downloadPdfBtn');
  if (btn && !btn.__bound){
    btn.addEventListener('click', downloadPdf, { once:false, passive:true });
    btn.__bound = true;
  }

  // --------- DOM safety: if upstream helper tries to add a duplicate header row, remove it.
  (function dedupeHeaders(){
    const thead = document.querySelector('#compatTable thead');
    if (!thead) return;
    const rows = thead.querySelectorAll('tr');
    if (rows.length > 1){
      for (let i=1;i<rows.length;i++) rows[i].remove();
    }
  })();

  // --------- Optional: tighten flag icons on the live page (if you use ▶ etc.)
  document.querySelectorAll('#compatTable td.flag').forEach(td=>{
    td.style.letterSpacing = '0';
  });

  // Expose a minimal API if you want to trigger programmatically
  window.TKPDF = { download: downloadPdf };
})();
</script>
</body>
</html>
