<!-- Talk Kink survey: floating dock card (inline styles, localStorage persistence) -->
<script>
(() => {
  const Z = 2147483647;                    // keep it on top of everything
  const KEY = '__TK_SELECTED_CATEGORIES';  // localStorage key
  const FEED_KEY = '__TK_KINK_DATA';       // where your feed lands

  /* ---------- CSS: force size/visibility no matter what ---------- */
  if (!document.getElementById('tkDockCSS')) {
    const css = document.createElement('style');
    css.id = 'tkDockCSS';
    css.textContent = `
      #tkDockCard{position:fixed!important;left:16px!important;top:96px!important;width:360px!important;
        height:70vh!important;display:block!important;visibility:visible!important;opacity:1!important;
        z-index:${Z}!important;pointer-events:auto!important;background:transparent!important;border:0!important}
      #tkDockCard .tk-card{background:#06181b;color:#fff;border:3px solid #00e5ff;border-radius:14px;
        padding:14px;box-shadow:0 10px 32px rgba(0,0,0,.55);width:100%;height:100%;overflow:auto;
        font:400 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      #tkDockCard .tk-row{display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px solid #2a2a2a;
        border-radius:12px;background:#0b0b0b;color:#e8f8fa}
      #tkDockCard .tk-btn{cursor:pointer;border:1px solid #2a2a2a;background:#0a0a0a;color:#fff;border-radius:10px;
        padding:8px 12px}
      #tkDockCard .tk-primary{cursor:pointer;background:#00e5ff;color:#001519;border:0;border-radius:12px;
        padding:10px 14px;font:700 16px/1.2 system-ui}
      #tkDockCard .tk-primary[disabled]{opacity:.6;cursor:not-allowed}
    `;
    document.head.appendChild(css);
  }

  /* ---------- Dock skeleton (immediate) ---------- */
  let card = document.getElementById('tkDockCard');
  if (!card) {
    card = document.createElement('div');
    card.id = 'tkDockCard';
    card.innerHTML = `
      <div class="tk-card" role="dialog" aria-label="Category selection" aria-modal="true">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h2 style="margin:0;font:700 22px/1.2 system-ui">Select categories</h2>
          <button id="tkClose" class="tk-btn">Close ✕</button>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin:6px 0 14px">
          <button id="tkAll"  class="tk-btn">Select All</button>
          <button id="tkNone" class="tk-btn">Deselect All</button>
          <span id="tkBadge" style="opacity:.75">Loading…</span>
        </div>
        <div id="tkList" style="display:grid;gap:10px">
          <div class="tk-row" style="opacity:.8">Loading categories…</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:12px">
          <button id="tkGo" class="tk-primary" disabled>Start Survey</button>
        </div>
      </div>`;
    (document.body || document.documentElement).appendChild(card);
  }

  const els = {
    list:   card.querySelector('#tkList'),
    badge:  card.querySelector('#tkBadge'),
    btnAll: card.querySelector('#tkAll'),
    btnNo:  card.querySelector('#tkNone'),
    btnGo:  card.querySelector('#tkGo'),
    btnX:   card.querySelector('#tkClose'),
  };

  els.btnX.onclick = () => { card.style.display = 'none'; };

  const getSel = () => [...els.list.querySelectorAll('input:checked')].map(n => n.value);
  const update = () => {
    const t = els.list.querySelectorAll('input[type="checkbox"]').length;
    const s = els.list.querySelectorAll('input:checked').length;
    els.badge.textContent = t ? `${s} selected / ${t} total` : `${s} selected`;
    els.btnGo.disabled = (s === 0);
    try { localStorage.setItem(KEY, JSON.stringify(getSel())); } catch {}
  };

  els.btnAll.onclick = () => { els.list.querySelectorAll('input[type="checkbox"]').forEach(n => n.checked = true); update(); };
  els.btnNo.onclick  = () => { els.list.querySelectorAll('input[type="checkbox"]').forEach(n => n.checked = false); update(); };

  els.btnGo.onclick = () => {
    const ids = getSel();
    try { localStorage.setItem(KEY, JSON.stringify(ids)); } catch {}
    document.dispatchEvent(new CustomEvent('tk:start-survey', { detail: { includeCategories: ids } }));
    setTimeout(() => {
      if (!window.__TK_SURVEY_STARTED) {
        const u = new URL('/kinksurvey/', location.origin);
        u.searchParams.set('run','1'); if (ids.length) u.searchParams.set('cats', ids.join(','));
        location.assign(u.toString());
      }
    }, 120);
  };

  /* ---------- Hydration when data is ready ---------- */
  const normalize = (raw) => (raw || [])
    .map(x => ({ id: String(x.id ?? x.slug ?? x.name ?? ''), name: String(x.name ?? x.title ?? x.id ?? '') }))
    .filter(x => x.id && x.name);

  function hydrate() {
    const raw = window[FEED_KEY];
    const cats = Array.isArray(raw) ? normalize(raw) : [];
    if (!cats.length) return false;

    let saved = [];
    try { saved = JSON.parse(localStorage.getItem(KEY) || '[]'); } catch {}
    const selected = new Set(saved.map(String));

    els.list.innerHTML = '';
    for (const { id, name } of cats) {
      const row = document.createElement('label');
      row.className = 'tk-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = id;
      cb.style.cssText = 'width:18px;height:18px';
      cb.checked = selected.has(id);
      const span = document.createElement('span');
      span.textContent = name;
      row.append(cb, span);
      els.list.append(row);
    }
    els.list.addEventListener('change', update);
    update();
    return true;
  }

  // 1) If already ready, hydrate now
  if (!hydrate()) {
    // 2) Hook a setter to catch future assignment
    try {
      let _val = window[FEED_KEY];
      Object.defineProperty(window, FEED_KEY, {
        configurable: true,
        get(){ return _val; },
        set(v){ _val = v; setTimeout(hydrate, 0); }
      });
    } catch {} // if it’s non-configurable, that’s fine—use polling.

    // 3) Poll as a safety net (up to ~10s)
    let tries = 0;
    const iv = setInterval(() => {
      if (hydrate() || ++tries > 40) clearInterval(iv);
    }, 250);

    // 4) Optional: listen for a custom signal your code can emit when feed lands
    document.addEventListener('tk:kink-data-ready', hydrate);
  }

  // Debug note:
  // console.log('[TK] dock @', card.getBoundingClientRect(), 'z=', getComputedStyle(card).zIndex);
})();
</script>
