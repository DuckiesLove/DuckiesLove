<!-- Talk Kink survey: floating dock card (inline styles, localStorage persistence) -->
<script>
(() => {
  const MAX_Z = 2147483647;
  const LS_KEY = '__TK_SELECTED_CATEGORIES';
  const FEED_URL = '';

  function ensureCSS() {
    if (document.getElementById('tkDockCSS')) return;
    const style = document.createElement('style');
    style.id = 'tkDockCSS';
    style.textContent = `
      html, body {
        content-visibility: visible !important;
        contain: initial !important;
        transform: none !important;
        filter: none !important;
        clip: auto !important;
        clip-path: none !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      #tkDockCard {
        all: initial;
        position: fixed !important;
        left: 16px !important;
        top: 96px !important;
        width: 360px !important;
        height: 70vh !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: ${MAX_Z} !important;
        background: transparent !important;
        border: 0 !important;
        transform: none !important;
        pointer-events: auto !important;
      }
    `;
    (document.head || document.documentElement).appendChild(style);
  }

  function ensureCardHost() {
    let card = document.getElementById('tkDockCard');
    if (!card) {
      card = document.createElement('div');
      card.id = 'tkDockCard';
      card.innerHTML = `
        <div role="dialog" aria-label="Category selection" aria-modal="true"
             style="background:#06181b;color:#fff;border:3px solid #00e5ff;border-radius:14px;
                    padding:14px;box-shadow:0 10px 32px rgba(0,0,0,.55);width:100%;height:100%;overflow:auto;
                    font:400 14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h2 style="margin:0;font:700 22px/1.2 system-ui">Select categories</h2>
            <button id="tkClose" class="themed-button"
                    style="cursor:pointer;border:1px solid #2a2a2a;background:#0a0a0a;color:#fff;border-radius:10px;padding:8px 12px">
                    Close âœ•</button>
          </div>
          <div style="display:flex;gap:12px;align-items:center;margin:6px 0 14px">
            <button id="tkAll"  class="themed-button"
                    style="cursor:pointer;border:1px solid #2a2a2a;background:#0a0a0a;color:#fff;border-radius:10px;padding:8px 12px">Select All</button>
            <button id="tkNone" class="themed-button"
                    style="cursor:pointer;border:1px solid #2a2a2a;background:#0a0a0a;color:#fff;border-radius:10px;padding:8px 12px">Deselect All</button>
            <span id="tkBadge" style="opacity:.75">0 selected</span>
          </div>
          <div id="tkList" style="display:grid;gap:10px"></div>
          <div style="margin-top:12px;display:flex;gap:12px">
            <button id="tkGo"
              style="cursor:pointer;background:#00e5ff;color:#001519;border:0;border-radius:12px;padding:10px 14px;
                     font:700 16px/1.2 system-ui">Start Survey</button>
          </div>
        </div>
      `;
      (document.body || document.documentElement).appendChild(card);
    }
    return card;
  }

  function normalize(raw) {
    if (!raw) return [];
    const arr = Array.isArray(raw) ? raw : raw.categories || raw.items || raw.data || [];
    return arr
      .map((entry) => {
        const id = String(entry?.id ?? entry?.slug ?? entry?.code ?? entry?.value ?? '').trim();
        const name = String(entry?.name ?? entry?.title ?? entry?.label ?? entry?.text ?? id).trim();
        return id && name ? { id, name } : null;
      })
      .filter(Boolean);
  }

  async function fetchFromFeed() {
    if (!FEED_URL) return [];
    try {
      const res = await fetch(FEED_URL, { credentials: 'omit', cache: 'no-store' });
      if (!res.ok) return [];
      return normalize(await res.json());
    } catch (err) {
      console.warn('[TK] feed fetch failed', err);
      return [];
    }
  }

  async function getCategories() {
    if (Array.isArray(window.__TK_KINK_DATA)) {
      return normalize(window.__TK_KINK_DATA);
    }
    if (window.__TK_DATA?.items) {
      const cats = normalize(window.__TK_DATA.items);
      if (cats.length) return cats;
    }
    await new Promise((resolve) => {
      let elapsed = 0;
      const timer = setInterval(() => {
        elapsed += 100;
        if (Array.isArray(window.__TK_KINK_DATA) || window.__TK_DATA?.items || elapsed >= 2000) {
          clearInterval(timer);
          resolve(elapsed);
        }
      }, 100);
    });
    if (Array.isArray(window.__TK_KINK_DATA)) {
      return normalize(window.__TK_KINK_DATA);
    }
    if (window.__TK_DATA?.items) {
      return normalize(window.__TK_DATA.items);
    }
    return fetchFromFeed();
  }

  function readSaved() {
    try {
      const raw = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      return Array.isArray(raw) ? raw.map((id) => String(id)) : [];
    } catch {
      return [];
    }
  }

  function saveSelected(ids) {
    try {
      const unique = Array.from(new Set(ids.map((id) => String(id))));
      localStorage.setItem(LS_KEY, JSON.stringify(unique));
    } catch (err) {
      console.warn('[TK] save localStorage failed', err);
    }
  }

  async function init() {
    ensureCSS();
    const card = ensureCardHost();
    const list = card.querySelector('#tkList');
    const badge = card.querySelector('#tkBadge');
    const btnAll = card.querySelector('#tkAll');
    const btnNone = card.querySelector('#tkNone');
    const btnGo = card.querySelector('#tkGo');
    const btnClose = card.querySelector('#tkClose');

    if (!list || !badge || !btnAll || !btnNone || !btnGo) {
      console.warn('[TK] dock controls missing');
      return;
    }

    const render = (cats) => {
      list.innerHTML = '';
      const saved = new Set(readSaved());
      cats.forEach(({ id, name }) => {
        const label = document.createElement('label');
        label.style.cssText = 'display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px solid #2a2a2a;border-radius:12px;background:#0b0b0b;color:#e8f8fa';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = id;
        checkbox.checked = saved.has(id);
        checkbox.style.cssText = 'width:18px;height:18px';
        checkbox.addEventListener('change', () => {
          const ids = Array.from(list.querySelectorAll('input:checked')).map((input) => input.value);
          saveSelected(ids);
          update();
        });
        const span = document.createElement('span');
        span.textContent = name;
        label.append(checkbox, span);
        list.append(label);
      });
      update();
    };

    const update = () => {
      const total = list.querySelectorAll('input[type="checkbox"]').length;
      const checked = list.querySelectorAll('input[type="checkbox"]:checked').length;
      badge.textContent = total ? `${checked} selected / ${total} total` : '0 selected';
      btnGo.disabled = checked === 0;
      btnGo.style.opacity = btnGo.disabled ? 0.6 : 1;
    };

    btnAll.addEventListener('click', () => {
      list.querySelectorAll('input[type="checkbox"]').forEach((input) => { input.checked = true; });
      const ids = Array.from(list.querySelectorAll('input:checked')).map((input) => input.value);
      saveSelected(ids);
      update();
    });

    btnNone.addEventListener('click', () => {
      list.querySelectorAll('input[type="checkbox"]').forEach((input) => { input.checked = false; });
      saveSelected([]);
      update();
    });

    btnGo.addEventListener('click', () => {
      const ids = Array.from(list.querySelectorAll('input:checked')).map((input) => input.value);
      saveSelected(ids);
      document.dispatchEvent(new CustomEvent('tk:start-survey', { detail: { includeCategories: ids } }));
      setTimeout(() => {
        if (!window.__TK_SURVEY_STARTED) {
          const url = new URL('/kinksurvey/', location.origin);
          url.searchParams.set('run', '1');
          if (ids.length) url.searchParams.set('cats', ids.join(','));
          location.assign(url.toString());
        }
      }, 120);
    });

    if (btnClose) {
      btnClose.addEventListener('click', () => {
        card.style.display = 'none';
      });
    }

    const cats = await getCategories();
    if (cats.length) {
      render(cats);
    } else {
      list.innerHTML = `<div style="opacity:.8;padding:10px 12px;border:1px solid #2a2a2a;border-radius:12px;background:#0b0b0b">No categories found yet. The panel will populate once the feed is ready.</div>`;
      badge.textContent = '0 selected / 0 total';
    }
  }

  init();
  document.addEventListener('tk:kinkdata-ready', init, { once: true });
})();
</script>
