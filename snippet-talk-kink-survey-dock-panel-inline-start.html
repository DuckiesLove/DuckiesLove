<!-- TK layout fix: restore left rail + main content dock -->
<style id="tk-layout-fix">
  :root{
    --tk-dock-gap:24px;
    --tk-left-width:380px;
    --tk-header-offset:96px; /* adjust if your header is taller/shorter */
    --tk-page-pad:24px;
    --tk-maxw:1400px;
  }
  html, body { height:100%; overflow-x:hidden; }

  /* Dock container that holds the left rail and the main app */
  .tkDock{
    box-sizing:border-box;
    display:grid;
    grid-template-columns: var(--tk-left-width) 1fr;
    gap: var(--tk-dock-gap);
    align-items:start;
    max-width: var(--tk-maxw);
    margin: 0 auto;
    padding: 0 var(--tk-page-pad) 64px;
    width:100%;
  }

  /* Left rail: full height, its own scrolling area */
  #categoryPanel{
    grid-column:1;
    width:auto;
    max-width:none!important;
    min-width:320px;
    position:sticky;
    top: var(--tk-header-offset);
    height: calc(100vh - var(--tk-header-offset) - var(--tk-dock-gap));
    overflow:auto;
    /* isolate to avoid cascading reflows */
    contain: layout paint style;
  }

  /* Right side: main app */
  #surveyApp{
    grid-column:2;
    align-self:start;
    min-height:50vh;
    contain: layout paint style;
  }

  /* Hard overrides to kill “drawer/overlay” sizing/position that caused the center mini panel */
  #categoryPanel.drawer,
  #categoryPanel.panel,
  #categoryPanel.tk-overlay,
  #categoryPanel.portal{
    position:sticky !important;
    left:auto !important;
    right:auto !important;
    top: var(--tk-header-offset) !important;
    transform:none !important;
    width:auto !important;
    max-width:none !important;
    box-shadow:none !important;
  }

  /* Responsive: stack on small screens */
  @media (max-width: 1100px){
    .tkDock{ grid-template-columns: 1fr; }
    #categoryPanel{ position:static; height:auto; }
    #surveyApp{ grid-column:1; }
  }
</style>

<script>
(() => {
  // Build/repair the dock and move the nodes into place
  function ensureDock() {
    const aside = document.getElementById('categoryPanel');
    const main  = document.getElementById('surveyApp') || document.querySelector('main');
    if (!aside || !main) return;

    // Remove classes that make it act like an overlay/drawer
    aside.classList.remove('drawer','panel','shadow-bottom','tk-overlay','portal');

    // Create the dock if it doesn't exist
    let dock = document.querySelector('.tkDock');
    if (!dock) {
      dock = document.createElement('section');
      dock.className = 'tkDock';
      // Place dock after header for predictable sticky offset
      const header = document.getElementById('tkHeader') || document.querySelector('header');
      if (header && header.parentNode) {
        header.parentNode.insertBefore(dock, header.nextSibling);
      } else {
        document.body.prepend(dock);
      }
    }

    // Move left rail and main app into the dock (order matters)
    if (aside.parentElement !== dock) dock.appendChild(aside);
    if (main.parentElement  !== dock) dock.appendChild(main);
  }

  // Run now and also once dynamic content settles
  const start = () => { try{ ensureDock(); }catch(e){ console.error('[TK layout fix]', e); } };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, {once:true});
  } else {
    start();
  }
  // In case your app lazy-mounts the nodes later, retry a few times
  let tries = 0, t = setInterval(() => {
    if (++tries > 20) return clearInterval(t);
    const ok = document.querySelector('.tkDock #categoryPanel') && document.querySelector('.tkDock #surveyApp');
    if (!ok) start(); else clearInterval(t);
  }, 150);
})();
</script>
