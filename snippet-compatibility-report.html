<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Compatibility Report Export</title>
</head>
<body>
<!-- (Optional) Example button & table skeleton (keep your own if you already have them)
<button id="downloadPdfBtn">Download Compatibility Report</button>
<table id="compatibilityTable">
  <thead>
    <tr>
      <th>Category</th><th>Partner A</th><th>Match</th><th>Flag</th><th>Partner B</th>
    </tr>
  </thead>
  <tbody><!-- your rows here --></tbody>
</table>
-->

<!--
TALK KINK • COMPATIBILITY REPORT — ONE-BOX FIX (copy/paste)

What this does
• Binds to your EXISTING “Download PDF” button: #downloadBtn or #downloadPdfBtn or [data-download-pdf]
• Builds the PDF from your on-page table OR (fallback) from window.partnerAData / window.partnerBData
• RECOMPUTES “Match %” and “Flag” (★ ≥ 90, ⚑ ≥ 60, 🚩 ≤ 30); only A/B are numeric
• Stops the “duplicated Category text” problem by smart-deduping repeated phrases
• Gives you exactly 5 columns in the PDF: Category | Partner A | Match | Flag | Partner B
• Auto-loads jsPDF + AutoTable if not already on the page

How to use
1) Make sure your table header includes (case-insensitive): “Category”, “Partner A”, “Partner B”.
   (It’s OK if “Match/Flag” are not rendered; this script recomputes them.)
   Recommended id: <table id="compatibilityTable">…</table>
2) Your download button must exist as ONE of:
   <button id="downloadBtn">Download PDF</button>
   <button id="downloadPdfBtn">Download PDF</button>
   <button data-download-pdf>Download PDF</button>
3) Paste THIS WHOLE <script> block at the very end of the HTML (after the table renders). Click the button.

Tip
If your table rows use <td data-cell="A">…</td> and <td data-cell="B">…</td>, this script will prefer them.
-->

<script>
(function () {
  /* ---------- Lazy-load libs ---------- */
  function loadScript(src){return new Promise((res,rej)=>{if(document.querySelector(`script[src="${src}"]`))return res();const s=document.createElement("script");s.src=src;s.onload=res;s.onerror=()=>rej(new Error("Failed to load "+src));document.head.appendChild(s);});}
  async function ensureLibs(){
    if(!(window.jspdf && window.jspdf.jsPDF)){
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
    const hasAuto=(window.jspdf&&window.jspdf.autoTable)||(window.jsPDF&&window.jsPDF.API&&window.jsPDF.API.autoTable);
    if(!hasAuto){
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }
  function runAutoTable(doc, opts){
    if(typeof doc.autoTable==="function") return doc.autoTable(opts);
    if(window.jspdf && typeof window.jspdf.autoTable==="function") return window.jspdf.autoTable(doc, opts);
    throw new Error("jsPDF-AutoTable not available");
  }

  /* ---------- Utils ---------- */
  const THRESH={star:90, flag:60, low:30};
  const ICON={star:"★", flag:"⚑", low:"🚩", blank:""};
  const tidy=s=>(s||"").replace(/\s+/g," ").trim();
  const toNum=v=>{const n=Number(String(v??"").trim());return Number.isFinite(n)?n:null;};
  const matchPct=(a,b)=>{const A=toNum(a),B=toNum(b); if(A==null||B==null)return null; return Math.round(100-(Math.abs(A-B)/5)*100);};
  const flagFor=p=>p==null?ICON.blank:(p>=THRESH.star?ICON.star:(p>=THRESH.flag?ICON.flag:(p<=THRESH.low?ICON.low:ICON.blank)));

  // Smart deduper for doubled category cells like “foo…foo…”
  function dedupeSmart(s){
    const t=tidy(s);
    if(!t) return t;
    // 1) perfect repeats: "ABAB" or "ABCABC"
    const m=t.match(/^(.+?)\1+$/); if(m) return m[1];
    // 2) locate second occurrence of the opening seed
    const seedLen=Math.min(48, Math.max(8, Math.floor(t.length/4)));
    const seed=t.slice(0,seedLen);
    const p=t.indexOf(seed, seedLen);
    if(p>0){ return tidy(t.slice(0,p)); }
    return t;
  }

  /* ---------- Table discovery & extraction ---------- */
  function getTable(){
    return document.getElementById("compatibilityTable")
        || document.querySelector('table[aria-label*="compatibility" i]')
        || document.querySelector("table");
  }
  function headerIndex(table){
    let ths=[...table.querySelectorAll("thead th")];
    if(!ths.length) ths=[...table.querySelectorAll("tr th")];
    const labs=ths.map(th=>tidy(th.textContent).toLowerCase());
    const idx={cat:0, A:1, B:4}; // defaults if not found
    const find=k=>labs.findIndex(x=>x.includes(k));
    const c=find("category"); if(c>-1) idx.cat=c;
    const a=find("partner a"); if(a>-1) idx.A=a;
    const b=find("partner b"); if(b>-1) idx.B=b;
    return idx;
  }

  function rowsFromTable(){
    const table=getTable(); if(!table) return [];
    const idx=headerIndex(table);

    let trs=[...table.querySelectorAll("tbody tr")];
    if(!trs.length) trs=[...table.querySelectorAll("tr")].filter(tr=>tr.closest("table")===table && tr.querySelectorAll("td").length);

    const out=[];
    for(const tr of trs){
      const tds=[...tr.querySelectorAll("td")]; if(!tds.length) continue;

      const catCell = tds[idx.cat] || tds[0];
      const aCell   = tr.querySelector('td[data-cell="A"]') || tds[idx.A] || tds[1];
      const bCell   = tr.querySelector('td[data-cell="B"]') || tds[idx.B] || tds[tds.length-1];

      // Clean & compute
      const category = dedupeSmart(catCell?.textContent || tr.getAttribute("data-kink-id") || "");
      const A = toNum(aCell?.textContent);
      const B = toNum(bCell?.textContent);
      const P = matchPct(A,B);

      out.push([ category || "—", (A==null?"—":A), (P==null?"—":`${P}%`), flagFor(P), (B==null?"—":B) ]);
    }
    return out;
  }

  /* ---------- Memory fallback ---------- */
  function rowsFromMemory(){
    const A=(window.partnerAData?.items)||(Array.isArray(window.partnerAData)?window.partnerAData:null);
    const B=(window.partnerBData?.items)||(Array.isArray(window.partnerBData)?window.partnerBData:null);
    if(!A && !B) return [];
    const mA=new Map((A||[]).map(i=>[(i.id||i.label),i]));
    const mB=new Map((B||[]).map(i=>[(i.id||i.label),i]));
    const keys=new Map(); (A||[]).forEach(i=>keys.set(i.id||i.label,i.label||i.id)); (B||[]).forEach(i=>keys.set(i.id||i.label,i.label||i.id));
    const out=[];
    for(const [id,label] of keys){
      const a=mA.get(id), b=mB.get(id);
      const Ar=toNum(a?.score), Br=toNum(b?.score), P=matchPct(Ar,Br);
      out.push([ label||id||"—", (Ar??"—"), (P==null?"—":`${P}%`), flagFor(P), (Br??"—") ]);
    }
    return out;
  }

  /* ---------- Export ---------- */
  async function exportPDF(ev){
    ev?.preventDefault?.();
    try{
      await ensureLibs();
      const { jsPDF }=window.jspdf;

      let rows=rowsFromTable();
      if(!rows.length) rows=rowsFromMemory();
      if(!rows.length){ alert("No data rows found to export. Make sure the table is visible or partnerA/B data is loaded."); return; }

      const doc=new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      doc.setFontSize(20);
      doc.text("Talk Kink • Compatibility Report", doc.internal.pageSize.width/2, 48, {align:"center"});

      runAutoTable(doc, {
        head: [["Category","Partner A","Match","Flag","Partner B"]],
        body: rows,
        startY: 70,
        styles: { fontSize: 11, cellPadding: 6, overflow:"linebreak" },
        headStyles: { fillColor:[0,0,0], textColor:[255,255,255], fontStyle:"bold" },
        // Nice fixed widths so A/Match/Flag/B stay narrow and Category gets room
        columnStyles: {
          0:{ halign:"left",   cellWidth: 560 },
          1:{ halign:"center", cellWidth: 85  },
          2:{ halign:"center", cellWidth: 95  },
          3:{ halign:"center", cellWidth: 70  },
          4:{ halign:"center", cellWidth: 85  }
        }
      });

      doc.save("compatibility-report.pdf");
    }catch(err){
      console.error("[PDF] Export failed:", err);
      alert("PDF export failed: "+err.message);
    }
  }

  /* ---------- Bind to existing button ---------- */
  function bind(){
    const btn=document.querySelector("#downloadBtn")||document.querySelector("#downloadPdfBtn")||document.querySelector("[data-download-pdf]");
    if(btn){
      btn.removeEventListener("click", exportPDF);
      btn.addEventListener("click", exportPDF);
      console.log("[PDF] Bound to:", btn);
    }else{
      console.warn("[PDF] Download button not found (use #downloadBtn / #downloadPdfBtn / [data-download-pdf]).");
    }
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", bind); else bind();
  new MutationObserver(bind).observe(document.documentElement,{childList:true,subtree:true});
})();
</script>

<!-- ✅ 1) Add this *once* near the end of every page that was freezing (before </body>) -->
<script>
/* ---------- TalkKink Safe Bootstrap (drop-in) ---------- */
(function () {
  const LOG = (...a) => console.log("[TK-SAFE]", ...a);

  /* A. QUICK SANITY CHECKS — find & warn about merge markers (these often lock pages) */
  try {
    const html = document.documentElement.innerHTML;
    const MERGE_MARKERS = [
      "<".repeat(7),
      "=".repeat(7),
      ">".repeat(7),
    ];
    if (MERGE_MARKERS.some((marker) => html.includes(marker))) {
      console.warn("[TK-SAFE] Merge conflict markers detected in DOM. Remove them to avoid broken JS/CSS.");
    }
  } catch (_) {}

  /* B. ONE-TIME INIT GUARD (prevents duplicate event bind/render loops) */
  if (window.__TK_INITED__) {
    LOG("Init skipped: already initialized.");
    return;
  }
  window.__TK_INITED__ = true;

  /* C. SAFE-MODE FLAGS (use ?safe=1 or ?nopdf=1 or ?noscore=1 to bypass heavy work) */
  const params = new URLSearchParams(location.search);
  const SAFE_MODE  = params.has("safe");
  const NO_PDF     = SAFE_MODE || params.has("nopdf");
  const NO_SCORE   = SAFE_MODE || params.has("noscore");

  if (SAFE_MODE) LOG("SAFE MODE ON: skipping scoring/render and lazy-loading libraries.");

  /* D. SMALL UTILITIES */
  const byId = (id) => document.getElementById(id);
  function once(el, type, handler, opts) {
    // prevent stacked duplicate listeners after HMR/partials
    el && el.addEventListener(type, function f(e) {
      el.removeEventListener(type, f, opts);
      handler(e);
    }, opts);
  }
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src; s.async = true; s.defer = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  function idle(fn) {
    // yield back to the browser to keep UI responsive
    return (window.requestIdleCallback || ((cb)=>setTimeout(cb,0)))(fn);
  }

  /* E. LAZY LOADERS FOR HEAVY LIBS (loaded only on click) */
  async function ensureJsPDF() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
  }
  async function ensureAutoTable() {
    // Only after jsPDF UMD maps window.jspdf.jsPDF
    await ensureJsPDF();
    const hasAT = (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable)
               || (window.jspdf && window.jspdf.autoTable);
    if (!hasAT) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* F. DEFENSIVE BINDINGS (buttons used across pages) */
  idle(() => {
    // PDF buttons (compatibility, IKA, etc.)
    const dl1 = byId("downloadBtn");
    const dl2 = byId("downloadPdfBtn");
    const anyDownload = dl1 || dl2;

    if (anyDownload) {
      const handler = async (e) => {
        e.preventDefault();
        if (NO_PDF) { alert("PDF disabled (safe mode). Add ?safe=0 or remove ?nopdf."); return; }
        try {
          // Lazy load heavy libs only now
          await ensureAutoTable();
          // Yield once more before heavy export:
          await new Promise(r => setTimeout(r, 0));
          // Call your existing exporter (must be defined elsewhere)
          if (typeof window.TKPDF_export === "function") {
            await window.TKPDF_export();
          } else if (typeof window.TKPDF_forceDark === "function") {
            await window.TKPDF_forceDark();
          } else if (typeof window.exportIKAPdf === "function") {
            await window.exportIKAPdf();
          } else {
            alert("Export function not found. Expected TKPDF_export/TKPDF_forceDark/exportIKAPdf.");
          }
        } catch (err) {
          console.error("[TK-SAFE] PDF export failed:", err);
          alert("PDF export failed: " + (err?.message || err));
        }
      };

      // Bind once to whichever exists
      if (dl1) once(dl1, "click", handler);
      if (dl2) once(dl2, "click", handler);
      LOG("Bound PDF button(s).");
    }

    // File upload styled label (IKA)
    const fileInput = byId("ikaFile");
    const fileLabel = document.querySelector('label[for="ikaFile"]');
    if (fileInput && fileLabel) {
      once(fileLabel, "click", () => fileInput.click());
      LOG("Bound Upload Survey label→input.");
    }
  });

  /* G. STOP RUNNING EXPENSIVE WORK ON LOAD (scoring/rendering) */
  // Wrap your page’s auto-render or scoring in this gate:
  window.TK_canRunHeavy = function () {
    if (SAFE_MODE) return false;
    // Avoid running more than once
    if (window.__TK_HEAVY_RAN__) return false;
    window.__TK_HEAVY_RAN__ = true;
    return true;
  };

  // Example usage for your pages (leave here; your code can call it):
  // if (window.TK_canRunHeavy()) {
  //   // run scoring/render here or schedule with idle(...)
  //   idle(() => window.renderResults && window.renderResults());
  // }

  /* H. GLOBAL CATCH FOR ACCIDENTAL LONG TASKS */
  // If something still locks the UI, advise safe mode.
  window.addEventListener("error", (e) => {
    console.warn("[TK-SAFE] Window error:", e.message);
  });
})();
</script>
<!-- ---------- End Safe Bootstrap ---------- -->
</body>
</html>
