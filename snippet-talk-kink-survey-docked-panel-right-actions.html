<!-- ===== TK CATEGORY PANEL (3/4) + RIGHT RAIL (1/4) =================== -->
<style>
  /* Layout: left panel (75%), right rail (25%) */
  #tkDockHost{position:relative;}
  #tkDockCard{
    position:absolute; inset:24px calc(25vw + 24px) 24px 24px;   /* left 3/4 */
    border:2px solid var(--teal,#00e5ff); border-radius:14px;
    padding:22px; background:#000; color:#fff;
    overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.45);
  }
  #tkRightRail{
    position:absolute; inset:24px 24px 24px calc(75vw + 24px);   /* right 1/4 */
    display:flex; flex-direction:column; gap:16px; align-items:stretch;
  }
  .tk-cta{
    display:block; text-align:center; padding:16px 18px; border-radius:16px;
    border:2px solid var(--teal,#00e5ff); font-weight:800; letter-spacing:.2px;
    background:#000; color:#fff; text-decoration:none;
    box-shadow:0 0 0 1px rgba(0,229,255,.08) inset;
    transition:transform .06s ease, box-shadow .12s ease, background .12s ease;
  }
  .tk-cta:hover{background:#041e22; transform:translateY(-1px);}

  /* Panel header row */
  .tk-head{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px;}
  .tk-head .group{display:flex; gap:12px; align-items:center;}

  /* Checklist grid (uniform buttons) */
  #categoryChecklist{
    display:grid; grid-template-columns:repeat(2, minmax(280px, 1fr)); gap:14px; align-items:stretch;
  }
  #categoryChecklist label{
    display:flex; align-items:center; gap:12px;
    padding:14px 16px; min-height:60px; cursor:pointer;
    border:2px solid var(--teal,#00e5ff); border-radius:16px;
    background:rgba(0,0,0,.45); box-shadow:0 0 0 1px rgba(0,229,255,.08) inset;
    transition:transform .06s ease, box-shadow .12s ease, background .12s ease;
  }
  #categoryChecklist label:hover{background:rgba(0,0,0,.65); box-shadow:0 0 0 2px rgba(0,229,255,.25) inset;}
  #categoryChecklist input[type="checkbox"]{width:20px; height:20px; accent-color:var(--teal,#00e5ff);}
  #categoryChecklist .tk-name{font-size:16.5px; font-weight:800; letter-spacing:.2px; line-height:1.2;}

  /* Buttons inside panel */
  .themed-button{border:2px solid var(--teal,#00e5ff); border-radius:14px; background:#000; color:#fff; padding:12px 16px; font-weight:800;}
  .tk-actions{display:flex; gap:12px; align-items:center; margin:14px 0 18px;}
  .tk-actions .spacer{flex:1 1 auto}

  /* Small screens: stack */
  @media (max-width: 980px){
    #tkDockCard{inset:16px 16px calc(35vh + 16px) 16px;}
    #tkRightRail{inset:auto 16px 16px 16px; height:32vh; position:fixed; bottom:0; backdrop-filter:blur(4px);}
    #categoryChecklist{grid-template-columns:1fr;}
  }
</style>

<div id="tkDockHost">
  <aside id="tkDockCard" role="dialog" aria-label="Category selection">
    <div class="tk-head">
      <div class="group">
        <button id="btnSelectAll" class="themed-button">Select All</button>
        <button id="btnDeselectAll" class="themed-button">Deselect All</button>
      </div>
      <div class="group"><strong id="selectedCountBadge" style="opacity:.8">0 selected / 0 total</strong></div>
    </div>
    <div class="tk-actions">
      <span class="spacer"></span>
      <button id="beginSurveyFromPanel" class="themed-button">Start Survey</button>
    </div>
    <div id="categoryChecklist" aria-live="polite"></div>
  </aside>
  <div id="tkRightRail" aria-label="Survey utilities">
    <a class="tk-cta" href="/compatibility.html">Compatibility Page</a>
    <a class="tk-cta" href="/analysis.html">Individual Kink Analysis</a>
  </div>
</div>



<script>
(() => {
  const FLAG = '__tkBuiltInPanelBooted';
  if (window[FLAG]) return;
  window[FLAG] = true;

  // ---- categories (alphabetical)
  const CATEGORIES = [
    { id: 'appearance-play',            name: 'Appearance Play' },
    { id: 'behavioral-play',            name: 'Behavioral Play' },
    { id: 'body-fluids-functions',      name: 'Body Fluids and Functions' },
    { id: 'body-modification',          name: 'Body Modification' },
    { id: 'body-part-fetish',           name: 'Body Part / Fetish Play' },
    { id: 'body-part-torture',          name: 'Body Part Torture' },
    { id: 'bondage-suspension',         name: 'Bondage and Suspension' },
    { id: 'breath-play',                name: 'Breath Play' },
    { id: 'breeding',                   name: 'Breeding' },
    { id: 'chastity-devices',           name: 'Chastity Devices' },
    { id: 'communication',              name: 'Communication' },
    { id: 'cosplay-identity',           name: 'Cosplay & Identity Play' },
    { id: 'gender-play-transformation', name: 'Gender Play & Transformation' },
    { id: 'headspace-regression',       name: 'Headspace & Regression' },
    { id: 'high-intensity-ssc-aware',   name: 'High-Intensity Kinks (SSC-Aware)' },
    { id: 'impact-play',                name: 'Impact Play' },
  ].sort((a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'base' }));

  const STORAGE_KEY = '__TK_SELECTED_CATEGORIES';
  const FALLBACK_RUN_PATH = '/kinksurvey/';

  const host = document.getElementById('categoryChecklist') || document.querySelector('#categoryChecklist');
  const badge = document.getElementById('selectedCountBadge') || document.querySelector('#selectedCountBadge');
  const btnSelAll = document.getElementById('btnSelectAll') || document.querySelector('#btnSelectAll');
  const btnDeselAll = document.getElementById('btnDeselectAll') || document.querySelector('#btnDeselectAll');
  const btnStart = document.getElementById('beginSurveyFromPanel') || document.querySelector('#beginSurveyFromPanel');

  if (!host) {
    console.warn('[TK] Built-in #categoryChecklist not found');
    return;
  }

  // ---- ensure panel is above everything (no extra overlay)
  const dock =
    document.getElementById('tkDockCard') ||
    host.closest('#tkDockCard') ||
    host.closest('[id^="tkDock"]') ||
    host;

  Object.assign(dock.style, {
    position: 'fixed',
    left: '0',
    top: '0',
    bottom: '0',
    width: '75vw',
    maxWidth: '1100px',
    zIndex: 2147483646,
    background: '#000',
    borderRight: '2px solid #00e0e0',
    overflow: 'hidden'
  });

  const scroller = host.parentElement || dock;
  scroller.style.overflow = 'auto';
  scroller.style.height = '100%';

  // kill any site “portal/overlay” that might sit on top
  document
    .querySelectorAll('.tk-portal-overlay, .tkPortalOverlay, [data-tk-overlay]')
    .forEach(el => (el.style.display = 'none'));

  // ---- host layout
  Object.assign(host.style, {
    display: 'grid',
    gridTemplateColumns: 'repeat(2, minmax(0, 1fr))',
    gap: '12px',
    padding: '16px 20px 24px',
    boxSizing: 'border-box'
  });

  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  function getCheckedIds() {
    return $$('input[type="checkbox"]:checked', host).map(n => n.value);
  }

  function updateBadge() {
    const total = $$('input[type="checkbox"]', host).length;
    const selected = $$('input[type="checkbox"]:checked', host).length;
    if (badge) badge.textContent = `${selected} selected / ${total} total`;
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(getCheckedIds()));
    } catch {}
  }

  function restore() {
    let saved = [];
    try {
      saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    } catch {}

    saved.forEach(v => {
      const esc = window.CSS && CSS.escape ? CSS.escape(String(v)) : String(v).replace(/"/g, '\\"');
      const cb = host.querySelector(`input[type="checkbox"][value="${esc}"]`);
      if (cb) cb.checked = true;
    });
    updateBadge();
  }

  // ---- render built-in list
  host.innerHTML = '';
  const frag = document.createDocumentFragment();

  CATEGORIES.forEach(({ id, name }) => {
    const row = document.createElement('label');
    row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:11px 14px;border:1px solid #2a2a2a;border-radius:12px;background:#0a0a0a;cursor:pointer;';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = id;
    cb.addEventListener('change', updateBadge);

    const span = document.createElement('span');
    span.textContent = name;

    row.append(cb, span);
    frag.append(row);
  });

  host.append(frag);
  updateBadge();
  restore();

  // ---- buttons
  btnSelAll?.addEventListener('click', () => {
    $$('input[type="checkbox"]', host).forEach(cb => (cb.checked = true));
    updateBadge();
  });

  btnDeselAll?.addEventListener('click', () => {
    $$('input[type="checkbox"]', host).forEach(cb => (cb.checked = false));
    updateBadge();
  });

  btnStart?.addEventListener('click', () => {
    const ids = getCheckedIds();
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
    } catch {}

    document.dispatchEvent(
      new CustomEvent('tk:start-survey', { detail: { includeCategories: ids } })
    );

    setTimeout(() => {
      if (!window.__TK_SURVEY_STARTED) {
        const url = new URL(FALLBACK_RUN_PATH, location.origin);
        url.searchParams.set('run', '1');
        if (ids.length) url.searchParams.set('cats', ids.join(','));
        location.assign(url.toString());
      }
    }, 120);
  });

  console.log('[TK] Built-in panel wired with', CATEGORIES.length, 'categories.');
})();
</script>

<!-- ==================================================================== -->
