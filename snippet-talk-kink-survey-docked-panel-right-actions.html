<!-- ===== TK CATEGORY PANEL (3/4) + RIGHT RAIL (1/4) =================== -->
<style>
  /* Layout: left panel (75%), right rail (25%) */
  #tkDockHost{position:relative;}
  #tkDockCard{
    position:absolute; inset:24px calc(25vw + 24px) 24px 24px;   /* left 3/4 */
    border:2px solid var(--teal,#00e5ff); border-radius:14px;
    padding:22px; background:#000; color:#fff;
    overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.45);
  }
  #tkRightRail{
    position:absolute; inset:24px 24px 24px calc(75vw + 24px);   /* right 1/4 */
    display:flex; flex-direction:column; gap:16px; align-items:stretch;
  }
  .tk-cta{
    display:block; text-align:center; padding:16px 18px; border-radius:16px;
    border:2px solid var(--teal,#00e5ff); font-weight:800; letter-spacing:.2px;
    background:#000; color:#fff; text-decoration:none;
    box-shadow:0 0 0 1px rgba(0,229,255,.08) inset;
    transition:transform .06s ease, box-shadow .12s ease, background .12s ease;
  }
  .tk-cta:hover{background:#041e22; transform:translateY(-1px);}

  /* Panel header row */
  .tk-head{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px;}
  .tk-head .group{display:flex; gap:12px; align-items:center;}

  /* Checklist grid (uniform buttons) */
  #categoryChecklist{
    display:grid; grid-template-columns:repeat(2, minmax(280px, 1fr)); gap:14px; align-items:stretch;
  }
  #categoryChecklist label{
    display:flex; align-items:center; gap:12px;
    padding:14px 16px; min-height:60px; cursor:pointer;
    border:2px solid var(--teal,#00e5ff); border-radius:16px;
    background:rgba(0,0,0,.45); box-shadow:0 0 0 1px rgba(0,229,255,.08) inset;
    transition:transform .06s ease, box-shadow .12s ease, background .12s ease;
  }
  #categoryChecklist label:hover{background:rgba(0,0,0,.65); box-shadow:0 0 0 2px rgba(0,229,255,.25) inset;}
  #categoryChecklist input[type="checkbox"]{width:20px; height:20px; accent-color:var(--teal,#00e5ff);}
  #categoryChecklist .tk-name{font-size:16.5px; font-weight:800; letter-spacing:.2px; line-height:1.2;}

  /* Buttons inside panel */
  .themed-button{border:2px solid var(--teal,#00e5ff); border-radius:14px; background:#000; color:#fff; padding:12px 16px; font-weight:800;}
  .tk-actions{display:flex; gap:12px; align-items:center; margin:14px 0 18px;}
  .tk-actions .spacer{flex:1 1 auto}

  /* Small screens: stack */
  @media (max-width: 980px){
    #tkDockCard{inset:16px 16px calc(35vh + 16px) 16px;}
    #tkRightRail{inset:auto 16px 16px 16px; height:32vh; position:fixed; bottom:0; backdrop-filter:blur(4px);}
    #categoryChecklist{grid-template-columns:1fr;}
  }
</style>

<script>
(function(){
  /* ---- Settings / helpers ---- */
  let host = document.getElementById('tkDockHost');
  if (!host) {
    host = document.createElement('div');
    host.id = 'tkDockHost';
    document.body.appendChild(host);
  }
  const LIST_ID  = 'categoryChecklist';
  const norm = s => (s||'').replace(/^\(\s*demo\s*\)\s*/i,'').trim().toLowerCase();
  const KEY = '__TK_SELECTED_CATEGORIES';

  function ensureChrome(){
    // Create/position the dock card (3/4) and right rail (1/4)
    let card = document.getElementById('tkDockCard');
    if(!card){
      card = document.createElement('aside');
      card.id = 'tkDockCard';
      card.setAttribute('role','dialog');
      card.setAttribute('aria-label','Category selection');
      host.appendChild(card);
    }
    let rail = document.getElementById('tkRightRail');
    if(!rail){
      rail = document.createElement('div');
      rail.id = 'tkRightRail';
      rail.innerHTML = `
        <a class="tk-cta" href="/compatibility.html">Compatibility Page</a>
        <a class="tk-cta" href="/analysis.html">Individual Kink Analysis</a>
      `;
      host.appendChild(rail);
    }
    return card;
  }

  function buildPanelSkeleton(card){
    if (card.dataset.wired) return;
    card.dataset.wired = '1';
    card.innerHTML = `
      <div class="tk-head">
        <div class="group">
          <button id="btnSelectAll" class="themed-button">Select All</button>
          <button id="btnDeselectAll" class="themed-button">Deselect All</button>
        </div>
        <div class="group"><strong id="selectedCountBadge" style="opacity:.8">0 selected / 0 total</strong></div>
      </div>
      <div class="tk-actions">
        <button id="btnClosePanel" class="themed-button">Close âœ•</button>
        <span class="spacer"></span>
        <button id="beginSurveyFromPanel" class="themed-button">Start Survey</button>
      </div>
      <div id="${LIST_ID}" aria-live="polite" aria-busy="true"></div>
    `;
    // close behavior keeps the layout but hides the card, if you need it
    card.querySelector('#btnClosePanel').onclick = ()=>{ card.style.display='none'; };
  }

  async function getKinks(){
    // prefer already loaded data if present
    if (Array.isArray(window.__TK_KINK_DATA) && window.__TK_KINK_DATA.length) return window.__TK_KINK_DATA;
    try{
      const url = window.__TK_KINKS_URL || '/data/kinks.json';
      const r = await fetch(url, {cache:'no-store'});
      const j = await r.json();
      return Array.isArray(j)? j : (j.items||[]);
    }catch(e){ console.warn('[TK] no kink data', e); return []; }
  }

  function getSelected(list){
    return Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
  }

  function updateBadge(list){
    const badge = document.getElementById('selectedCountBadge');
    if (!badge) return;
    const total    = list.querySelectorAll('input[type="checkbox"]').length;
    const selected = list.querySelectorAll('input[type="checkbox"]:checked').length;
    badge.textContent = `${selected} selected / ${total} total`;
  }

  function persist(list){
    const ids = getSelected(list);
    try { localStorage.setItem(KEY, JSON.stringify(ids)); } catch {}
    updateBadge(list);
    return ids;
  }

  function restore(list){
    try {
      const saved = JSON.parse(localStorage.getItem(KEY) || '[]');
      if (Array.isArray(saved)) {
        const wanted = new Set(saved.map(String));
        list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = wanted.has(cb.value);
        });
      }
    } catch {}
  }

  function renderChecklist(items){
    const list = document.getElementById(LIST_ID);
    if(!list) return;
    list.innerHTML = '';
    const frag = document.createDocumentFragment();
    items.slice()
         .sort((a,b)=> norm(a.name||a.label).localeCompare(norm(b.name||b.label), undefined,{sensitivity:'base'}))
         .forEach(it=>{
            const id = String(it.id ?? it.value ?? it.slug ?? it.name);
            const lab = document.createElement('label');
            const cb = document.createElement('input'); cb.type='checkbox'; cb.value = id;
            const name = document.createElement('span'); name.className='tk-name'; name.textContent = it.name || it.label || id;
            lab.append(cb, name);
            frag.appendChild(lab);
         });
    list.appendChild(frag);
    list.setAttribute('aria-busy','false');

    restore(list);
    wireSelectionCounters(list);
  }

  function wireSelectionCounters(list){
    list.addEventListener('change', () => { persist(list); }, {passive:true});
    const selectAllBtn = document.getElementById('btnSelectAll');
    const deselectBtn  = document.getElementById('btnDeselectAll');
    if (selectAllBtn) selectAllBtn.onclick = ()=>{ list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);  persist(list); };
    if (deselectBtn)  deselectBtn.onclick  = ()=>{ list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); persist(list); };
    persist(list);
  }

  async function init(){
    const card = ensureChrome();
    buildPanelSkeleton(card);
    const data = await getKinks();
    if (data.length) {
      renderChecklist(data);
      const list = document.getElementById(LIST_ID);
      const start = document.getElementById('beginSurveyFromPanel');
      if (start && list) {
        start.onclick = () => {
          const ids = persist(list);
          document.dispatchEvent(new CustomEvent('tk:start-survey', { detail: { includeCategories: ids } }));
          setTimeout(() => {
            if (!window.__TK_SURVEY_STARTED) {
              const u = new URL('/kinksurvey/', location.origin);
              if (ids.length) u.searchParams.set('cats', ids.join(','));
              u.searchParams.set('run','1');
              location.assign(u.toString());
            }
          }, 120);
        };
      }
    } else {
      const list = document.getElementById(LIST_ID);
      if (list) {
        list.textContent = 'No categories available.';
        list.setAttribute('aria-busy', 'false');
      }
    }
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
<!-- ==================================================================== -->
