<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Role Matches</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/theme.css" />
</head>
<body class="dark-mode">
  <div class="scroll-container scrollable-panel">
    <h1>Your Role Matches</h1>
    <p>Upload your exported survey to see how your kinks align with common roles.</p>

    <label class="survey-button file-upload">
      <span>Select Survey File</span>
      <input type="file" id="roleFile" hidden />
    </label>

    <div id="rolesOutput" class="pdf-container result-container"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="module">
    import { calculateRoleScores } from './js/calculateRoleScores.js';
    import { initTheme, applyPrintStyles } from './js/theme.js';
    initTheme();

    function flattenSurvey(survey) {
      const items = [];
      Object.entries(survey).forEach(([category, cat]) => {
        ['Giving', 'Receiving', 'General'].forEach(role => {
          if (Array.isArray(cat[role])) {
            cat[role].forEach(it => items.push({ category, ...it }));
          }
        });
      });
      return items;
    }

    function titleCase(str) {
      return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    function getBarColor(score) {
      if (score >= 95) return '#00cc00';
      if (score >= 85) return '#33cc33';
      if (score >= 70) return '#66cc33';
      if (score >= 55) return '#cccc33';
      if (score >= 40) return '#ff9933';
      if (score >= 20) return '#ff6633';
      if (score > 0) return '#cc0033';
      return '#990000';
    }

    function renderResultRow(roleName, score, tooltipText) {
      const row = document.createElement('div');
      row.className = 'result-row';
      row.innerHTML = `
        <div class="percentage">${score}%</div>
        <div class="bar-container" title="${tooltipText || ''}">
          <div class="bar-fill" style="width: ${score}%; background-color: ${getBarColor(score)};"></div>
        </div>
        <div class="role">${titleCase(roleName)}</div>
        <div class="more-info"><a href="#">More info</a></div>
      `;
      return row;
    }

    function applyComparisonStylesForPDF() {
      const style = document.createElement('style');
      style.innerHTML = `
        @media print {
          body {
            background-color: #111 !important;
            color: white !important;
            font-family: Arial, sans-serif;
          }

          #comparison-chart {
            background-color: #111 !important;
            color: white !important;
            padding: 24px;
            border-radius: 12px;
            max-width: 850px;
            margin: auto;
            font-size: 14px;
          }

          .result-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #333;
          }

          .percentage {
            width: 60px;
            font-weight: bold;
            text-align: right;
            color: white !important;
          }

          .role {
            flex: 1.5;
            color: white !important;
          }

          .bar-container {
            flex: 2;
            background: #222;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
          }

          .bar-fill {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 5px;
          }

          .more-info {
            flex-shrink: 0;
            font-size: 0.85rem;
            color: #ccc !important;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Build a fully styled printable DOM
    function exportStyledChartToPDF() {
      const original = document.getElementById('comparison-chart');
      if (!original) return;

      // Clone the styled content
      const clone = original.cloneNode(true);

      // Apply inline styles directly to each node
      clone.querySelectorAll('.result-row').forEach(row => {
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';
        row.style.padding = '6px 0';
        row.style.borderBottom = '1px solid #333';
        row.style.color = 'white';
      });

      clone.querySelectorAll('.percentage').forEach(el => {
        el.style.width = '60px';
        el.style.textAlign = 'right';
        el.style.fontWeight = 'bold';
        el.style.color = 'white';
      });

      clone.querySelectorAll('.role').forEach(el => {
        el.style.flex = '1.5';
        el.style.color = 'white';
      });

      clone.querySelectorAll('.bar-container').forEach(el => {
        el.style.flex = '2';
        el.style.background = '#222';
        el.style.height = '10px';
        el.style.borderRadius = '5px';
        el.style.position = 'relative';
        el.style.overflow = 'hidden';
      });

      clone.querySelectorAll('.bar-fill').forEach(el => {
        el.style.height = '100%';
        el.style.borderRadius = '5px';
        el.style.position = 'absolute';
        el.style.left = '0';
        el.style.top = '0';
      });

      clone.querySelectorAll('.bar-fill.green').forEach(el => {
        el.style.backgroundColor = '#00cc66';
      });
      clone.querySelectorAll('.bar-fill.yellow').forEach(el => {
        el.style.backgroundColor = '#ffcc00';
      });
      clone.querySelectorAll('.bar-fill.red').forEach(el => {
        el.style.backgroundColor = '#cc0033';
      });

      clone.querySelectorAll('.more-info').forEach(el => {
        el.style.flexShrink = '0';
        el.style.fontSize = '12px';
        el.style.color = '#ccc';
      });

      // Wrap in a styled container
      const wrapper = document.createElement('div');
      wrapper.style.background = '#111';
      wrapper.style.color = 'white';
      wrapper.style.fontFamily = 'Arial, sans-serif';
      wrapper.style.padding = '20px';
      wrapper.style.borderRadius = '10px';
      wrapper.style.maxWidth = '850px';
      wrapper.style.margin = 'auto';
      wrapper.appendChild(clone);

      // Create a temporary iframe for html2pdf to render from
      const iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.left = '-9999px';
      document.body.appendChild(iframe);

      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open();
      doc.write(`<html><head><title>Export</title></head><body>${wrapper.outerHTML}</body></html>`);
      doc.close();

      // Wait for DOM to render and trigger PDF
      setTimeout(() => {
        html2pdf().from(iframe.contentDocument.body).save('comparison.pdf');
        document.body.removeChild(iframe);
      }, 300);
    }

    document.getElementById('roleFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const parsed = JSON.parse(ev.target.result);
          const survey = parsed.survey || parsed;
          const scores = calculateRoleScores({ all: flattenSurvey(survey) });
          const container = document.getElementById('rolesOutput');
          if (!scores.length) {
            container.textContent = 'No role data found.';
            return;
          }
          container.innerHTML = '';
          const heading = document.createElement('div');
          heading.style.textAlign = 'center';
          heading.style.fontSize = '24px';
          heading.style.fontWeight = 'bold';
          heading.style.marginBottom = '30px';
          heading.textContent = 'TalkKink Compatibility Profile';
          container.appendChild(heading);
          const title = document.createElement('div');
          title.className = 'result-section-title';
          title.textContent = 'Your Survey Summary';
          container.appendChild(title);
          const chart = document.createElement('div');
          chart.id = 'comparison-chart';
          scores.forEach(s => {
            chart.appendChild(renderResultRow(s.name, s.percent));
          });
          container.appendChild(chart);
          const btn = document.createElement('button');
          btn.className = 'download-btn';
          btn.textContent = 'Download PDF';
          btn.addEventListener('click', exportStyledChartToPDF);
          container.appendChild(btn);
        } catch (err) {
          document.getElementById('rolesOutput').textContent = 'Invalid file.';
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
