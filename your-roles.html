<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Role Matches</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/theme.css" />
</head>
<body class="dark-mode">
  <div class="scroll-container scrollable-panel">
    <h1>Your Role Matches</h1>
    <p>Upload your exported survey to see how your kinks align with common roles.</p>

    <label class="survey-button file-upload">
      <span>Select Survey File</span>
      <input type="file" id="roleFile" hidden />
    </label>

    <div id="export-target" class="pdf-container print-wrapper result-container"></div>  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="module">
    import { calculateRoleScores } from './js/calculateRoleScores.js';
    import { initTheme, applyPrintStyles } from './js/theme.js';
    initTheme();

    function titleCase(str) {
      return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    function getBarColor(score) {
      if (score >= 95) return '#00cc00';
      if (score >= 85) return '#33cc33';
      if (score >= 70) return '#66cc33';
      if (score >= 55) return '#cccc33';
      if (score >= 40) return '#ff9933';
      if (score >= 20) return '#ff6633';
      if (score > 0) return '#cc0033';
      return '#990000';
    }

    function renderResultRow(roleName, score, tooltipText) {
      const row = document.createElement('div');
      row.className = 'result-row compact';
      row.innerHTML = `
        <div class="percentage">${score}%</div>
        <div class="bar-container" title="${tooltipText || ''}">
          <div class="bar-fill" style="width: ${score}%; background-color: ${getBarColor(score)};"></div>
        </div>
        <div class="role">${titleCase(roleName)}</div>
        <div class="more-info"><a href="#">More info</a></div>
      `;
      return row;
    }

    function exportPDFFromVisibleStyledContent() {
      const mode = document.body.classList.contains('light-mode') ? 'light' : 'dark';
      applyPrintStyles(mode);
      const element = document.getElementById("export-target");
      if (!element) return;

      // Force background color for PDF rendering
      element.style.backgroundColor = "#fff";

      document.body.classList.add('exporting');
      element.classList.add('pdf-export');
      html2pdf()
        .set({
          margin: 0,
          filename: 'kink-compatibility-results.pdf',
          image: { type: 'png', quality: 1 },
          html2canvas: {
            scale: 2,
            backgroundColor: '#fff',
            useCORS: true
          },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
          pagebreak: { mode: ['avoid-all'] }
        })
        .from(element)
        .save()
        .then(() => {
          document.body.classList.remove('exporting');
        });
      element.classList.remove('pdf-export');
      element.style.backgroundColor = "";
    }

    document.getElementById('roleFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const parsed = JSON.parse(ev.target.result);
          const answers = parsed.answers || parsed;
          const scores = calculateRoleScores(answers);
          const container = document.getElementById('export-target');
          if (!scores.length) {
            container.textContent = 'No role data found.';
            return;
          }
          container.innerHTML = '';
          const heading = document.createElement('div');
          heading.style.textAlign = 'center';
          heading.style.fontSize = '24px';
          heading.style.fontWeight = 'bold';
          heading.style.marginBottom = '30px';
          heading.textContent = 'TalkKink Compatibility Profile';
          container.appendChild(heading);
          const title = document.createElement('div');
          title.className = 'result-section-title';
          title.textContent = 'Your Survey Summary';
          container.appendChild(title);
          const chart = document.createElement('div');
          chart.id = 'comparison-chart';
          chart.className = 'pdf-export-area';
          scores.forEach(s => {
            const card = document.createElement('div');
            card.className = 'result-card';
            const header = document.createElement('div');
            header.className = 'result-header';
            header.innerHTML = `<span>${titleCase(s.name)}</span><span>⭐</span>`;
            card.appendChild(header);
            card.appendChild(renderResultRow(s.name, s.percent));
            chart.appendChild(card);
          });
          container.appendChild(chart);
          setTimeout(() => {
            exportPDFFromVisibleStyledContent();          }, 0);
        } catch (err) {
          document.getElementById('export-target').textContent = 'Invalid file.';
        }
      };
      reader.readAsText(file);
    });  </script>
  <script>
    fetch("/check-session", { credentials: "include" })
      .then(res => {
        if (res.status === 401) {
          window.location.href = "/token.html";
        }
      });
  </script>
<!-- ✅ 1) Add this *once* near the end of every page that was freezing (before </body>) -->
<script src="js/tk-safe-bootstrap.js"></script>
<!-- ---------- End Safe Bootstrap ---------- -->
</body>
</html>
