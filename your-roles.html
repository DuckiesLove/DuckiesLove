<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Role Matches</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/theme.css" />
</head>
<body class="dark-mode">
  <div class="scroll-container scrollable-panel">
    <h1>Your Role Matches</h1>
    <p>Upload your exported survey to see how your kinks align with common roles.</p>

    <label class="survey-button file-upload">
      <span>Select Survey File</span>
      <input type="file" id="roleFile" hidden />
    </label>

    <div id="rolesOutput" class="pdf-container result-container"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="module">
    import { calculateRoleScores } from './js/calculateRoleScores.js';
    import { initTheme } from './js/theme.js';
    initTheme();

    function flattenSurvey(survey) {
      const items = [];
      Object.entries(survey).forEach(([category, cat]) => {
        ['Giving', 'Receiving', 'General'].forEach(role => {
          if (Array.isArray(cat[role])) {
            cat[role].forEach(it => items.push({ category, ...it }));
          }
        });
      });
      return items;
    }

    function titleCase(str) {
      return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    function createEntry(name, percent) {
      const row = document.createElement('div');
      row.className = 'result-row';
      row.dataset.score = percent;
      row.style.setProperty('--bar-width', `${percent}%`);

      const pct = document.createElement('div');
      pct.className = 'percentage';
      pct.textContent = `${percent}%`;

      const bar = document.createElement('div');
      bar.className = 'bar';

      const role = document.createElement('div');
      role.className = 'role';
      role.textContent = titleCase(name);

      const info = document.createElement('div');
      info.className = 'more-info';
      const link = document.createElement('a');
      link.href = '#';
      link.textContent = 'More info';
      info.appendChild(link);

      row.appendChild(pct);
      row.appendChild(bar);
      row.appendChild(role);
      row.appendChild(info);
      return row;
    }

    function downloadResults() {
      const element = document.getElementById('rolesOutput');
      const opt = {
        margin: 0.5,
        filename: 'TalkKink_Compatibility_Report.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }

    document.getElementById('roleFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const parsed = JSON.parse(ev.target.result);
          const survey = parsed.survey || parsed;
          const scores = calculateRoleScores({ all: flattenSurvey(survey) });
          const container = document.getElementById('rolesOutput');
          if (!scores.length) {
            container.textContent = 'No role data found.';
            return;
          }
          container.innerHTML = '';
          const heading = document.createElement('div');
          heading.style.textAlign = 'center';
          heading.style.fontSize = '24px';
          heading.style.fontWeight = 'bold';
          heading.style.marginBottom = '30px';
          heading.textContent = 'TalkKink Compatibility Profile';
          container.appendChild(heading);
          const title = document.createElement('div');
          title.className = 'result-section-title';
          title.textContent = 'Your Survey Summary';
          container.appendChild(title);
          const chart = document.createElement('div');
          chart.id = 'comparison-chart';
          scores.forEach(s => {
            chart.appendChild(createEntry(s.name, s.percent));
          });
          container.appendChild(chart);
          const btn = document.createElement('button');
          btn.className = 'download-btn';
          btn.textContent = 'Download PDF';
          btn.addEventListener('click', downloadResults);
          container.appendChild(btn);
        } catch (err) {
          document.getElementById('rolesOutput').textContent = 'Invalid file.';
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
