<!-- Talk Kink — Categories panel (left) + THREE STACKED BUTTONS (right) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk Kink Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional: fine if your site already ships these -->
  <link rel="stylesheet" href="/js/css/style.css" />
  <link rel="stylesheet" href="/js/css/theme.css" />
  <link rel="stylesheet" href="/js/css/kinksurvey_overrides.css" />

  <style>
    /* ===== 2-col shell ===== */
    #tkPortal{ display:grid; grid-template-columns: 380px 1fr; gap:28px; align-items:start; }
    @media (max-width:980px){ #tkPortal{ grid-template-columns:1fr; } }

    /* ===== Left: category panel (uses your existing runtime to fill the list) ===== */
    .category-panel{
      position:sticky; top:16px;
      max-height:calc(100dvh - 32px);
      overflow:auto; padding:16px; border-radius:14px;
      scroll-behavior:smooth;
    }
    @media (min-width:1100px){ .category-panel{ top:20px; max-height:calc(100dvh - 40px); } }
    @media (max-width:980px){ .category-panel{ position:relative; top:0; max-height:none; } }
    .panel-header{ display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin-bottom:10px; }
    .category-checklist{ list-style:none; margin:12px 0 16px; padding:0; }
    .category-checklist li{ display:flex; align-items:center; gap:10px; padding:8px 6px; border-radius:8px; cursor:pointer; }

    /* ===== Right: ACTION STACK (always visible pre-start) ===== */
    #tkActionCol{ align-self:start; }
    .action-stack{ display:grid; gap:14px; max-width:560px; }
    .action-stack .themed-button{
      display:block; width:100%; text-align:center;
      padding:14px 16px; border-radius:12px; font-weight:700;
    }
    .action-stack .themed-button:disabled{ opacity:.55; cursor:not-allowed; }
    .action-stack .ghost{ background:transparent; border:2px solid var(--tk-accent,#39e3ff); }

    /* ===== Hide everything else on right pre-start (keep the 3 buttons visible) ===== */
    body.tk-prestart #tkActionCol{ display:block !important; }
    body.tk-prestart #tkPortal > :not(#categoryPanel):not(#tkActionCol){ display:none !important; }

    /* Engine mounts remain hidden until you decide to reveal them */
    #surveyApp[hidden], #surveyScoreCard[hidden]{ display:none !important; }
  </style>
</head>

<body class="theme-dark tk-prestart">
  <div id="tkPortal">
    <!-- LEFT: Category Panel (your bootstrap fills the list from /data/*.json) -->
    <section id="categoryPanel" class="panel category-panel">
      <header class="panel-header">
        <h2>Categories</h2>
        <div class="category-counter">
          <span id="categorySelectedCount">0</span>/<span id="categoryTotalCount">0</span> selected
        </div>
      </header>
      <!-- Either bootstrap path can target these -->
      <div id="tk-cat-list">
        <ul id="categoryChecklist" class="category-checklist"><!-- runtime populated --></ul>
      </div>
    </section>

    <!-- RIGHT: *** THREE STACKED BUTTONS *** -->
    <aside id="tkActionCol">
      <section id="tkActionStack" class="action-stack">
        <button id="startSurveyBtn" class="themed-button start-button" disabled>Start Survey</button>
        <a id="btnKinkAnalysis" class="themed-button ghost" href="https://talkkink.org/KinkSurveyPage/index.html#analysis">Individual Kink Analysis</a>
        <a id="btnCompatibility" class="themed-button ghost" href="https://talkkink.org/KinkSurveyPage/index.html#compatibility">Compatibility Page</a>
      </section>

      <!-- (Optional) your engine mounts live here; stay hidden until Start -->
      <section id="surveyApp" class="survey-app" hidden></section>
      <aside id="surveyScoreCard" class="scorecard" hidden></aside>
    </aside>
  </div>

  <script>
    /* Keep the left panel nicely tall even when toolbars resize */
    (function(){
      const panel = document.getElementById('categoryPanel'); if(!panel) return;
      const size = () => {
        const r = panel.getBoundingClientRect();
        const vh = Math.max(document.documentElement.clientHeight, innerHeight||0);
        panel.style.maxHeight = Math.max(260, vh - r.top - 16) + 'px';
      };
      requestAnimationFrame(size);
      addEventListener('resize', size);
    })();

    /* Wire: counter + Start gating + pre-start exit (no repopulation; uses your loader’s list) */
    (function(){
      const panel = document.getElementById('categoryPanel');
      const ul = document.getElementById('categoryChecklist');
      const selEl = document.getElementById('categorySelectedCount');
      const totEl = document.getElementById('categoryTotalCount');
      const startBtn = document.getElementById('startSurveyBtn');
      const app = document.getElementById('surveyApp');

      if (!panel || !ul || !startBtn) return;

      const selected = () => Array.from(ul.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      const update = () => {
        const total = ul.querySelectorAll('li').length;
        if (totEl) totEl.textContent = String(total);
        if (selEl) selEl.textContent = String(selected().length);
        startBtn.disabled = selected().length === 0;
      };

      ul.addEventListener('change', e => { if (e.target?.matches('input[type="checkbox"]')) update(); });
      startBtn.addEventListener('click', e => {
        if (startBtn.disabled){ e.preventDefault(); return; }
        document.body.classList.remove('tk-prestart');      // reveal right-side content
        if (app) app.hidden = false;                        // show engine mount
        panel.dispatchEvent(new CustomEvent('tk:survey:start', {bubbles:true, detail:{ selected: selected() }}));
        if (window.TKSurvey?.start) window.TKSurvey.start({ categories: selected() });
      });

      // Initial compute after your runtime likely injected items
      // Delay one frame so counts pick up freshly-inserted li's
      requestAnimationFrame(update);
    })();

    /* (Optional) tiny stub so you can see Start work even without your engine */
    window.TKSurvey = window.TKSurvey || {
      start: ({categories})=>{
        const mount = document.getElementById('surveyApp');
        if (!mount) return;
        mount.innerHTML = `<div class="panel"><h2>Survey Running</h2>
          <p>Categories: ${categories.join(', ') || '(none)'}.</p></div>`;
      }
    };
  </script>
</body>
</html>
