<!-- Talk Kink â€” Categories-Only + Action Stack (Codex one-box) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk Kink Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional: safe if your site already ships these -->
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/kinksurvey_overrides.css" />

  <style>
    /* ===== Shell layout: left = categories, right = actions/content ===== */
    #tkPortal { display:grid; grid-template-columns: 360px 1fr; gap: 28px; align-items:start; }
    @media (max-width: 980px){ #tkPortal{ grid-template-columns:1fr; } }

    /* ===== Category panel ===== */
    .category-panel{
      position: sticky;
      top: 16px;
      max-height: calc(100dvh - 32px);
      overflow: auto;
      padding: 16px;
      border-radius: 14px;
      scroll-behavior: smooth;
    }
    @media (min-width:1100px){
      .category-panel{ top:20px; max-height: calc(100dvh - 40px); }
    }
    @media (max-width:980px){
      .category-panel{ position:relative; top:0; max-height:none; }
    }

    .panel-header{ display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin-bottom:10px; }
    .category-counter{ opacity:.85; white-space:nowrap; }

    .category-checklist{ list-style:none; margin:12px 0 16px; padding:0; }
    .category-checklist li{ display:flex; align-items:center; gap:10px; padding:8px 6px; border-radius:8px; cursor:pointer; }
    .category-checklist input[type="checkbox"]{ flex:0 0 auto; }

    /* ===== Right column: stacked actions ===== */
    .action-stack{
      display:grid;
      gap:14px;
      align-content:start;
      max-width:560px;
      margin:0 0 20px 0;
    }
    .action-stack .themed-button{
      display:block; width:100%;
      text-align:center; padding:14px 16px;
      border-radius:12px; font-weight:700;
    }
    .action-stack .themed-button:disabled{ opacity:.55; cursor:not-allowed; }
    .action-stack .ghost{
      background:transparent; border:2px solid var(--tk-accent, #39e3ff);
    }

    /* ===== Keep app + scorecard hidden until engine allows ===== */
    #surveyApp[hidden], #surveyScoreCard[hidden]{ display:none !important; }

    /* ===== Pre-start: show ONLY category panel + action stack ===== */
    body.tk-prestart #categoryPanel{ display:block !important; }
    body.tk-prestart #tkActionStack{ display:grid !important; }
    body.tk-prestart #tkPortal > :not(#categoryPanel):not(#surveyMain){ display:none !important; }
    body.tk-prestart #surveyMain > :not(#tkActionStack){ display:none !important; }
  </style>
</head>

<!-- tk-prestart prevents the right column content from flashing before Start -->
<body class="theme-dark tk-prestart">
  <div id="tkPortal">
    <!-- LEFT: Category Panel (kept visible pre-start) -->
    <section id="categoryPanel" class="panel category-panel">
      <header class="panel-header">
        <h2>Categories</h2>
        <div class="category-counter">
          <span id="categorySelectedCount">0</span>
          <span>/</span>
          <span id="categoryTotalCount">0</span>
          <span> selected</span>
        </div>
      </header>

      <!-- Either loader may target these; we provide both safely -->
      <div id="tk-cat-list">
        <ul id="categoryChecklist" class="category-checklist"></ul>
      </div>
    </section>

    <!-- RIGHT: All right-column content lives inside #surveyMain -->
    <main id="surveyMain" class="portal-main">
      <!-- Action Stack (always visible pre-start) -->
      <section id="tkActionStack" class="action-stack">
        <button id="startSurveyBtn" class="themed-button start-button" disabled>
          Start Survey
        </button>
        <a id="btnKinkAnalysis" class="themed-button ghost" href="/kinksurvey/analysis/">Individual Kink Analysis</a>
        <a id="btnCompatibility" class="themed-button ghost" href="/kinksurvey/compat/">Compatibility Page</a>
      </section>

      <!-- Engine mount points (hidden until Start) -->
      <section id="surveyApp" class="survey-app" hidden></section>
      <aside id="surveyScoreCard" class="scorecard" hidden></aside>
    </main>
  </div>

  <script>
    /* ===== Utilities ===== */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const log = (...a)=>console.info("[TK]", ...a);

    /* Resize fallback so the sticky panel always fills the viewport nicely */
    (function sizePanel(){
      const panel = $('#categoryPanel'); if(!panel) return;
      const update = () => {
        const rect = panel.getBoundingClientRect();
        const vh = Math.max(document.documentElement.clientHeight, window.innerHeight||0);
        const maxH = Math.max(260, vh - rect.top - 16);
        panel.style.maxHeight = maxH + 'px';
      };
      requestAnimationFrame(update);
      addEventListener('resize', update);
    })();

    /* ===== Robust category bootstrap (works with new or legacy loaders) ===== */
    (function(){
      const panel = $('#categoryPanel');
      const ul = $('#categoryChecklist');
      const totalEl = $('#categoryTotalCount');
      const selEl = $('#categorySelectedCount');
      const startBtn = $('#startSurveyBtn');
      const surveyApp = $('#surveyApp');

      const slug = s => String(s).toLowerCase().replace(/&/g,'and').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

      async function tryFetch(urls){
        for (const url of urls){
          try {
            const r = await fetch(url, {credentials:'same-origin'});
            if (!r.ok) { log('skip', url, r.status); continue; }
            const j = await r.json(); log('loaded', url);
            return j;
          } catch(e){ log('fail', url, e.message); }
        }
        return null;
      }

      function parseCategoryList(obj){
        if (!obj) return [];
        if (Array.isArray(obj)) return obj;
        if (Array.isArray(obj.categories)) return obj.categories;
        if (obj.data && Array.isArray(obj.data.categories)) return obj.data.categories;
        return [];
      }

      function deriveFromKinks(obj){
        const items = obj?.items || obj?.kinks || (Array.isArray(obj) ? obj : []);
        const set = new Set(items.map(x => x?.category || x?.cat || x?.Category).filter(Boolean));
        return Array.from(set).sort();
      }

      function render(names){
        ul.innerHTML = names.map(n=>{
          const id = slug(n);
          return `<li data-cat="${id}">
            <input type="checkbox" id="cat_${id}" value="${id}">
            <label for="cat_${id}">${n}</label>
          </li>`;
        }).join('');
      }

      function selected() {
        return $$('#categoryChecklist input[type="checkbox"]:checked').map(i=>i.value);
      }

      function update() {
        const n = selected().length;
        if (selEl) selEl.textContent = String(n);
        if (startBtn) startBtn.disabled = n === 0;
        panel.dispatchEvent(new CustomEvent('tk:categories:change', {
          bubbles:true, detail:{countSelected:n, total: $$('#categoryChecklist li').length}
        }));
      }

      async function ensurePopulated(){
        // Give any in-page loader a moment to populate first
        await new Promise(r=>setTimeout(r, 150));
        if (ul.children.length > 0) return;

        // Try canonical names first, then derive from kinks dataset (both path flavors)
        const categories = parseCategoryList(await tryFetch([
          '/kinksurvey/data/categories.json', '/data/categories.json'
        ])) || [];

        let names = categories;
        if (!names.length){
          names = deriveFromKinks(await tryFetch([
            '/kinksurvey/data/kinks.json', '/data/kinks.json'
          ])) || [];
        }
        // Dedupe/normalize
        const norm = s => s?.toString().trim().replace(/\s+/g,' ');
        names = Array.from(new Map(names.map(n=>[norm(n).toLowerCase(), norm(n)])).values()).filter(Boolean).sort((a,b)=>a.localeCompare(b));
        render(names);
      }

      function wire(){
        totalEl.textContent = String($$('#categoryChecklist li').length);
        $('#categoryChecklist').addEventListener('change', e=>{
          if (e.target?.matches('input[type="checkbox"]')) update();
        });
        startBtn.addEventListener('click', e=>{
          if (startBtn.disabled){ e.preventDefault(); return; }
          // Exit pre-start: reveal right column content, let engine take over
          document.body.classList.remove('tk-prestart');
          if (surveyApp) surveyApp.hidden = false;
          panel.dispatchEvent(new CustomEvent('tk:survey:start', {bubbles:true, detail:{selected: selected()}}));
          // If you have a real engine globally, call it here:
          if (window.TKSurvey?.start) window.TKSurvey.start({ categories: selected() });
        });
        update();
      }

      (async function main(){
        await ensurePopulated();
        wire();
        log('categories ready:', $$('#categoryChecklist li').length);
      })();
    })();

    /* ===== Optional stub engine (remove if you already mount a real one) ===== */
    window.TKSurvey = window.TKSurvey || {
      start: ({categories})=>{
        const mount = document.getElementById('surveyApp');
        if (!mount) return;
        mount.innerHTML = `<div class="panel"><h2>Survey</h2>
          <p>Initialized with categories:</p>
          <ul>${categories.map(c=>`<li>${c}</li>`).join('')}</ul></div>`;
      }
    };
  </script>
</body>
</html>
