<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Compatibility Upload Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <style>
    .tk-consent-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999}
    .tk-consent-modal{width:min(540px,92vw);background:#0b0b0c;color:#e9e9ef;border:1px solid #2a2a35;border-radius:16px;padding:20px 18px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
    .tk-consent-modal h3{margin:0 0 8px 0;font-size:1.1rem}
    .tk-consent-modal p{margin:6px 0 12px 0;line-height:1.35}
    .tk-consent-row{display:flex;gap:10px;align-items:flex-start;margin:10px 0 16px}
    .tk-consent-row input[type="checkbox"]{margin-top:3px;transform:scale(1.1)}
    .tk-consent-actions{display:flex;gap:10px;justify-content:flex-end}
    .tk-btn{padding:10px 14px;border-radius:12px;border:1px solid #3b3b49;background:#18181c;color:#fafafc;cursor:pointer}
    .tk-btn.primary{background:#2b64ff;border-color:#2b64ff}
    .tk-btn:disabled{opacity:.6;cursor:not-allowed}
    .tk-consent-small{opacity:.8;font-size:.9rem}
  </style>
</head>
<body>
<!-- ========== TalkKink: Partner Consent Gate ========== -->
<div id="tk-consent" class="tk-consent-backdrop" aria-hidden="true">
  <div role="dialog" aria-modal="true" aria-labelledby="tk-consent-title" class="tk-consent-modal">
    <h3 id="tk-consent-title">Confirm Partner Consent</h3>
    <p>Before importing a partner‚Äôs survey, please confirm you have their explicit consent to upload and compare their responses here.</p>
    <div class="tk-consent-row">
      <input id="tk-consent-checkbox" type="checkbox" />
      <label for="tk-consent-checkbox">
        I have my partner‚Äôs explicit permission to upload and process their survey responses on this site.
      </label>
    </div>
    <p class="tk-consent-small">You can remove uploaded data at any time. If you do not have consent, click <b>Cancel</b>.</p>
    <div class="tk-consent-actions">
      <button class="tk-btn" data-action="cancel">Cancel</button>
      <button class="tk-btn primary" data-action="continue" disabled>Continue</button>
    </div>
  </div>
</div>
<!-- ========== /Partner Consent Gate ========== -->

<!-- ======= UI: error surfaces, status, file inputs, and download button ======= -->
<div id="compat-upload">
  <div id="globalError" style="display:none;color:#b00020;margin:.5rem 0;"></div>

  <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
    <label>
      <strong>Survey A (Partner A):</strong>
      <input id="uploadA" type="file" accept="application/json,.json" />
    </label>
    <span id="statusA" style="font-size:.9rem;color:#666">No file</span>
  </div>

  <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;margin-top:.5rem">
    <label>
      <strong>Survey B (Partner B):</strong>
      <input id="uploadB" type="file" accept="application/json,.json" data-partner-upload />
    </label>
    <span id="statusB" style="font-size:.9rem;color:#666">No file</span>
  </div>

  <button id="downloadBtn" disabled style="margin-top:.75rem">Download Compatibility PDF</button>
</div>

<script>
(function () {
  async function tkConfirmPartnerConsent() {
    const root = document.getElementById('tk-consent');
    if (!root) return false;
    const checkbox = root.querySelector('#tk-consent-checkbox');
    const btnContinue = root.querySelector('[data-action="continue"]');
    const btnCancel = root.querySelector('[data-action="cancel"]');
    if (!checkbox || !btnContinue || !btnCancel) return false;

    checkbox.checked = false;
    btnContinue.disabled = true;

    const result = await new Promise(resolve => {
      function onCheck() { btnContinue.disabled = !checkbox.checked; }
      function cleanup(value) {
        root.style.display = 'none';
        root.setAttribute('aria-hidden', 'true');
        checkbox.removeEventListener('change', onCheck);
        btnCancel.removeEventListener('click', onCancel);
        btnContinue.removeEventListener('click', onContinue);
        resolve(value);
      }
      function onCancel() { cleanup(false); }
      function onContinue() { cleanup(true); }

      checkbox.addEventListener('change', onCheck);
      btnCancel.addEventListener('click', onCancel);
      btnContinue.addEventListener('click', onContinue);

      root.style.display = 'flex';
      root.setAttribute('aria-hidden', 'false');
    });

    return result;
  }

  window.tkConfirmPartnerConsent = tkConfirmPartnerConsent;
})();
</script>

<script>
(function(){
/* =====================================================================
   Robust, symmetric upload pipeline for Survey A & B
   - Parses a wide range of JSON shapes
   - Validates & shows per-survey status
   - Enables "Download" only when BOTH surveys have numeric items
   - No alerts; messages shown inline
   ===================================================================== */

let partnerAData = null;
let partnerBData = null;
let partnerAAnswers = {};
let partnerBAnswers = {};
let compatibilityItems = [];

function sanitizeScore(score) {
  if (score == null || score === '' || score === '&&&') return '&&&';
  return score;
}

function calculateMatchScore(a, b) {
  if (
    a === '&&&' || b === '&&&' ||
    a === null || b === null ||
    a === undefined || b === undefined ||
    a === '' || b === ''
  ) {
    return '&&&';
  }

  const diff = Math.abs(a - b);
  const max = 5; // scale 0‚Äì5
  const matchPercent = Math.round(100 - (diff / max) * 100);
  return `${matchPercent}%`;
}

function generateCompatibilityRows(partnerAAnswersMap = {}, partnerBAnswersMap = {}, items = []) {
  return items.map(item => {
    const aScoreRaw = partnerAAnswersMap[item.id];
    const bScoreRaw = partnerBAnswersMap[item.id];
    const aScore = sanitizeScore(aScoreRaw);
    const bScore = sanitizeScore(bScoreRaw);
    const match = calculateMatchScore(aScoreRaw, bScoreRaw);
    return {
      item: item.label,
      partnerA: aScore,
      match,
      partnerB: bScore,
    };
  });
}

function normalizeItemId(entry) {
  const raw = entry?.id
    ?? entry?.key
    ?? entry?.kinkId
    ?? entry?.kinkID
    ?? entry?.slug
    ?? entry?.label
    ?? entry?.name;
  if (raw === undefined || raw === null) return '';
  const str = String(raw).trim();
  return str;
}

function normalizeItemLabel(entry, fallback) {
  const raw = entry?.label
    ?? entry?.name
    ?? entry?.title
    ?? entry?.kink
    ?? entry?.kinkLabel
    ?? entry?.id
    ?? entry?.key
    ?? fallback;
  const str = raw == null ? '' : String(raw).trim();
  return str || fallback;
}

function toAnswerDictionary(items = []) {
  const dict = {};
  items.forEach(item => {
    const id = normalizeItemId(item);
    if (!id) return;
    const score = toNumberish(item?.score ?? item?.value ?? item?.rating);
    if (typeof score !== 'number' || Number.isNaN(score)) return;
    const clamped = Math.max(0, Math.min(5, score));
    dict[id] = Math.round(clamped * 100) / 100;
  });
  return dict;
}

function buildCompatibilityItems(aItems = [], bItems = []) {
  const unique = new Map();
  const append = list => {
    list.forEach(item => {
      if (!item) return;
      const id = normalizeItemId(item);
      if (!id || unique.has(id)) return;
      unique.set(id, normalizeItemLabel(item, id));
    });
  };
  append(Array.isArray(aItems) ? aItems : []);
  append(Array.isArray(bItems) ? bItems : []);
  return Array.from(unique.entries())
    .map(([id, label]) => ({ id, label }))
    .sort((a, b) => a.label.localeCompare(b.label, undefined, { sensitivity: 'base' }));
}

function updateAnswerCaches() {
  partnerAAnswers = toAnswerDictionary(partnerAData?.items || []);
  partnerBAnswers = toAnswerDictionary(partnerBData?.items || []);
  compatibilityItems = buildCompatibilityItems(partnerAData?.items || [], partnerBData?.items || []);
  if (typeof window !== 'undefined') {
    window.partnerAData = partnerAData;
    window.partnerBData = partnerBData;
    window.partnerAAnswers = partnerAAnswers;
    window.partnerBAnswers = partnerBAnswers;
    window.compatibilityItems = compatibilityItems;
    window.calculateMatchScore = calculateMatchScore;
    window.generateCompatibilityRows = generateCompatibilityRows;
  }
}

updateAnswerCaches();

const NAME_KEYS  = ["id","key","name","label","title","slug"];
const SCORE_KEYS = ["rating","score","value","val","points","level"];

/* If your <tr> ids differ from the JSON keys, map them here */
const ID_ALIAS = new Map([
  // ["JSON key", "your data-kink-id value"],
]);

/* ---------- helpers ---------- */
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function pick(obj, keys) { for (const k of keys) if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k]; }
function toNumberish(v) {
  if (typeof v === "number" && !Number.isNaN(v)) return v > 5 && v <= 10 ? v / 2 : v;
  if (typeof v === "string") {
    const t = v.trim();
    if (/^\d+%$/.test(t)) return Number(t.slice(0, -1)) / 20;      // e.g. "80%" -> 4.0 on 0‚Äì5
    if (/^\d+\s*\/\s*\d+$/.test(t)) return Number(t.split("/")[0]); // e.g. "4/5" -> 4
    const n = Number(t);
    if (!Number.isNaN(n)) return n > 5 && n <= 10 ? n / 2 : n;      // handle 1‚Äì10 scales
  }
  return null;
}

/* Accepts varied row shapes and returns {id,label,score} or null */
function mapRow(row) {
  if (!row || typeof row !== "object") return null;
  const candidate = ["", "item", "question", "meta", "data"]
    .map(prefix => prefix ? row[prefix] : row)
    .find(v => v && typeof v === "object") || row;

  const nameLike  = pick(candidate, NAME_KEYS);
  const scoreLike = pick(candidate, SCORE_KEYS);

  const idRaw = (typeof nameLike === "string" ? nameLike : String(nameLike ?? "")).trim();
  if (!idRaw) return null;

  const score = toNumberish(scoreLike);
  const id = ID_ALIAS.get(idRaw) || idRaw;
  return { id, label: idRaw, score };
}

/* Accept {items:[...]}, {answers:[...]}, {data:[...]}, bare array, first array found, or plain object map */
function normalizeSurvey(json) {
  let rows = [];
  let usingObjectMap = false;
  if (Array.isArray(json)) rows = json;
  else if (Array.isArray(json?.items)) rows = json.items;
  else if (Array.isArray(json?.answers)) rows = json.answers;
  else if (Array.isArray(json?.data)) rows = json.data;
  else if (json && typeof json === "object") {
    const firstArray = Object.values(json).find(v => Array.isArray(v));
    if (Array.isArray(firstArray)) rows = firstArray;
    else {
      usingObjectMap = true;
      rows = Object.entries(json);
    }
  }
  if (!rows) rows = [];

  const items = [];
  let missingScores = 0;

  if (usingObjectMap) {
    for (const [k, v] of rows) {
      const score = toNumberish(v);
      if (typeof score !== "number") missingScores++;
      const id = ID_ALIAS.get(k) || k;
      items.push({ id, label: k, score });
    }
  } else {
    for (const r of rows) {
      const m = mapRow(r);
      if (!m) continue;
      if (typeof m.score !== "number") missingScores++;
      items.push({ id: m.id, label: m.label, score: m.score });
    }
  }
  return { items, missingScores };
}

function validateNormalized(n) {
  const errors = [];
  if (!n.items.length) errors.push("No recognizable items with names/ids were found.");
  const scored = n.items.filter(i => typeof i.score === "number");
  if (n.items.length && !scored.length) errors.push("Items found, but none contained numeric scores.");
  return { errors, scoredCount: scored.length, total: n.items.length, missing: n.missingScores };
}

/* ---------- UI feedback ---------- */
function setGlobalError(msgs) {
  const box = document.getElementById("globalError");
  if (!box) return;
  if (!msgs || msgs.length === 0) { box.style.display = "none"; box.innerHTML = ""; return; }
  box.style.display = "block";
  box.innerHTML = msgs.map(m => `<div>‚Ä¢ ${escapeHtml(m)}</div>`).join("");
}

function setStatus(which, text, state) {
  const el = document.getElementById(which === "A" ? "statusA" : "statusB");
  if (!el) return;
  el.textContent = text;
  if (state === true) el.style.color = "#1b5e20";
  else if (state === false) el.style.color = "#b00020";
  else el.style.color = "#666";
}

/* Enable download only when BOTH A and B have at least one numeric score */
function updateUIStates() {
  const btn = document.getElementById("downloadBtn");
  const aOk = !!(partnerAData?.items?.some(i => typeof i.score === "number"));
  const bOk = !!(partnerBData?.items?.some(i => typeof i.score === "number"));
  btn.disabled = !(aOk && bOk);
  if (!aOk || !bOk) {
    setGlobalError([]);
  }
}

// Escape an arbitrary id for use in querySelector
function cssEscape(str){
  return String(str).replace(/["\\#.:><~+^$[\]|(){}=]/g, "\\$&");
}

// Ensure a table row exists for a given id; creates one if missing
function ensureRowExists(id, label){
  let tbody = document.querySelector('tbody');
  if (!tbody){
    const anyRow = document.querySelector('[data-kink-id]');
    if (anyRow) tbody = anyRow.parentElement;
    else return null;
  }
  let row = document.querySelector(`[data-kink-id="${cssEscape(id)}"]`);
  if (row) return row;

  row = document.createElement('tr');
  row.setAttribute('data-kink-id', id);

  const tdLabel = document.createElement('td');
  tdLabel.textContent = label || id;

  const tdA = document.createElement('td');
  tdA.setAttribute('data-cell','A');
  tdA.textContent = 'N/A';

  const tdMatch = document.createElement('td');
  tdMatch.setAttribute('data-cell','Match');
  tdMatch.textContent = 'N/A';

  const tdB = document.createElement('td');
  tdB.setAttribute('data-cell','B');
  tdB.textContent = 'N/A';

  row.append(tdLabel, tdA, tdMatch, tdB);
  tbody.appendChild(row);
  return row;
}

/* ---------- Public upload handlers: wired to both inputs ---------- */
async function handleUpload(file, which) {
  if (!file) return;

  setStatus(which, "Loading...", null);
  await new Promise(r => setTimeout(r));

  try {
    const text = await file.text();
    await new Promise(r => setTimeout(r));
    const json = JSON.parse(text);
    await new Promise(r => setTimeout(r));

    const normalized = normalizeSurvey(json);
    const { errors, scoredCount, total, missing } = validateNormalized(normalized);

    // Store by partner
    if (which === "A") {
      partnerAData = normalized;
    } else {
      partnerBData = normalized;
    }
    updateAnswerCaches();

    // Update comparison table right away (no-op if you haven‚Äôt built it)
    updateComparison();

    if (errors.length) {
      setStatus(which, `Loaded ${total} items (${scoredCount} scored). Issues: ${errors.join(" ")}`, false);
    } else {
      const warn = missing ? ` ‚Ä¢ ${missing} item(s) missing scores ‚Üí shown as N/A` : "";
      setStatus(which, `‚úÖ Loaded ${total} items, ${scoredCount} scored${warn}`, true);
    }

    updateUIStates();
    console.info(`[Upload ${which}]`, { total, scoredCount, missing, errors });

  } catch (e) {
    setStatus(which, `Invalid JSON for Survey ${which}. ${e.message}`, false);
    updateUIStates();
  }
}

/* ---------- Table injection (creates missing rows when needed) ---------- */
function updateComparison() {
  const aItems = partnerAData?.items || [];
  const bItems = partnerBData?.items || [];
  const aMap = new Map(aItems.map(i => [i.id, i]));
  const bMap = new Map(bItems.map(i => [i.id, i]));

  const ids = new Set([...aMap.keys(), ...bMap.keys()]);
  let updated = 0;

  ids.forEach(id => {
    const a = aMap.get(id);
    const b = bMap.get(id);
    const label = a?.label || b?.label || id;

    let tr = document.querySelector(`[data-kink-id="${cssEscape(id)}"]`);
    if (!tr) tr = ensureRowExists(id, label);
    if (!tr) return; // still nothing to attach to

    const aCell = tr.querySelector('[data-cell="A"]');
    if (aCell) aCell.textContent = typeof a?.score === 'number' ? String(a.score) : 'N/A';

    const bCell = tr.querySelector('[data-cell="B"]');
    if (bCell) bCell.textContent = typeof b?.score === 'number' ? String(b.score) : 'N/A';

    const matchCell = tr.querySelector('[data-cell="Match"]');
    if (matchCell) {
      if (typeof a?.score === 'number' && typeof b?.score === 'number') {
        const diff = Math.abs(a.score - b.score);
        const pct = Math.max(0, 100 - (diff / 5) * 100);
        matchCell.textContent = `${Math.round(pct)}%`;
      } else {
        matchCell.textContent = 'N/A';
      }
    }

    const flagCell = tr.querySelector('[data-cell="Flag"]');
    if (flagCell) {
      if (typeof a?.score === 'number' && typeof b?.score === 'number') {
        flagCell.textContent = Math.abs(a.score - b.score) >= 3 ? 'üö©' : '';
      } else {
        flagCell.textContent = '';
      }
    }
    updated++;
  });

  if (!updated) {
    setGlobalError(['No matching rows were found or created. Check your ID_ALIAS mappings or table structure.']);
  } else {
    setGlobalError([]);
  }
}

  /* ---------- Wire up inputs & button ---------- */
  document.getElementById("uploadA")?.addEventListener("change", e => handleUpload(e.target.files?.[0], "A"));
  const uploadB = document.getElementById("uploadB");
  if (uploadB) {
    uploadB.addEventListener("change", async e => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (typeof window.tkConfirmPartnerConsent === "function") {
        const ok = await window.tkConfirmPartnerConsent();
        if (!ok) { e.target.value = ""; return; }
      }
      handleUpload(file, "B");
    });
  }

  })();
</script>

<script>
(function installSolidPdfExport(){
  // ---- utils
  const sanitizeScore = score => (score == null || score === '' || score === '&&&') ? '&&&' : score;
  const num = v => {
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) ? n : null;
  };
  const matchPct = (a, b) => {
    const A = num(a), B = num(b);
    if (A == null || B == null) return '&&&';
    const pct = Math.round(100 - (Math.abs(A - B) / 5) * 100);
    return `${pct}%`;
  };

  function rowsFromAnswerCaches() {
    const items = Array.isArray(window.compatibilityItems) ? window.compatibilityItems : null;
    if (!items || !items.length) return null;
    const builder = typeof window.generateCompatibilityRows === 'function'
      ? window.generateCompatibilityRows
      : (aMap, bMap, list) => list.map(item => {
          const aScore = aMap[item.id];
          const bScore = bMap[item.id];
          const pct = matchPct(aScore, bScore);
          return {
            item: item.label,
            partnerA: sanitizeScore(aScore),
            match: pct,
            partnerB: sanitizeScore(bScore)
          };
        });
    const rows = builder(window.partnerAAnswers || {}, window.partnerBAnswers || {}, items) || [];
    const filtered = rows
      .filter(row => row && (row.partnerA !== '' || row.partnerB !== '' || row.match))
      .map(row => [
        row.item || '‚Äî',
        row.partnerA === '' || row.partnerA == null ? '‚Äî' : String(row.partnerA),
        row.match || '‚Äî',
        row.partnerB === '' || row.partnerB == null ? '‚Äî' : String(row.partnerB)
      ]);
    return filtered.length ? filtered : null;
  }

  // ---- collect rows from DOM (fallback)
  function collectRows() {
    const cached = rowsFromAnswerCaches();
    if (cached) return cached;

    let trs = Array.from(document.querySelectorAll('tbody tr[data-kink-id]'));
    if (trs.length === 0) {
      trs = Array.from(document.querySelectorAll('tbody tr'))
        .filter(tr => tr.querySelector('td'));
    }
    const rows = [];
    for (const tr of trs) {
      const cat = tr.cells?.[0]?.textContent?.trim() || tr.getAttribute('data-kink-id') || '';
      const aTxt = tr.querySelector('td[data-cell="A"]')?.textContent
                ?? tr.cells?.[1]?.textContent ?? '';
      const bTxt = tr.querySelector('td[data-cell="B"]')?.textContent
                ?? tr.cells?.[tr.cells.length - 1]?.textContent ?? '';

      const A = num(aTxt), B = num(bTxt);
      const pct = matchPct(A, B);

      rows.push([
        cat || '‚Äî',
        (A ?? '‚Äî'),
        (pct == null ? '‚Äî' : `${pct}%`),
        (B ?? '‚Äî')
      ]);
    }
    return rows;
  }

  // ---- call AutoTable for any UMD/attach style
  function runAutoTable(doc, opts) {
    if (typeof doc.autoTable === "function") {
      doc.autoTable(opts);
    } else if (window.jspdf && typeof window.jspdf.autoTable === "function") {
      window.jspdf.autoTable(doc, opts);
    } else {
      throw new Error("jsPDF-AutoTable not found. Include the plugin before this script.");
    }
  }

  // ---- main export function
  async function exportCompatibilityPDF() {
    try {
      const aReady = partnerAData?.items?.some(i => typeof i.score === "number");
      const bReady = partnerBData?.items?.some(i => typeof i.score === "number");
      if (!aReady || !bReady) {
        alert("Upload both surveys with scored items before downloading the compatibility PDF.");
        return;
      }

      if (!(window.jspdf && window.jspdf.jsPDF)) {
        alert("Missing jsPDF. Add the CDN script before this exporter.");
        return;
      }

      const rows = collectRows();
      if (!rows.length) {
        console.warn("[PDF] No data rows found.");
        alert("No data rows found to export. Make sure the table has rows before exporting.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

      doc.setFontSize(18);
      doc.text("Talk Kink ‚Ä¢ Compatibility Report", 40, 48);

      runAutoTable(doc, {
        head: [["Category", "Partner A", "Match", "Partner B"]],
        body: rows,
        startY: 70,
        styles: { fontSize: 10, cellPadding: 6, overflow: "linebreak" },
        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontStyle: "bold" },
        columnStyles: {
          0: { halign: "left"  },
          1: { halign: "center" },
          2: { halign: "center" },
          3: { halign: "center" }
        }
      });

      doc.save("compatibility-report.pdf");
    } catch (err) {
      console.error("[PDF] Export failed:", err);
      alert("PDF export failed: " + err.message);
    }
  }

  // ---- bind button
  const btn = document.getElementById("downloadBtn") || document.querySelector("[data-download-pdf]");
  if (btn) btn.onclick = exportCompatibilityPDF;
  window.downloadCompatibilityPDF = exportCompatibilityPDF;

  // Debug info
  (function debugLog(){
    const rows = collectRows();
    console.log(`[PDF] Found ${rows.length} data rows. First row:`, rows[0]);
  })();
})();
</script>

<!-- ===== TalkKink Compatibility ‚Äì Test Harness =====
Place this AFTER your existing compatibility script (so it can call handleUpload). -->

<style>
  .tk-testbar { display:flex; flex-wrap:wrap; gap:.5rem; margin:1rem 0; }
  .tk-note { font-size:.9rem; opacity:.8; }
</style>

<div class="tk-testbar" id="tk-tests">
  <button type="button" onclick="TK_loadSample('A','objectMap05')">Load Sample A (Object map 0‚Äì5)</button>
  <button type="button" onclick="TK_loadSample('B','array10')">Load Sample B (Array 1‚Äì10 ‚Üí scaled)</button>
  <button type="button" onclick="TK_loadSample('B','percent')">Load Sample B (Percent strings)</button>
  <button type="button" onclick="TK_loadSample('B','mismatch')">Load Sample B (Fuzzy label mismatch)</button>
  <button type="button" onclick="TK_loadSample('A','malformed')">Load Malformed JSON ‚Üí error</button>
  <div class="tk-note">Use these to verify parsing, fuzzy mapping, scaling, and PDF gating.</div>
</div>

<script>
/* ------- Test Fixtures ------- */
const TK_FIXTURES = {
  /* A: object map like your export (0‚Äì5 scale) */
  objectMap05: {
    "Choosing my partner‚Äôs outfit for the day or a scene": 5,
    "Selecting their underwear, lingerie, or base layers": 5,
    "Styling their hair (braiding, brushing, tying, etc.)": 1,
    "Picking head coverings (bonnets, veils, hoods, hats) for mood or protocol": 1,
    "Offering makeup, polish, or accessories as part of ritual or play": 5
  },

  /* B: array of rows on a 1‚Äì10 scale ‚Üí should normalize to 0‚Äì5 */
  array10: [
    { label: "Choosing my partner‚Äôs outfit for the day or a scene", rating: 8 },
    { label: "Selecting their underwear, lingerie, or base layers", rating: 7 },
    { label: "Styling their hair (braiding, brushing, tying, etc.)", rating: 2 },
    { label: "Picking head coverings (bonnets, veils, hoods, hats) for mood or protocol", rating: 3 },
    { label: "Offering makeup, polish, or accessories as part of ritual or play", rating: 9 }
  ],

  /* B: percent strings ‚Üí should coerce to 0‚Äì5 (80% ‚Üí 4.0) */
  percent: {
    "Choosing my partner‚Äôs outfit for the day or a scene": "80%",
    "Selecting their underwear, lingerie, or base layers": "60%",
    "Styling their hair (braiding, brushing, tying, etc.)": "20%",
    "Picking head coverings (bonnets, veils, hoods, hats) for mood or protocol": "40%",
    "Offering makeup, polish, or accessories as part of ritual or play": "100%"
  },

  /* B: labels with punctuation/spacing differences ‚Üí tests fuzzy match */
  mismatch: {
    "Choosing my partners outfit for the day (or scene)": 4,
    "Selecting underwear / lingerie / base layers": 3,
    "Styling their hair - braiding, brushing, tying etc": 2,
    "Picking head coverings (hoods, hats, veils)": 2,
    "Makeup / polish / accessories as ritual or play": 5
  },

  /* Malformed JSON (string, not parseable on purpose) */
  malformed: "{ this is not valid JSON }"
};

/* ------- Loader: calls your existing handleUpload(file, 'A'|'B') ------- */
async function TK_loadSample(which, key){
  const data = TK_FIXTURES[key];
  let file;

  if (key === "malformed") {
    file = new File([TK_FIXTURES.malformed], `malformed-${which}.json`, { type: "application/json" });
  } else {
    const text = JSON.stringify(data, null, 2);
    file = new File([text], `sample-${key}-${which}.json`, { type: "application/json" });
  }

  // Prefer the real UI pathway if your script uses input change listeners
  const input = document.getElementById(which === 'A' ? 'uploadA' : 'uploadB');
  if (input) {
    // Trigger your existing handler path by dispatching a synthetic change
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
    input.dispatchEvent(new Event('change', { bubbles: true }));
    return;
  }

  // Fallback: call global handleUpload directly if exposed
  if (typeof handleUpload === "function") {
    await handleUpload(file, which);
  } else {
    console.warn("handleUpload is not in global scope; ensure the main module script is loaded first.");
  }
}

/* ------- Quick ‚ÄúTest Plan‚Äù you can follow step-by-step (visible in console) ------- */
console.log(`TalkKink Test Plan:
1) Click "Load Sample A (Object map 0‚Äì5)" ‚Üí Partner A column should fill with 5,5,1,1,5.
2) Click "Load Partner Survey" (if present) or one of the B buttons:
   a) "Array 1‚Äì10" ‚Üí values normalize; Match% computed.
   b) "Percent strings" ‚Üí 80% becomes 4.0, etc.
   c) "Fuzzy mismatch" ‚Üí labels with different punctuation still map to rows.
3) Try "Malformed JSON" ‚Üí status should turn red with an error message; Download remains disabled.
4) After both A and B are valid, Download button enables. If jsPDF + AutoTable are on the page, a PDF is generated.
`);
</script>
<script>
/***********************************************************************
 * TALK KINK ‚Äì stable upload flow + labels + % bars + A‚ÜíZ sorting
 * (with ‚Äúwaiting for second survey‚Äù message and a TEST button
 *  to clone the uploaded file to the missing partner ‚Äì no DevTools needed)
 *
 * Paste once near the end of the page, after your normal JS.
 **********************************************************************/

/* ---------------------------- GLOBAL STATE ---------------------------- */
window.tkState  = window.tkState  || { A:null, B:null };
window._tkReady = window._tkReady || { A:false, B:false };
const bothReady = () => !!(tkState?.A?.cells?.length && tkState?.B?.cells?.length);

/* ---------------------------- CSS FOR BARS ---------------------------- */
(function(){
  if (document.getElementById('tk-addon-css')) return;
  const css = `
    .tk-bar{position:relative;height:18px;border:1px solid #888;border-radius:4px}
    .tk-bar>i{position:absolute;inset:0;width:0%;background:#23b37a;border-radius:3px}
    .tk-bar>span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
                 font:600 12px/1 system-ui,sans-serif;color:#fff}
    .tk-wait{margin:.75rem 0;padding:.75rem;border:1px dashed #888;border-radius:8px}
    .tk-wait b{margin-right:.5rem}
  `;
  const s = document.createElement('style');
  s.id='tk-addon-css'; s.textContent=css; document.head.appendChild(s);
})();

/* ------------------------ GUARD HEAVY FUNCTIONS ----------------------- */
(function wrapHeavy(){
  const heavy = ['updateComparison','calculateCompatibility','buildRows','bindPdf','exportPDF'];
  heavy.forEach(n=>{
    const fn = window[n];
    if (typeof fn!=='function' || fn._tkWrapped) return;
    window[n] = function guarded(...a){
      if (!bothReady()) { console.debug(`[compat] ${n} waiting for both uploads`); return null; }
      return fn.apply(this,a);
    };
    window[n]._tkWrapped = true;
  });
  console.info('[compat] kill-switch enabled');
})();

/* ----------------------------- LABELS MAP ----------------------------- */
const TK_LABELS = window.TK_LABELS = Object.assign(
  {},
  window.TK_LABELS,
  {
    cb_e4bdv: "Dress partner‚Äôs outfit",
    cb_hhxwj: "Pick lingerie / base layers",
    cb_a19iy: "Uniforms (school, military, nurse, etc.)",
    cb_5gzwk: "Time-period dress-up",
    cb_wwf76: "Makeup as protocol or control",
    cb_swujj: "Accessory or ornament rules",
    cb_05hqj: "Wardrobe restrictions or permissions"
  }
);
// Optional: site-wide overrides if present
(async ()=>{ try{
  const r = await fetch('/data/labels-overrides.json',{cache:'no-store'});
  if (r.ok){ Object.assign(TK_LABELS, await r.json()); }
  console.info('[tk-labels] overrides merged:', Object.keys(TK_LABELS).length, 'keys');
}catch{} })();

const tLabel = v=>{
  if (!v) return v;
  if (TK_LABELS[v]) return TK_LABELS[v];
  const code=(String(v).match(/\bcb_[a-z0-9]{4,}\b/i)||[])[0];
  return TK_LABELS[code] || v;
};

/* --------------------- TABLE: labels + % bars + sort ------------------ */
function tkParsePercent(raw){
  const text = (raw == null ? '' : String(raw)).trim();
  if (!text) return null;
  const match = text.match(/(-?\d+(?:\.\d+)?)\s*%?/);
  if (!match) return null;
  const value = Number(match[1]);
  if (!Number.isFinite(value)) return null;
  return Math.max(0, Math.min(100, Math.round(value)));
}

function tkEnhanceTable(){
  const table = document.querySelector('#compatTable') || document.querySelector('table');
  if (!table) return;

  // 1) labels in first column
  (table.querySelectorAll('tbody tr')||[]).forEach(tr=>{
    const td = tr.cells?.[0]; if (!td) return;
    const raw = (td.textContent||'').trim();
    const pretty = tLabel(raw);
    if (pretty && pretty!==raw) td.textContent = pretty;
  });

  // 2) % bars in the ‚ÄúMatch %‚Äù column
  const ths = Array.from(table.querySelectorAll('thead th'));
  const pctIdx = ths.findIndex(th=>/match\s*%/i.test(th.textContent));
  const idx = pctIdx>=0 ? pctIdx : 2;
  (table.querySelectorAll('tbody tr')||[]).forEach(tr=>{
    const cell = tr.cells?.[idx]; if (!cell) return;
    const raw = (cell.textContent||'').trim();
    const pct = tkParsePercent(raw);
    if (pct == null){
      cell.textContent = raw || '‚Äî';
      return;
    }
    cell.textContent='';
    const bar=document.createElement('div'); bar.className='tk-bar';
    const fill=document.createElement('i'); fill.style.width=pct+'%';
    const cap=document.createElement('span'); cap.textContent= raw || (pct+'%');
    bar.append(fill,cap); cell.appendChild(bar);
  });

  // 3) sort rows A‚ÜíZ by first column
  const tb = table.tBodies?.[0]; if (!tb) return;
  const rows = Array.from(tb.rows);
  rows.sort((a,b)=>{
    const A=(a.cells?.[0]?.textContent||'').toLowerCase();
    const B=(b.cells?.[0]?.textContent||'').toLowerCase();
    return A.localeCompare(B);
  });
  rows.forEach(r=>tb.appendChild(r));
}

/* ------------------ SHOW ‚ÄúWAITING‚Äù + TEST WITHOUT DEVTOOLS ------------- */
function tkShowWait(){
  if (document.getElementById('tk-wait')) return;
  const host = document.querySelector('#controls') || document.querySelector('main') || document.body;
  const box = document.createElement('div');
  box.id='tk-wait'; box.className='tk-wait';
  box.innerHTML = `
    <b>Waiting for the second survey‚Ä¶</b>
    <button id="tk-dup" type="button">Use uploaded file for both (TEST)</button>
    <div style="opacity:.75;margin-top:.25rem">Upload the unmodified JSON exported from the site for the other partner to run the full comparison.</div>
  `;
  host.prepend(box);
  document.getElementById('tk-dup').onclick = ()=>{
    if (tkState.A?.cells?.length && !tkState.B?.cells?.length){
      tkState.B = JSON.parse(JSON.stringify(tkState.A)); _tkReady.B = true;
    }else if (tkState.B?.cells?.length && !tkState.A?.cells?.length){
      tkState.A = JSON.parse(JSON.stringify(tkState.B)); _tkReady.A = true;
    }
    document.getElementById('tk-wait')?.remove();
    tkMaybeRender();
  };
}

function tkMaybeRender(){
  // If both not ready, show a friendly wait box and stop here
  if (!bothReady()){ tkShowWait(); return; }

  // Run the app‚Äôs heavy draw now that both are present
  if (typeof window.updateComparison==='function') window.updateComparison();

  // Post-enhance the result
  tkEnhanceTable();
}

/* ------------------------ WIRE UPLOAD INPUTS (safe) -------------------- */
(function wire(){
  const upA=document.getElementById('uploadA'), upB=document.getElementById('uploadB');
  const parse=(txt, who)=>{
    try{
      const j=JSON.parse(txt);
      if (!Array.isArray(j?.answers) || !j.answers.length) throw 0;
      return j;
    }catch{ alert(`Invalid JSON for Survey ${who}. Please upload the unmodified JSON exported from this site.`); return null; }
  };
  if (upA) upA.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if (!f) return;
    const r=new FileReader(); r.onload=ev=>{ const j=parse(ev.target.result,'A'); if (!j) return (e.target.value='');
      tkState.A = { cells: (j.answers||[]).map((a,i)=>({ id:a.id||a.key||`a_${i}`, label:a.label||a.name||a.question||a.id })) };
      _tkReady.A=true; e.target.value=''; tkMaybeRender();
    }; r.readAsText(f);
  }, {passive:true});

  if (upB) upB.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if (!f) return;
    const r=new FileReader(); r.onload=ev=>{ const j=parse(ev.target.result,'B'); if (!j) return (e.target.value='');
      tkState.B = { cells: (j.answers||[]).map((a,i)=>({ id:a.id||a.key||`b_${i}`, label:a.label||a.name||a.question||a.id })) };
      _tkReady.B=true; e.target.value=''; tkMaybeRender();
    }; r.readAsText(f);
  }, {passive:true});
})();

/* ---------------------------- BOOT ------------------------------------- */
window.addEventListener('load', ()=>{
  // Alphabetize the category checklist in the side panel (best-effort)
  const panel = document.querySelector('[aria-label="Category selection"]')
             || document.querySelector('#categoryPanel')
             || document.querySelector('.tk-wide-panel')
             || document.querySelector('aside[role="region"]');
  if (panel){
    const list = panel.querySelector('ul,ol') || panel;
    const items = Array.from(list.querySelectorAll('li,label,.item,.row'))
      .map(el=>el.closest('li')||el).filter(Boolean);
    const unique = Array.from(new Set(items));
    unique.sort((a,b)=> (a.textContent||'').trim().toLowerCase()
                      .localeCompare((b.textContent||'').trim().toLowerCase()));
    unique.forEach(el=>list.appendChild(el));
  }
  tkMaybeRender();
});
</script>

<!-- ‚úÖ 1) Add this *once* near the end of every page that was freezing (before </body>) -->
<script>
/* ---------- TalkKink Safe Bootstrap (drop-in) ---------- */
(function () {
  const LOG = (...a) => console.log("[TK-SAFE]", ...a);

  /* A. QUICK SANITY CHECKS ‚Äî find & warn about merge markers (these often lock pages) */
  try {
    const html = document.documentElement.innerHTML;
    const HEAD = '<'.repeat(7);
    const SEP = '='.repeat(7);
    const TAIL = '>'.repeat(7);
    if (html.includes(HEAD) && html.includes(SEP) && html.includes(TAIL)) {
      const conflictPattern = new RegExp(`${HEAD}[\s\S]*?${SEP}[\s\S]*?${TAIL}`);
      if (conflictPattern.test(html)) {
        console.warn("[TK-SAFE] Merge conflict markers detected in DOM. Remove them to avoid broken JS/CSS.");
      }
    }
  } catch (_) {}

  /* B. ONE-TIME INIT GUARD (prevents duplicate event bind/render loops) */
  if (window.__TK_INITED__) {
    LOG("Init skipped: already initialized.");
    return;
  }
  window.__TK_INITED__ = true;

  /* C. SAFE-MODE FLAGS (use ?safe=1 or ?nopdf=1 or ?noscore=1 to bypass heavy work) */
  const params = new URLSearchParams(location.search);
  const SAFE_MODE  = params.has("safe");
  const NO_PDF     = SAFE_MODE || params.has("nopdf");
  const NO_SCORE   = SAFE_MODE || params.has("noscore");

  if (SAFE_MODE) LOG("SAFE MODE ON: skipping scoring/render and lazy-loading libraries.");

  /* D. SMALL UTILITIES */
  const byId = (id) => document.getElementById(id);
  function once(el, type, handler, opts) {
    // prevent stacked duplicate listeners after HMR/partials
    el && el.addEventListener(type, function f(e) {
      el.removeEventListener(type, f, opts);
      handler(e);
    }, opts);
  }
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src; s.async = true; s.defer = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  function idle(fn) {
    // yield back to the browser to keep UI responsive
    return (window.requestIdleCallback || ((cb)=>setTimeout(cb,0)))(fn);
  }

  /* E. LAZY LOADERS FOR HEAVY LIBS (loaded only on click) */
  async function ensureJsPDF() {
    // Already present?
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    if (window.jsPDF) return window.jsPDF; // legacy global some sites still use

    // If the script tag exists but hasn‚Äôt finished loading, wait for it:
    const tag = document.querySelector('script[data-lib="jspdf"]');
    if (tag && !tag.dataset.loaded) {
      await new Promise((resolve, reject) => {
        tag.addEventListener('load', () => { tag.dataset.loaded = '1'; resolve(); }, { once: true });
        tag.addEventListener('error', () => reject(new Error('Failed to fetch jsPDF script')), { once: true });
      });
    }

    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    if (window.jsPDF) return window.jsPDF;

    // As a last resort, inject dynamically (in case the tag wasn‚Äôt added)
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      s.crossOrigin = 'anonymous';
      s.referrerPolicy = 'no-referrer';
      s.dataset.lib = 'jspdf';
      s.onload = () => { s.dataset.loaded = '1'; resolve(); };
      s.onerror = () => reject(new Error('Failed to fetch jsPDF script'));
      document.head.appendChild(s);
    });

    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    if (window.jsPDF) return window.jsPDF;

    throw new Error('jsPDF failed to load');
  }
  async function ensureAutoTable() {
    // Only after jsPDF UMD maps window.jspdf.jsPDF
    await ensureJsPDF();
    const hasAT = (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable)
               || (window.jspdf && window.jspdf.autoTable);
    if (!hasAT) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* F. DEFENSIVE BINDINGS (buttons used across pages) */
  idle(() => {
    // PDF buttons (compatibility, IKA, etc.)
    const dl1 = byId("downloadBtn");
    const dl2 = byId("downloadPdfBtn");
    const anyDownload = dl1 || dl2;

    if (anyDownload) {
      const handler = async (e) => {
        e.preventDefault();
        if (NO_PDF) { alert("PDF disabled (safe mode). Add ?safe=0 or remove ?nopdf."); return; }
        try {
          // Lazy load heavy libs only now
          await ensureAutoTable();
          // Yield once more before heavy export:
          await new Promise(r => setTimeout(r, 0));
          // Call your existing exporter (must be defined elsewhere)
          if (typeof window.TKPDF_export === "function") {
            await window.TKPDF_export();
          } else if (typeof window.TKPDF_forceDark === "function") {
            await window.TKPDF_forceDark();
          } else if (typeof window.exportIKAPdf === "function") {
            await window.exportIKAPdf();
          } else {
            alert("Export function not found. Expected TKPDF_export/TKPDF_forceDark/exportIKAPdf.");
          }
        } catch (err) {
          console.error("[TK-SAFE] PDF export failed:", err);
          alert("PDF export failed: " + (err?.message || err));
        }
      };

      // Bind once to whichever exists
      if (dl1) once(dl1, "click", handler);
      if (dl2) once(dl2, "click", handler);
      LOG("Bound PDF button(s).");
    }

    // File upload styled label (IKA)
    const fileInput = byId("ikaFile");
    const fileLabel = document.querySelector('label[for="ikaFile"]');
    if (fileInput && fileLabel) {
      once(fileLabel, "click", () => fileInput.click());
      LOG("Bound Upload Survey label‚Üíinput.");
    }
  });

  /* G. STOP RUNNING EXPENSIVE WORK ON LOAD (scoring/rendering) */
  // Wrap your page‚Äôs auto-render or scoring in this gate:
  window.TK_canRunHeavy = function () {
    if (SAFE_MODE) return false;
    // Avoid running more than once
    if (window.__TK_HEAVY_RAN__) return false;
    window.__TK_HEAVY_RAN__ = true;
    return true;
  };

  // Example usage for your pages (leave here; your code can call it):
  // if (window.TK_canRunHeavy()) {
  //   // run scoring/render here or schedule with idle(...)
  //   idle(() => window.renderResults && window.renderResults());
  // }

  /* H. GLOBAL CATCH FOR ACCIDENTAL LONG TASKS */
  // If something still locks the UI, advise safe mode.
  window.addEventListener("error", (e) => {
    console.warn("[TK-SAFE] Window error:", e.message);
  });
})();
</script>
<!-- ---------- End Safe Bootstrap ---------- -->
</body>
</html>
