<!-- Drop-in: centered header + snug table with AutoTable v3/v4 compatibility -->
<script>
/**
 * TalkKink PDF — force our handler, center header, start table under it.
 * Drop this as the LAST script on the page.
 */
(function () {
  // 1) Resolve jsPDF (v1 or v2)
  const JsPDF = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  if (!JsPDF) { console.error('[compat] jsPDF not found'); alert('PDF engine missing'); return; }

  // 2) Get button and nuke any old handlers by cloning the node
  const BTN_IDs = ['#downloadPdfBtn', '#downloadPDF', '#tkDownloadPdf']; // try common IDs
  let btn = null;
  for (const id of BTN_IDs) { btn = document.querySelector(id); if (btn) break; }
  if (!btn) { console.error('[compat] Download button not found'); alert('Download button not found'); return; }

  const fresh = btn.cloneNode(true);
  btn.parentNode.replaceChild(fresh, btn);
  btn = fresh;

  console.log('[compat] Bound new PDF generator to', btn);

  // 3) Tokens / layout
  const TOK = {
    margins: { top: 60, left: 64, right: 64, bottom: 60 },
    cyan: [0, 255, 255],
    title: 'TalkKink Compatibility',
    section: 'Behavioral Play'
  };

  const headerCenterX = (doc) => doc.internal.pageSize.getWidth() / 2;

  function drawHeader(doc) {
    const w = doc.internal.pageSize.getWidth();
    const cx = headerCenterX(doc);

    // (debug) backdrop bar so you can SEE the header area is being drawn
    doc.setFillColor(8, 12, 14);
    doc.rect(TOK.margins.left, 40, w - TOK.margins.left - TOK.margins.right, 110, 'F');

    // Title
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(28);
    doc.text(TOK.title, cx, 70, { align: 'center' });

    // Timestamp
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(175, 210, 255);
    doc.setFontSize(9);
    doc.text('Generated: ' + new Date().toLocaleString(), cx, 90, { align: 'center' });

    // Divider
    if (doc.setLineWidth) doc.setLineWidth(1);
    doc.setDrawColor(...TOK.cyan);
    doc.line(TOK.margins.left, 102, w - TOK.margins.right, 102);

    // Section
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.text(TOK.section, cx, 125, { align: 'center' });

    return 142; // startY for the table
  }

  // 4) Rows (use your real builder if available)
  async function buildRows() {
    if (typeof window.buildCompatibilityRows === 'function') {
      return await window.buildCompatibilityRows();
    }
    // Fallback: infer from window.QUESTIONS + window.answers Map
    const rows = [];
    try {
      const Q = window.QUESTIONS || [];
      const A = window.answers instanceof Map ? window.answers : null;
      if (Q.length && A) {
        for (const q of Q) {
          const a = A.get(q.id);
          // [Item, Partner A, Match, Flag, Partner B]
          rows.push([q.text || q.label || '', String(a?.a ?? ''), (a?.match ?? 0) + '%', '▶', String(a?.b ?? '')]);
        }
        return rows;
      }
    } catch {}
    console.warn('[compat] No live data found; rows empty');
    return rows;
  }

  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    console.log('[compat] PDF click -> generator running');

    const doc = new JsPDF({ unit: 'pt', format: 'letter' });

    if (typeof doc.autoTable !== 'function') {
      console.error('[compat] AutoTable not on doc (plugin not loaded before this script).');
      alert('PDF table plugin unavailable');
      return;
    }

    const startY = drawHeader(doc);
    const body = await buildRows();

    // Build the table under our header
    doc.autoTable({
      head: [['Item', 'Partner A', 'Match', 'Flag', 'Partner B']],
      body,
      startY,
      margin: TOK.margins,
      styles:     { textColor:[255,255,255], fillColor:[10,10,12], lineColor:[34,34,42], lineWidth:0.25, valign:'middle' },
      headStyles: { textColor:[0,255,255],   fillColor:[0,0,0],    lineColor:[34,34,42], halign:'left' },
      didDrawPage(data) {
        if (data.pageNumber > 1) drawHeader(doc);
      }
    });

    doc.save('compatibility-pretty-dark.pdf');
  });
})();
</script>
