<!-- Self-hosted libs (put these just before the final script) -->
<script src="/assets/js/vendor/jspdf.umd.min.js?v=2"></script>
<script src="/assets/js/vendor/jspdf.plugin.autotable.min.js?v=2"></script>

<!-- FINAL script: replaces any previous PDF click logic and centers header + table -->
<script>
(function () {
  const jsPDF = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  if (!jsPDF) { console.error('[compat] jsPDF missing'); return; }

  // Find the download button and strip any old listeners by cloning
  const BTN_SEL = ['#downloadPdfBtn', '#downloadPDF', '#tkDownloadPdf'];
  let btn = null;
  for (const s of BTN_SEL) { const el = document.querySelector(s); if (el) { btn = el; break; } }
  if (!btn) { console.error('[compat] Download button not found'); return; }
  const clone = btn.cloneNode(true);
  btn.parentNode.replaceChild(clone, btn);
  btn = clone;

  console.log('[compat] Bound new PDF generator to', btn);

  // Theme tokens
  const TOK = {
    page: { unit: 'pt', format: 'letter' },
    cyan: [0, 255, 255],
    bodyFill: [10, 10, 12],
    grid: [34, 34, 42],
    margins: { top: 56, right: 56, bottom: 60, left: 56 },
    title: 'TalkKink Compatibility',
    section: 'Behavioral Play'
  };

  function centerX(doc){ return doc.internal.pageSize.getWidth() / 2; }

  // Draw centered header and return the Y where the table must start
  function drawHeader(doc) {
    const cx = centerX(doc);
    const w  = doc.internal.pageSize.getWidth();

    // Title
    doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(28);
    doc.text(TOK.title, cx, 70, { align: 'center' });

    // Timestamp
    doc.setFont('helvetica','normal'); doc.setTextColor(175,210,255); doc.setFontSize(10);
    doc.text('Generated: ' + new Date().toLocaleString(), cx, 88, { align: 'center' });

    // Cyan rule
    if (doc.setLineWidth) doc.setLineWidth(1);
    doc.setDrawColor(...TOK.cyan);
    doc.line(TOK.margins.left, 100, w - TOK.margins.right, 100);

    // Section
    doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(22);
    doc.text(TOK.section, cx, 124, { align: 'center' });

    return 140; // startY for table
  }

  // Build body rows (use your live data if present)
  async function buildRows() {
    if (typeof window.buildCompatibilityRows === 'function') {
      try { return await window.buildCompatibilityRows(); } catch {}
    }
    const Q = Array.isArray(window.QUESTIONS) ? window.QUESTIONS : [];
    const A = window.answers instanceof Map ? window.answers : null;
    if (Q.length && A) {
      return Q.map(q => {
        const a = A.get(q.id) || {};
        return [
          q.text || q.label || '',
          String(a.a ?? ''),
          (a.match != null ? a.match : 0) + '%',
          '▶',
          String(a.b ?? '')
        ];
      });
    }
    // Minimal fallback so the button still works
    return [
      ['Sample item', '3', '100%', '▶', '3']
    ];
  }

  // Fixed column widths so we can perfectly center the table
  // Total width = 360 + 70 + 70 + 50 + 70 = 620 pt
  const COL_WIDTHS = { 0: 360, 1: 70, 2: 70, 3: 50, 4: 70 };
  function centeredMargin(doc) {
    const total = Object.values(COL_WIDTHS).reduce((a,b)=>a+b,0);
    const pageW = doc.internal.pageSize.getWidth();
    const left  = Math.max(TOK.margins.left, (pageW - total)/2);
    return { top: TOK.margins.top, right: TOK.margins.right, bottom: TOK.margins.bottom, left };
  }

  btn.addEventListener('click', async (e) => {
    e.preventDefault();

    if (typeof jsPDF.prototype.autoTable !== 'function') {
      console.error('[compat] autoTable plugin missing'); alert('PDF plugin unavailable'); return;
    }

    const doc = new jsPDF(TOK.page);
    const startY = drawHeader(doc);
    const body   = await buildRows();

    doc.autoTable({
      head: [['Item', 'Partner A', 'Match', 'Flag', 'Partner B']],
      body,
      startY,
      margin: centeredMargin(doc),
      styles:     { fillColor: TOK.bodyFill, textColor:[255,255,255], lineColor: TOK.grid, lineWidth: 0.25, valign:'middle' },
      headStyles: { fillColor:[0,0,0],        textColor: TOK.cyan,     lineColor: TOK.grid, fontStyle:'bold' },
      columnStyles: {
        0: { cellWidth: COL_WIDTHS[0], halign:'left'  },
        1: { cellWidth: COL_WIDTHS[1], halign:'center'},
        2: { cellWidth: COL_WIDTHS[2], halign:'center'},
        3: { cellWidth: COL_WIDTHS[3], halign:'center'},
        4: { cellWidth: COL_WIDTHS[4], halign:'center'},
      },
      didDrawPage(data) { if (data.pageNumber > 1) drawHeader(doc); }
    });

    doc.save('compatibility-pretty-dark.pdf');
  });
})();
</script>
