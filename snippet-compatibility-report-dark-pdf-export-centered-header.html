<!-- Drop-in: page-centered header + snug table; AutoTable v3–v4 compatible -->
<script>
(function () {
  // ---- jsPDF + AutoTable detection ----
  const JS = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  if (!JS) { console.warn('[compat] jsPDF missing'); return; }
  const hasAT =
    !!(JS.API && JS.API.autoTable) ||
    !!(window.jspdf?.jsPDF?.API?.autoTable) ||
    !!(window.jsPDF?.API?.autoTable);
  if (!hasAT) { console.warn('[compat] AutoTable missing'); return; }

  // ---- Style tokens ----
  const TOK = {
    cyan: [0,255,255],
    white: [255,255,255],
    stamp: [170,210,255],
    margins: { left: 72, right: 72 },       // keep in sync with AutoTable margins
    title: 'TalkKink Compatibility',
    section: 'Behavioral Play'
  };

  // Centering mode: 'page' or 'table'
  const CENTER_MODE = 'page'; // change to 'table' if you want center of table area

  function centerX(doc) {
    const PW = doc.internal.pageSize.getWidth();
    if (CENTER_MODE === 'table') {
      const w = PW - TOK.margins.left - TOK.margins.right;
      return TOK.margins.left + w / 2;
    }
    return PW / 2; // page center
  }

  // Draw the header; return the y where table should start
  function drawHeader(doc) {
    const CX = centerX(doc);

    doc.setFont('helvetica','bold');
    doc.setFontSize(28);
    doc.setTextColor(...TOK.white);
    doc.text(TOK.title, CX, 64, { align: 'center' });

    doc.setFont('helvetica','normal');
    doc.setFontSize(9);
    doc.setTextColor(...TOK.stamp);
    doc.text('Generated: ' + new Date().toLocaleString(), CX, 82, { align: 'center' });

    // divider
    doc.setDrawColor(...TOK.cyan);
    doc.setLineWidth?.(1);
    doc.line(TOK.margins.left, 94, doc.internal.pageSize.getWidth() - TOK.margins.right, 94);

    // section
    doc.setFont('helvetica','bold');
    doc.setFontSize(22);
    doc.setTextColor(...TOK.white);
    doc.text(TOK.section, CX, 120, { align: 'center' });

    // where the table should start
    return 138;
  }

  // Build your rows. Replace with your real builder.
  async function getRows() {
    if (typeof window.buildCompatibilityRows === 'function') {
      return await window.buildCompatibilityRows();
    }
    return []; // fallback
  }

  // Main generator (exported)
  window.generateDarkPDF = async function () {
    const doc = new JS({ unit: 'pt', format: 'letter' });
    const rows = await getRows();

    // Always draw header BEFORE table on page 1
    const startY = drawHeader(doc);

    // Use whichever AutoTable binding exists
    const autoTable =
      (JS.API && JS.API.autoTable) ||
      (window.jspdf?.jsPDF?.API?.autoTable) ||
      (window.jsPDF?.API?.autoTable);

    autoTable.call(doc, {
      head: [['Item', 'Partner A', 'Match', 'Flag', 'Partner B']],
      body: rows,
      startY, // <- puts table right below header on page 1 (v3/v4 supported)
      margin: { top: 60, left: TOK.margins.left, right: TOK.margins.right, bottom: 60 },
      styles:     { textColor:[255,255,255], fillColor:[8,8,10], lineColor:[32,32,40], lineWidth:0.25, valign:'middle' },
      headStyles: { textColor:[0,255,255],   fillColor:[0,0,0],  lineColor:[32,32,40], halign:'left' },
      // Header on subsequent pages
      didDrawPage: function (data) {
        if ((data.pageNumber || doc.internal.getNumberOfPages()) > 1) {
          drawHeader(data.doc || doc);
        }
      },
    });

    doc.save('compatibility-pretty-dark.pdf');
  };

  // Wire button once; remove other older handlers/snippets
  const btn = document.querySelector('#downloadPdfBtn');
  if (btn) {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await window.generateDarkPDF(); }
      catch (err) { console.error(err); alert('Sorry—could not generate the PDF.'); }
    }, { once: false });
  }
})();
</script>
