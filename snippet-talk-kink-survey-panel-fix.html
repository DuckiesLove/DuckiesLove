<!-- ========== TK ONE-PASTE: drawer fix + z-index + theme + passive listeners ========== -->
<style>
  /* Minimal theme tokens that won’t disturb your current look,
     but give the Theme picker something to switch. */
  :root {
    --tk-bg:#090909; --tk-fg:#eafcff; --tk-accent:#00e6ff; --tk-accent-2:#41fff0;
    --tk-chip:#0f0f0f; --tk-border:#00e6ff;
  }
  html.tk-theme-neo   { --tk-bg:#070b0c; --tk-fg:#eafcff; --tk-accent:#00edff; --tk-chip:#061214; }
  html.tk-theme-contrast {
    --tk-bg:#000; --tk-fg:#fff; --tk-accent:#00ffff; --tk-chip:#000; --tk-border:#00ffff;
  }
  /* Only scope minor overrides to the panel bits we might create */
  #tkThemeDock{
    position:fixed; left:1rem; bottom:1rem; z-index:10050; display:flex; gap:.5rem;
    background:color-mix(in oklab, var(--tk-bg) 80%, #000); border:1px solid var(--tk-border);
    color:var(--tk-fg); border-radius:12px; padding:.5rem .6rem; box-shadow:0 8px 28px rgba(0,0,0,.45);
    backdrop-filter: blur(6px);
  }
  #tkThemeDock button{
    background:var(--tk-chip); color:var(--tk-fg); border:1px solid var(--tk-border);
    padding:.35rem .6rem; border-radius:10px; font:600 13px/1.1 system-ui,Segoe UI,Arial;
    letter-spacing:.2px; cursor:pointer;
  }
  #tkThemeDock button[aria-pressed="true"]{
    outline:0; border-color:var(--tk-accent); box-shadow:0 0 0 2px color-mix(in srgb, var(--tk-accent) 40%, transparent);
  }

  /* Make sure our overlay/panel always sit above all site layers */
  #tkOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); opacity:0; pointer-events:none;
              transition:opacity .18s ease; z-index:9998; }
  #categorySurveyPanel{ position:fixed; top:0; right:0; height:100dvh; width:min(720px,92vw);
    background:var(--tk-bg); color:var(--tk-fg); border-left:2px solid var(--tk-border);
    box-shadow:-20px 0 40px rgba(0,0,0,.45); transform:translateX(100%); transition:transform .2s ease;
    z-index:10000; display:flex; flex-direction:column;
  }
  .tk-panel-open #tkOverlay{ opacity:1; pointer-events:auto; }
  .tk-panel-open #categorySurveyPanel{ transform:translateX(0); }
</style>

<script>
(() => {
  /* ---------- A) Passive listeners for touch/wheel (silence console violations) ---------- */
  let supportsPassive=false;
  try{const o=Object.defineProperty({},"passive",{get(){supportsPassive=true}});
      window.addEventListener("tk-passive-test",()=>{},o);
      window.removeEventListener("tk-passive-test",()=>{},o);}catch(_){ }
  if (supportsPassive && !window.__tkPatchedPassive__) {
    window.__tkPatchedPassive__=true;
    const orig = EventTarget.prototype.addEventListener;
    const passiveFirst = new Set(["touchstart","touchmove","touchend","touchcancel","wheel"]);
    EventTarget.prototype.addEventListener = function(type, listener, options){
      if (passiveFirst.has(type)) {
        if (options == null) options = { passive:true };
        else if (typeof options === "boolean") options = { capture:options, passive:true };
        else if (typeof options === "object" && !("passive" in options)) options = {...options, passive:true};
      }
      return orig.call(this, type, listener, options);
    };
  }

  /* ---------- B) DOM helpers + ensure overlay/panel exist and sit on top ---------- */
  const $  = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const ensure = (id, tag, attrs={})=>{
    let el = document.getElementById(id);
    if(!el){ el = Object.assign(document.createElement(tag), { id, ...attrs }); document.body.appendChild(el); }
    return el;
  };
  const scrim = ensure("tkOverlay","div");
  const panel = ensure("categorySurveyPanel","aside",{ role:"dialog","aria-modal":"true","aria-hidden":"true" });

  function openPanel(){
    document.documentElement.classList.add("tk-panel-open");
    panel.setAttribute("aria-hidden","false");
  }
  function closePanel(){
    document.documentElement.classList.remove("tk-panel-open");
    panel.setAttribute("aria-hidden","true");
  }
  scrim.addEventListener("click", closePanel);

  /* ---------- C) Robust Start Survey binding (id, class, data attr, OR exact text) ------- */
  const byText = (txt)=>
    $$("a,button").filter(el => (el.textContent||"").trim().toLowerCase() === txt);
  const startButtons = [
    '#startSurveyBtn','.start-survey-btn','[data-tk-start]'
  ].flatMap(sel => $$(sel)).concat(byText('start survey'));
  startButtons.forEach(btn=>{
    if(!btn.__tkWired){ btn.addEventListener("click",(e)=>{e.preventDefault(); openPanel();}); btn.__tkWired=true; }
  });

  /* ---------- D) Theme picker (Dark / Neo-Teal / High Contrast) ------------------------- */
  function applyTheme(name){
    const html=document.documentElement;
    html.classList.remove('tk-theme-neo','tk-theme-contrast');
    if(name==='neo') html.classList.add('tk-theme-neo');
    if(name==='contrast') html.classList.add('tk-theme-contrast');
    localStorage.setItem('tkTheme',name);
    // reflect pressed state
    $$(`#tkThemeDock button`).forEach(b=>b.setAttribute('aria-pressed', String(b.dataset.theme===name)));
  }
  function buildThemeDock(){
    if($('#tkThemeDock')) return;
    const dock = document.createElement('div');
    dock.id = 'tkThemeDock';
    dock.innerHTML = `
      <button type="button" data-theme="dark"      aria-pressed="false" title="Dark">Dark</button>
      <button type="button" data-theme="neo"       aria-pressed="false" title="Neo-Teal">Neo-Teal</button>
      <button type="button" data-theme="contrast"  aria-pressed="false" title="High Contrast">High Contrast</button>
    `;
    dock.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-theme]'); if(!b) return;
      applyTheme(b.dataset.theme);
    }, { passive:true });
    document.body.appendChild(dock);
    const saved = localStorage.getItem('tkTheme') || 'dark';
    applyTheme(saved);
  }
  buildThemeDock();

  /* ---------- E) If your app exposes a “Prepare & Open” step, hook it as well ----------- */
  // If there’s a custom event you dispatch when the data finishes binding,
  // you can open the panel automatically by listening to it:
  // document.addEventListener('tk:data-ready', openPanel);

  console.log("[TK] One-paste ready → panel wired, overlay on top, theme dock active.");
})();
</script>
<!-- ============================== /END ONE-PASTE ======================================== -->
