<!-- ==== TK one-paste: always-open panel + Start Survey wiring + diag ==== -->
<style>
  #tkOverlay{position:fixed;inset:0;background:rgba(0,0,0,.62);opacity:0;pointer-events:none;
             transition:opacity .18s ease;z-index:9998}
  #categorySurveyPanel{position:fixed;top:0;right:0;height:100dvh;width:min(720px,92vw);
    background:#0b0b0c;color:#eafcff;border-left:2px solid #00e6ff;
    box-shadow:-22px 0 44px rgba(0,0,0,.55);transform:translateX(100%);
    transition:transform .22s ease;z-index:10000;display:flex;flex-direction:column}
  .tk-panel-open #tkOverlay{opacity:1;pointer-events:auto}
  .tk-panel-open #categorySurveyPanel{transform:translateX(0)}
  /* lightweight skeleton only if your app didn’t render the real panel */
  .tk-skel header{display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-bottom:1px solid #00e6ff}
  .tk-skel h2{margin:0;font:700 20px/1.2 system-ui}
  .tk-skel .actions{display:flex;gap:8px}
  .tk-skel .btn{background:#081214;border:1px solid #00e6ff;color:#eafcff;border-radius:10px;
    padding:.4rem .7rem;font:600 13px/1 system-ui;cursor:pointer}
  .tk-skel .body{padding:16px 18px;overflow:auto}
  .tk-skel .hint{opacity:.75;font:500 13px/1.4 system-ui}
</style>

<script>
(()=>{

  /* ===== helpers ===== */
  const $  =(s,r=document)=>r.querySelector(s);
  const $$ =(s,r=document)=>Array.from(r.querySelectorAll(s));
  const log=(...a)=>console.log("[TK]",...a);

  const ensure=(id,tag,attrs={})=>{
    let el=document.getElementById(id);
    if(!el){el=document.createElement(tag);el.id=id;Object.assign(el,attrs);document.body.appendChild(el);}
    return el;
  };

  /* ===== guarantee scrim + panel exist and are on top ===== */
  const scrim = ensure('tkOverlay','div');
  const panel = ensure('categorySurveyPanel','aside');

  if(!panel.hasChildNodes()){
    panel.classList.add('tk-skel');
    panel.setAttribute('role','dialog'); panel.setAttribute('aria-modal','true'); panel.setAttribute('aria-hidden','true');
    panel.innerHTML = `
      <header>
        <h2>Select categories</h2>
        <div class="actions">
          <button type="button" class="btn" id="tkSelectAll">Select All</button>
          <button type="button" class="btn" id="tkDeselectAll">Deselect All</button>
          <button type="button" class="btn" id="tkClose">Close ✕</button>
        </div>
      </header>
      <div class="body">
        <p class="hint">Skeleton panel shown. Your real category UI will appear here when your app binds.</p>
        <div id="tkCatMount"></div>
      </div>`;
  }

  function openPanel(){
    document.documentElement.classList.add('tk-panel-open');
    panel.setAttribute('aria-hidden','false');
    log("Panel opened.");
  }
  function closePanel(){
    document.documentElement.classList.remove('tk-panel-open');
    panel.setAttribute('aria-hidden','true');
    log("Panel closed.");
  }

  // Close interactions
  scrim.addEventListener('click', closePanel);
  panel.addEventListener('click', (e)=>{ if(e.target.id==='tkClose') closePanel(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanel(); });

  // Expose for console diagnostics
  window.tkOpenPanel  = openPanel;
  window.tkClosePanel = closePanel;

  /* ===== robust Start Survey wiring =====
     - matches your buttons by id, data attr, or visible text
     - re-wires if your framework replaces nodes after hydration
  */
  const wired = new WeakSet();
  function wireStartButtons(root=document){
    const explicit = [
      '#startSurveyBtn','.start-survey-btn','[data-tk-start]'
    ].map(sel=>$(sel,root)).filter(Boolean);

    const byText = $$('a,button',root).filter(el=>{
      const t=(el.textContent||'').trim();
      return /^start\s+survey$/i.test(t);
    });

    [...new Set([...explicit,...byText])].forEach(btn=>{
      if(!wired.has(btn)){
        btn.addEventListener('click',(ev)=>{ ev.preventDefault(); log("Start Survey clicked.", btn); openPanel(); }, {passive:false});
        wired.add(btn);
      }
    });
  }
  wireStartButtons();

  // Observe DOM for re-renders and re-wire
  const mo=new MutationObserver(muts=>{
    for(const m of muts){
      if(m.type==='childList' && (m.addedNodes.length||m.removedNodes.length)){
        wireStartButtons(document);
      }
    }
  });
  mo.observe(document.documentElement,{subtree:true,childList:true});

  // Optional: auto-open once after first load so you can visually verify
  if(!sessionStorage.getItem('tk_auto_opened')){
    sessionStorage.setItem('tk_auto_opened','1');
    setTimeout(()=>{ log("Auto-open (first load) to verify UI."); openPanel(); }, 250);
  }

  // Silence passive touch warnings (optional)
  try{
    let supportsPassive=false;
    const opt=Object.defineProperty({},"passive",{get(){supportsPassive=true}});
    window.addEventListener("tk-passive",()=>{},opt); window.removeEventListener("tk-passive",()=>{},opt);
    if(supportsPassive && !window.__tkPatchedPassive__){
      window.__tkPatchedPassive__=true;
      const orig=EventTarget.prototype.addEventListener;
      const preferPassive=new Set(["touchstart","touchmove","touchend","wheel"]);
      EventTarget.prototype.addEventListener=function(type,listener,options){
        if(preferPassive.has(type)){
          if(options==null) options={passive:true};
          else if(typeof options==="boolean") options={capture:options,passive:true};
          else if(typeof options==="object" && !("passive" in options)) options={...options,passive:true};
        }
        return orig.call(this,type,listener,options);
      };
    }
  }catch(_){
  }

  log("One-paste installed: Start Survey wired; panel guaranteed; use tkOpenPanel()/tkClosePanel().");
})();
</script>
<!-- ==== /end TK one-paste ==== -->
