<!-- ===== TK: guaranteed panel open + optional skeleton (one-paste) ===== -->
<style>
  /* Keep your current look; just ensure stacking order + smooth open */
  #tkOverlay{position:fixed;inset:0;background:rgba(0,0,0,.62);opacity:0;pointer-events:none;
             transition:opacity .18s ease;z-index:9998}
  #categorySurveyPanel{position:fixed;top:0;right:0;height:100dvh;width:min(720px,92vw);
    background:#0b0b0c;color:#eafcff;border-left:2px solid #00e6ff;
    box-shadow:-22px 0 44px rgba(0,0,0,.55);transform:translateX(100%);
    transition:transform .22s ease;z-index:10000;display:flex;flex-direction:column}
  .tk-panel-open #tkOverlay{opacity:1;pointer-events:auto}
  .tk-panel-open #categorySurveyPanel{transform:translateX(0)}
  /* very light internal styling only if we had to create a skeleton */
  .tk-skel header{display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-bottom:1px solid #00e6ff}
  .tk-skel h2{margin:0;font:700 20px/1.2 system-ui}
  .tk-skel .actions{display:flex;gap:8px}
  .tk-skel .btn{background:#081214;border:1px solid #00e6ff;color:#eafcff;border-radius:10px;
    padding:.4rem .7rem;font:600 13px/1 system-ui;cursor:pointer}
  .tk-skel .body{padding:16px 18px;overflow:auto}
  .tk-skel .hint{opacity:.75;font:500 13px/1.4 system-ui}
</style>

<script>
(()=>{

  /* ---------- helpers ---------- */
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const ensure=(id,tag,attrs={})=>{
    let el=document.getElementById(id);
    if(!el){el=document.createElement(tag);el.id=id;Object.assign(el,attrs);document.body.appendChild(el);}
    return el;
  };

  /* ---------- overlay + panel always exist and on top ---------- */
  const scrim = ensure('tkOverlay','div');
  const panel = ensure('categorySurveyPanel','aside');
  if(!panel.hasChildNodes()){
    // We assume the site didn’t render the panel; add a safe skeleton
    panel.classList.add('tk-skel');
    panel.setAttribute('role','dialog'); panel.setAttribute('aria-modal','true'); panel.setAttribute('aria-hidden','true');
    panel.innerHTML = `
      <header>
        <h2>Select categories</h2>
        <div class="actions">
          <button type="button" class="btn" id="tkSelectAll">Select All</button>
          <button type="button" class="btn" id="tkDeselectAll">Deselect All</button>
          <button type="button" class="btn" id="tkClose">Close ✕</button>
        </div>
      </header>
      <div class="body">
        <p class="hint">Panel skeleton loaded. Your real category UI will render here when your app binds data.</p>
        <div id="tkCatMount"></div>
      </div>`;
  }

  function openPanel(){
    document.documentElement.classList.add('tk-panel-open');
    panel.setAttribute('aria-hidden','false');
  }
  function closePanel(){
    document.documentElement.classList.remove('tk-panel-open');
    panel.setAttribute('aria-hidden','true');
  }
  scrim.addEventListener('click', closePanel);
  panel.addEventListener('click', (e)=>{ if(e.target.id==='tkClose') closePanel(); });

  /* ---------- bind to ALL Start Survey variants ---------- */
  function wireStartButtons(){
    const seen = new WeakSet();
    const candidates = [
      '#startSurveyBtn','.start-survey-btn','[data-tk-start]',
      ...$$('button,a').filter(el=>/^\s*start\s+survey\s*$/i.test(el.textContent||'')),
    ].filter(Boolean);

    candidates.forEach(btn=>{
      if(!seen.has(btn)){
        btn.addEventListener('click',(ev)=>{ ev.preventDefault(); openPanel(); }, {passive:false});
        seen.add(btn);
      }
    });
  }
  wireStartButtons();

  /* ---------- optional: expose helpers for quick debugging ---------- */
  window.tkOpenPanel = openPanel;
  window.tkClosePanel = closePanel;

  /* ---------- if your app dispatches an event when UI is ready, hook it ---------- */
  document.addEventListener('tk:ui-ready', ()=>{ /* openPanel(); */ });

  /* ---------- quality-of-life: mark touch listeners passive to silence warnings ---------- */
  try{
    let supportsPassive=false;
    const opt=Object.defineProperty({},"passive",{get(){supportsPassive=true}});
    window.addEventListener("tk-passive",()=>{},opt); window.removeEventListener("tk-passive",()=>{},opt);
    if(supportsPassive && !window.__tkPatchedPassive__){
      window.__tkPatchedPassive__=true;
      const orig=EventTarget.prototype.addEventListener;
      const preferPassive=new Set(["touchstart","touchmove","touchend","wheel"]);
      EventTarget.prototype.addEventListener=function(type,listener,options){
        if(preferPassive.has(type)){
          if(options==null) options={passive:true};
          else if(typeof options==="boolean") options={capture:options,passive:true};
          else if(typeof options==="object" && !("passive" in options)) options={...options,passive:true};
        }
        return orig.call(this,type,listener,options);
      };
    }
  }catch(_){ }

  console.log("[TK] One-paste: panel skeleton ensured and Start Survey wired.");
})();
</script>
<!-- ===== /end one-paste ===== -->
