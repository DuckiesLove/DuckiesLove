<!-- Talk-Kink survey panel overlay + trigger fix -->
<style id="tk-fix-styles">
  /* --- force the drawer to be above the  full-screen overlay --- */
  #tkOverlay.tk-overlay { z-index: 10000 !important; pointer-events: auto; }
  #categorySurveyPanel.category-panel {
    z-index: 10050 !important;
    display: none; visibility: hidden; opacity: 0;
    transition: opacity .18s ease-out;
  }
  /* visible state when we open the panel */
  .tk-panel-open #categorySurveyPanel.category-panel {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
  .tk-panel-open body, body.tk-panel-open { overflow: hidden; }
</style>

<script id="tk-fix-script">
(() => {
  /* small helpers */
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  const panel   = $('#categorySurveyPanel');
  const overlay = $('#tkOverlay');

  if (!panel || !overlay) {
    console.warn('[TK] Fix could not find required nodes:', { panel: !!panel, overlay: !!overlay });
    return;
  }

  /* make sure ARIA doesn't hide the panel while it has focusable children */
  panel.removeAttribute('aria-hidden');

  /* ----- public controls (available in console too) ----- */
  window.tkOpenPanel = function tkOpenPanel() {
    document.documentElement.classList.add('tk-panel-open');
    document.body.classList.add('tk-panel-open');
    panel.style.display   = 'flex';
    panel.style.visibility= 'visible';
    panel.style.opacity   = '1';
    overlay.style.display = 'block';
    overlay.style.visibility = 'visible';
    // focus a safe element if present
    const firstFocusable = panel.querySelector('[tabindex],button,[href],input,select,textarea');
    firstFocusable?.focus({ preventScroll: true });
  };

  window.tkClosePanel = function tkClosePanel() {
    document.documentElement.classList.remove('tk-panel-open');
    document.body.classList.remove('tk-panel-open');
    panel.style.opacity = '0';
    // after fade, fully hide
    setTimeout(() => {
      if (!document.body.classList.contains('tk-panel-open')) {
        panel.style.display = 'none';
        panel.style.visibility = 'hidden';
        overlay.style.display = '';
        overlay.style.visibility = '';
      }
    }, 180);
  };

  /* ----- wire “Start Survey” triggers robustly ----- */
  const startSelectors = [
    '#startSurveyBtn',           // if you have one
    '#startSurvey',              // common id
    '[data-action="start-survey"]',
    '.start-survey-btn'
  ];

  // 1) explicit selectors
  startSelectors.forEach(sel => {
    $$(sel).forEach(el => el.addEventListener('click', e => { e.preventDefault(); tkOpenPanel(); }));
  });

  // 2) text fallback (“Start Survey” buttons or links)
  $$('a,button,[role="button"]').forEach(el => {
    const t = (el.textContent || '').trim().toLowerCase();
    if (t === 'start survey') {
      el.addEventListener('click', e => { e.preventDefault(); tkOpenPanel(); });
    }
  });

  // close wiring (X button / backdrop if you want)
  $('[data-action="close"]')?.addEventListener('click', e => { e.preventDefault(); tkClosePanel(); });
  overlay.addEventListener('click', () => tkClosePanel());

  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.body.classList.contains('tk-panel-open')) tkClosePanel();
  });

  // sanity log & quick probe
  console.log('[TK] Panel wired; overlay=', !!overlay, ' drawer=', !!panel, 'true');
  window.tkProbe = function tkProbe() {
    const vis = el => !!el && el.offsetParent !== null && getComputedStyle(el).visibility !== 'hidden' && getComputedStyle(el).opacity !== '0';
    return [
      { key:'panel',   selector:'#categorySurveyPanel', present: !!panel,   visible: vis(panel)   },
      { key:'overlay', selector:'#tkOverlay',           present: !!overlay, visible: vis(overlay) },
    ];
  };
})();
</script>
