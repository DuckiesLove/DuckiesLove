<!-- === FULL-BLEED BLACK PDF EXPORT (drop this once before </body>) === -->
<style>
  /* Ensure the on-screen page itself is pure black with no gutters */
  html, body { background:#000; color:#fff; margin:0; padding:0; }
  /* Make the app container span the full width */
  .wrap { width:100%; margin:0; padding:0; box-sizing:border-box; }
  /* Consent modal */
  #tk-consent-overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.55);
    z-index:99999;
  }
  #tk-consent-card{
    max-width:520px;
    width:90%;
    background:#111;
    color:#fff;
    border:1px solid #333;
    border-radius:10px;
    padding:16px;
  }
  #tk-consent-card h3{
    margin:0 0 8px 0;
    font:600 16px system-ui;
  }
  #tk-consent-card p{
    margin:0 0 10px 0;
    line-height:1.4;
  }
  #tk-consent-actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:12px;
  }
  .tk-btn{
    padding:8px 14px;
    border-radius:8px;
    border:1px solid #555;
    background:#1f1f1f;
    color:#fff;
    cursor:pointer;
  }
  .tk-btn.primary{
    background:#2a7;
    border-color:#2a7;
  }
</style>

<div id="tk-consent-overlay" aria-modal="true" role="dialog">
  <div id="tk-consent-card">
    <h3>Consent Check</h3>
    <p>Do you have your partner’s consent to export or share this compatibility PDF?</p>
    <div id="tk-consent-actions">
      <button class="tk-btn" id="tk-consent-cancel" type="button">Cancel</button>
      <button class="tk-btn primary" id="tk-consent-confirm" type="button">I Confirm</button>
    </div>
  </div>
</div>

<!-- (Optional) Inline code→name overrides. Fill these in or leave empty. -->
<script>
  window.TK_LABELS = {
    /* Examples – replace/extend with your own:
    "cb_e4bdv": "Dress partner’s outfit",
    "cb_hhxwj": "Pick lingerie / base layers",
    */
  };
</script>

<script>
/*
 * Full-bleed, solid-black PDF export for the compatibility table.
 * - No white margins (0pt all sides)
 * - Uses jsPDF + AutoTable
 * - Translates first column codes (cb_*) via TK_LABELS or /data/labels-overrides.json or /data/kinks.json
 * - Replaces any old window.print() handler on #dl
 *
 * HOW TO USE
 * 1) Ensure your Download button has id="dl" and no inline onclick.
 *    <button id="dl" type="button">Download PDF</button>
 * 2) Paste THIS WHOLE BLOCK once before </body>.
 * 3) (Optional) Fill window.TK_LABELS above with your code→name mapping.
 */
(() => {
  const CDN_JSPDF     = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js';
  const CDN_AUTOTABLE = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js';

  function ensureConsentElements(){
    const overlay = document.getElementById('tk-consent-overlay');
    const confirm = document.getElementById('tk-consent-confirm');
    const cancel = document.getElementById('tk-consent-cancel');
    if (!overlay || !confirm || !cancel) return null;
    return { overlay, confirm, cancel };
  }

  function showConsentModal(){
    const els = ensureConsentElements();
    if (!els) return Promise.resolve(true);

    const { overlay, confirm, cancel } = els;
    overlay.style.display = 'flex';

    return new Promise(resolve => {
      let done = false;
      const cleanup = (result) => {
        if (done) return;
        done = true;
        overlay.style.display = 'none';
        confirm.removeEventListener('click', onConfirm);
        cancel.removeEventListener('click', onCancel);
        overlay.removeEventListener('click', onOverlayClick);
        document.removeEventListener('keydown', onKey);
        resolve(result);
      };

      const onConfirm = () => cleanup(true);
      const onCancel = () => cleanup(false);
      const onOverlayClick = (ev) => { if (ev.target === overlay) cleanup(false); };
      const onKey = (ev) => { if (ev.key === 'Escape') cleanup(false); };

      confirm.addEventListener('click', onConfirm);
      cancel.addEventListener('click', onCancel);
      overlay.addEventListener('click', onOverlayClick);
      document.addEventListener('keydown', onKey);

      confirm.focus?.();
    });
  }

  async function ensureConsent(){
    return await showConsentModal();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('dl');
    if (!btn) return;

    // Remove any old listeners (including window.print()) by cloning
    const clone = btn.cloneNode(true);
    btn.replaceWith(clone);
    clone.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!(await ensureConsent())) return;
      try {
        await ensureLibs();
        const labels = await loadLabels();
        await exportFullBleedPDF(labels);
      } catch (err) {
        console.error('[PDF] Export failed:', err);
        alert('PDF export failed. See console for details.');
      }
    });
  });

  async function ensureLibs() {
    if (!window.jspdf || !window.jspdf.jsPDF) await loadScript(CDN_JSPDF);
    if (!(window.jspdf && 'autoTable' in window.jspdf)) await loadScript(CDN_AUTOTABLE);
  }
  function loadScript(src) {
    return new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = res; s.onerror = () => rej(new Error('Failed to load '+src));
      document.head.appendChild(s);
    });
  }

  // Attempt to obtain a label map from multiple places
  async function loadLabels() {
    // 1) Inline overrides take precedence
    if (window.TK_LABELS && Object.keys(window.TK_LABELS).length) return window.TK_LABELS;

    // 2) Try site JSONs if present
    const tryUrls = [
      '/data/labels-overrides.json', 'data/labels-overrides.json',
      '/data/kinks.json',            'data/kinks.json'
    ];
    for (const url of tryUrls) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) continue;
        const json = await r.json();
        if (json && typeof json === 'object') {
          // Accept either a flat map or an object with .labels
          if (json.labels && typeof json.labels === 'object') return json.labels;
          return json;
        }
      } catch (_) {}
    }
    return {}; // fallback: no mapping
  }

  // Find the comparison table (we render only this)
  function findCompatTable() {
    const looksRight = (t) => t && /Category/i.test(t.textContent) && /Partner A/i.test(t.textContent);
    return Array.from(document.querySelectorAll('table')).find(looksRight) || document.querySelector('table');
  }

  async function exportFullBleedPDF(LABELS) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'landscape' });
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const bleed = 3;

    const tableEl = findCompatTable();
    if (!tableEl) throw new Error('Compatibility table not found.');

    const paintPage = () => {
      if (typeof pdf.setFillColor === 'function') pdf.setFillColor(0,0,0);
      if (typeof pdf.rect === 'function') pdf.rect(-bleed,-bleed,pageW + bleed*2,pageH + bleed*2,'F');
      if (typeof pdf.setTextColor === 'function') pdf.setTextColor(255,255,255);
      if (typeof pdf.setDrawColor === 'function') pdf.setDrawColor(0,0,0);
      if (typeof pdf.setLineWidth === 'function') pdf.setLineWidth(0);
    };

    paintPage();
    try {
      pdf.setFont('helvetica','normal');
    } catch(_) {}

    let primed = false;
    pdf.autoTable({
      html: tableEl,
      theme: 'plain',
      useCss: false,
      startY: -bleed,
      startX: -bleed,
      margin: { top: 0, right: 0, bottom: 0, left: 0 },
      tableWidth: pageW + bleed*2,
      horizontalPageBreak: true,
      styles: {
        cellPadding: 8,
        fillColor: null,
        textColor: 255,
        lineColor: [0,0,0],
        lineWidth: 0,
        halign: 'left',
        valign: 'middle',
        overflow: 'linebreak',
        minCellHeight: 18
      },
      headStyles: {
        fillColor: null,
        textColor: 255,
        fontStyle: 'bold',
        lineColor: [0,0,0],
        lineWidth: 0,
        cellPadding: 10
      },
      tableLineColor: [0,0,0],
      tableLineWidth: 0,
      columnStyles: {
        0: { halign: 'left' },
        1: { halign: 'center' },
        2: { halign: 'center' },
        3: { halign: 'center' }
      },
      didAddPage: () => {
        paintPage();
      },
      willDrawCell: () => {
        if (!primed) {
          primed = true;
          if (typeof pdf.setDrawColor === 'function') pdf.setDrawColor(0,0,0);
          if (typeof pdf.setLineWidth === 'function') pdf.setLineWidth(0);
        }
      },
      // Translate cb_* codes in the first column if mapping exists
      didParseCell: (data) => {
        if (data.section === 'body' && data.column.index === 0) {
          const raw = String((data.cell.text && data.cell.text[0]) || '');
          if (raw.startsWith('cb_') && LABELS && LABELS[raw]) {
            data.cell.text = [LABELS[raw]];
          }
        }
      }
    });

    pdf.save('compatibility.pdf');
  }
})();
</script>
<!-- === END FULL-BLEED BLACK PDF EXPORT === -->
