<!-- Talk-Kink: Hard lock category panel pinned on the left -->
<script id="tk-hard-lock-panel-left-js">
/* === TK HARD LOCK: show + pin category panel on the left ================= */
(() => {
  const log = (...a)=>console.log('[TK lock]',...a);

  // 1) Layout rules: fixed left column for the panel, push content right.
  const css = `
    :root{ --tk-left:420px; --tk-pad:24px; --tk-top:96px }
    body{
      margin-left:calc(var(--tk-left) + var(--tk-pad)) !important;
      transition:margin-left .15s ease;
      overflow:auto !important;
    }
    #tkPinnedPanel{
      position:fixed !important;
      top:var(--tk-top) !important;
      left:var(--tk-pad) !important;
      width:var(--tk-left) !important;
      height:calc(100vh - (var(--tk-top) + 24px)) !important;
      overflow:auto !important;
      display:block !important;
      visibility:visible !important;
      opacity:1 !important;
      pointer-events:auto !important;
      z-index:2147483000 !important;
      transform:none !important;
    }
    /* nuke overlays/scrims */
    #tkOverlay,.tk-overlay,[data-tk="overlay"],.modal-backdrop{ display:none !important; pointer-events:none !important }
    body.tk-panel-open, body.panel-open, body.modal-open{ overflow:auto !important }
    /* ensure only the panel has Start Survey */
    a[href*="kinksurvey"] .btn-start, .start-survey, [data-role="start-survey"]{ display:none !important }
  `;
  const style=document.createElement('style'); style.textContent=css; document.head.append(style);

  // 2) Try to open the panel using site helpers if present.
  const openPanel = () => {
    try { if (typeof window.tkOpenPanel === 'function') tkOpenPanel(); } catch(e){}
    // also click any "Start Survey" triggers the site wired
    document.querySelectorAll('#startSurveyBtn,[data-action="startSurvey"],#start-survey-btn')
      .forEach(el => el.click());
  };

  // 3) Find the actual panel in the DOM.
  const findPanel = () => {
    const picks = [
      '#categorySurveyPanel',
      'aside.category-panel',
      'aside[id*="category"][class*="panel"]',
      '[aria-controls="categorySurveyPanel"]',
      '[data-panel="category"]',
      '.category-panel'
    ];
    for (const sel of picks) {
      const hit = document.querySelector(sel);
      if (hit) {
        // If selector landed on a control, jump to the panel
        if (hit.getAttribute('aria-controls')) {
          const id = hit.getAttribute('aria-controls');
          const tgt = document.getElementById(id);
          if (tgt) return tgt;
        }
        // Otherwise use the element itself (prefer the panel container)
        return hit.closest('aside,section,div') || hit;
      }
    }
    // very broad fallback
    return Array.from(document.querySelectorAll('aside,section,div'))
      .find(n => /category.*panel/i.test(n.id||'') || /category.*panel/i.test(n.className||''));
  };

  // 4) Remove overlay/scrim + body classes that block interaction.
  const neuterOverlay = () => {
    document.querySelector('#tkOverlay')?.remove();
    document.querySelectorAll('.tk-overlay,[data-tk="overlay"],.modal-backdrop').forEach(n=>n.remove());
    document.body.classList.remove('tk-panel-open','panel-open','modal-open');
  };

  // 5) Pin the panel to the left and keep it there.
  const pinPanel = () => {
    const p = findPanel();
    if (!p) return false;

    neuterOverlay();

    if (!document.body.contains(p)) document.body.appendChild(p); // reclaim from portals
    p.id = 'tkPinnedPanel';
    Object.assign(p.style,{
      position:'fixed', left:'24px', top:'96px',
      width:'420px', height:'calc(100vh - 120px)',
      overflow:'auto', display:'block', visibility:'visible',
      opacity:'1', zIndex:'2147483000', transform:'none'
    });

    log('panel pinned', p);
    return true;
  };

  // Run now + retry a bit for late hydration, then watch for DOM changes.
  openPanel();
  let tries = 0, max = 60;
  const timer = setInterval(() => { if (pinPanel() || ++tries >= max) clearInterval(timer); }, 120);

  new MutationObserver(() => pinPanel())
    .observe(document.documentElement, {childList:true, subtree:true, attributes:true});

  // expose a tiny probe if you want to check
  window.tkLockProbe = () => ({
    pinned: !!document.querySelector('#tkPinnedPanel'),
    overlay: !!document.querySelector('#tkOverlay') || !!document.querySelector('.tk-overlay')
  });
})();
</script>
