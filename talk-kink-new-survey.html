<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talk Kink — Survey</title>
<style>
  :root{
    --bg:#000; --fg:#e6ffff; --accent:#00e6ff;
    --panelStart:#0f2834; --panelEnd:#0b1f27; --panelEdge:#23e0ff80;
    --row:#0a1820; --soft:#08161c; --line:#00e5ff44;
    --btn:#071a1f; --btnb:#00e6ff; --btnfg:#eaffff;
    --barBg:#062028; --barFill:#13e0ff;
    --ksv-panel-w:720px;
    --tk-rate-w:6rem;
    --tk-q-gap:.75rem;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* WIDER PAGE */
  .wrap{max-width:1440px;margin:28px auto;padding:0 20px}

  /* Layout shell */
  #tkPortal {
    display: grid;
    grid-template-columns: minmax(320px, 420px) 1fr;
    gap: clamp(16px, 2.4vw, 28px);
    align-items: start;
    width: min(1400px, 100%);
    margin: 0 auto;
    padding: clamp(12px, 2vw, 24px);
    box-sizing: border-box;
  }
  .tk-left {
    min-height: 60vh;
    max-height: calc(100vh - 9rem);
    overflow: auto;
    border: 2px solid rgba(0,255,255,.35);
    border-radius: 16px;
    padding: 16px;
    box-sizing: border-box;
  }
  .tk-right {
    display: grid;
    justify-items: center;
    gap: clamp(18px, 2.8vw, 28px);
  }

  .tk-right .tk-stack {
    display: grid;
    gap: clamp(18px, 2.4vw, 26px);
    width: min(900px, 92vw);
    justify-self: center;
  }

  .tk-right .tk-meta {
    margin-top: 8px;
    opacity: .8;
    text-align: center;
  }

  /* Disabled + ready states for Start button */
  .tk-disabled {
    pointer-events: none !important;
    opacity: .45 !important;
    filter: grayscale(.25);
  }
  .tk-pulse { animation: tkPulse 1.25s ease-in-out infinite; }
  @keyframes tkPulse {
    0%,100% { box-shadow: 0 0 0 0 rgba(0,240,255,.35) }
    50%     { box-shadow: 0 0 0 10px rgba(0,240,255,0) }
  }

  /* Responsive: stack on narrow screens */
  @media (max-width: 980px) {
    #tkPortal { grid-template-columns: 1fr; }
    .tk-left { max-height: none; }
  }

  h1{font-size:clamp(28px,5vw,48px);margin:0 0 18px 0;text-align:center}

  .btn{
    display:inline-block;padding:14px 22px;border:2px solid var(--btnb);
    border-radius:12px;background:var(--btn);color:var(--btnfg);
    cursor:pointer;font-weight:800;letter-spacing:.2px;transition:.15s
  }
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  .btn:hover{transform:translateY(-1px)}
  .btn.xl{padding:16px 26px;font-size:1.05rem}
  .tk-meta select{
    padding:12px 14px;border:2px solid var(--btnb);border-radius:12px;
    background:#05151a;color:var(--fg);font-weight:700
  }

  /* BIGGER, WIDER CATEGORY PANEL */
  .panel{
    border:1px solid var(--panelEdge);border-radius:18px;
    background:linear-gradient(180deg, var(--panelStart) 0%, var(--panelEnd) 100%);
    box-shadow:0 0 0 1px #00141a inset, 0 10px 28px #00121aa6;
    padding:16px;
    /* full width of the wide container */
    width:100%;
    max-height:78vh; overflow:auto; margin:0 auto;
  }
  .category-panel select,
  .category-panel input[type="number"],
  .category-panel input[type="text"][inputmode="numeric"]{
    width:4.5rem !important;
    min-width:4.5rem !important;
    text-align:center;
  }
  .category-panel select,
  .category-panel input[type="number"],
  .category-panel input[type="text"][inputmode="numeric"],
  .category-panel input[type="range"]{
    font-variant-numeric:tabular-nums;
  }
  .category-panel [data-kink-id]{
    display:flex;
    align-items:center;
    gap:16px;
  }
  .panelHeader{
    position:sticky; top:0; z-index:5; padding:10px 12px; margin:-16px -16px 12px;
    background:linear-gradient(180deg,#0d2b36 0%, #0c2028 100%);
    border-bottom:1px solid #00f0ff33; border-radius:18px 18px 0 0;
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  }
  .status{opacity:.9; font-weight:700}

  .alphaGroup{margin:14px 0 18px}
  .alphaHeader{
    position:sticky; top:56px; z-index:2;
    padding:6px 10px; margin:0 0 10px 0; width:fit-content;
    background:#04222b; border:1px solid #0cf2ff33; border-radius:999px; font-weight:900; color:#90f7ff
  }
  /* MORE COLUMNS ON WIDE VIEW — panel fills the 1440px container */
  .alphaGrid{display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));}
  .row{
    border:1px solid var(--line);border-radius:12px;background:var(--row);
    padding:12px 14px; transition:.12s box-shadow, .12s transform;
  }
  .row:hover{box-shadow:0 0 0 1px #00e5ff55; transform:translateY(-1px)}
  .row label{display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:700}

  .notice{margin:14px 0;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:#071317}
  /* SURVEY */
  .survey{margin-top:24px;border:1px solid var(--line);border-radius:14px;background:var(--soft);padding:16px}
  .catTitle{margin:0 0 8px 0;color:#7ef9ff}
  .item{display:flex;align-items:center;gap:10px;padding:8px 0;border-top:1px dashed #00e5ff22}
  .item:first-child{border-top:0}
  select,input[type="text"]{
    padding:6px 8px;border:1px solid #144; border-radius:8px;background:#071820;color:var(--fg)
  }

  /* Keep question + rating aligned */
  .item.tk-qrow,
  .item.item--scale{ /* alias for clarity */
    display:grid;
    grid-template-columns:minmax(0,1fr) var(--tk-rate-w);
    column-gap:var(--tk-q-gap);
    align-items:center;
  }
  .item.tk-qrow .tk-q-label,
  .item.item--scale .tk-q-label{
    grid-column:1 / 2;
    min-width:0;
    overflow-wrap:anywhere;
    word-break:normal;
    line-height:1.35;
  }
  .item.tk-qrow select,
  .item.tk-qrow input[type="number"],
  .item.tk-qrow input[type="text"][inputmode="numeric"],
  .item.tk-qrow .tk-rate,
  .item.item--scale select,
  .item.item--scale input[type="number"],
  .item.item--scale input[type="text"][inputmode="numeric"],
  .item.item--scale .tk-rate{
    grid-column:2 / 3;
    justify-self:end;
    width:100%;
    max-width:var(--tk-rate-w);
    box-sizing:border-box;
  }
  .item.tk-qrow select,
  .item.item--scale select{
    height:2.25rem;
    padding:0 .5rem;
  }
  @media (max-width:480px){
    :root{ --tk-rate-w:4.75rem; }
    .item.tk-qrow,
    .item.item--scale{ column-gap:.5rem; }
    .item.tk-qrow .tk-q-label,
    .item.item--scale .tk-q-label{ font-size:.98rem; }
  }

  /* PROGRESS */
  .progress{
    margin:8px 0 16px 0; padding:10px 12px; border-radius:12px;
    background:linear-gradient(180deg,#0b2530 0%, #0b1e26 100%);
    border:1px solid #0cf2ff33;
  }
  .progressTop{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;font-weight:700}
  .bar{height:12px;border-radius:999px;background:var(--barBg);overflow:hidden;border:1px solid #093642}
  .fill{height:100%;width:0%;background:linear-gradient(90deg,#08d7ff 0%, var(--barFill) 100%);box-shadow:0 0 6px #13e0ff}
  .counter{opacity:.95}
  a.home{color:var(--accent)}

  .selectedCats{
    margin:0 0 18px 0;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid #00e5ff22;
    background:#071820;
  }
  .selectedCats h3{
    margin:0 0 10px 0;
    font-size:1rem;
    color:#7ef9ff;
  }
  .selectedCatsList{
    list-style:decimal inside;
    margin:0;
    padding:0;
    display:grid;
    gap:6px;
  }
  .selectedCatsList li{
    font-weight:600;
    color:#d7fcff;
    opacity:.88;
  }
  .selectedCatsList li.is-current{
    color:#fff;
    opacity:1;
    text-shadow:0 0 6px #00e6ff55;
  }

</style>
</head>
<body>
  <div class="wrap">
    <h1>Talk Kink — Survey</h1>

    <div id="tkPortal">
      <div class="tk-left">
        <!-- WIDE CATEGORY PANEL -->
        <section class="panel category-panel" id="categoryPanel" aria-label="Category selection">
          <div class="panelHeader">
            <button class="btn" id="selectAll">Select All</button>
            <button class="btn" id="deselectAll">Deselect All</button>
            <span class="status" id="statusMsg">Loading categories…</span>
          </div>
          <div id="categoryList"></div>
        </section>
      </div>
      <div class="tk-right">
        <div class="tk-stack" aria-label="Main actions">
          <button class="btn xl tk-disabled" id="startBtn" data-tk-start disabled>Start Survey</button>
          <a class="btn" href="/compatibility/">Compatibility Page</a>
          <a class="btn" href="/ika/">Individual Kink Analysis</a>
        </div>
        <div class="tk-meta" aria-label="Theme">
          <label style="display:flex;gap:10px;align-items:center;justify-content:center">
            <span style="font-weight:800">Theme</span>
            <select id="themeSelect">
              <option value="dark" selected>Dark</option>
              <option value="lipstick">Lipstick</option>
              <option value="forest">Forest</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div id="diag" class="notice" style="display:none"></div>

    <!-- SURVEY -->
    <section id="survey" class="survey" style="display:none">
      <div class="progress" role="group" aria-label="Progress">
        <div class="progressTop">
          <div class="counter" id="catCounter">Category 1 of 1</div>
          <div class="counter" id="qCounter">0 of 0 answered</div>
        </div>
        <div class="bar" aria-label="Questions progress">
          <div class="fill" id="qFill" style="width:0%" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
        </div>
      </div>

      <div class="selectedCats" id="selectedCats" aria-live="polite" style="display:none">
        <h3>Selected categories</h3>
      </div>

      <h2 class="catTitle" id="catTitle"></h2>
      <div id="items"></div>
      <div class="nav" style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn" id="skipBtn">Skip Category</button>
        <button class="btn" id="nextBtn">Next Category</button>
      </div>
    </section>

    <section id="done" class="notice" style="display:none">
      <h3>Survey complete!</h3>
      <p>You’ve reached the end of the selected categories. <a class="home" href="/">Back to home</a></p>
    </section>
  </div>

<script>
(async function(){
  /* ---------- data fetch ---------- */
  async function safeJson(url) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) {
        return { data: null, error: `HTTP ${res.status} ${res.statusText || ''}`.trim() };
      }
      const text = await res.text();
      if (!text || !text.trim()) {
        return { data: null, error: 'Empty response body' };
      }
      try {
        return { data: JSON.parse(text), error: null };
      } catch (err) {
        return { data: null, error: `Invalid JSON (${err?.message || 'parse error'})` };
      }
    } catch (err) {
      return { data: null, error: err?.message || 'Network error' };
    }
  }

  async function loadKinksDataset() {
    const v = Date.now();
    const urls = [
      `/data/kinks.json?v=${v}`,
      `/kinksurvey/data/kinks.json?v=${v}`,
      `data/kinks.json?v=${v}`
    ];
    const errors = [];
    for (const u of urls) {
      const { data, error } = await safeJson(u);
      if (data) {
        const summary = Array.isArray(data)
          ? `${data.length} top-level entries`
          : `object with ${Object.keys(data || {}).length} keys`;
        console.log(`[TK DEBUG] Kinks data loaded from ${u} (${summary})`, data);
        return { dataset: data, source: u, errors };
      }
      if (error) {
        console.warn(`[TK WARNING] Kinks dataset fetch issue for ${u}: ${error}`);
        errors.push(`${u}: ${error}`);
      }
    }
    return { dataset: null, source: null, errors };
  }

  const el = (id)=>document.getElementById(id);
  const $panel = el('categoryPanel');
  const $list  = el('categoryList');
  const $status= el('statusMsg');
  const $diag  = el('diag');
  const $start = el('startBtn');
  const $survey= el('survey');
  const $title = el('catTitle');
  const $items = el('items');
  const $done  = el('done');
  const $selectedCats = el('selectedCats');
  const $catCounter = el('catCounter');
  const $qCounter   = el('qCounter');
  const $qFill      = el('qFill');

  const LS_KEY = '__TK_SELECTED_CATEGORIES';
  const state = { cats:[], sel:[], idx:0 };
  const savedSet = new Set();

  function loadSaved(){
    try {
      const raw = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      return Array.isArray(raw) ? raw.map(v => String(v ?? '').trim()).filter(Boolean) : [];
    } catch {
      return [];
    }
  }

  function saveSelection(ids){
    try {
      const uniq = Array.from(new Set(ids.map(v => String(v ?? '').trim()).filter(Boolean)));
      localStorage.setItem(LS_KEY, JSON.stringify(uniq));
    } catch {}
  }

  const tidy = (s)=>String(s??'').replace(/\s+/g,' ').trim();
  const slugify = (s)=>{
    const base = tidy(s).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
    return base || 'cat_'+Math.random().toString(36).slice(2,8);
  };
  function normalize(raw){
    const out = [];
    const push = (name, items)=>{
      const cat = tidy(name); if(!cat) return;
      const good=[];
      (items||[]).forEach(it=>{
        const id=tidy(it?.id||it?.key||it?.name||'');
        const label=tidy(it?.label||it?.text||'');
        const type=tidy(it?.type||'scale');
        if(id && label) good.push({id,label,type});
      });
      if(good.length) out.push({category:cat, items:good});
    };
    if (Array.isArray(raw)) raw.forEach(x=>push(x?.category ?? x?.name, x?.items));
    else if (raw && typeof raw==='object') Object.entries(raw).forEach(([k,v])=>push(k,v));
    return out;
  }

  /* ========== RENDER: WIDE, ALPHABETICAL PANEL ========== */
  function groupAlpha(cats){
    const grouped = new Map();
    cats.forEach(c=>{
      const ch = c.category.charAt(0).toUpperCase();
      const key = /[A-Z]/.test(ch) ? ch : '#';
      if(!grouped.has(key)) grouped.set(key, []);
      grouped.get(key).push(c);
    });
    for (const [, arr] of grouped) arr.sort((a,b)=>a.category.localeCompare(b.category,'en',{sensitivity:'base'}));
    const letters = Array.from(grouped.keys()).filter(l=>l!=='#').sort();
    if (grouped.has('#')) letters.push('#');
    return {grouped, letters};
  }

  function renderPanel(cats){
    $list.innerHTML='';
    const {grouped, letters} = groupAlpha(cats);
    letters.forEach(letter=>{
      const box = document.createElement('section'); box.className='alphaGroup';
      const h = document.createElement('div'); h.className='alphaHeader'; h.textContent = letter;
      const grid = document.createElement('div'); grid.className='alphaGrid';
      grouped.get(letter).forEach(c=>{
        const id='cb_'+Math.random().toString(36).slice(2,7);
        const slug = slugify(c.category);
        const row=document.createElement('div');
        row.className='row';
        row.setAttribute('role','listitem');
        row.dataset.kinkId = slug;
        row.innerHTML=`<label for="${id}"><input id="${id}" type="checkbox" value="${c.category}"> ${c.category}</label>`;
        const cb = row.querySelector('input[type="checkbox"]');
        if (cb){
          cb.name = `cat_${slug}`;
          cb.dataset.kinkId = slug;
          cb.checked = savedSet.has(c.category.toLowerCase());
        }
        grid.appendChild(row);
      });
      box.appendChild(h); box.appendChild(grid);
      $list.appendChild(box);
    });
    updateStart();
  }

  function selected(){
    if (!$list) return [];
    return Array.from($list.querySelectorAll('input[type="checkbox"]'))
      .filter(cb=>cb.checked)
      .map(cb=>cb.value?.trim())
      .filter(Boolean);
  }
  function updateStart(){
    const sel = selected().length;
    const ready = sel > 0;
    $start.disabled = !ready;
    $start.classList.toggle('tk-disabled', !ready);
    $start.classList.toggle('tk-pulse', ready);
    $status.textContent = `${sel} selected / ${state.cats.length} total`;
  }
  function persistSelection(){
    const ids = selected();
    savedSet.clear();
    ids.forEach(id => savedSet.add(id.toLowerCase()));
    saveSelection(ids);
  }
  function showDiag(msg){ $diag.style.display='block'; $diag.textContent=msg; }
  function showDatasetError(message){
    const msg = message || 'Failed to load kink data. Check your internet or JSON file structure.';
    showDiag(msg);
    if ($status) $status.textContent = 'Dataset unavailable';
    if ($panel){
      $panel.innerHTML = '';
      const notice = document.createElement('div');
      notice.className = 'notice';
      notice.style.margin = '0';
      notice.textContent = msg;
      $panel.appendChild(notice);
      $panel.style.display = 'block';
    }
    if ($start){
      $start.disabled = true;
      $start.classList.add('tk-disabled');
      $start.classList.remove('tk-pulse');
    }
  }

  /* ---------- per-category progress ---------- */
  function isAnswered(ctrl){
    if (ctrl.tagName === 'SELECT') return ['1','2','3','4','5'].includes(ctrl.value);
    if (ctrl.type === 'checkbox') return ctrl.checked === true;
    if (ctrl.type === 'text') return ctrl.value.trim().length > 0;
    return false;
  }
  function setupQProgress(controls){
    function update(){
      const total = controls.length;
      let answered = 0;
      controls.forEach(c => { if (isAnswered(c)) answered++; });
      $qCounter.textContent = `${answered} of ${total} answered`;
      const pct = total ? Math.round((answered/total)*100) : 0;
      $qFill.style.width = pct+'%';
      $qFill.setAttribute('aria-valuenow', pct);
    }
    controls.forEach(c => c.addEventListener('change', update));
    update();
  }

  function renderCategory(i){
    const c = state.sel[i];
    highlightSelectedCategory();
    if(!c){ $survey.style.display='none'; $done.style.display='block'; return; }
    $done.style.display='none';
    $survey.style.display='block';
    $catCounter.textContent = `Category ${i+1} of ${state.sel.length}`;
    $title.textContent = c.category;
    $items.innerHTML='';
    c.items.forEach(it=>{
      const row=document.createElement('div');
      row.className='item';
      const inputId='k_'+it.id;
      const t=(it.type||'scale').toLowerCase();
      row.dataset.type = t;

      if (t==='bool'){
        row.classList.add('item--bool');
        row.innerHTML = `<input type="checkbox" id="${inputId}" name="${it.id}"> <label for="${inputId}">${it.label}</label>`;
      } else if (t==='text'){
        row.classList.add('item--text');
        row.innerHTML = `<input type="text" id="${inputId}" name="${it.id}" placeholder="Your note"> <label for="${inputId}">${it.label}</label>`;
      } else {
        row.classList.add('tk-qrow','item--scale');
        row.innerHTML =
          `<label class="tk-q-label" for="${inputId}">${it.label}</label>
           <select id="${inputId}" name="${it.id}">
             <option value="" selected hidden>–</option>
             <option value="1">1</option>
             <option value="2">2</option>
             <option value="3">3</option>
             <option value="4">4</option>
             <option value="5">5</option>
           </select>`;
      }
      $items.appendChild(row);
    });
    const controls = Array.from($items.querySelectorAll('select,input[type="checkbox"],input[type="text"]'));
    setupQProgress(controls);
  }

  function highlightSelectedCategory(){
    if (!$selectedCats) return;
    const rows = Array.from($selectedCats.querySelectorAll('li[data-index]'));
    rows.forEach(li => {
      const idx = Number(li.dataset.index);
      li.classList.toggle('is-current', idx === state.idx);
    });
  }

  function renderSelectedCategories(){
    if (!$selectedCats) return;
    if (!state.sel.length){
      $selectedCats.style.display = 'none';
      $selectedCats.innerHTML = '<h3>Selected categories</h3>';
      return;
    }
    const list = document.createElement('ol');
    list.className = 'selectedCatsList';
    state.sel.forEach((cat, idx) => {
      const li = document.createElement('li');
      li.textContent = cat.category;
      li.dataset.index = String(idx);
      if (idx === state.idx) li.classList.add('is-current');
      list.appendChild(li);
    });
    $selectedCats.innerHTML = '<h3>Selected categories</h3>';
    $selectedCats.appendChild(list);
    $selectedCats.style.display = 'block';
  }

  /* ---------- bindings ---------- */
  $panel.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('input[type="checkbox"]')){
      persistSelection();
      updateStart();
    }
  });
  document.getElementById('selectAll').addEventListener('click', ()=>{
    $panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);
    persistSelection();
    updateStart();
  });
  document.getElementById('deselectAll').addEventListener('click', ()=>{
    $panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
    persistSelection();
    updateStart();
  });

  document.getElementById('startBtn').addEventListener('click', ()=>{
    const choice = selected();
    if (!choice.length) return;
    saveSelection(choice);
    savedSet.clear();
    choice.forEach(id => savedSet.add(id.toLowerCase()));
    const want = new Set(choice.map(s=>s.toLowerCase()));
    state.sel = state.cats
      .slice()
      .filter(c=>want.has(c.category.toLowerCase()))
      .sort((a,b)=>a.category.localeCompare(b.category,'en',{sensitivity:'base'})); // alphabetical in survey too
    state.idx = 0;
    if (!state.sel.length){ showDiag('No matching categories in dataset.'); return; }
    $panel.style.display='none';
    renderSelectedCategories();
    renderCategory(state.idx);
    window.__TK_SURVEY_STARTED = true;
    const evt = new CustomEvent('tk:start-survey', { detail: { includeCategories: choice }});
    document.dispatchEvent(evt);
    setTimeout(()=>{
      if (!window.__TK_SURVEY_STARTED){
        const u = new URL('/kinksurvey/', location.origin);
        u.searchParams.set('run','1');
        if (choice.length) u.searchParams.set('cats', choice.join(','));
        location.assign(u.toString());
      }
    }, 120);
  });

  document.getElementById('skipBtn').addEventListener('click', ()=>{ state.idx++; renderCategory(state.idx); });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ state.idx++; renderCategory(state.idx); });

  /* ---------- boot ---------- */
  try{
    const info = await loadKinksDataset();
    if (!info.dataset) {
      const errMsg = info.errors?.length ? info.errors.join(' | ') : 'Dataset unavailable. Expected /data/kinks.json';
      const error = new Error(errMsg);
      error.errors = info.errors || [];
      throw error;
    }
    state.cats = normalize(info.dataset);
    if (!state.cats.length) {
      console.warn('[TK WARNING] Kink data is empty or malformed.', info.dataset);
      showDatasetError('Kink data is missing or broken. Please check kinks.json formatting.');
      return;
    }
    console.log(`[TK DEBUG] Normalized kink categories ready: ${state.cats.length}`, info.source);
    state.cats.sort((a,b)=>a.category.localeCompare(b.category,'en',{sensitivity:'base'}));

    const saved = loadSaved();
    if (saved.length){
      const byName = new Map(state.cats.map(c => [c.category.toLowerCase(), c.category]));
      const cleaned = [];
      savedSet.clear();
      saved.forEach(id => {
        const canonical = byName.get(id.toLowerCase());
        if (canonical){
          savedSet.add(canonical.toLowerCase());
          cleaned.push(canonical);
        }
      });
      if (cleaned.length !== saved.length) saveSelection(cleaned);
    } else {
      savedSet.clear();
    }

    renderPanel(state.cats);
    persistSelection();
  }catch(e){
    const msg = e?.message || 'Dataset unavailable. Expected /data/kinks.json';
    console.error('[TK ERROR] Failed to fetch or parse kinks.json:', msg);
    showDatasetError('Failed to load kink data. Check your internet or JSON file structure.');
    if (Array.isArray(e?.errors) && e.errors.length) {
      e.errors.forEach(line => console.warn('[TK WARNING]', line));
    }
  }
})();
</script>
<!-- TK: Kink Survey helpers (zero defaults, download JSON on completion) -->
<script>
/* =====================================================================
   TalkKink – Survey export that Compatibility & IKA accept
   - All ratings default to 0 on load.
   - Completion footer shows “Download Survey”.
   - Exported JSON contains multiple shapes (answersByKey, answers, ratings,
     and cells+keys) so the compatibility page can always consume it.
   ===================================================================== */

(function () {
  const $  = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  /* ----------------------- 0) Utility ----------------------- */
  function normLabel(s){ return (s||'').replace(/\s+/g,' ').replace(/\u00a0/g,' ').trim().toLowerCase(); }

  async function fetchFirst(urls){
    const errors = [];
    for (const url of urls){
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok){ errors.push(`${url}: HTTP ${res.status}`); continue; }
        const txt = await res.text();
        if (/^\s*</.test(txt)){ errors.push(`${url}: HTML`); continue; } // 404 page etc.
        return { json: JSON.parse(txt), url };
      }catch(e){ errors.push(`${url}: ${e.message||e}`); }
    }
    return { json:null, url:null, errors };
  }

  /* ----------------------- 1) Start all ratings at 0 ----------------------- */
  function zeroAllRatings(){
    const controls = $$([
      'select[data-rating]',
      '.kink-row select',
      '.kink-row input[type="number"]',
      '.ksv-row select',
      '.ksv-row input[type="number"]',
      'select[data-score]',
      'input[type="number"][data-score]',
      'input[type="range"][data-score]'
    ].join(','));

    controls.forEach(el => {
      // only set if empty/invalid
      const v = (el.value ?? '').trim();
      if (v === '' || isNaN(Number(v))){
        el.value = '0';
        el.dispatchEvent(new Event('input',  { bubbles:true }));
        el.dispatchEvent(new Event('change', { bubbles:true }));
      }
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', zeroAllRatings, { once:true });
  }else{
    zeroAllRatings();
  }

  /* ----------------------- 2) Load canonical keys from kinks.json ----------------------- */
  const KINKS_URLS = [
    '/data/kinks.json',
    '/kinksurvey/data/kinks.json',
    '/kinksurvey/kinks.json',
    '/kinks.json',
    '/assets/kinks.json'
  ];

  function flattenKinks(kjson){
    const list = [];
    const visit = (n) => {
      if (!n) return;
      if (Array.isArray(n)){ n.forEach(visit); return; }
      if (n.items)     visit(n.items);
      if (n.kinks)     visit(n.kinks);
      if (n.children)  visit(n.children);
      if (n.key && n.label) list.push({ key:n.key, label:n.label });
    };
    visit(kjson);
    const byLabel = Object.create(null);
    list.forEach(it => byLabel[normLabel(it.label)] = it.key);
    return { list, byLabel };
  }

  /* ----------------------- 3) Scrape ratings from DOM ----------------------- */
  function inferRowLabel(row){
    const el = row.querySelector('[data-kink-label], .kink-label, .ksv-label, .label, .tk-kink-label, h4, .title');
    if (el) return el.textContent || '';
    const clone = row.cloneNode(true);
    $$('select,input,button', clone).forEach(n => n.remove());
    return clone.textContent || '';
  }

  function collectAnswers(keyLookup /* {byLabel}? */){
    const rows = $$('[data-kink-id], [data-kink-key], .kink-row, .ksv-row');
    const answers = [];
    const answersByKey = Object.create(null);
    const answersById  = Object.create(null);

    rows.forEach(row => {
      const id  = row.getAttribute('data-kink-id')  || row.dataset.kinkId  || row.dataset.id  || row.id || null;
      let   key = row.getAttribute('data-kink-key') || row.dataset.kinkKey || row.dataset.key || null;
      const labelText = inferRowLabel(row);

      const ctl = row.querySelector('select, input[type="range"], input[type="number"]');
      const rating = Number((ctl && ctl.value) || 0);

      if (!key && keyLookup){
        const lab = normLabel(labelText);
        key = keyLookup.byLabel[lab] || null;
      }

      if (id || key){
        const label = labelText ? labelText.trim() : null;
        answers.push({ id:id ?? null, key:key ?? null, label, rating });
        if (id)  answersById[id]  = rating;
        if (key) answersByKey[key] = rating;
      }
    });

    return { answers, answersByKey, answersById };
  }

  /* ----------------------- 4) Build export payload (union shape) ----------------------- */
  async function buildPayload(){
    // 4a. Try to obtain canonical keys
    let keysMeta = null;
    let keys = [];
    try{
      const r = await fetchFirst(KINKS_URLS);
      if (r.json){
        keysMeta = flattenKinks(r.json);
        keys = keysMeta.list.map(it => it.key);
      }
    }catch(e){ /* non-fatal */ }

    // 4b. Collect ratings and build multiple shapes
    const { answers, answersByKey, answersById } = collectAnswers(keysMeta);

    // ratings map (alias of answersByKey)
    const ratings = Object.assign({}, answersByKey);

    // cells aligned to keys order (only if we have keys)
    let cells = null;
    if (keys.length){
      cells = keys.map(k => Number(answersByKey[k] || 0));
    }

    const now = new Date().toISOString();
    const schemaId = 'tk-survey.v1';
    let site = '';
    try{
      site = window.location && window.location.origin ? window.location.origin : '';
    }catch(_e){ site = ''; }
    if (site === 'file://') site = '';
    return {
      // meta / identity
      $schema: "https://talkkink.org/schemas/kink-survey-result.v1.json",
      schema: schemaId,
      app: "talkkink",
      tool: "kinksurvey",
      type: "kink-survey-export",
      version: 1,
      generatedAt: now,
      site: site || undefined,

      // preferred fast path for compatibility/IKA
      answersByKey,         // { key: rating }
      answers,              // [ {id?, key?, rating} ... ]
      ratings,              // alias (some loaders look for this)
      answersById,          // if IDs exist in DOM

      // matrix form (row-order) – for loaders that expect positional cells
      keys: keys.length ? keys : undefined,
      cells: cells || undefined,

      // provenance (debug)
      kinksSource: keysMeta ? "resolved" : "unknown"
    };
  }

  function download(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.download = filename;
    a.href = URL.createObjectURL(blob);
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  async function onDownloadSurvey(){
    const payload = await buildPayload();
    const ts = new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
    download(`tk-survey_${ts}.json`, payload);
  }

  /* ----------------------- 5) Replace “Back to home” with Download button ----------------------- */
  function installCompleteObserver(){
    const obs = new MutationObserver(() => {
      // look for any completion region
      const box =
        $('[data-survey-complete], .survey-complete, .ksv-complete') ||
        Array.from($$('.notice, .card, div')).find(n => /survey\s+complete/i.test(n.textContent||''));
      if (!box) return;

      // remove “back to home” if present
      const back = Array.from(box.querySelectorAll('a,button'))
        .find(el => /back\s+to\s+home/i.test(el.textContent||''));
      if (back) back.remove();

      if (!$('#tkDownloadSurveyBtn')){
        const btn = document.createElement('button');
        btn.id = 'tkDownloadSurveyBtn';
        btn.type = 'button';
        btn.textContent = 'Download Survey';
        btn.style.cssText = `
          margin-top:16px; padding:12px 18px; font-weight:800;
          color:#001315; background:#00e6ff; border:0; border-radius:12px;
          cursor:pointer; box-shadow:0 0 0 2px rgba(0,230,255,.35) inset;
        `;
        btn.addEventListener('click', onDownloadSurvey);
        box.appendChild(btn);
      }
    });
    obs.observe(document.body, { childList:true, subtree:true });
  }
  installCompleteObserver();
})();
</script>

</body>
</html>
