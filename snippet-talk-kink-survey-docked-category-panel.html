<!-- ================= TK DOCKED SURVEY LAYOUT (kinksurvey only) ================= -->
<style id="tkDockStyles">
  :root { --tk-railW: clamp(260px, 25vw, 420px); }

  html.tk-dock body { overflow: hidden; } /* no page scroll behind the dock */

  /* Left-side blackout to stop the blurred homepage CTA from showing */
  #tkDockBackdrop {
    position: fixed; inset: 0 var(--tk-railW) 0 0;
    background:#000; z-index: 2147483638;
  }

  /* Right, fixed rail (1/4) */
  #tkRightRail {
    position: fixed; inset: 0 0 0 auto;
    width: var(--tk-railW);
    display: flex; flex-direction: column; gap: 18px;
    padding: 24px 20px;
    background: transparent;
    z-index: 2147483640;
    pointer-events: auto;
  }

  #tkRightRail h3 {
    margin: 0 0 6px; font: 700 18px/1.2 system-ui,Segoe UI,Arial; color:#bafcff; letter-spacing:.2px;
  }

  #tkRightRail .tk-rail-btn {
    display: block; width: 100%;
    border: 2px solid #00e5ff; border-radius: 16px;
    padding: 16px 18px; text-align: center; text-decoration: none;
    font: 800 20px/1 system-ui,Segoe UI,Arial; color:#bafcff; background: rgba(0,0,0,.35);
    box-shadow: 0 0 18px rgba(0,229,255,.15) inset, 0 0 22px rgba(0,229,255,.08);
    transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
  }
  #tkRightRail .tk-rail-btn:hover { transform: translateY(-1px); box-shadow:0 0 22px rgba(0,229,255,.24) inset, 0 0 26px rgba(0,229,255,.14); }
  #tkRightRail .tk-rail-btn:active { transform: translateY(0); }

  /* The survey panel fills the left 3/4, always visible */
  #categorySurveyPanel {
    position: fixed !important;
    inset: 0 var(--tk-railW) 0 0 !important;
    display: block !important;
    z-index: 2147483639 !important;
  }
  #categorySurveyPanel .panel {
    position: absolute !important; inset: 0 !important;
    display: grid; grid-template-rows: auto auto 1fr auto;
    gap: 12px; height: 100%; overflow: hidden;
    padding: 18px; border: 2px solid var(--teal,#00e5ff);
    border-radius: 16px; background:#000; color:#fff;
    box-shadow: 0 12px 40px rgba(0,0,0,.6);
  }
  #categorySurveyPanel .tk-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  #categorySurveyPanel .tk-actions { display:flex; gap:10px; align-items:center; }
  #categorySurveyPanel .themed-button { border:2px solid #00e5ff; border-radius:12px; padding:10px 14px; color:#bafcff; background:#02191c; font-weight:800; cursor:pointer; }
  #categorySurveyPanel .themed-button:hover { background:#052228; }

  #categoryChecklist {
    display:grid;
    grid-template-columns:repeat(2,minmax(320px,1fr));
    gap:18px;
    align-items:stretch;
    padding-right:6px;
    overflow:auto;
  }
  #categoryChecklist label {
    display:flex; align-items:center; gap:14px;
    padding:16px 18px;
    min-height:64px;
    border:2px solid var(--teal,#00e5ff);
    border-radius:16px;
    background:rgba(0,0,0,.45);
    box-shadow:0 0 0 1px rgba(0,229,255,.08) inset;
    transition:transform .06s ease, box-shadow .12s ease, background .12s ease;
    cursor:pointer;
  }
  #categoryChecklist label:hover {
    background:rgba(0,0,0,.6);
    box-shadow:0 0 0 2px rgba(0,229,255,.25) inset;
    transform:translateY(-1px);
  }
  #categoryChecklist input[type="checkbox"] {
    width:22px;
    height:22px;
    flex:0 0 auto;
    accent-color:var(--teal,#00e5ff);
  }
  #categoryChecklist label span {
    font-size:clamp(16px,1.6vw,18.5px);
    font-weight:700;
    letter-spacing:.2px;
    line-height:1.2;
  }
  #categoryChecklist input[type="checkbox"]:checked + span {
    text-shadow:0 0 12px rgba(0,229,255,.35);
  }
  #categoryChecklist input[type="checkbox"]:checked:focus-visible {
    outline:2px solid var(--teal,#00e5ff);
    outline-offset:3px;
  }
  @media (max-width:980px){
    #categoryChecklist{ grid-template-columns:1fr; }
  }

  /* Sticky footer so Start button is always reachable & at bottom of list */
  #tkPanelFooter {
    position: sticky; bottom: 0;
    padding-top: 10px; margin-top: 6px;
    background: linear-gradient(to top, #000 65%, rgba(0,0,0,0));
  }
  #beginSurveyFromPanel {
    width: 100%;
    padding: 14px 16px; border-radius: 14px;
    border: 2px solid #00e5ff; background:#00e5ff; color:#001a1d;
    font: 900 20px/1 system-ui,Segoe UI,Arial; cursor: pointer;
  }

  /* Hide the original homepage CTAs so they donâ€™t sit behind the panel */
  .tk-hidden { display: none !important; }
</style>

<aside id="categorySurveyPanel" role="dialog" aria-label="Category selection" aria-modal="true" aria-hidden="false">
  <div class="panel">
    <div class="tk-header">
      <h2 style="margin:0">Select categories</h2>
      <div class="tk-actions">
        <button id="btnSelectAll"   class="themed-button">Select All</button>
        <button id="btnDeselectAll" class="themed-button">Deselect All</button>
        <span id="selectedCountBadge" style="opacity:.75">0 selected / 0 total</span>
      </div>
    </div>

    <!-- optional helper line -->
    <div style="opacity:.68">Choose everything you want included. The Start button is at the bottom.</div>

    <div id="categoryChecklist" aria-live="polite" aria-busy="true"></div>

    <div id="tkPanelFooter">
      <button id="beginSurveyFromPanel" class="themed-button" style="background:#00e5ff;color:#001a1d;border-color:#00e5ff;">Start Survey</button>
    </div>
  </div>
</aside>

<!-- Right rail -->
<div id="tkRightRail" aria-label="Survey utilities" hidden>
  <h3>Shortcuts</h3>
  <a id="tkGoCompat" class="tk-rail-btn" href="#">Compatibility Page</a>
  <a id="tkGoIndividual" class="tk-rail-btn" href="#">Individual Kink Analysis</a>
</div>

<div id="tkDockBackdrop" aria-hidden="true"></div>

<script>
(() => {
  document.documentElement.classList.add('tk-dock');

  /* 1) Wire right-rail buttons to your existing links, then hide the originals */
  const findByText = (txt) => {
    const nodes = Array.from(document.querySelectorAll('a,button'));
    const norm = s => s.replace(/\s+/g,' ').trim().toLowerCase();
    const tgt = norm(txt);
    return nodes.find(n => norm(n.textContent) === tgt);
  };

  const btnCompat    = findByText('Compatibility Page');
  const btnIndividual= findByText('Individual Kink Analysis');

  const rail = document.getElementById('tkRightRail');
  if (btnCompat)    { document.getElementById('tkGoCompat').href    = btnCompat.href || '#';    }
  if (btnIndividual){ document.getElementById('tkGoIndividual').href= btnIndividual.href || '#';}

  // show rail now that links are set (fallback to # if not found)
  rail.hidden = false;

  // hide original trio of big CTAs so they never peek through
  ['Start Survey','Compatibility Page','Individual Kink Analysis'].forEach(txt=>{
    const n = findByText(txt);
    if (!n) return;
    // hide closest reasonable wrapper
    let wrap = n.closest('a,button,div,section,aside,li') || n;
    wrap.classList.add('tk-hidden');
  });

  /* 2) Build the categories into the left panel */
  const LOG = (...a)=>console.log('[TK cats]', ...a);
  const $  = (sel, root=document)=>root.querySelector(sel);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const DATA_URL = '/data/kinks.json';
  const KEY      = '__TK_SELECTED_CATEGORIES';

  function normItems(raw) {
    const CHILD_KEYS = ['items', 'categories', 'cats', 'kinks', 'data', 'rows'];

    function flatten(value) {
      if (!value) return [];
      if (Array.isArray(value)) {
        const out = [];
        for (const entry of value) {
          if (entry == null) continue;
          if (Array.isArray(entry)) {
            out.push(...flatten(entry));
            continue;
          }
          if (typeof entry === 'object') {
            let nested = [];
            for (const key of CHILD_KEYS) {
              if (key in entry) {
                nested = flatten(entry[key]);
                if (nested.length) break;
              }
            }
            if (nested.length) {
              out.push(...nested);
              continue;
            }
          }
          out.push(entry);
        }
        return out;
      }
      if (typeof value === 'object') {
        for (const key of CHILD_KEYS) {
          if (!(key in value)) continue;
          const nested = flatten(value[key]);
          if (nested.length) return nested;
        }
        if ('id' in value || 'name' in value || 'label' in value || 'title' in value || 'value' in value || 'slug' in value) {
          return [value];
        }
        return Object.entries(value).map(([id, val]) => {
          if (val && typeof val === 'object') {
            return { id, ...val };
          }
          return { id, name: val };
        });
      }
      return [];
    }

    function toEntry(item, index) {
      if (item == null) return null;
      if (typeof item === 'string' || typeof item === 'number') {
        const value = String(item).trim();
        if (!value) return null;
        return { id: value || String(index + 1), name: value };
      }
      if (typeof item !== 'object') return null;
      const id = String(item.id ?? item.ID ?? item.value ?? item.slug ?? item.code ?? item.key ?? '').trim();
      const name = String(item.name ?? item.title ?? item.label ?? item.slug ?? item.code ?? item.id ?? `Item ${index + 1}`).trim();
      if (!id && !name) return null;
      return {
        id: id || name || String(index + 1),
        name: name || id || `Item ${index + 1}`
      };
    }

    const alpha = { sensitivity: 'base' };
    return flatten(raw)
      .map(toEntry)
      .filter(Boolean)
      .sort((a, b) => a.name.localeCompare(b.name, undefined, alpha));
  }

  async function loadData() {
    if (Array.isArray(window.__TK_KINK_DATA) && window.__TK_KINK_DATA.length) {
      LOG('using preloaded __TK_KINK_DATA');
      return normItems(window.__TK_KINK_DATA);
    }
    try {
      LOG('fetching', DATA_URL);
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const json = await res.json();
      const items = normItems(json);
      window.__TK_KINK_DATA = items;
      return items;
    } catch (e) {
      console.warn('[TK cats] fetch failed:', e);
      return normItems([
        { id: 'demo-1', name: '(demo) Bondage' },
        { id: 'demo-2', name: '(demo) Roleplay' },
        { id: 'demo-3', name: '(demo) Impact' }
      ]);
    }
  }

  function getCheckedIds(list) {
    return list ? $$('input[type="checkbox"]:checked', list).map((n) => n.value) : [];
  }

  function updateBadge() {
    const list = $('#categoryChecklist');
    const selected = list ? $$('input[type="checkbox"]:checked', list).length : 0;
    const total = list ? $$('input[type="checkbox"]', list).length : 0;
    const badge = $('#selectedCountBadge');
    if (badge) badge.textContent = `${selected} selected / ${total} total`;
    const ids = getCheckedIds(list);
    try {
      localStorage.setItem(KEY, JSON.stringify(ids));
    } catch {}
    return ids;
  }

  function restoreSelections() {
    let ids = [];
    try {
      ids = JSON.parse(localStorage.getItem(KEY) || '[]');
    } catch {}
    if (!ids.length) {
      updateBadge();
      return;
    }
    const list = $('#categoryChecklist');
    ids.forEach((id) => {
      try {
        const cb = list?.querySelector(`input[type="checkbox"][value="${CSS.escape(String(id))}"]`);
        if (cb) cb.checked = true;
      } catch {}
    });
    updateBadge();
  }

  function wireBulkButtons() {
    const list = $('#categoryChecklist');
    const btnAll = $('#btnSelectAll');
    if (btnAll && !btnAll.dataset.tkBulkWired) {
      btnAll.dataset.tkBulkWired = '1';
      btnAll.addEventListener('click', () => {
        $$('input[type="checkbox"]', list).forEach((cb) => {
          cb.checked = true;
        });
        updateBadge();
      });
    }
    const btnNone = $('#btnDeselectAll');
    if (btnNone && !btnNone.dataset.tkBulkWired) {
      btnNone.dataset.tkBulkWired = '1';
      btnNone.addEventListener('click', () => {
        $$('input[type="checkbox"]', list).forEach((cb) => {
          cb.checked = false;
        });
        updateBadge();
      });
    }
  }

  function wireStartButton() {
    const btn = $('#beginSurveyFromPanel');
    if (!btn || btn.dataset.tkStartWired) return;
    btn.dataset.tkStartWired = '1';
    btn.addEventListener('click', () => {
      const ids = updateBadge();
      document.dispatchEvent(new CustomEvent('tk:start-survey', { detail: { includeCategories: ids } }));
      setTimeout(() => {
        if (!window.__TK_SURVEY_STARTED) {
          const u = new URL(location.origin + '/kinksurvey/');
          u.searchParams.set('run', '1');
          if (ids.length) u.searchParams.set('cats', ids.join(','));
          location.assign(u.toString());
        }
      }, 120);
    });
  }

  function render(items) {
    const list = $('#categoryChecklist');
    if (!list) return;

    list.setAttribute('aria-busy', 'true');
    list.innerHTML = '';

    if (!items.length) {
      list.innerHTML = '<div style="opacity:.75;padding:18px 4px;">No categories found yet. The panel will populate once the feed is ready.</div>';
      $('#selectedCountBadge')?.textContent = '0 selected / 0 total';
      list.removeAttribute('aria-busy');
      wireStartButton();
      return;
    }

    const frag = document.createDocumentFragment();
    items.forEach(({ id, name }) => {
      const row = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = id;
      cb.setAttribute('aria-label', name);
      cb.addEventListener('change', updateBadge);
      const text = document.createElement('span');
      text.textContent = name;
      row.append(cb, text);
      frag.append(row);
    });
    list.append(frag);

    $('#selectedCountBadge')?.textContent = `0 selected / ${items.length} total`;
    restoreSelections();
    wireBulkButtons();
    wireStartButton();

    list.removeAttribute('aria-busy');
    LOG('rendered', items.length, 'categories');
  }

  async function boot() {
    const host = $('#categoryChecklist');
    if (!host) {
      console.warn('[TK cats] #categoryChecklist not found; nothing to render into.');
      return;
    }
    host.style.display = 'grid';
    host.style.gridTemplateColumns = '1fr 1fr';
    host.style.gap = '12px';

    const items = await loadData();
    render(items);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot, { once: true });
  } else {
    boot();
  }
})();
</script>
<!-- ================= /TK DOCKED SURVEY LAYOUT ================= -->
