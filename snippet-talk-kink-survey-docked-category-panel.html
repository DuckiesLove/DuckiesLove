<!-- TalkKink: Docked Category Panel (inline styles, persistent dock) -->
<script>
(() => {
  const DOCK_WIDTH = 'clamp(360px,30vw,520px)';
  const HOST_ID = 'tkDockHard';

  if (document.getElementById(HOST_ID)) {
    console.log('[TK] dock already present');
    return;
  }

  const host = document.createElement('aside');
  host.id = HOST_ID;
  host.setAttribute('role','dialog');
  host.setAttribute('aria-modal','true');
  Object.assign(host.style, {
    position: 'fixed',
    inset: '0 0 0 0',
    zIndex: '2147483647',
    pointerEvents: 'none'
  });

  const dock = document.createElement('div');
  Object.assign(dock.style, {
    position: 'fixed',
    top: '88px',
    left: '24px',
    bottom: '24px',
    width: 'min(520px,30vw)',
    maxWidth: '520px',
    minWidth: '320px',
    overflow: 'auto',
    padding: '24px',
    border: '2px solid var(--teal, #00e5ff)',
    borderRadius: '16px',
    background: '#000',
    color: '#fff',
    boxShadow: '0 12px 40px rgba(0,0,0,.6)',
    pointerEvents: 'auto'
  });

  const header = document.createElement('div');
  Object.assign(header.style, {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    margin: '0 0 10px'
  });
  const h2 = document.createElement('h2');
  h2.textContent = 'Select categories';
  Object.assign(h2.style, { margin: 0 });

  const btnClose = document.createElement('button');
  btnClose.textContent = 'Close ✕';
  Object.assign(btnClose.style, {
    cursor: 'pointer',
    border: '1px solid var(--teal,#00e5ff)',
    color: 'var(--teal,#00e5ff)',
    background: '#000',
    borderRadius: '12px',
    padding: '8px 12px'
  });
  header.append(h2, btnClose);

  const row = document.createElement('div');
  Object.assign(row.style, {
    display: 'flex',
    gap: '12px',
    alignItems: 'center',
    margin: '8px 0 14px'
  });

  const btnAll = document.createElement('button');
  btnAll.textContent = 'Select All';
  const btnNone = document.createElement('button');
  btnNone.textContent = 'Deselect All';
  const countBadge = document.createElement('span');
  countBadge.textContent = '0 selected / 0 total';
  countBadge.style.opacity = '.75';

  for (const b of [btnAll, btnNone]) {
    Object.assign(b.style, {
      cursor: 'pointer',
      border: '1px solid var(--teal,#00e5ff)',
      color: 'var(--teal,#00e5ff)',
      background: '#000',
      borderRadius: '12px',
      padding: '8px 12px'
    });
  }
  row.append(btnAll, btnNone, countBadge);

  const list = document.createElement('div');
  list.id = 'tkList';
  Object.assign(list.style, { display: 'grid', gap: '10px' });
  list.innerHTML = '<div style="opacity:.8">Loading categories…</div>';

  const bottomRow = document.createElement('div');
  Object.assign(bottomRow.style, { display: 'flex', gap: '12px', marginTop: '16px' });

  const btnStart = document.createElement('button');
  btnStart.textContent = 'Start Survey';
  Object.assign(btnStart.style, {
    cursor: 'pointer',
    border: '1px solid var(--teal,#00e5ff)',
    color: '#000',
    background: 'var(--teal,#00e5ff)',
    borderRadius: '12px',
    padding: '10px 14px',
    fontWeight: '700'
  });
  bottomRow.append(btnStart);

  dock.append(header, row, list, bottomRow);
  host.append(dock);
  document.documentElement.append(host);

  try {
    document.body.style.marginLeft = DOCK_WIDTH;
  } catch { /* ignore */ }

  const STORE = '__TK_SELECTED_CATEGORIES';
  const getSel = () => new Set(JSON.parse(localStorage.getItem(STORE) || '[]'));
  const setSel = (arr) => localStorage.setItem(STORE, JSON.stringify(Array.from(new Set(arr))));

  const refreshCount = () => {
    const total = list.querySelectorAll('input[type=checkbox]').length;
    const selected = list.querySelectorAll('input[type=checkbox]:checked').length;
    countBadge.textContent = `${selected} selected / ${total} total`;
  };

  const addCheckRow = ({ id, name }) => {
    const label = document.createElement('label');
    Object.assign(label.style, {
      display: 'flex', alignItems: 'center', gap: '10px',
      padding: '10px 12px', border: '1px solid #2a2a2a',
      borderRadius: '12px', background: '#090909'
    });
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.value = id;
    input.checked = getSel().has(id);
    Object.assign(input.style, { width: '18px', height: '18px' });
    input.addEventListener('change', () => {
      const sel = Array.from(list.querySelectorAll('input:checked')).map(n => n.value);
      setSel(sel);
      refreshCount();
    });
    const span = document.createElement('span');
    span.textContent = name;
    label.append(input, span);
    list.append(label);
  };

  (async () => {
    let cats = [];
    try {
      if (typeof window.tkLoadKinkData === 'function') {
        const data = await window.tkLoadKinkData();
        cats = (data && Array.isArray(data.categories)) ? data.categories :
               (data?.kinks?.categories || data?.cats || []);
      } else if (Array.isArray(window.__TK_CATS)) {
        cats = window.__TK_CATS;
      }
    } catch (e) {
      console.warn('[TK] category load failed:', e);
    }

    if (!cats || !cats.length) {
      list.innerHTML = '<div style="opacity:.8">No category feed detected yet. Panel is locked; when your categories load, rerun the snippet or refresh.</div>';
      console.log('[TK] panel visible; no categories found');
    } else {
      list.innerHTML = '';
      const seen = new Set();
      for (const c of cats) {
        const id = String(c.id || c.value || c.slug || c.code || c.name || '').trim();
        const name = String(c.name || c.title || c.label || c.slug || c.code || id).trim();
        if (!id || !name || seen.has(id)) continue;
        seen.add(id);
        addCheckRow({ id, name });
      }
      refreshCount();
      console.log('[TK] categories rendered:', seen.size);
    }
  })();

  btnAll.addEventListener('click', () => {
    list.querySelectorAll('input[type=checkbox]').forEach(n => n.checked = true);
    setSel(Array.from(list.querySelectorAll('input:checked')).map(n => n.value));
    refreshCount();
  });
  btnNone.addEventListener('click', () => {
    list.querySelectorAll('input[type=checkbox]').forEach(n => n.checked = false);
    setSel([]);
    refreshCount();
  });

  btnStart.addEventListener('click', () => {
    const ids = JSON.parse(localStorage.getItem(STORE) || '[]');
    document.dispatchEvent(new CustomEvent('tk:start-survey', { detail: { includeCategories: ids } }));
    setTimeout(() => {
      if (!window.__TK_SURVEY_STARTED) {
        const u = new URL('/kinksurvey/', location.origin);
        u.searchParams.set('run', '1');
        if (ids.length) u.searchParams.set('cats', ids.join(','));
        location.assign(u.toString());
      }
    }, 120);
  });

  btnClose.addEventListener('click', () => {
    try { document.body.style.marginLeft = ''; } catch {}
    host.remove();
  });

  console.log('[TK] dock injected & locked (inline styles). If you do not see it, check CSP errors in Console.');
})();
</script>
