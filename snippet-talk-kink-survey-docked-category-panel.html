<!-- TalkKink: Docked Category Panel (inline styles, persistent dock) -->
<script>
(() =>{
  const HOST = document.getElementById('tkDockHard');
  if(!HOST){ console.warn('[TK] no dock host found'); return; }
  const list   = HOST.querySelector('div > div:nth-of-type(3)');  // checklist container
  const badge  = HOST.querySelector('span');                      // "x selected / y total"
  const btnAll = HOST.querySelector('button:nth-of-type(1)');     // Select All
  const btnNone= HOST.querySelector('button:nth-of-type(2)');     // Deselect All
  const btnGo  = HOST.querySelector('button:last-of-type');       // Start Survey

  const KEY='__TK_SELECTED_CATEGORIES';
  const getSel =()=>new Set(JSON.parse(localStorage.getItem(KEY)||'[]'));
  const setSel =(arr)=>localStorage.setItem(KEY,JSON.stringify(Array.from(new Set(arr))));
  const updateBadge =()=> {
    const total=list.querySelectorAll('input[type=checkbox]').length;
    const sel  =list.querySelectorAll('input[type=checkbox]:checked').length;
    badge.textContent=`${sel} selected / ${total} total`;
    btnGo.disabled = sel===0;  // disable Start until something selected
    btnGo.style.opacity = sel===0 ? .6 : 1;
    btnGo.style.cursor  = sel===0 ? 'not-allowed' : 'pointer';
  };

  function addRow(id,name){
    const L=document.createElement('label');
    Object.assign(L.style,{display:'flex',alignItems:'center',gap:'10px',padding:'10px 12px',
                           border:'1px solid #2a2a2a',borderRadius:'12px',background:'#0b0b0b'});
    const cb=document.createElement('input'); cb.type='checkbox'; cb.value=id; cb.style.width=cb.style.height='18px';
    cb.checked=getSel().has(id);
    cb.onchange=()=>{
      const ids=Array.from(list.querySelectorAll('input:checked')).map(n=>n.value);
      setSel(ids); updateBadge();
    };
    const s=document.createElement('span'); s.textContent=name;
    L.append(cb,s); list.append(L);
  }

  function normalizeCats(raw){
    if(!raw) return [];
    // accept many shapes: [{id,name}], [{code,label}], etc.
    return raw.map(c=>{
      const id = String(c.id||c.value||c.slug||c.code||c.name||'').trim();
      const name = String(c.name||c.title||c.label||c.slug||c.code||id).trim();
      return id && name ? {id,name} : null;
    }).filter(Boolean);
  }

  async function getCats(){
    try{
      // 1) official loader (if exposed)
      if (typeof window.tkLoadKinkData === 'function') {
        const d = await window.tkLoadKinkData();
        return normalizeCats( (d?.categories) || (d?.kinks?.categories) || [] );
      }
      // 2) promise variant (if a promise exists)
      if (window.tkLoadKinkDataPromise && typeof window.tkLoadKinkDataPromise.then==='function'){
        const d = await window.tkLoadKinkDataPromise;
        return normalizeCats( (d?.categories) || (d?.kinks?.categories) || [] );
      }
      // 3) preloaded global
      if (Array.isArray(window.__TK_CATS)) return normalizeCats(window.__TK_CATS);
    }catch(e){ console.warn('[TK] getCats error', e); }
    return [];
  }

  async function hydrate(){
    const cats = await getCats();
    if (!cats.length) return false;

    list.innerHTML='';
    const seen=new Set();
    for(const {id,name} of cats){
      if(seen.has(id)) continue; seen.add(id);
      addRow(id,name);
    }
    // Restore previous selection if it contains unknown IDs, drop them
    setSel(Array.from(getSel()).filter(id=>seen.has(id)));
    updateBadge();

    // Select/Deselect all
    btnAll.onclick = ()=>{
      list.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=true);
      setSel(Array.from(list.querySelectorAll('input:checked')).map(n=>n.value));
      updateBadge();
    };
    btnNone.onclick = ()=>{
      list.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
      setSel([]); updateBadge();
    };

    // Start Survey
    btnGo.onclick = ()=>{
      const ids=Array.from(getSel());
      document.dispatchEvent(new CustomEvent('tk:start-survey',{detail:{includeCategories:ids}}));
      setTimeout(()=>{ if(!window.__TK_SURVEY_STARTED){
        const u=new URL('/kinksurvey/',location.origin);
        u.searchParams.set('run','1'); if(ids.length) u.searchParams.set('cats',ids.join(','));
        location.assign(u.toString());
      }},120);
    };

    console.log('[TK] dock hydrated with', cats.length, 'categories');
    return true;
  }

  // Try immediately, then poll a few times, then listen for a future signal
  (async()=>{
    if (await hydrate()) return;
    for (let i=0;i<20;i++){       // ~4s total
      await new Promise(r=>setTimeout(r,200));
      if (await hydrate()) return;
    }
    // If your loader dispatches a signal later, catch it
    window.addEventListener('tk:kinkdata-ready', hydrate, {once:true});
    document.addEventListener('tk:kinkdata-ready', hydrate, {once:true});
    console.log('[TK] waiting for kink data â€¦');
  })();
})();
</script>
