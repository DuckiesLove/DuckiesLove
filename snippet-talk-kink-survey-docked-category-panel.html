<!-- ================= TK DOCKED SURVEY LAYOUT (kinksurvey only) ================= -->
<style id="tkDockStyles">
  :root { --tk-railW: clamp(260px, 25vw, 420px); }

  html.tk-dock body { overflow: hidden; } /* no page scroll behind the dock */

  /* Left-side blackout to stop the blurred homepage CTA from showing */
  #tkDockBackdrop {
    position: fixed; inset: 0 var(--tk-railW) 0 0;
    background:#000; z-index: 2147483638;
  }

  /* Right, fixed rail (1/4) */
  #tkRightRail {
    position: fixed; inset: 0 0 0 auto;
    width: var(--tk-railW);
    display: flex; flex-direction: column; gap: 18px;
    padding: 24px 20px;
    background: transparent;
    z-index: 2147483640;
    pointer-events: auto;
  }

  #tkRightRail h3 {
    margin: 0 0 6px; font: 700 18px/1.2 system-ui,Segoe UI,Arial; color:#bafcff; letter-spacing:.2px;
  }

  #tkRightRail .tk-rail-btn {
    display: block; width: 100%;
    border: 2px solid #00e5ff; border-radius: 16px;
    padding: 16px 18px; text-align: center; text-decoration: none;
    font: 800 20px/1 system-ui,Segoe UI,Arial; color:#bafcff; background: rgba(0,0,0,.35);
    box-shadow: 0 0 18px rgba(0,229,255,.15) inset, 0 0 22px rgba(0,229,255,.08);
    transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
  }
  #tkRightRail .tk-rail-btn:hover { transform: translateY(-1px); box-shadow:0 0 22px rgba(0,229,255,.24) inset, 0 0 26px rgba(0,229,255,.14); }
  #tkRightRail .tk-rail-btn:active { transform: translateY(0); }

  /* The survey panel fills the left 3/4, always visible */
  #categorySurveyPanel {
    position: fixed !important;
    inset: 0 var(--tk-railW) 0 0 !important;
    display: block !important;
    z-index: 2147483639 !important;
  }
  #categorySurveyPanel .panel {
    position: absolute !important; inset: 0 !important;
    display: grid; grid-template-rows: auto auto 1fr auto;
    gap: 12px; height: 100%; overflow: hidden;
    padding: 18px; border: 2px solid var(--teal,#00e5ff);
    border-radius: 16px; background:#000; color:#fff;
    box-shadow: 0 12px 40px rgba(0,0,0,.6);
  }
  #categorySurveyPanel .tk-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  #categorySurveyPanel .tk-actions { display:flex; gap:10px; align-items:center; }
  #categorySurveyPanel .themed-button { border:2px solid #00e5ff; border-radius:12px; padding:10px 14px; color:#bafcff; background:#02191c; font-weight:800; cursor:pointer; }
  #categorySurveyPanel .themed-button:hover { background:#052228; }

  #categoryChecklist { overflow: auto; padding-right: 6px; }
  #categoryChecklist label {
    display:flex; align-items:center; gap:12px; padding:12px 14px;
    border:1px solid #2a2a2a; border-radius:12px; background:#090909;
    margin: 8px 0;
  }
  #categoryChecklist input[type="checkbox"] { width: 18px; height: 18px; }

  /* Sticky footer so Start button is always reachable & at bottom of list */
  #tkPanelFooter {
    position: sticky; bottom: 0;
    padding-top: 10px; margin-top: 6px;
    background: linear-gradient(to top, #000 65%, rgba(0,0,0,0));
  }
  #beginSurveyFromPanel {
    width: 100%;
    padding: 14px 16px; border-radius: 14px;
    border: 2px solid #00e5ff; background:#00e5ff; color:#001a1d;
    font: 900 20px/1 system-ui,Segoe UI,Arial; cursor: pointer;
  }

  /* Hide the original homepage CTAs so they don’t sit behind the panel */
  .tk-hidden { display: none !important; }
</style>

<aside id="categorySurveyPanel" role="dialog" aria-label="Category selection" aria-modal="true" aria-hidden="false">
  <div class="panel">
    <div class="tk-header">
      <h2 style="margin:0">Select categories</h2>
      <div class="tk-actions">
        <button id="btnSelectAll"   class="themed-button">Select All</button>
        <button id="btnDeselectAll" class="themed-button">Deselect All</button>
        <span id="selectedCountBadge" style="opacity:.75">0 selected / 0 total</span>
      </div>
    </div>

    <!-- optional helper line -->
    <div style="opacity:.68">Choose everything you want included. The Start button is at the bottom.</div>

    <div id="categoryChecklist" aria-live="polite" aria-busy="true"></div>

    <div id="tkPanelFooter">
      <button id="beginSurveyFromPanel" class="themed-button" style="background:#00e5ff;color:#001a1d;border-color:#00e5ff;">Start Survey</button>
    </div>
  </div>
</aside>

<!-- Right rail -->
<div id="tkRightRail" aria-label="Survey utilities" hidden>
  <h3>Shortcuts</h3>
  <a id="tkGoCompat" class="tk-rail-btn" href="#">Compatibility Page</a>
  <a id="tkGoIndividual" class="tk-rail-btn" href="#">Individual Kink Analysis</a>
</div>

<div id="tkDockBackdrop" aria-hidden="true"></div>

<script>
(() => {
  document.documentElement.classList.add('tk-dock');

  /* 1) Wire right-rail buttons to your existing links, then hide the originals */
  const findByText = (txt) => {
    const nodes = Array.from(document.querySelectorAll('a,button'));
    const norm = s => s.replace(/\s+/g,' ').trim().toLowerCase();
    const tgt = norm(txt);
    return nodes.find(n => norm(n.textContent) === tgt);
  };

  const btnCompat    = findByText('Compatibility Page');
  const btnIndividual= findByText('Individual Kink Analysis');

  const rail = document.getElementById('tkRightRail');
  if (btnCompat)    { document.getElementById('tkGoCompat').href    = btnCompat.href || '#';    }
  if (btnIndividual){ document.getElementById('tkGoIndividual').href= btnIndividual.href || '#';}

  // show rail now that links are set (fallback to # if not found)
  rail.hidden = false;

  // hide original trio of big CTAs so they never peek through
  ['Start Survey','Compatibility Page','Individual Kink Analysis'].forEach(txt=>{
    const n = findByText(txt);
    if (!n) return;
    // hide closest reasonable wrapper
    let wrap = n.closest('a,button,div,section,aside,li') || n;
    wrap.classList.add('tk-hidden');
  });

  /* 2) Build the categories into the left panel */
  const KEY = '__TK_SELECTED_CATEGORIES';

  function tkNormalizeItems(raw){
    // Accept either simple list or objects with id/name
    return (raw||[]).map((it,i)=>{
      if (typeof it === 'string') return { id:String(i+1), name:it };
      return { id:String(it.id ?? i+1), name:String(it.name ?? it.title ?? `Item ${i+1}`) };
    });
  }

  async function getKinks(){
    // prefer already-injected data if present
    if (Array.isArray(window.__TK_KINK_DATA) && window.__TK_KINK_DATA.length) return tkNormalizeItems(window.__TK_KINK_DATA);
    // try the feed we’ve been using
    try {
      const u = new URL('/data/kinks.json', location.origin);
      u.searchParams.set('v', Date.now());      // bust cache
      const r = await fetch(u.toString());
      if (r.ok) return tkNormalizeItems(await r.json());
    } catch(e){}
    // last resort: a short demo set so UI isn’t empty
    return tkNormalizeItems([
      {id:'demo-1', name:'(demo) Bondage'},
      {id:'demo-2', name:'(demo) Roleplay'},
      {id:'demo-3', name:'(demo) Impact'},
    ]);
  }

  function updateBadge(list){
    const total = list.querySelectorAll('input[type="checkbox"]').length;
    const sel   = list.querySelectorAll('input[type="checkbox"]:checked').length;
    document.getElementById('selectedCountBadge').textContent = `${sel} selected / ${total} total`;
  }

  function saveSelection(list){
    const ids = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
    localStorage.setItem(KEY, JSON.stringify(ids));
    return ids;
  }

  (async () => {
    const items = await getKinks();
    const list  = document.getElementById('categoryChecklist');
    list.innerHTML = '';

    items.forEach(({id,name})=>{
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.value = id; cb.setAttribute('aria-label', name);
      const span = document.createElement('span'); span.textContent = name;
      label.append(cb, span);
      list.appendChild(label);
    });

    // restore previous selection
    try {
      const prev = JSON.parse(localStorage.getItem(KEY) || '[]');
      if (Array.isArray(prev) && prev.length){
        prev.forEach(id => {
          const box = list.querySelector(`input[value="${CSS.escape(id)}"]`);
          if (box) box.checked = true;
        });
      }
    } catch {}

    // live badge
    list.addEventListener('change', () => updateBadge(list));
    updateBadge(list);

    // select/deselect all
    document.getElementById('btnSelectAll').onclick   = () => {
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateBadge(list);
    };
    document.getElementById('btnDeselectAll').onclick = () => {
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateBadge(list);
    };

    // start survey from panel (single source of truth)
    document.getElementById('beginSurveyFromPanel').onclick = () => {
      const ids = saveSelection(list);

      // your event contract (kept from earlier work)
      document.dispatchEvent(new CustomEvent('tk:start-survey', { detail: { includeCategories: ids }}));

      // Fallback navigation if the runner didn’t start it
      setTimeout(() => {
        if (!window.__TK_SURVEY_STARTED) {
          const u = new URL(location.origin + '/kinksurvey/');
          u.searchParams.set('run','1');
          if (ids.length) u.searchParams.set('cats', ids.join(','));
          location.assign(u.toString());
        }
      }, 120);
    };
  })();
})();
</script>
<!-- ================= /TK DOCKED SURVEY LAYOUT ================= -->
