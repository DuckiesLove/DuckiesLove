<!-- ================== TALK KINK — DUAL PANEL QUESTION CARD + COLORFUL SCALE ================== -->
<script>
/* ======================= TK DUAL PANEL (fixed host + grid + sync) ======================= */
(function TKDualPanel(){

  // ---------- 1) inject minimal CSS (once) ----------
  const CSS = `
  /* ======================= CSS — layout + skins ======================= */

  /* ===================== FINAL: no middle X-scroll + left normal + right Y-scroll ===================== */

  /* 1) Kill horizontal overflow anywhere in/around the question card */
  :where(#tk-question-host,
         #surveyApp,
         #questionArea,
         .question-layout,
         .survey-question-panel,
         .survey-question-panel > *,
         .question-panel,
         .question-card,
         #tk-question-card){
    box-sizing: border-box !important;
    max-width: 100% !important;
    width: 100% !important;
    min-width: 0 !important;         /* prevent flex/grid children from forcing overflow */
    overflow-x: clip !important;      /* stronger than hidden for killing the bar */
  }

  /* Prevent child content from creating X-overflow */
  :where(#tk-question-card, #tk-question-card *){
    max-width: 100% !important;
    white-space: normal !important;
    word-break: normal !important;
    overflow-wrap: anywhere;
  }

  /* Normalize images/tables just in case */
  #tk-question-card img,
  #tk-question-card svg,
  #tk-question-card table { max-width: 100%; height: auto; }

  /* 2) Left (question) card: never scroll inside */
  #tk-question-card{
    display: block !important;
    padding: 18px 20px 16px;
    overflow-y: visible !important;
    max-height: none !important;
    border-radius: 18px;
  }

  /* Legacy wrappers that add a horizontal track — hide it completely */
  .survey-question-panel .question-card::-webkit-scrollbar { height: 0 !important; }
  .survey-question-panel .question-card { scrollbar-width: none !important; }

  /* Let the 0–5 row wrap instead of causing overflow */
  #tk-question-card .tk-scale{ flex-wrap: wrap; min-width: 0; }

  /* 3) Right (rating) panel: only vertical scroll */
  #tk-rating-card{
    position: sticky;
    top: 96px;
    max-height: calc(100vh - 120px);
    overflow-y: auto !important;
    overflow-x: hidden !important;
    overscroll-behavior: contain;
  }

  /* Optional: nicer scrollbar for the right panel */
  #tk-rating-card::-webkit-scrollbar{ width: 10px; }
  #tk-rating-card::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.22); border-radius: 8px; }
  #tk-rating-card{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.22) transparent; }

  /* Host: two-column layout (question left, colorful rating right).
     Works on ANY element with .tk-dual (body, #surveyApp, custom wrapper, etc.) */
  .tk-dual{
    display:grid;
    grid-template-columns:minmax(560px,1fr) 360px;
    gap:24px;
    align-items:start;
    overflow-x:hidden; /* kill stray inner scrollbars */
  }
  @media (max-width:1100px){
    .tk-dual{ grid-template-columns:1fr; }
  }

  /* Shared panel look (matches your sidebar “blue glow”) */
  .tk-pane{
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)) var(--tk-surface, rgba(13,17,23,.82));
    border-radius: 18px;
    border: 1px solid var(--tk-edge, rgba(255,255,255,.10));
    box-shadow:
      inset 0 0 0 1px rgba(var(--tk-glow-rgb, 0 170 255), .15),
      0 8px 22px rgba(0,0,0,.35),
      0 0 28px var(--tk-glow-soft, rgba(0,170,255,.10));
    color: var(--fg, #eef3f9);
  }

  /* ---------------- Question card (LEFT) ---------------- */
  #tk-question-card{
    box-sizing:border-box;
    overflow-x:hidden !important;
  }
  #tk-question-card .tk-question-title{ font-weight:700; font-size:1.12rem; margin:6px 0 4px; }
  #tk-question-card .tk-sub{ color: var(--tk-text-subtle, rgba(255,255,255,.72)); margin-bottom:10px; }

  /* keep only the top progress (outside); never show a second inside the card */
  #tk-question-card #tk-progress, #tk-question-card .tk-progress{ display:none !important; }

  /* 0–5 mono row (left) */
  #tk-question-card .tk-scale{
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:8px 0 10px;
  }
  #tk-question-card .tk-scale button{
    appearance:none; background:transparent; color:#fff; padding:8px 14px; min-width:44px; border-radius:12px;
    width:auto !important;
    border:1px solid rgba(var(--tk-glow-rgb, 0 170 255), .25);
    box-shadow: inset 0 0 0 1px rgba(var(--tk-glow-rgb, 0 170 255), .12), 0 0 12px rgba(var(--tk-glow-rgb, 0 170 255), .10);
    font-weight:600; transition:transform .05s, box-shadow .15s, background-color .15s;
  }
  #tk-question-card .tk-scale button:hover{ background:rgba(var(--tk-glow-rgb, 0 170 255), .08); }
  #tk-question-card .tk-scale button.is-active{
    background:rgba(var(--tk-glow-rgb, 0 170 255), .14);
    border-color:rgba(var(--tk-glow-rgb, 0 170 255), .45);
    box-shadow: inset 0 0 0 1px rgba(var(--tk-glow-rgb, 0 170 255), .35), 0 0 20px rgba(var(--tk-glow-rgb, 0 170 255), .28);
    transform:translateY(-1px);
  }
  #tk-question-card .tk-meta{ color: var(--tk-text-subtle, rgba(255,255,255,.72)); font-size:.92rem; }

  /* ---------------- Colorful rating panel (RIGHT) ---------------- */
  #tk-rating-card{
    padding:16px;
  }
  #tk-rating-card .tk-h{ font-weight:800; text-transform:uppercase; letter-spacing:.35px; font-size:.8rem; opacity:.9; margin:0 0 8px; }
  #tk-rating-card .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  #tk-rating-card .chip{
    display:flex; gap:10px; align-items:center; cursor:pointer; border-radius:12px; padding:10px 12px;
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    transition:transform .12s, box-shadow .15s, background .15s, border-color .15s;
  }
  #tk-rating-card .chip:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.35); }
  #tk-rating-card .chip.is-active{ outline:2px solid currentColor; background:rgba(255,255,255,.06); }
  #tk-rating-card .dot{ width:28px;height:28px;border-radius:999px;display:grid;place-items:center;font-weight:800;color:#071018;box-shadow:inset 0 0 0 2px rgba(0,0,0,.25); }
  #tk-rating-card .t1{ font-weight:700;line-height:1.15; }
  #tk-rating-card .t2{ font-size:.86rem;opacity:.85;line-height:1.15; }
  .g0 .dot{background:#60a5fa;}  .g0 .t1{color:#bfe0ff;}
  .g1 .dot{background:#ef4444;}  .g1 .t1{color:#ffc6c6;}
  .g2 .dot{background:#f59e0b;}  .g2 .t1{color:#ffe2b3;}
  .g3 .dot{background:#10b981;}  .g3 .t1{color:#bdf5e4;}
  .g4 .dot{background:#22c55e;}  .g4 .t1{color:#c7ffd8;}
  .g5 .dot{background:#84cc16;}  .g5 .t1{color:#e8ffc2;}
  `;
  if (!document.getElementById('tk-dual-css')) {
    const style = document.createElement('style');
    style.id = 'tk-dual-css';
    style.textContent = CSS;
    document.head.appendChild(style);
  }

  // ---------- 2) find a sensible host and ensure both panels exist ----------
  function findHost(){
    return (
      document.querySelector('#tk-question-host') ||
      document.querySelector('#surveyApp') ||
      document.querySelector('#questionArea')?.parentElement ||
      document.body
    );
  }

  function ensureHostAndPanels(){
    let host = findHost();
    // if host is BODY and question card lives somewhere else, wrap it so grid works
    const existingCard = document.querySelector('#tk-question-card') ||
                         document.querySelector('.survey-question-panel .question-card');
    if (host === document.body && existingCard && existingCard.parentElement !== document.body){
      const wrapper = document.createElement('div');
      wrapper.id = 'tk-question-host';
      existingCard.parentElement.insertBefore(wrapper, existingCard);
      wrapper.appendChild(existingCard);
      host = wrapper;
    }

    host.classList.add('tk-dual');

    if (!document.querySelector('#tk-question-card')){
      const left = document.createElement('div');
      left.id = 'tk-question-card';
      left.className = 'tk-pane';
      host.prepend(left);
    }
    if (!document.querySelector('#tk-rating-card')){
      const right = document.createElement('aside');
      right.id = 'tk-rating-card';
      right.className = 'tk-pane';
      right.setAttribute('aria-label','Rating panel');
      host.appendChild(right);
    }
  }

  // ---------- 3) render colorful rating panel ----------
  function renderRightPanel(){
    const card = document.querySelector('#tk-rating-card');
    if (!card) return;
    card.innerHTML = `
      <div class="tk-h">Rate this</div>
      <div class="grid" role="group" aria-label="Rating 0 to 5">
        ${[
          {n:0,t1:'No/Hard No',t2:'Select 0', cls:'g0'},
          {n:1,t1:'Hard Limit',t2:'Select 1', cls:'g1'},
          {n:2,t1:'Maybe',t2:'Select 2', cls:'g2'},
          {n:3,t1:'Like',t2:'Select 3', cls:'g3'},
          {n:4,t1:'Love',t2:'Select 4', cls:'g4'},
          {n:5,t1:'Hell Yes',t2:'Select 5', cls:'g5'},
        ].map(x => `
          <button type="button" class="chip ${x.cls}" data-score="${x.n}" aria-pressed="false">
            <span class="dot">${x.n}</span>
            <span>
              <div class="t1">${x.t1}</div>
              <div class="t2">${x.t2}</div>
            </span>
          </button>
        `).join('')}
      </div>
    `;
    const grid = card.querySelector('.grid');
    grid.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip'); if (!btn) return;
      const score = btn.dataset.score;
      setRightActive(score);
      setLeftActive(score);
      const ev = new CustomEvent('tk:score', { bubbles:true, detail:{ score: Number(score) } });
      card.dispatchEvent(ev);
      if (typeof window.setCurrentScore === 'function'){
        window.setCurrentScore(Number(score));
      }
    });
  }

  // ---------- 4) ensure left card has a visible question & mono scale ----------
  function skinLeftCard(){
    const left = document.querySelector('#tk-question-card');
    if (!left) return;

    // If your renderer didn’t build a row yet, add a simple 0–5 row
    if (!left.querySelector('.tk-scale')) {
      const title = left.querySelector('.tk-question-title')?.textContent || 'Question';
      const sub   = left.querySelector('.tk-sub')?.textContent || '';
      left.innerHTML = `
        <div class="tk-question-title">${title}</div>
        ${sub ? `<div class="tk-sub">${sub}</div>` : ''}
        <div class="tk-scale" id="tk-mono-scale">
          ${[0,1,2,3,4,5].map(n=>`<button type="button" data-val="${n}" aria-pressed="false">${n}</button>`).join('')}
        </div>
        <div class="tk-meta" id="tk-qmeta"></div>
      `;
    }

    const row = left.querySelector('#tk-mono-scale') || left.querySelector('.tk-scale');
    if (row && !row.dataset.wired){
      row.dataset.wired = '1';
      row.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        setLeftActive(b.dataset.val);
        setRightActive(b.dataset.val);
        const card = document.querySelector('#tk-rating-card');
        const score = Number(b.dataset.val);
        if (card){
          const ev = new CustomEvent('tk:score', { bubbles:true, detail:{ score } });
          card.dispatchEvent(ev);
        }
        if (typeof window.setCurrentScore === 'function'){
          window.setCurrentScore(score);
        }
      });
    }
  }

  // ---------- 5) sync helpers ----------
  function setLeftActive(val){
    const row = document.querySelector('#tk-question-card .tk-scale');
    if (!row) return;
    row.querySelectorAll('button').forEach(b=>{
      b.classList.toggle('is-active', b.dataset.val === String(val));
      b.setAttribute('aria-pressed', b.dataset.val === String(val) ? 'true' : 'false');
    });
  }
  function setRightActive(val){
    const grid = document.querySelector('#tk-rating-card .grid');
    if (!grid) return;
    grid.querySelectorAll('.chip').forEach(b=>{
      const on = b.dataset.score === String(val);
      b.classList.toggle('is-active', on);
      b.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
  }

  // ---------- 6) public hook: call after YOUR question renders ----------
  window.TK_DUAL_REFRESH = function(){
    ensureHostAndPanels();
    skinLeftCard();
    renderRightPanel();
  };

  // run once on load
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', window.TK_DUAL_REFRESH, { once:true });
  } else {
    window.TK_DUAL_REFRESH();
  }
})();
</script>
