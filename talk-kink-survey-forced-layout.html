<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TalkKink Survey — Forced Layout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--panel:rgba(255,255,255,.03);--border:rgba(255,255,255,.14);--text:#e9eef7}
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    /* Grid */
    #tk-app{display:grid;grid-template-columns:300px 1fr 340px;gap:16px;max-width:1400px;margin:24px auto;padding:0 16px}
    .tk-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    h2,h3{margin:0 0 10px}
    /* Categories */
    #tk-cat-list{display:grid;gap:8px;max-height:70vh;overflow:auto;padding-right:4px}
    .tk-cat{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05)}
    /* Actions */
    .tk-actions{display:grid;gap:14px;max-width:780px}
    .tk-btn, .tk-a{display:inline-block;text-align:center;padding:16px 20px;border:1px solid var(--border);border-radius:999px;background:transparent;color:inherit;text-decoration:none}
    .tk-btn:hover, .tk-a:hover{filter:brightness(1.2)}
    /* Scale */
    .tk-grid,#tk-scale{display:grid;grid-template-columns:repeat(6,minmax(44px,1fr));gap:10px;margin-top:10px}
    .tk-opt{border:1px solid var(--border);border-radius:12px;padding:10px 0;background:transparent;color:inherit;cursor:pointer;font-size:16px}
    .tk-opt.selected{outline:2px solid currentColor}
    .legend{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    @media (max-width:1024px){#tk-app{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main id="tk-app">
    <!-- Left -->
    <aside id="tk-categories" class="tk-card">
      <h3>Categories</h3>
      <div id="tk-cat-list" role="listbox" aria-multiselectable="true">Loading…</div>
    </aside>

    <!-- Center -->
    <section class="tk-card">
      <section id="tk-landing" class="tk-card" style="background:transparent;border:none;padding:0">
        <h2>TalkKink Survey</h2>
        <div class="tk-actions" style="margin-top:14px">
          <button id="btnStart" class="tk-btn" type="button">Start Survey</button>
          <a class="tk-a" href="#">Individual Kink Analysis</a>
          <a class="tk-a" href="#">Compatibility Page</a>
        </div>
      </section>
      <section id="question-panel" class="tk-card" hidden></section>
    </section>

    <!-- Right -->
    <aside id="tk-right" class="tk-card" hidden>
      <h3>How to score</h3>
      <ul class="legend" id="tk-legend">
        <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
        <li><b>1</b> — Hard Limit (no-go)</li>
        <li><b>2</b> — Soft Limit (willing to try…)</li>
        <li><b>3</b> — Curious / context-dependent</li>
        <li><b>4</b> — Comfortable / enjoy</li>
        <li><b>5</b> — Favorite / enthusiastic yes</li>
      </ul>
      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px">
        <div>Rate interest/comfort (0–5)</div>
        <div class="tk-grid" id="tk-scale-sidebar" data-group="rating-A"></div>
      </div>
    </aside>
  </main>

  <script>
    console.log("TK inline bootstrap v2025-10-17-6");

    // Helpers
    async function loadKinks() {
      try {
        const res = await fetch("/data/kinks.json", { cache: "no-store" });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        return await res.json();
      } catch (e) {
        console.warn("Using fallback categories (fetch failed):", e.message);
        // Fallback demo data
        return { categories: [
          { name: "Appearance Play" }, { name: "Behavioral Play" }, { name: "Body Fluids And Functions" },
          { name: "Body Modification" }, { name: "Body Part Fetish Play" }, { name: "Bondage And Suspension" }
        ]};
      }
    }

    function categoriesFrom(data) {
      if (Array.isArray(data)) return data.map(x => x?.name || x?.title || x?.category || String(x));
      if (Array.isArray(data?.categories)) return data.categories.map(x => x?.name || x?.title || x?.category || String(x));
      if (data && typeof data === "object") return Object.keys(data);
      return [];
    }

    function makeScale(container, group = "rating-A") {
      if (!container) return;
      container.innerHTML = "";
      for (let i = 0; i <= 5; i++) {
        const b = document.createElement("button");
        b.className = "tk-opt";
        b.type = "button";
        b.dataset.group = group;
        b.dataset.value = i;
        b.textContent = i;
        b.setAttribute("aria-pressed", "false");
        container.appendChild(b);
      }
    }

    function renderQuestionCard() {
      const panel = document.getElementById("question-panel");
      panel.hidden = false;
      panel.innerHTML = `
        <div>Appearance Play • Choosing My Partner</div>
        <h2>Giving: Rate interest/comfort (0–5)</h2>
        <div id="tk-guard" aria-live="polite"></div>
        <div id="tk-scale" data-group="rating-A"></div>
      `;
      makeScale(document.getElementById("tk-scale"), "rating-A");
      makeScale(document.getElementById("tk-scale-sidebar"), "rating-A");
      document.getElementById("tk-right").hidden = false;
    }

    // Sync rating buttons (center + right)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button.tk-opt");
      if (!btn) return;
      const group = btn.dataset.group;
      const value = btn.dataset.value;
      document.querySelectorAll(`button.tk-opt[data-group="${group}"]`).forEach(b => {
        const on = b.dataset.value === value;
        b.classList.toggle("selected", on);
        b.setAttribute("aria-pressed", on ? "true" : "false");
      });
      const guard = document.getElementById("tk-guard");
      if (guard) guard.textContent = `Selected ${value} of 5`;
    });

    // Start
    window.startSurvey = function () {
      document.getElementById("tk-landing")?.setAttribute("hidden", "hidden");
      renderQuestionCard();
    };

    // DOM Ready
    document.addEventListener("DOMContentLoaded", async () => {
      // Categories
      const list = document.getElementById("tk-cat-list");
      list.textContent = "Loading…";
      try {
        const data = await loadKinks();
        const cats = categoriesFrom(data).filter(Boolean).sort((a,b)=>a.localeCompare(b));
        list.innerHTML = cats.map((c,i)=>`<label class="tk-cat"><input type="checkbox" id="cat_${i}" /><span>${c}</span></label>`).join("") || "No categories parsed";
        console.log("✅ Categories:", cats.length);
      } catch (err) {
        console.error("❌ Failed to load categories", err);
        list.textContent = "Error loading categories.";
      }

      // Wire start
      document.getElementById("btnStart")?.addEventListener("click", (e) => {
        e.preventDefault();
        startSurvey();
      });

      // Optional: autostart with ?autostart
      if (new URLSearchParams(location.search).has("autostart")) startSurvey();
    });
  </script>
</body>
</html>
