<!-- Talk Kink survey: Shadow DOM dock root with lifeguard -->
<script>
(() => {
  /* ==== options you can tweak ==== */
  const POS = { left: '16px', top: '96px', width: '360px', height: '70vh' };
  const LS_KEY = '__TK_SELECTED_CATEGORIES';
  const Z = 2147483647;                     // keep above anything
  const ROOT_ID = 'tkDockRoot';
  const FEED_POLL_MS = 250;
  const FEED_POLL_MAX = 80;                 // ~20s
  const HARDEN_MS = 500;                    // style refresh interval
  const HARDEN_WINDOW_MS = 15000;           // keep reapplying for 15s

  /* ---------- harden root styles ---------- */
  const hardCss = (id) => `
    #${id}{
      all:initial !important;
      position:fixed !important;
      left:${POS.left} !important;
      top:${POS.top} !important;
      width:${POS.width} !important;
      height:${POS.height} !important;
      display:block !important;
      visibility:visible !important;
      opacity:1 !important;
      z-index:${Z} !important;
      pointer-events:auto !important;
      transform:none !important;
      contain:layout style size !important;
      isolation:isolate !important;
      background:transparent !important;
    }
  `;

  function ensureRoot() {
    let root = document.getElementById(ROOT_ID);
    if (!root) {
      root = document.createElement('div');
      root.id = ROOT_ID;
      document.body.appendChild(root);
      root.attachShadow({ mode:'open' });
    } else if (!root.isConnected) {
      document.body.appendChild(root);
    }
    // inline (in case style tag gets delayed/removed)
    Object.assign(root.style, {
      position:'fixed', left:POS.left, top:POS.top,
      width:POS.width, height:POS.height,
      display:'block', visibility:'visible', opacity:'1',
      zIndex:String(Z), transform:'none', pointerEvents:'auto'
    });
    let s = document.getElementById('tkDockHardCSS');
    if (!s) {
      s = document.createElement('style');
      s.id = 'tkDockHardCSS';
      s.textContent = hardCss(ROOT_ID);
      document.head.appendChild(s);
    }
    return root;
  }

  /* ---------- UI ---------- */
  function render(shadow, categories) {
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    shadow.innerHTML = `
      <style>
        :host{all:initial}
        .card{box-sizing:border-box; font:400 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          background:#06181b; color:#fff; border:3px solid #00e5ff; border-radius:14px;
          width:100%; height:100%; padding:12px; overflow:auto; box-shadow:0 12px 40px rgba(0,0,0,.6)}
        h2{margin:6px 0 10px 2px; font:700 20px/1.2 system-ui}
        .row{display:flex; gap:10px; align-items:center; margin:8px 0}
        .btn{cursor:pointer; background:#021114; border:2px solid #00e5ff; border-radius:12px; color:#00e5ff;
             padding:8px 12px; font-weight:700}
        .btn.primary{background:#00e5ff; color:#001316}
        .list{display:grid; gap:10px}
        label.item{display:flex; gap:10px; align-items:center; padding:10px 12px;
          border:1px solid #2a2a2a; border-radius:12px; background:#0b1719}
        input[type="checkbox"]{width:18px; height:18px}
        .muted{opacity:.7}
      </style>
      <div class="card">
        <h2>Select categories</h2>
        <div class="row">
          <button class="btn" id="selAll">Select All</button>
          <button class="btn" id="deselAll">Deselect All</button>
          <span class="muted" id="badge">0 selected / ${categories.length} total</span>
        </div>
        <div class="list" id="list" role="group" aria-label="Categories"></div>
        <div style="margin-top:14px">
          <button class="btn primary" id="go">Start Survey</button>
        </div>
      </div>
    `;

    const list  = shadow.getElementById('list');
    const badge = shadow.getElementById('badge');

    const selSet = new Set(saved.map(String));
    for (const {id,name} of categories) {
      const row = document.createElement('label');
      row.className='item';
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.value=String(id); cb.checked=selSet.has(String(id));
      const txt = document.createElement('span'); txt.textContent = name;
      row.append(cb, txt); list.appendChild(row);
    }

    function selected() {
      return [...list.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>cb.value);
    }
    function updateBadge(){ badge.textContent = `${selected().length} selected / ${categories.length} total`; }
    list.addEventListener('change', ()=>{ localStorage.setItem(LS_KEY, JSON.stringify(selected())); updateBadge(); });
    updateBadge();

    shadow.getElementById('selAll').onclick = ()=>{
      list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);
      localStorage.setItem(LS_KEY, JSON.stringify(selected())); updateBadge();
    };
    shadow.getElementById('deselAll').onclick = ()=>{
      list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
      localStorage.setItem(LS_KEY, JSON.stringify(selected())); updateBadge();
    };
    shadow.getElementById('go').onclick = ()=>{
      const ids = selected();
      localStorage.setItem(LS_KEY, JSON.stringify(ids));
      document.dispatchEvent(new CustomEvent('tk:start-survey',{detail:{includeCategories:ids}}));
      setTimeout(()=>{ // URL fallback if runner didn't start
        if (!window.__TK_SURVEY_STARTED) {
          const u = new URL('/kinksurvey/', location.origin);
          u.searchParams.set('run','1'); if (ids.length) u.searchParams.set('cats', ids.join(','));
          location.assign(u.toString());
        }
      },120);
    };
  }

  /* ---------- feed helper ---------- */
  function normalizeFeed() {
    const f = window.__TK_KINK_DATA || {};
    const arr = Array.isArray(f) ? f : Array.isArray(f.categories) ? f.categories : [];
    return arr.map(x => ({ id: x.id ?? x.value ?? x.slug ?? String(x), name: x.name ?? x.label ?? String(x) }))
              .filter(x => x.id && x.name);
  }

  /* ---------- mount + watchdog ---------- */
  function mount() {
    const root = ensureRoot();
    const shadow = root.shadowRoot;

    let cats = normalizeFeed();
    if (!cats.length) {
      // poll for feed
      let tries = 0;
      const t = setInterval(()=>{
        cats = normalizeFeed();
        if (cats.length || ++tries > FEED_POLL_MAX) {
          clearInterval(t);
          if (!cats.length) cats = [
            {id:'demo-1', name:'(demo) Bondage'},
            {id:'demo-2', name:'(demo) Roleplay'},
            {id:'demo-3', name:'(demo) Impact'}
          ];
          render(shadow, cats);
        } else {
          // keep dock visible even before we render
          ensureRoot();
        }
      }, FEED_POLL_MS);

      window.addEventListener('tk:kink-data', () => {
        const now = normalizeFeed();
        if (now.length) { clearInterval(t); render(shadow, now); }
      }, { once:true });
    } else {
      render(shadow, cats);
    }

    // Mutation watchdog: reattach if removed/hidden
    if (!window.__tkDockWatch) {
      window.__tkDockWatch = new MutationObserver(()=>{
        const r = document.getElementById(ROOT_ID);
        if (!r || !r.isConnected || getComputedStyle(r).display==='none') ensureRoot();
      });
      window.__tkDockWatch.observe(document.documentElement, {childList:true, subtree:true, attributes:true});
    }

    // First 15s: re-apply inline styles every 500ms (covers late theme passes)
    const start = performance.now();
    const bump = () => {
      ensureRoot();
      if (performance.now() - start < HARDEN_WINDOW_MS) setTimeout(bump, HARDEN_MS);
    };
    bump();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mount, { once:true });
  } else {
    mount();
  }
})();
</script>
