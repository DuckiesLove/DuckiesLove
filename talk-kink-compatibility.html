<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TalkKink Compatibility</title>
<style>
  :root{
    --bg:#0e0f11;            /* page background */
    --panel:#0b0c0d;         /* table banding base */
    --row:#111315;           /* row color */
    --row-alt:#0f1012;       /* zebra */
    --ink:#e6feff;           /* main text */
    --ink-dim:#b8dfe0;
    --accent:#00e7ff;        /* teal glow */
    --grid:#23292d;          /* table lines */
  }
  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  }
  .page{
    max-width:1120px;
    margin:28px auto 48px;
    padding:0 16px;
  }

  /* Centered, outlined headings (like before) */
  .title, .subtitle, .section {
    text-align:center;
    margin:0;
  }
  .title{
    font-size:56px; line-height:1.05; font-weight:800; letter-spacing:.5px;
    color:var(--accent);
    /* outline with soft glow */
    text-shadow:
      0 0 0 var(--bg),
      0 0 18px rgba(0,231,255,.35),
      0 0 40px rgba(0,231,255,.25);
    -webkit-font-smoothing:antialiased;
  }
  .subtitle{
    margin-top:10px; font-size:20px; color:var(--ink-dim);
  }
  .hr { height:3px; background:var(--accent); margin:18px auto 14px; max-width:92%; opacity:.85; }

  .section{
    font-size:44px; font-weight:800; color:var(--accent); margin:12px 0 10px;
    text-shadow:
      0 0 0 var(--bg),
      0 0 14px rgba(0,231,255,.25),
      0 0 28px rgba(0,231,255,.18);
  }

  /* Table fills the page, no white boxes */
  .compat{
    width:100%; border-collapse:separate; border-spacing:0;
    background:transparent; table-layout:fixed;
  }
  .compat col.label   { width:56%; }
  .compat col.a       { width:12%; }
  .compat col.match   { width:16%; }
  .compat col.flag    { width:4%; }    /* tighter flag column */
  .compat col.b       { width:12%; }

  .compat thead th{
    position:sticky; top:0; z-index:1;
    background:#0f1215;
    color:var(--accent); font-weight:800; font-size:20px; padding:14px 12px;
    border-bottom:1px solid var(--grid);
    text-align:center;
    /* give the header the outlined look, too */
    text-shadow:
      0 0 0 var(--bg),
      0 0 12px rgba(0,231,255,.22);
  }
  .compat thead th:first-child{ text-align:left; }

  .compat tbody td{
    padding:14px 12px; font-size:19px; line-height:1.3; color:var(--ink);
    border-bottom:1px solid #151a1e; background:var(--row);
  }
  .compat tbody tr:nth-child(2n) td{ background:var(--row-alt); }
  .compat tbody td.label{ color:var(--ink); }
  .compat tbody td.num, .compat tbody td.match, .compat tbody td.flag{
    text-align:center; white-space:nowrap;
  }
  .compat tbody td.flag{
    text-align:center; letter-spacing:.5px; color:var(--ink-dim);
  }

  /* Download button */
  .bar { display:flex; gap:12px; justify-content:center; margin:18px 0 6px; }
  .btn {
    appearance:none; border:none; border-radius:12px; padding:10px 16px;
    background:#0f1d22; color:var(--ink); font-weight:700; cursor:pointer;
    box-shadow:0 0 0 1px rgba(0,231,255,.25), 0 6px 20px rgba(0,231,255,.12) inset;
  }
  .btn:hover{ box-shadow:0 0 0 1px rgba(0,231,255,.5), 0 0 18px rgba(0,231,255,.18) inset; }

  /* make sure the whole sheet breathes to edges on small screens */
  @media (max-width:880px){
    .title{ font-size:44px; }
    .section{ font-size:34px; }
    .compat thead th, .compat tbody td{ font-size:18px; }
    .compat col.label{ width:54%; }
    .compat col.match{ width:17%; }
  }
</style>
</head>
<body>
  <div class="page" id="app">
    <h1 class="title">TalkKink Compatibility</h1>
    <p class="subtitle" id="ts">Generated: —</p>
    <div class="hr"></div>
    <h2 class="section">Behavioral Play</h2>

    <div class="bar"><button id="downloadPdfBtn" class="btn">Download PDF</button></div>

    <table class="compat" id="compatTable" aria-label="Compatibility table">
      <colgroup>
        <col class="label"><!-- Item -->
        <col class="a">    <!-- Partner A -->
        <col class="match"><!-- Match -->
        <col class="flag"><!-- Flag -->
        <col class="b">    <!-- Partner B -->
      </colgroup>
      <thead>
        <tr>
          <th>Item</th>
          <th>Partner A</th>
          <th>Match</th>
          <th>Flag</th>
          <th>Partner B</th>
        </tr>
      </thead>
      <tbody id="compatBody"><!-- rows injected --></tbody>
    </table>
  </div>

<script>
/* ──────────────────────────────────────────────────────────────────────────
   One-time bootstrap (prevents “double loading”)
────────────────────────────────────────────────────────────────────────── */
(() => {
  if (window.__TK_ONE_TIME_INIT__) return;  // hard lock
  window.__TK_ONE_TIME_INIT__ = true;

  /* Timestamp */
  const ts = new Date();
  document.getElementById('ts').textContent =
    'Generated: ' + ts.toLocaleString();

  /* Demo source (will be replaced if live globals/localStorage exist) */
  const FALLBACK = [
    ['Giving: Assigning corner time or time-outs',      0, '100%', '▫²', 0],
    ['General: Attitude toward funishment vs serious correction', 3, '100%', '▫²', 3],
    ['Receiving: Being placed in the corner or given a time-out', 5, '100%', '▫²', 5],
    ['Receiving: Getting scolded or lectured for correction',     5, '100%', '▫²', 5],
    ['Receiving: Having privileges revoked (phone, TV)',          3, '100%', '▫²', 3],
    ['Giving: Lecturing or scolding to modify behavior',          4, '100%', '▫²', 4],
    ['Giving: Playful punishments that still reinforce rules',    3, '100%', '▫²', 3],
    ['General: Preferred style of discipline (strict vs lenient)',4, '100%', '▫²', 4],
    ['Receiving: Receiving playful \'funishments\' for minor rule-breaking',2, '100%', '▫²', 2],
    ['Giving: Removing privileges (phone, TV, sweets)',           2, '100%', '▫²', 2],
    ['General: Use of behavior contracts or rule agreements',     2, '100%', '▫²', 2],
  ];

  /* Source resolution: use live globals if present, else localStorage, else fallback */
  function pickRows(){
    try{
      if (Array.isArray(window.talkkinkCompatRows) && window.talkkinkCompatRows.length){
        return window.talkkinkCompatRows;
      }
      const fromLS = localStorage.getItem('talkkink:compatRows');
      if (fromLS){
        const rows = JSON.parse(fromLS);
        if (Array.isArray(rows) && rows.length) return rows;
      }
    }catch{}
    return FALLBACK;
  }

  /* Render into DOM (single-run; we clear body first to avoid doubles) */
  const TBODY = document.getElementById('compatBody');
  function renderTable(rows){
    TBODY.replaceChildren(); // clear any old render
    for (const r of rows){
      const [label, a, match, flag, b] = r;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="label">${label}</td>
        <td class="num">${a}</td>
        <td class="match">${match}</td>
        <td class="flag">${flag}</td>
        <td class="num">${b}</td>
      `;
      TBODY.appendChild(tr);
    }
  }

  const ROWS = pickRows();
  renderTable(ROWS);

  /* ───────────────────────────────────────────────────────────────────────
     PDF EXPORT
     - Loads local vendor files first to dodge “Tracking Prevention blocked…”
     - Falls back to jsDelivr only if allowed in the browser
     - Keeps centered headings and gives them a crisp “outlined” look.
  ─────────────────────────────────────────────────────────────────────── */
  async function loadJsPDF(){
    if (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API.autoTable) return;

    // prefer local copies to avoid third-party storage blocking
    const localScripts = [
      '/vendor/jspdf.umd.min.js',
      '/vendor/jspdf.plugin.autotable.min.js'
    ];
    const cdnScripts = [
      'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
      'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js'
    ];

    async function inject(src){
      await new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true; s.onload = resolve; s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    // try local
    try { for (const s of localScripts) await inject(s); }
    catch(e){ /* ignore; will try CDN */ }

    // if still not available, try CDN (may be blocked by Tracking Prevention)
    if (!(window.jspdf && window.jspdf.jsPDF)){
      try { for (const s of cdnScripts) await inject(s); }
      catch(e){ /* final failure handled below */ }
    }

    if (!(window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API.autoTable)){
      throw new Error('jsPDF/AutoTable not available. Host local copies in /vendor or allow the CDN.');
    }
  }

  function outlineTextPDF(doc, text, x, y, main=[0,231,255], stroke=[0,0,0]){
    // crude “stroke” by stamping black offsets around the text
    const offsets = [[0.35,0],[ -0.35,0],[0,0.35],[0,-0.35]];
    doc.setTextColor(...stroke);
    offsets.forEach(([dx,dy])=>doc.text(text, x+dx, y+dy, {align:'center'}));
    doc.setTextColor(...main);
    doc.text(text, x, y, {align:'center'});
  }

  async function downloadPDF(){
    await loadJsPDF();
    const { jsPDF } = window.jspdf;

    const doc = new jsPDF({ unit:'pt', format:'a4', compress:true });
    const pageW = doc.internal.pageSize.getWidth();

    /* margins tuned to use the page (shrinks empty bands) */
    const M = { top: 40, left: 36, right: 36, bottom: 42 };

    // Background fill (dark)
    doc.setFillColor(16,18,19);
    doc.rect(0,0,pageW,doc.internal.pageSize.getHeight(),'F');

    // Title + timestamp (centered + outlined)
    doc.setFont('helvetica','bold'); doc.setFontSize(34);
    outlineTextPDF(doc, 'TalkKink Compatibility', pageW/2, M.top+8);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.setTextColor(184,223,224);
    doc.text(
      'Generated: ' + new Date().toLocaleString(),
      pageW/2, M.top + 28, {align:'center'}
    );

    // Section heading
    doc.setFont('helvetica','bold'); doc.setFontSize(24);
    outlineTextPDF(doc, 'Behavioral Play', pageW/2, M.top + 62);

    // Column widths (percent -> points)
    const COLW = [0.56, 0.12, 0.16, 0.04, 0.12].map(p => (pageW - M.left - M.right) * p);

    // Build rows for AutoTable
    const head = [['Item','Partner A','Match','Flag','Partner B']];
    const body = ROWS.map(r => [r[0], String(r[1]), r[2], r[3], String(r[4])]);

    doc.autoTable({
      startY: M.top + 80,
      head, body,
      theme:'plain',
      margin: { left: M.left, right: M.right },
      tableWidth: pageW - M.left - M.right,
      styles: {
        font:'helvetica', fontSize:11, cellPadding:6,
        textColor:[230,254,255], fillColor:[17,19,21], lineColor:[35,41,45], lineWidth:0.7
      },
      headStyles: {
        font:'helvetica', fontStyle:'bold', fontSize:12,
        textColor:[0,231,255], fillColor:[16,18,21]
      },
      columnStyles: {
        0:{ cellWidth:COLW[0], halign:'left'   },
        1:{ cellWidth:COLW[1], halign:'center' },
        2:{ cellWidth:COLW[2], halign:'center' },
        3:{ cellWidth:COLW[3], halign:'center' }, // tight Flag
        4:{ cellWidth:COLW[4], halign:'center' }
      },
      didParseCell(data){
        // zebra
        if (data.section === 'body'){
          const even = data.row.index % 2 === 0;
          data.cell.styles.fillColor = even ? [17,19,21] : [15,16,18];
        }
      }
    });

    doc.save('talkkink-compatibility.pdf');
  }

  document.getElementById('downloadPdfBtn')?.addEventListener('click', downloadPDF, { once:false });
})();
</script>
</body>
</html>
