<!--
TALK KINK • FIX "jsPDF-AutoTable failed to load" — ONE BOX FOR CODEX

What this does
1) Loads jsPDF UMD, exposes window.jsPDF, then loads AutoTable — from LOCAL first, then CDNs.
2) Verifies window.jspdf.autoTable OR window.jsPDF.API.autoTable is present before allowing export.
3) Hooks your existing Download button so libs are ready when clicked (no code changes elsewhere).

How to use
- Put BOTH minified files on your server (recommended):
    /js/vendor/jspdf.umd.min.js
    /js/vendor/jspdf.plugin.autotable.min.js
- Paste this entire block just before </body> in compatibility.html (or the page with the button).
- Make sure your button is one of: #downloadBtn, #downloadPdfBtn, or [data-download-pdf].
-->

<script>
(function(){
  const JSPDF_LOCAL   = "/js/vendor/jspdf.umd.min.js";
  const AUTOTABLE_LOCAL = "/js/vendor/jspdf.plugin.autotable.min.js";

  const JSPDF_CDNS = [
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
    "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
    "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"
  ];
  const AUTOTABLE_CDNS = [
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js",
    "https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js",
    "https://unpkg.com/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"
  ];

  function log(){ try{ console.log.apply(console, ["[TK-PDF]"].concat([].slice.call(arguments))); }catch{} }

  function loadScript(src, timeoutMs=8000){
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve("cached");
      const s = document.createElement("script");
      s.src = src; s.async = true;
      const t = setTimeout(() => { s.remove(); reject(new Error("Timeout loading " + src)); }, timeoutMs);
      s.onload = () => { clearTimeout(t); resolve("ok"); };
      s.onerror = () => { clearTimeout(t); reject(new Error("Failed to load " + src)); };
      document.head.appendChild(s);
    });
  }

  async function ensureJsPDF(){
    // already present?
    if (window.jspdf && window.jspdf.jsPDF) {
      window.jsPDF = window.jspdf.jsPDF; // expose for plugins
      return;
    }
    // try LOCAL first
    try {
      await loadScript(JSPDF_LOCAL);
    } catch(e){
      log("Local jsPDF not found:", e.message);
    }
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      // fall back to CDNs
      let ok = false;
      for (const url of JSPDF_CDNS){
        try {
          await loadScript(url);
          if (window.jspdf && window.jspdf.jsPDF) { ok = true; break; }
        } catch (e) { log("CDN jsPDF error:", e.message); }
      }
      if (!ok) throw new Error("jsPDF failed to load from all sources");
    }
    // expose global constructor for AutoTable UMD plugin
    if (window.jspdf && window.jspdf.jsPDF) window.jsPDF = window.jspdf.jsPDF;
  }

  async function ensureAutoTable(){
    const hasAT = (window.jspdf && window.jspdf.autoTable) ||
                  (window.jsPDF && window.jsPDF.API && window.jsPDF.API.autoTable);
    if (hasAT) return;

    // require jsPDF first
    await ensureJsPDF();

    // try LOCAL first
    try {
      await loadScript(AUTOTABLE_LOCAL);
    } catch(e){
      log("Local AutoTable not found:", e.message);
    }

    let ready = (window.jspdf && window.jspdf.autoTable) ||
                (window.jsPDF && window.jsPDF.API && window.jsPDF.API.autoTable);
    if (!ready){
      // fall back to CDNs
      let ok = false;
      for (const url of AUTOTABLE_CDNS){
        try {
          await loadScript(url);
          ready = (window.jspdf && window.jspdf.autoTable) ||
                  (window.jsPDF && window.jsPDF.API && window.jsPDF.API.autoTable);
          if (ready) { ok = true; break; }
        } catch(e) { log("CDN AutoTable error:", e.message); }
      }
      if (!ok) throw new Error("jsPDF-AutoTable failed to load");
    }
  }

  // Optional: quick sanity check util you can call from console
  window.TK_checkPDFLibs = async () => {
    try {
      await ensureJsPDF(); await ensureAutoTable();
      log("jsPDF present:", !!(window.jspdf && window.jspdf.jsPDF));
      const okAT = (window.jspdf && window.jspdf.autoTable) ||
                   (window.jsPDF && window.jsPDF.API && window.jsPDF.API.autoTable);
      log("AutoTable present:", !!okAT);
      alert("PDF libs READY");
    } catch (e) {
      console.error("[TK-PDF] check failed:", e);
      alert("PDF libs FAILED: " + e.message);
    }
  };

  // Bind your existing button so libs are guaranteed BEFORE your export runs
  function bindDownload(){
    const btn = document.querySelector("#downloadBtn") ||
                document.querySelector("#downloadPdfBtn") ||
                document.querySelector("[data-download-pdf]");
    if (!btn) { log("Download button not found"); return; }
    if (btn.__tkBound) return;
    btn.__tkBound = true;

    // Capture phase to preload libs before site handler executes
    btn.addEventListener("click", async (e) => {
      try {
        await ensureJsPDF();
        await ensureAutoTable();
        log("PDF libs ready; proceeding to site exporter");
        // let your page's existing click handler continue (no preventDefault)
      } catch (err) {
        e.preventDefault();
        console.error("[TK-PDF] Export blocked:", err);
        alert("PDF export failed to start: " + err.message + "\n\nMake sure AutoTable is reachable or host it at /js/vendor/.");
      }
    }, true);

    log("Bound Download PDF");
  }

  // init + keep bound across SPA rerenders
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindDownload, { once:true });
  } else {
    bindDownload();
  }
  new MutationObserver(bindDownload).observe(document.documentElement, { childList:true, subtree:true });
})();
</script>

<!--
If you prefer STATIC (no dynamic loader), host both files and include in THIS ORDER:

<script src="/js/vendor/jspdf.umd.min.js"></script>
<script>window.jsPDF = window.jspdf.jsPDF;</script>
<script src="/js/vendor/jspdf.plugin.autotable.min.js"></script>

Ensure BEFORE your export code runs that:
  - window.jspdf && window.jspdf.jsPDF is truthy
  - AND (window.jspdf.autoTable OR window.jsPDF.API.autoTable) is truthy
Otherwise, include the dynamic loader above.
-->
