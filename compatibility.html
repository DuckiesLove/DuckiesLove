<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>See Our Compatibility</title>
  <!-- Import theme and global layout styles -->
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/global.css" />
  <link rel="stylesheet" href="/css/compat-table.css" />
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
  #compat-container {
    width: 100%;
    max-width: 100%;
  }
  table {
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    text-align: center;
    vertical-align: middle;
    padding: 6px;
  }
  th:first-child, td:first-child {
    text-align: left;
    padding-left: 10px;
  }
  </style>
  <style>
    .upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      margin-top: 3rem;
    }

      .upload-button {
        position: relative;
        display: inline-block;
      }

    .upload-button input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .wide-button {
      min-width: 260px;
      max-width: 300px;
      width: 100%;
    }
  </style>
  <style>
    /* Keep rows from splitting in both web and print */
    .compat-section tr { break-inside: avoid; page-break-inside: avoid; }

    /* Make sure tables are fixed-width to avoid right-side cutoff */
    .compat-section table {
      width: 100% !important;
      table-layout: fixed !important;
      border-collapse: collapse !important;
    }

    /* Optional: make header clean (no decorative lines/boxes) */
    .section-title, .category-header, .compat-category {
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }
  </style>
</head>
<body class="theme-dark">
  <div class="main-container themed">
    <h1 class="page-title">See Our Compatibility</h1>
    <div class="upload-container">
      <button class="themed-button wide-button" onclick="window.history.back()">← Back</button>

      <label id="uploadYourSurvey" class="upload-button themed-button wide-button">
        <input id="uploadSurveyA" type="file" accept="application/json" />
        Upload Your Survey
      </label>

      <label id="uploadPartnerSurvey" class="upload-button themed-button wide-button">
        <input id="uploadSurveyB" type="file" accept="application/json" />
        Upload Partner’s Survey
      </label>

      <button class="themed-button wide-button" id="downloadBtn">Download PDF</button>
    </div>

    <div id="comparisonResults">
      <div id="loading-spinner" class="loading-overlay"><div class="spinner"></div></div>
      <div id="compat-container" class="compat-root" data-compat-root></div>
      <div class="print-footer"></div>
    </div>
  </div>

  <script src="js/template-survey.js"></script>
  <script type="module" src="js/compatibilityPage.js"></script>
  <script type="module">
    import { initTheme, applyThemeColors } from './js/theme.js';
    initTheme();
    window.applyThemeColors = applyThemeColors;
  </script>
  <!-- Safe session check script -->
  <script>
  /**
   * Safe session check:
   * - Silently ignores 404 / network errors (useful on static hosting & local previews)
   * - Only redirects on 401 Unauthorized
   * - Won’t throw or spam the console
   *
   * How to use:
   * 1) Paste this block.
   * 2) Delete the old:
   *      fetch("/check-session", { credentials: "include" })
   *        .then(res => { if (res.status === 401) window.location.href = "/token.html"; });
   * 3) Call safeCheckSession(); (or skip entirely if you don’t need auth)
   */

  (function(){
    function safeCheckSession(opts){
      const cfg = Object.assign({
        url: '/check-session',          // change if your API path differs
        redirectTo: '/token.html',      // where to send on 401
        credentials: 'include',         // send cookies if present
        log: false                      // set true to log non-401 statuses
      }, (opts || {}));

      try {
        fetch(cfg.url, { credentials: cfg.credentials })
          .then(res => {
            if (res.status === 401) {
              // Only redirect on explicit 401
              window.location.href = cfg.redirectTo;
              return;
            }
            // Silence 404s and other statuses unless logging is enabled
            if (cfg.log && res.status !== 204 && res.status !== 200) {
              console.info('[session] status:', res.status);
            }
          })
          .catch(() => {
            // Network error / CORS / offline — ignore quietly
          });
      } catch (_) {
        // Older browsers / unexpected errors — ignore
      }
    }

    // OPTIONAL: run automatically on load (safe even if endpoint doesn’t exist)
    document.addEventListener('DOMContentLoaded', function(){
      safeCheckSession();
    });

    // Expose if you want to call manually later
    window.safeCheckSession = safeCheckSession;
  })();
  </script>

  <script type="module">
    import { downloadCompatibilityPDF } from '/js/pdfDownload.js';
    // auto-wire is built into the module, but this exposes it if you need to call it manually:
    window.downloadCompatibilityPDF = downloadCompatibilityPDF;
  </script>
  <script src="/js/tkSpacingPatch.js"></script>
<script>
/* ===================== COMPAT: Robust A/B Fill (markup-agnostic) ===================== *
 * Supports three table shapes:
 *  1) Cells with data-partner-a / data-partner-b attributes             (preferred)
 *  2) Cells with .pa / .pb classes                                      (legacy)
 *  3) No markers, but THEAD headers literally "Partner A" / "Partner B" (auto-tag)
 *
 * Also:
 *  - Annotates rows with data-full (full visible label) and data-id (normalized key)
 *  - Matches JSON -> rows by data-id -> data-full -> visible text -> fuzzy overlap
 *  - Bootstraps a simple table if your container has 0 rows
 *  - Recomputes a Match % (assumes 1–5 scale)
 *
 * Requirements:
 *  - Your wrapper has data-compat-root OR you use #pdf-container
 *  - First column is the label cell (visible text)
 *  - Keep THEAD headers: Category | Partner A | Match | Partner B (lets us auto-tag A/B)
 */

(function(){
  /* ---------- normalizers ---------- */
  function norm(s){
    return String(s||'')
      .replace(/[\u2018\u2019\u2032]/g,"'")
      .replace(/[\u201C\u201D\u2033]/g,'"')
      .replace(/[\u2013\u2014]/g,'-')
      .replace(/\u2026/g,'')
      .replace(/[^\w\s'-]/g,' ')
      .replace(/\s+/g,' ')
      .trim().toLowerCase();
  }
  const toks = s => norm(s).split(' ').filter(Boolean);

  /* ---------- JSON → lookup ---------- */
  function toLookup(json){
    const map = new Map();
    if (!json || typeof json !== 'object') return map;

    // flat {key:value}
    if (!Array.isArray(json) && !json.items && !json.survey){
      for (const [k,v] of Object.entries(json)){
        const n = Number(v); if (Number.isFinite(n)) map.set(norm(k), n);
      }
      return map;
    }

    // items array
    if (Array.isArray(json.items)){
      for (const it of json.items){
        const k = norm(it?.name ?? it?.label ?? it?.key ?? it?.id ?? '');
        const n = Number(it?.rating ?? it?.score ?? it?.value);
        if (k && Number.isFinite(n)) map.set(k, n);
      }
      return map;
    }

    // nested survey export
    if (json.survey && typeof json.survey === 'object'){
      Object.values(json.survey).forEach(section=>{
        ['Giving','Receiving','General'].forEach(bucket=>{
          (Array.isArray(section?.[bucket])?section[bucket]:[]).forEach(it=>{
            const k = norm(it?.name ?? it?.label ?? it?.id ?? '');
            const n = Number(it?.rating ?? it?.score ?? it?.value);
            if (k && Number.isFinite(n)) map.set(k, Math.max(map.get(k)??-Infinity, n));
          });
        });
      });
    }
    return map;
  }

  /* ---------- DOM helpers ---------- */
  function getRoot(){
    return document.querySelector('[data-compat-root]') || document.querySelector('#pdf-container') || document.body;
  }

  // If no rows exist, create a simple "All" table from the union of JSON keys
  function bootstrapIfEmpty(root){
    const hasRows = root.querySelectorAll('tbody tr').length > 0;
    if (hasRows) return false;

    const aMap = toLookup(window.partnerASurvey || window.surveyA || {});
    const bMap = toLookup(window.partnerBSurvey || window.surveyB || {});
    const keys = new Set([...aMap.keys(), ...bMap.keys()]);
    if (!keys.size) return false;

    const section = document.createElement('section'); section.className = 'compat-section';
    const h2 = document.createElement('h2'); h2.className = 'section-title'; h2.textContent = 'All'; section.appendChild(h2);

    const table = document.createElement('table'); table.className = 'compat-table';
    const thead = document.createElement('thead'); const thr = document.createElement('tr');
    ['Category','Partner A','Match','Partner B'].forEach(t=>{ const th=document.createElement('th'); th.textContent=t; thr.appendChild(th); });
    thead.appendChild(thr);
    const tbody = document.createElement('tbody');

    keys.forEach(k=>{
      const tr = document.createElement('tr');
      tr.setAttribute('data-id', k);
      tr.setAttribute('data-full', k);
      const td0 = document.createElement('td'); td0.textContent = k;
      const tda = document.createElement('td'); tda.className = 'pa'; tda.setAttribute('data-partner-a',''); tda.textContent = aMap.has(k) ? aMap.get(k) : '-';
      const tdm = document.createElement('td'); tdm.className = 'match';
      const tdb = document.createElement('td'); tdb.className = 'pb'; tdb.setAttribute('data-partner-b',''); tdb.textContent = bMap.has(k) ? bMap.get(k) : '-';
      tr.append(td0, tda, tdm, tdb); tbody.appendChild(tr);
    });

    table.append(thead, tbody); section.appendChild(table);
    root.innerHTML = ''; root.appendChild(section);
    console.log(`[compat] bootstrapped ${keys.size} rows from JSON union.`);
    return true;
  }

  // Ensure each row has data-full and data-id
  function annotateRows(root){
    root.querySelectorAll('table tbody tr').forEach(tr=>{
      const first = tr.querySelector('td:first-child, th:first-child');
      const vis = first ? (first.textContent || '') : '';
      if (!tr.hasAttribute('data-full') && vis) tr.setAttribute('data-full', vis);
      if (!tr.hasAttribute('data-id')){
        const canon = norm(tr.getAttribute('data-full') || vis);
        if (canon) tr.setAttribute('data-id', canon);
      }
    });
  }

  // If there are no .pa/.pb markers, use THEAD headers to tag the columns
  function ensurePartnerMarkers(root){
    root.querySelectorAll('table').forEach(table=>{
      const thead = table.querySelector('thead tr'); if (!thead) return;
      const ths = Array.from(thead.children).map(th => norm(th.textContent));
      const idxA = ths.indexOf('partner a');
      const idxB = ths.indexOf('partner b');

      const tbody = table.querySelector('tbody'); if (!tbody) return;
      if (idxA >= 0 && !tbody.querySelector('td.pa, td[data-partner-a]')){
        tbody.querySelectorAll('tr').forEach(tr=>{ const td = tr.children[idxA]; if (td){ td.classList.add('pa'); td.setAttribute('data-partner-a',''); }});
      }
      if (idxB >= 0 && !tbody.querySelector('td.pb, td[data-partner-b]')){
        tbody.querySelectorAll('tr').forEach(tr=>{ const td = tr.children[idxB]; if (td){ td.classList.add('pb'); td.setAttribute('data-partner-b',''); }});
      }
    });
  }

  /* ---------- matching ---------- */
  function rowKeyBundle(tr){
    const id   = tr.getAttribute('data-id')   || '';
    const full = tr.getAttribute('data-full') || '';
    const vis  = tr.querySelector('td:first-child, th:first-child')?.textContent || '';
    return { kId: norm(id), kFull: norm(full), kVis: norm(vis) };
  }

  function pickValue(keys, lookup){
    // 1) exact id
    if (keys.kId && lookup.has(keys.kId)) return lookup.get(keys.kId);
    // 2) exact full
    if (keys.kFull && lookup.has(keys.kFull)) return lookup.get(keys.kFull);
    // 3) exact visible
    if (keys.kVis && lookup.has(keys.kVis)) return lookup.get(keys.kVis);
    // 4) contains (either direction)
    for (const [lk, val] of lookup.entries()){
      if (lk.includes(keys.kFull) || keys.kFull.includes(lk)) return val;
      if (lk.includes(keys.kVis)  || keys.kVis.includes(lk))  return val;
    }
    // 5) token overlap ≥60% or ≥4 shared tokens
    const tryKeys = [keys.kFull, keys.kVis].filter(Boolean);
    for (const rk of tryKeys){
      const rt = toks(rk); if (!rt.length) continue;
      for (const [lk, val] of lookup.entries()){
        const lt = toks(lk); if (!lt.length) continue;
        const set = new Set(lt);
        const shared = rt.filter(t=>set.has(t)).length;
        const overlap = Math.min(shared/rt.length, shared/lt.length);
        if (shared >= 4 || overlap >= 0.6) return val;
      }
    }
    return undefined;
  }

  /* ---------- fill + match ---------- */
  function fillColumn(root, selectorList, lookup){
    if (!lookup || !lookup.size) return 0;
    const rows = root.querySelectorAll('table tbody tr');
    let wrote = 0;
    rows.forEach(tr=>{
      const td = tr.querySelector(selectorList);
      if (!td) return;
      const current = (td.textContent || '').trim();
      if (current && !/^[-–—]$/.test(current)) return; // don't overwrite real values
      const val = pickValue(rowKeyBundle(tr), lookup);
      if (val == null) return;
      td.textContent = String(val);
      wrote++;
    });
    return wrote;
  }

  function computeMatch(a, b){
    const na = Number(a), nb = Number(b);
    if (!Number.isFinite(na) || !Number.isFinite(nb)) return '';
    const diff = Math.abs(na - nb);                      // 0..4
    return Math.round((1 - diff/4) * 100) + '%';         // 100..0
  }

  function recomputeMatches(root){
    root.querySelectorAll('table tbody tr').forEach(tr=>{
      const a = tr.querySelector('td[data-partner-a], td.pa')?.textContent;
      const b = tr.querySelector('td[data-partner-b], td.pb')?.textContent;
      const m = tr.querySelector('td[data-match]') || tr.children[2]; // assume 3rd col if standard
      if (m && m.tagName === 'TD') m.textContent = computeMatch(a, b);
    });
  }

  /* ---------- main entry ---------- */
  function runFill(){
    const root = getRoot();
    if (!root) return;

    // If empty, create a minimal table so we can fill something
    bootstrapIfEmpty(root);

    // Make keys discoverable & cells targetable
    annotateRows(root);
    ensurePartnerMarkers(root);

    const aMap = toLookup(window.partnerASurvey || window.surveyA || {});
    const bMap = toLookup(window.partnerBSurvey || window.surveyB || {});

    const wroteA = fillColumn(root, 'td[data-partner-a], td.pa', aMap);
    const wroteB = fillColumn(root, 'td[data-partner-b], td.pb', bMap);

    if (wroteA || wroteB) recomputeMatches(root);
    if (typeof window.populateFlags === 'function') window.populateFlags();

    console.log(`[compat] filled Partner A cells: ${wroteA}; Partner B cells: ${wroteB}`);
  }

  // Wire uploads (Partner A / Partner B)
  document.addEventListener('change', async e=>{
    if (!e.target) return;
    if (e.target.matches('#uploadSurveyA,[data-upload-a],#uploadSurveyB,[data-upload-b]')){
      // If your upload handlers already parse JSON and set window.partnerASurvey/window.partnerBSurvey,
      // runFill will use them. If not, attempt quick inline parsing:
      const f = e.target.files && e.target.files[0];
      if (f && !window.partnerASurvey && !window.partnerBSurvey){
        try {
          const json = JSON.parse(await f.text());
          if (e.target.matches('#uploadSurveyA,[data-upload-a]')) window.partnerASurvey = json;
          else window.partnerBSurvey = json;
        } catch {}
      }
      setTimeout(runFill, 150);
    }
  });

  // Expose manual trigger + run once
  window.__compatRunFill = runFill;
  document.addEventListener('DOMContentLoaded', () => setTimeout(runFill, 250));
})();
</script>

<!-- OPTIONAL: Minimal wiring if you don’t already parse and call handlers -->
<script>
  // If you already parse uploads elsewhere, you can delete this block.
  const upA = document.querySelector('#uploadSurveyA,[data-upload-a]');
  if (upA) upA.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if (!f) return;
    try { window.partnerASurvey = JSON.parse(await f.text()); } catch {}
    if (window.__compatRunFill) window.__compatRunFill();
  });
  const upB = document.querySelector('#uploadSurveyB,[data-upload-b]');
  if (upB) upB.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if (!f) return;
    try { window.partnerBSurvey = JSON.parse(await f.text()); } catch {}
    if (window.__compatRunFill) window.__compatRunFill();
  });
</script>
<!-- TALK KINK — centered header + tighter top spacing (web + PDF) -->
<script>
/* ============================================================================
   WHAT THIS DOES (step-by-step)
   1) Loads a clean, rounded display font (Fredoka) for the title.
   2) Inserts a centered “Talk Kink” heading above the table on the live page.
   3) Injects the same centered heading into the PDF clone on page one only.
   4) Reduces the top margin so the categories/table sit higher (less empty space).
   5) Keeps all changes PDF-only or additive; your existing layout stays intact.
   ============================================================================ */

/* 1) Load aesthetic display font (Fredoka) once */
(function loadFont(){
  if (!document.querySelector('link[data-tk-font]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://fonts.googleapis.com/css2?family=Fredoka:wght@500;700&display=swap';
    link.setAttribute('data-tk-font','1');
    document.head.appendChild(link);
  }
})();

/* 2) Web (live page) header: centered “Talk Kink” above the table */
(function injectLiveHeader(){
  const ROOT = document.getElementById('pdf-container') || document.querySelector('[data-compat-root]') || document.body;
  if (!ROOT) return;

  // Add styles for the live title (does not affect PDF clone)
  if (!document.querySelector('style[data-tk-live]')) {
    const css = `
      .tk-live-title{
        font-family: 'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        font-weight: 700;
        font-size: clamp(28px, 4.2vw, 44px);
        line-height: 1.05;
        letter-spacing: .4px;
        color: #fff;
        text-align: center;
        margin: 18px 0 12px 0; /* small gap above categories */
        text-shadow: 0 2px 0 rgba(0,0,0,.35);
      }
      /* pull the categories up slightly on live page as well */
      #pdf-container, [data-compat-root]{
        scroll-margin-top: 24px;
      }
    `;
    const style = document.createElement('style');
    style.setAttribute('data-tk-live','1');
    style.textContent = css;
    document.head.appendChild(style);
  }

  // Insert the heading once
  if (!document.querySelector('.tk-live-title')) {
    const h = document.createElement('div');
    h.className = 'tk-live-title';
    h.textContent = 'Talk Kink';
    ROOT.parentNode.insertBefore(h, ROOT);
  }
})();

/* 3) PDF clone header (centered) + 4) tighter top spacing for categories */
(function pdfHeaderAndSpacing(){
  // Styles apply ONLY inside the PDF clone (.pdf-export)
  if (!document.querySelector('style[data-tk-pdf-center]')) {
    const css = `
      /* PDF-only title block, centered at the very top */
      .pdf-export .tk-header{
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 64px);
        text-align: center;
        color: #fff;
        z-index: 999;
        pointer-events: none;
      }
      .pdf-export .tk-header .tk-title{
        font-family: 'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        font-weight: 700;
        font-size: 26pt;
        line-height: 1.0;
        letter-spacing: .4px;
        text-shadow: 0 2px 0 rgba(0,0,0,.35);
        margin: 0;
      }
      /* Pull the categories/table up a bit under the centered title */
      .pdf-export #pdf-container,
      .pdf-export .compat-root,
      .pdf-export .compat-table-wrap{
        margin-top: 86px !important; /* reduce from large gap; tweak 76–96px to taste */
      }

      /* Optional: keep columns sensible on page one (text gets real estate) */
      .pdf-export table colgroup col.col-text   { width: 58% !important; }
      .pdf-export table colgroup col.col-pa     { width: 10% !important; }
      .pdf-export table colgroup col.col-match  { width: 12% !important; }
      .pdf-export table colgroup col.col-flag   { width: 8%  !important; }
      .pdf-export table colgroup col.col-pb     { width: 12% !important; }
      .pdf-export td, .pdf-export th{ padding: 6px 8px !important; }
    `;
    const style = document.createElement('style');
    style.setAttribute('data-tk-pdf-center','1');
    style.textContent = css;
    document.head.appendChild(style);
  }

  // Wrap your existing exporter so we can inject the centered title into the PDF clone
  const attach = () => {
    if (typeof window.downloadCompatibilityPDF !== 'function') return false;
    const original = window.downloadCompatibilityPDF;

    window.downloadCompatibilityPDF = async function patchedDownload(){
      // Remember current children so we can find the newly-added clone shell
      const before = new Set([...document.body.children]);
      const res = await original.apply(this, arguments).catch(e=>{ throw e; });

      // Try to find the newly mounted PDF overlay/clone
      const shell = [...document.body.children].find(n => !before.has(n) && n.querySelector && n.querySelector('.pdf-export'))
                 || document.querySelector('.pdf-export')?.closest('div')
                 || document.querySelector('.pdf-export');

      if (shell && shell.querySelector) {
        const clone = shell.querySelector('.pdf-export') || shell;

        // Ensure the table reserves proportional widths (helps keep columns neat)
        clone.querySelectorAll('table').forEach(tbl=>{
          if (!tbl.querySelector('colgroup')){
            const cg = document.createElement('colgroup');
            cg.innerHTML = `
              <col class="col-text"><col class="col-pa"><col class="col-match">
              <col class="col-flag"><col class="col-pb">
            `;
            const thead = tbl.querySelector('thead');
            if (thead && thead.nextSibling) tbl.insertBefore(cg, thead.nextSibling);
            else tbl.insertBefore(cg, tbl.firstChild);
          }
        });

        // Inject the centered header if missing
        if (!clone.querySelector('.tk-header')) {
          const box = document.createElement('div');
          box.className = 'tk-header';
          box.innerHTML = `<div class="tk-title">Talk Kink</div>`;
          clone.appendChild(box);
        }
      }

      return res;
    };
    return true;
  };

  // Attach immediately or as soon as the exporter arrives
  if (!attach()){
    const iv = setInterval(()=>{ if (attach()) clearInterval(iv); }, 120);
    setTimeout(()=>clearInterval(iv), 8000);
  }
})();
</script>

<style>
  /* PDF-only toggles (web stays unchanged) */
  .pdf-export .tk-pdf-only { display:block !important; }

  /* ===== Title & spacing knobs you can tweak ===== */
  :root {
    /* Move the title DOWN a little from the very top of the page */
    --tk-title-top: 22px;         /* ↑ increase to push title farther down */
    /* Pull the first category/table UP closer to the title */
    --tk-first-section-up: -18px; /* more negative = closer to the title */
  }

  /* Centered “Talk Kink” on page 1 */
  .pdf-export .tk-pdf-title {
    position: relative;
    top: var(--tk-title-top);
    font-family: "Fredoka One", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    font-weight: 700;
    text-align: center;
    font-size: 54px;             /* adjust size if desired */
    line-height: 1.05;
    letter-spacing: .5px;
    color: #fff;
    margin: 0 0 10px 0;
  }

  /* Keep PDF surface tidy */
  .pdf-export { padding-top: 0 !important; }
  .pdf-export .compat-intro,
  .pdf-export .page-spacer,
  .pdf-export .hero,
  .pdf-export header,
  .pdf-export .banner,
  .pdf-export .top-gap { display:none !important; }

  /* Pull the first category/table closer to the title */
  .pdf-export .compat-section:first-of-type,
  .pdf-export .categories-table:first-of-type,
  .pdf-export table:first-of-type,
  .pdf-export .section-title:first-of-type {
    /* negative margin moves it upward toward the title */
    margin-top: var(--tk-first-section-up) !important;
  }
</style>

<script>
  (function () {
    // Insert centered PDF-only title at the very top of #pdf-container (once)
    const ROOT = document.getElementById('pdf-container');
    if (!ROOT) return;

    if (!ROOT.querySelector('#tkPdfTitle')) {
      const title = document.createElement('div');
      title.id = 'tkPdfTitle';
      title.className = 'tk-pdf-only tk-pdf-title';
      title.textContent = 'Talk Kink';
      ROOT.insertBefore(title, ROOT.firstChild);
    }

    // Nudge first section/table up after layout settles so it hugs the title
    function tightenFirstSection() {
      const first =
        ROOT.querySelector('.compat-section') ||
        ROOT.querySelector('.categories-table') ||
        ROOT.querySelector('table');
      if (first) {
        const cssVar = getComputedStyle(document.documentElement)
          .getPropertyValue('--tk-first-section-up').trim();
        if (cssVar) first.style.marginTop = cssVar;
      }
    }

    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.finally(() =>
        requestAnimationFrame(() => requestAnimationFrame(tightenFirstSection))
      );
    } else {
      requestAnimationFrame(() => requestAnimationFrame(tightenFirstSection));
    }
  })();
</script>

<script>
(function () {
  /* ========= TUNABLES ========= */
  const TITLE_TEXT = 'Talk Kink';
  const TITLE_FONT_FAMILY = `'Fredoka One', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif`;
  const TITLE_FONT_SIZE = '64px';       // header size in the PDF
  const TITLE_TOP_PADDING = '28px';     // space from the very top of the page to the title
  const GAP_BELOW_TITLE = '14px';       // space between title and first category/table
  /* ============================ */

  // 1) Add tiny PDF-only CSS so the title is centered and gaps are controlled
  (function injectPdfOnlyCSS(){
    if (document.querySelector('style[data-tk-pdf-head]')) return;
    const css = `
      /* Only affects the cloned PDF content (your exporter puts .pdf-export on the clone) */
      .pdf-export .tk-pdf-title {
        width: 100% !important;
        text-align: center !important;
        font-weight: 700 !important;
        color: #fff !important;
        line-height: 1.1 !important;
        padding-top: ${TITLE_TOP_PADDING} !important;
        margin: 0 0 ${GAP_BELOW_TITLE} 0 !important;
      }
      .pdf-export .tk-pdf-title h1 {
        font-family: ${TITLE_FONT_FAMILY} !important;
        font-size: ${TITLE_FONT_SIZE} !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      /* Trim the big gap many themes put before the first section/table */
      .pdf-export .tk-tight-top { margin-top: 0 !important; padding-top: 0 !important; }
    `;
    const s = document.createElement('style');
    s.setAttribute('data-tk-pdf-head', 'true');
    s.textContent = css;
    document.head.appendChild(s);
  })();

  // 2) Guard: we need the target container and the exporter function
  function getPdfRoot(){ return document.getElementById('pdf-container'); }
  function hasExporter(){ return typeof window.downloadCompatibilityPDF === 'function'; }

  // 3) Build a temporary header INSIDE #pdf-container (so it will be cloned into the PDF),
  //    then remove it afterward so your web page layout is untouched.
  async function withPdfHeader(runner){
    const root = getPdfRoot();
    if (!root) { alert('PDF container (#pdf-container) not found.'); return; }

    // Create the title band at the very top of the content
    const titleBand = document.createElement('div');
    titleBand.className = 'tk-pdf-title';
    titleBand.setAttribute('data-hide-on-web', 'true');
    titleBand.innerHTML = `<h1>${TITLE_TEXT}</h1>`;

    // Try to tighten the area above the first visible section/table
    // We’ll mark that first block with tk-tight-top temporarily
    const firstBlock =
      root.querySelector('.compat-section, .category-section, .section-title, h2, h3, table') || root.firstElementChild;

    // Insert the title at the very top of the container
    root.insertBefore(titleBand, root.firstChild);
    if (firstBlock) firstBlock.classList.add('tk-tight-top');

    try {
      return await runner();   // run the PDF export while the header exists
    } finally {
      // Remove the temporary title and class so the live page stays clean
      titleBand.remove();
      if (firstBlock) firstBlock.classList.remove('tk-tight-top');
    }
  }

  // 4) Wire the existing Download button so we inject the title just-in-time,
  //    call your current exporter, then clean up automatically.
  function wireTalkKinkHeader(){
    const btn = document.getElementById('downloadBtn') || document.querySelector('[data-download-pdf]');
    if (!btn) { console.warn('[TK PDF] Download button not found.'); return; }
    if (!hasExporter()) { console.warn('[TK PDF] downloadCompatibilityPDF() not found.'); return; }

    // Replace any existing click handler with a clean one
    const fresh = btn.cloneNode(true);
    btn.replaceWith(fresh);
    fresh.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await withPdfHeader(() => window.downloadCompatibilityPDF());
      } catch (err) {
        console.error('[TK PDF] Export failed:', err);
        alert('Could not generate PDF. Open console for details.');
      }
    });
  }

  // 5) Run on DOM ready (and immediately if DOM is already loaded)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wireTalkKinkHeader);
  } else {
    wireTalkKinkHeader();
  }
})();
</script>

</body>
</html>
