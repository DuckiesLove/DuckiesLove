<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Kill-switch for legacy Partner-B bootstrap that caused "freeze after first upload" -->
  <script>
    // Hard disable any code path that auto-fills Partner B from internal JSON.
    // This must be loaded before every other script.
    window.TK_DISABLE_BOOTSTRAP_B = true;
    console.info('[compat] kill-switch enabled');
    // one-time guard so labels/overrides merge only once per load
    window._tkLabelsMerged = false;
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>See Our Compatibility</title>
  <style>
    /* Kill any category dock/panel overlays without layout shift */
    #tkDockCard,
    #categorySurveyPanel,
    aside.category-panel,
    .category-panel,
    [data-testid="select-categories-panel"],
    #tkOverlay,
    .tk-overlay {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Ensure body isn't pushed for a removed dock */
    html.tk-dock body {
      margin-left: 0 !important;
    }
  </style>
  <script>
    (function killCategoryPanel() {
      const selectors = [
        '#tkDockCard',
        '#categorySurveyPanel',
        'aside.category-panel',
        '.category-panel',
        '[data-testid="select-categories-panel"]',
        '#tkOverlay',
        '.tk-overlay'
      ];

      window.__TK_DISABLE_PANEL__ = true;
      window.__TK_DISABLE_PORTAL__ = true;

      const purge = () => {
        document.documentElement.classList.remove('tk-dock');
        if (document.body) {
          document.body.style.marginLeft = '';
        }
        selectors.forEach((selector) => {
          document.querySelectorAll(selector).forEach((node) => node.remove());
        });
      };

      purge();

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', purge, { once: true });
      }

      const observer = new MutationObserver(purge);
      observer.observe(document.documentElement, { childList: true, subtree: true });
      setTimeout(() => observer.disconnect(), 4000);
    })();
  </script>
  <!-- COMPAT PAGE: recentre layout + neutralize any dock margin -->
  <style id="compat-centering">
    :root {
      --tk-dock-width: 0px !important;
    }

    html,
    body {
      margin: 0;
    }

    .compat-page,
    .compat-wrapper,
    #compatRoot,
    main,
    .page,
    .container {
      max-width: 960px;
      margin: 0 auto !important;
      padding: 40px 16px;
    }

    .compat-buttons,
    .compat-actions {
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
    }

    .compat-buttons .themed-button,
    .compat-actions .themed-button,
    .themed-button.compat {
      width: min(680px, 90vw);
    }
  </style>

  <script>
    (function () {
      try {
        if (document.body) {
          document.body.style.marginLeft = '0px';
        }
        document.documentElement.style.setProperty('--tk-dock-width', '0px');

        const host = document.querySelector(
          '#compatRoot, .compat-page, .compat-wrapper, main, .page, .container'
        );

        if (host) {
          Object.assign(host.style, {
            maxWidth: '960px',
            margin: '0 auto',
            padding: '40px 16px'
          });
        }

        document.querySelectorAll('.themed-button').forEach((btn) => {
          Object.assign(btn.style, {
            width: 'min(680px, 90vw)',
            margin: '0 auto',
            display: 'block'
          });
        });
      } catch (err) {
        console.warn('[compat] unable to apply centering overrides', err);
      }
    })();
  </script>
  <style id="tk-compat-center">
    /* Remove any panel/dock if an older script injected it */
    #tkDockCard,
    #categorySurveyPanel,
    .category-panel,
    .tk-overlay {
      display: none !important;
    }

    html,
    body {
      margin: 0;
    }

    body[style*="margin-left"] {
      margin-left: 0 !important;
    }

    /* Center the content column */
    .compat-wrap,
    .compat-container,
    .container,
    main,
    #app {
      box-sizing: border-box;
      max-width: 960px;
      width: min(960px, 92vw);
      margin-inline: auto;
      padding-inline: 16px;
    }

    .compat-wrap > *,
    .compat-container > *,
    .container > *,
    main > * {
      max-width: 100%;
    }
  </style>
  <script>
    (function () {
      // Nuke any leftover dock/overlay/panel on this page
      for (const sel of ['#tkDockCard', '.tk-overlay', '#categorySurveyPanel', '.category-panel']) {
        const n = document.querySelector(sel);
        if (n) n.remove();
      }

      try {
        document.body.style.marginLeft = '';
      } catch (err) {
        console.warn('[compat] unable to clear dock margin', err);
      }
    })();
  </script>
  <!-- Import theme and global layout styles -->
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/global.css" />
  <link rel="stylesheet" href="/css/compat-table.css" />
  <link rel="stylesheet" href="/css/font-failopen.css">
  <link rel="stylesheet" href="/css/compatibility.css" />
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />

  <style>
    /* --- Percent bar (Match %) --- */
    .pct {
      position: relative;
      width: 100%;
      height: 22px;
      border: 1px solid #3ddbf3;
      border-radius: 6px;
      background: rgba(61,219,243,0.08);
      overflow: hidden;
    }
    .pct-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #18a0fb, #3df3c3);
      transition: width .35s ease;
    }
    .pct-text {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    /* Friendly label text in first column (wrap nicely on small screens) */
    .tk-cat {
      white-space: normal;
      line-height: 1.2;
    }
    .tk-code {
      opacity: .5;
      font-size: .85em;
      margin-left: .4rem;
    }
  </style>
  <style>
    td.pct-cell .pct { position: relative; height: 1.1em; line-height: 1.1em; }
    td.pct-cell .pct .bar { position:absolute; left:0; top:0; bottom:0; width:0%;
                            background:rgba(0,255,255,0.25); border-radius:2px; }
    td.pct-cell .pct .txt { position:relative; display:block; text-align:center; }
    td.pct-cell { min-width:5rem; }
  </style>
  <style>
  #pdf-container {
    width: 100%;
    max-width: 100%;
  }
  table {
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    text-align: center;
    vertical-align: middle;
    padding: 6px;
  }
  th:first-child, td:first-child {
    text-align: left;
    padding-left: 10px;
  }
  </style>
  <style>
    .upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      margin-top: 3rem;
    }

    .upload-button {
      position: relative;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .upload-button input[type="file"] {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .upload-button .upload-trigger {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .upload-button .upload-trigger:focus-visible {
      outline: 2px solid rgba(61, 219, 243, 0.9);
      outline-offset: 2px;
    }

    .wide-button {
      min-width: 260px;
      max-width: 300px;
      width: 100%;
    }
    .export-tip {
      font-size: 0.9rem;
      margin: 0;
    }
  </style>
  <style>
    /* Keep rows from splitting in both web and print */
    .compat-section tr { break-inside: avoid; page-break-inside: avoid; }

    /* Make sure tables are fixed-width to avoid right-side cutoff */
    .compat-section table {
      width: 100% !important;
      table-layout: fixed !important;
      border-collapse: collapse !important;
    }

    /* Optional: make header clean (no decorative lines/boxes) */
    .section-title, .category-header, .compat-category {
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }
  </style>
  <style>
    /* Force LIGHT pdf colors by default; override via body[style] if you want dark */
    :root { --pdf-bg:#fff; --pdf-text:#000; }
    .pdf-export, #pdfWrapper, .pdf-container {
      background: var(--pdf-bg) !important;
      color: var(--pdf-text) !important;
    }
  </style>
  <style>
    /* optional polish to match your theme */
    .tk-compat th, .tk-compat td{
      border-bottom:1px solid #00e6ff33;
      padding:.55rem .8rem;
      vertical-align:middle;
    }
    .tk-compat td.ta-c{ text-align:center; }
  </style>
  <style>
  /* Small, unobtrusive subtitle under the category code */
  .tk-catwrap { display:flex; flex-direction:column; gap:2px; }
  .tk-catwrap .tk-code { font-weight:600; letter-spacing:0.02em; }
  .tk-catwrap .tk-sub  {
    font-weight:500; opacity:.78;
    font-size: clamp(11px,.9vw,13px);
    line-height:1.2;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    max-width: min(48vw, 780px);  /* fits your wide first column */
  }

  /* Match % meter (tuned for your dark theme) */
  .tk-meter {
    position: relative;
    height: 10px; min-width: 110px;
    background: rgba(0, 230, 255, .12);
    border-radius: 999px;
    outline: 1px solid rgba(0,230,255,.20);
    overflow: hidden;
  }
  .tk-meter > .tk-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg,
      rgba(0,230,255,.88), rgba(120,255,250,.95));
    box-shadow: 0 0 10px rgba(0,230,255,.35) inset;
    border-radius: inherit;
    transition: width .35s ease;
  }
  .tk-meter + .tk-pct {
    display:inline-block; min-width: 42px;
    font-weight:800; letter-spacing:.02em;
    margin-left:.5rem; opacity:.9;
  }

  /* Keep row height stable on narrow screens */
  @media (max-width: 720px){
    .tk-catwrap .tk-sub { max-width: 70vw; }
    .tk-meter { min-width: 80px; }
  }
  </style>
  <style>
  /* ====== Match % chip (compact, no layout shift) ====== */
  .tk-match-chip{
    display:inline-flex; flex-direction:column; align-items:center; gap:6px;
    min-width:70px; line-height:1; vertical-align:middle;
  }
  .tk-match-num{ font-weight:800; letter-spacing:.02em; }
  .tk-match-bar{
    position:relative; width:90px; height:7px; border-radius:999px;
    outline:1px solid rgba(0,230,255,.35);
    background:rgba(0,230,255,.10); overflow:hidden;
  }
  .tk-match-fill{
    display:block; height:100%; width:var(--w,0%);
    background:linear-gradient(90deg,#00e6ff,#3bffc4);
    border-radius:inherit; transition:width .25s ease;
  }
  /* Dim the bar if the value is “missing” on that row */
  .tk-match-chip[data-missing="1"] .tk-match-bar{ opacity:.38; }

  /* ====== Category main + tiny subline (summary) ====== */
  .tk-cat-wrap{ display:flex; flex-direction:column; gap:3px; }
  .tk-cat-main{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tk-cat-sub{
    font-size:.82em; color:#9beff7; opacity:.78;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    max-width:48ch;  /* keep it subtle; doesn’t stretch your layout */
  }
  /* On narrow screens you can hide the subline if you want */
  @media (max-width: 680px){
    .tk-cat-sub{ display:none; }
  }
  </style>
  <style>
  /* Compatibility table progressive enhancement (fallback match bar + labels) */
  td.ksv-match { white-space: nowrap; }

  .ksv-matchwrap{
    display:flex; flex-direction:column; align-items:center; gap:.4rem;
    min-width:8rem;
  }
  .ksv-pct{
    font: 800 0.95rem/1.1 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    letter-spacing:.02em; color:#d9ffff;
  }
  .ksv-bar{
    width:100%; height:6px; border-radius:999px;
    background: rgba(0,230,255,.12);
    outline: 1px solid rgba(0,230,255,.35);
    overflow:hidden;
  }
  .ksv-bar > i{
    display:block; height:100%; width:var(--w,0%);
    background: linear-gradient(90deg,#00e6ff 0%, #5fffd6 100%);
    box-shadow: 0 0 6px #00e6ff66 inset;
  }

  td.ksv-cat{
    word-break: break-word;
  }
  .ksv-cat .ksv-cat-text{
    display:inline;
  }
  </style>

  <link rel="stylesheet" href="/assets/css/comparison.css" />
</head>
<body data-page="compat">
  <main class="tk-landing">
    <h1 class="tk-title">TalkKink Compatibility</h1>

    <div class="tk-menu">
      <label for="fileA" class="tk-btn">Upload Your Survey</label>
      <label for="fileB" class="tk-btn">Upload Partner’s Survey</label>
      <button id="btnDownloadPdf" class="tk-btn" disabled>Download PDF</button>
    </div>

        <a href="https://talkkink.org/KinkSurveyPage/index.html" class="tk-btn back">← Back</a>

    <input id="fileA" type="file" accept=".json" hidden />
    <input id="fileB" type="file" accept=".json" hidden />
  </main>

  <script>
    function ksvParseSurveyJsonText(jsonText, partner = 'A') {
      const fail = (reason) => ({ ok: false, reason, cells: [], survey: null });
      if (typeof jsonText !== 'string') return fail('No JSON payload provided');

      let payload;
      try {
        payload = JSON.parse(jsonText);
      } catch (err) {
        return fail('Invalid JSON');
      }

      const answers = {};
      const answersByKey = {};
      let maxIndex = 0;

      const clamp = (value) => {
        const n = Number(value);
        if (!Number.isFinite(n)) return 0;
        if (n < 0) return 0;
        if (n > 5) return 5;
        return Math.round(n);
      };

      const toRating = (value) => {
        if (value == null || value === '') return 0;
        if (typeof value === 'number' && Number.isFinite(value)) return clamp(value);
        if (typeof value === 'string') {
          const trimmed = value.trim();
          if (!trimmed) return 0;
          const match = trimmed.match(/-?\d+(?:\.\d+)?/);
          if (match) return clamp(Number(match[0]));
        }
        return 0;
      };

      const applyRating = (index, value) => {
        const idx = Number(index);
        if (!Number.isFinite(idx) || idx <= 0) return;
        const normalized = toRating(value);
        const key = String(idx);
        answersByKey[key] = normalized;
        if (idx > maxIndex) maxIndex = idx;
      };

      const absorbArray = (arr) => {
        if (!Array.isArray(arr)) return;
        arr.forEach((value, i) => applyRating(i + 1, value));
      };

      const absorbObject = (obj) => {
        if (!obj || typeof obj !== 'object') return;
        Object.keys(obj)
          .sort((a, b) => Number(a) - Number(b))
          .forEach((key) => applyRating(key, obj[key]));
      };

      if (Array.isArray(payload)) {
        absorbArray(payload);
      } else if (payload && typeof payload === 'object') {
        absorbArray(payload.cells);
        absorbArray(payload.answers);
        absorbObject(payload.answersByKey);
        absorbObject(payload.answersById);
        absorbObject(payload.ratings);
      } else {
        return fail('Unsupported survey payload');
      }

      if (!maxIndex) {
        return fail('No survey answers found');
      }

      for (let i = 1; i <= maxIndex; i += 1) {
        const key = String(i);
        const rating = Object.prototype.hasOwnProperty.call(answersByKey, key)
          ? answersByKey[key]
          : 0;
        answers[key] = rating;
        answersByKey[key] = rating;
      }

      const cells = Array.from({ length: maxIndex }, (_, i) => answersByKey[String(i + 1)] ?? 0);
      return { ok:true, cells, survey: { answers, answersByKey } };
}

    window.ksvParseSurveyJsonText = ksvParseSurveyJsonText;
  </script>

  <script defer src="/js/theme-globals.js"></script>
  <script defer src="/js/pdfDownload.js"></script>
  <script defer src="/assets/js/comparison.js"></script>
  <!-- =====================  TalkKink Compatibility PDF (ALL-IN-ONE)  =====================
Paste this whole block into Codex (e.g., at the end of compatibility.html, before </body>).
It adds a "Download PDF" button (id="btnDownloadPdf") and generates a black-background,
category-grouped PDF using the surveys stored in localStorage as:
  - tk_compat.self
  - tk_compat.partner
======================================================================================== -->

  <!-- 1) jsPDF UMD (must come before our script) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- 2) ALL-IN-ONE UMD PDF GENERATOR (no ES modules) -->
  <script>
(function (global) {
  'use strict';

  // ---------- helpers ----------
  function ensureJsPDF() {
    const j = global.jspdf && global.jspdf.jsPDF;
    if (!j) {
      alert('jsPDF not loaded. Include jspdf.umd.min.js before this script.');
      return null;
    }
    return j;
  }

  function split(doc, text, width) {
    return doc.splitTextToSize(String(text ?? ''), width);
  }

  function groupByCategory(rows) {
    const map = new Map();
    (rows || []).forEach(r => {
      const key = r.category || r.categoryId || 'Other';
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(r);
    });
    return map;
  }

  function paintBlackBackground(doc) {
    const { wPt, hPt } = doc.internal.pageSize;
    doc.setFillColor(0, 0, 0);
    doc.rect(0, 0, wPt, hPt, 'F');
  }

  function writeLines(doc, lines, x, y, lineH, margin) {
    const { hPt } = doc.internal.pageSize;
    let cy = y, maxY = hPt - margin;
    lines.forEach(line => {
      if (cy + lineH > maxY) {
        doc.addPage();
        paintBlackBackground(doc);
        cy = margin;
      }
      doc.text(line, x, cy);
      cy += lineH;
    });
    return cy;
  }

  function mergePairs(self, partner) {
    const out = [];
    const ids = new Set([
      ...Object.keys(self?.byKink || {}),
      ...Object.keys(partner?.byKink || {})
    ]);
    ids.forEach(kid => {
      const s = self.byKink?.[kid] || {};
      const p = partner.byKink?.[kid] || {};
      const ref = (self.answers?.find(a => a.kinkId == kid) ||
                   partner.answers?.find(a => a.kinkId == kid)) || { title: kid, category: 'Other' };
      out.push({
        kinkId: kid,
        title: ref.title || kid,
        category: ref.category || ref.categoryId || 'Other',
        sGiving: s.giving ?? null,
        sReceiving: s.receiving ?? null,
        sGeneral: s.general ?? null,
        pGiving: p.giving ?? null,
        pReceiving: p.receiving ?? null,
        pGeneral: p.general ?? null
      });
    });
    return out;
  }

  function buildCategoryRows(self, partner) {
    const merged = mergePairs(self, partner);
    return merged.map(m => ({
      category: m.category,
      title: m.title,
      pairText: [
        `You/Partner — G: ${m.sGiving ?? '-'} / ${m.pGiving ?? '-'}`,
        `R: ${m.sReceiving ?? '-'} / ${m.pReceiving ?? '-'}`,
        `Gen: ${m.sGeneral ?? '-'} / ${m.pGeneral ?? '-'}`
      ].join(' • ')
    }));
  }

  function headerLine(doc, txt, x, y) {
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text(txt, x, y);
    doc.setFont('helvetica', 'normal');
  }

  // ---------- main ----------
  function generate(self, partner, filename = 'talkkink-compatibility.pdf') {
    const jsPDF = ensureJsPDF();
    if (!jsPDF) return;
    if (!self || !partner) {
      alert('Upload both surveys first.');
      return;
    }

    const doc = new jsPDF({ unit: 'pt', format: 'letter' }); // 612 x 792
    paintBlackBackground(doc);
    doc.setTextColor(255, 255, 255);

    const margin = 48;
    const contentW = doc.internal.pageSize.wPt - margin * 2;
    let y = margin + 10;

    // Title
    doc.setFontSize(26);
    doc.setFont('helvetica', 'bold');
    const title = 'TalkKink Compatibility';
    const tW = doc.getTextWidth(title);
    doc.text(title, (doc.internal.pageSize.wPt - tW) / 2, y);
    y += 30;

    // Meta
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    const selectedCats = (self.meta?.selectedCategories && self.meta.selectedCategories.length)
      ? self.meta.selectedCategories.join(', ')
      : '—';
    y = writeLines(doc, [
      `Exported: ${new Date().toLocaleString()}`,
      `Theme: ${self.meta?.theme || partner.meta?.theme || 'dark'}`,
      `Selected Categories: ${selectedCats}`
    ], margin, y, 14, margin) + 8;

    // Category blocks
    const catMap = groupByCategory(buildCategoryRows(self, partner));
    for (const [cat, items] of catMap.entries()) {
      headerLine(doc, cat, margin, y);
      y += 20;

      items.forEach(item => {
        doc.setFontSize(12);
        y = writeLines(doc, split(doc, `• ${item.title}`, contentW), margin, y, 15, margin);
        doc.setFontSize(10);
        y = writeLines(doc, split(doc, item.pairText, contentW), margin + 16, y, 13, margin);
        y += 6;
      });

      y += 10;
    }

    // Footer
    const { hPt } = doc.internal.pageSize;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'italic');
    doc.text('TalkKink — https://talkkink.org', margin, hPt - margin + 20);

    doc.save(filename);
  }

  function generateFromStorage() {
    let self = null, partner = null;
    try { self = JSON.parse(localStorage.getItem('tk_compat.self')); } catch {}
    try { partner = JSON.parse(localStorage.getItem('tk_compat.partner')); } catch {}
    if (!self || !partner) {
      alert('Upload both surveys first.');
      return;
    }
    generate(self, partner);
  }

  // expose global
  global.TKCompatPDF = { generate, generateFromStorage };

})(window);

// 3) WIRE THE BUTTON (expects a button with id="btnDownloadPdf")
(function () {
  const btn = document.querySelector('#btnDownloadPdf');
  if (btn) btn.addEventListener('click', () => window.TKCompatPDF.generateFromStorage());
})();
  </script>
</body>

</html>
