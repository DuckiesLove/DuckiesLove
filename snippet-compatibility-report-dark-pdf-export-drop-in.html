<!-- 
Talk Kink â€” Compatibility Report â€¢ Dark Mode Exporter
====================================================

ðŸ“– Directions:
1. Make sure your table is present on the page 
   (id="compatibilityTable", class="results-table compat", or just <table>).

2. Add a button with id="downloadBtn" somewhere in your HTML if you want 
   users to click and download:
     <button id="downloadBtn">Download PDF</button>

3. Paste this <script> block before </body> in your HTML 
   OR paste just the JS part in DevTools Console.

4. Use either:
   - Click the button (#downloadBtn), OR
   - Run TKPDF_forceDark() in the console.

A PDF called compatibility-dark.pdf will be downloaded.
-->
<script>
(async function () {
  // loader
  const load = (src) =>
    new Promise((res, rej) => {
      if (document.querySelector(`script[src="${src}"]`)) return res();
      const s = document.createElement("script");
      s.src = src;
      s.onload = res;
      s.onerror = () => rej(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });

  async function ensureLibs() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await load("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
    const hasAT =
      (window.jspdf && window.jspdf.autoTable) ||
      (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable);
    if (!hasAT) {
      await load("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  const tidy = (s) => (s || "").replace(/\s+/g, " ").trim();
  const toNum = (v) => {
    const n = Number(String(v ?? "").replace(/[^\d.-]/g, ""));
    return Number.isFinite(n) ? n : null;
  };

  function findTable() {
    return (
      document.querySelector("#compatibilityTable") ||
      document.querySelector(".results-table.compat") ||
      document.querySelector("table")
    );
  }

  function extractRows(table) {
    const trs = [...table.querySelectorAll("tr")].filter(
      (tr) => tr.querySelectorAll("th").length === 0 && tr.querySelectorAll("td").length > 0
    );
    return trs.map((tr) => {
      const cells = [...tr.querySelectorAll("td")].map((td) => tidy(td.textContent));
      const category = cells[0] || "â€”";
      const nums = cells.map(toNum).filter((n) => n !== null);
      const A = nums.length ? nums[0] : null;
      const B = nums.length ? nums[nums.length - 1] : null;
      let pct = cells.find((c) => /%$/.test(c)) || null;
      if (!pct && A != null && B != null) {
        const p = Math.round(100 - (Math.abs(A - B) / 5) * 100);
        pct = `${Math.max(0, Math.min(100, p))}%`;
      }
      return [category, A ?? "â€”", pct ?? "â€”", B ?? "â€”"];
    });
  }

  async function TKPDF_exportDark() {
    try {
      await ensureLibs();
      const { jsPDF } = window.jspdf;
      const table = findTable();
      if (!table) return alert("No table found.");
      const body = extractRows(table);
      if (!body.length) return alert("No rows to export.");

      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const paintBg = () => {
        doc.setFillColor(0, 0, 0);
        doc.rect(0, 0, pageW, pageH, "F");
        doc.setTextColor(255, 255, 255);
      };

      paintBg();
      doc.setFontSize(24);
      doc.text("Talk Kink â€¢ Compatibility Report", pageW / 2, 42, { align: "center" });

      const marginLR = 30;
      const usable = pageW - marginLR * 2;
      const Awidth = 90, Mwidth = 110, Bwidth = 90;
      const CatWidth = Math.max(220, usable - (Awidth + Mwidth + Bwidth));

      const runAT = (opts) => {
        if (typeof doc.autoTable === "function") return doc.autoTable(opts);
        if (window.jspdf && typeof window.jspdf.autoTable === "function")
          return window.jspdf.autoTable(doc, opts);
        throw new Error("AutoTable not available");
      };

      runAT({
        theme: "grid",
        head: [["Category", "Partner A", "Match %", "Partner B"]],
        body,
        startY: 64,
        margin: { left: marginLR, right: marginLR, top: 64, bottom: 40 },
        tableWidth: usable,
        styles: {
          fontSize: 11,
          cellPadding: 6,
          textColor: [255, 255, 255],
          fillColor: [0, 0, 0],
          lineColor: [255, 255, 255],
          lineWidth: 1.2,
          halign: "center",
          valign: "middle",
        },
        headStyles: {
          fillColor: [0, 0, 0],
          textColor: [255, 255, 255],
          fontStyle: "bold",
          lineColor: [255, 255, 255],
          lineWidth: 1.6,
        },
        bodyStyles: {
          fillColor: [0, 0, 0],
          textColor: [255, 255, 255],
        },
        alternateRowStyles: {
          fillColor: [0, 0, 0],
          textColor: [255, 255, 255],
        },
        columnStyles: {
          0: { cellWidth: CatWidth, halign: "left" },
          1: { cellWidth: Awidth, halign: "center" },
          2: { cellWidth: Mwidth, halign: "center" },
          3: { cellWidth: Bwidth, halign: "center" },
        },
        willDrawPage: paintBg,
      });

      doc.save("compatibility-dark.pdf");
    } catch (err) {
      console.error("[TK-PDF] Export failed:", err);
      alert("PDF export failed: " + (err?.message || err));
    }
  }

  window.TKPDF_forceDark = TKPDF_exportDark;

  const btn = document.querySelector("#downloadBtn");
  if (btn) {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      TKPDF_exportDark();
    });
    console.log("[TK-PDF] Bound Download PDF button");
  }
})();
</script>
