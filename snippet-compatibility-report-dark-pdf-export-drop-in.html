<!-- TK FULL-BLEED PDF + LABEL MAP + BUTTON FIX (drop-in) -->
<style id="tk-fullbleed-css">
  :root{--fg:#e6e6e6}
  html,body{background:#000;color:var(--fg);margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{width:100%;margin:0;padding:24px 24px 40px;box-sizing:border-box}
  /* Print CSS (in case someone uses the browser dialog) */
  @media print {
    @page{size:auto;margin:0}
    html,body{background:#000!important}
    .wrap{padding:0}
  }
</style>

<script>
(() => {
  const BTN_SELECTOR = '#dl';
  const TARGET_SELECTOR = '.wrap';
  const JSPDF_URL = '/js/vendor/jspdf.umd.min.js';
  const H2C_URL = '/js/vendor/html2canvas.min.js';

  const log = (...a) => console.log('[TK-PDF]', ...a);

  // Safe loader for vendor libs
  const loadScript = (src) => new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = new URL(src, document.baseURI).href;
    s.defer = true;
    s.onload = res;
    s.onerror = () => rej(new Error('Failed to load ' + src));
    document.head.appendChild(s);
  });

  async function ensureVendors() {
    if (!globalThis.jspdf) await loadScript(JSPDF_URL);
    if (!globalThis.html2canvas) await loadScript(H2C_URL);
    if (!globalThis.jspdf || !globalThis.html2canvas) {
      throw new Error('jsPDF or html2canvas not available');
    }
  }

  async function makeFullBleedPDF() {
    log('Export start');
    await ensureVendors();

    // Force a black background for the snapshot
    const target = document.querySelector(TARGET_SELECTOR) || document.body;
    const prevHtmlBg = getComputedStyle(document.documentElement).backgroundColor;
    const prevBodyBg = getComputedStyle(document.body).backgroundColor;
    document.documentElement.style.background = '#000';
    document.body.style.background = '#000';

    try {
      // Snapshot: scale up for sharper PDF
      const canvas = await globalThis.html2canvas(target, {
        backgroundColor: '#000',
        scale: Math.min(2, window.devicePixelRatio || 1.5),
        allowTaint: true,
        useCORS: true,
        logging: false
      });

      const { jsPDF } = globalThis.jspdf;
      // Landscape if your table is wide; flip to 'p' for portrait if you prefer
      const doc = new jsPDF({ orientation: 'l', unit: 'pt', format: 'a4' });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      // BLACK PAGE, NO MARGINS
      doc.setFillColor(0,0,0);
      doc.rect(0, 0, pageW, pageH, 'F');

      // Fit canvas edge-to-edge (preserving aspect)
      const imgData = canvas.toDataURL('image/png');
      const imgW = canvas.width;
      const imgH = canvas.height;
      const ratio = Math.min(pageW / imgW, pageH / imgH);
      const drawW = imgW * ratio;
      const drawH = imgH * ratio;
      const x = (pageW - drawW) / 2;
      const y = (pageH - drawH) / 2;

      doc.addImage(imgData, 'PNG', x, y, drawW, drawH, undefined, 'FAST');
      doc.save('compatibility.pdf');
      log('Export complete');
    } catch (err) {
      console.error('[TK-PDF] Export failed:', err);
      alert('PDF export failed. See console for details.');
    } finally {
      // restore any previous backgrounds
      document.documentElement.style.background = prevHtmlBg;
      document.body.style.background = prevBodyBg;
    }
  }

  // Intercept clicks robustly (works even if another handler exists)
  function bindDownload() {
    const btn = document.querySelector(BTN_SELECTOR);
    if (!btn) {
      log(`Button ${BTN_SELECTOR} not found; will re-try after DOMContentLoaded`);
      document.addEventListener('DOMContentLoaded', bindDownload, { once: true });
      return;
    }
    // Remove any inline onclick to avoid window.print()
    btn.removeAttribute('onclick');

    // Capture phase to beat bubbling handlers that call print()
    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopImmediatePropagation();
      makeFullBleedPDF();
    }, true);

    log('Hijacker armed â€” click your Download PDF and it will use the new exporter.');
  }

  // Arm immediately and after DOM is ready
  bindDownload();
  document.addEventListener('DOMContentLoaded', bindDownload, { once: true });
})();
</script>
