<!-- 
Talk Kink â€” Compatibility Report â€¢ Dark Mode Exporter
====================================================

ðŸ“– Directions:
1. Make sure your table is present on the page 
   (id="compatibilityTable", class="results-table compat", or just <table>).

2. Add a button with id="downloadBtn" somewhere in your HTML if you want 
   users to click and download:
     <button id="downloadBtn">Download PDF</button>

3. Paste this <script> block before </body> in your HTML 
   OR paste just the JS part in DevTools Console.

4. Use either:
   - Click the button (#downloadBtn), OR
   - Run TKPDF_forceDark() in the console.

A PDF called compatibility-dark.pdf will be downloaded.
-->
<script>
(async function () {
  // loader
  const load = (src) =>
    new Promise((res, rej) => {
      if (document.querySelector(`script[src="${src}"]`)) return res();
      const s = document.createElement("script");
      s.src = src;
      s.onload = res;
      s.onerror = () => rej(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });

  async function ensureLibs() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await load("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
    const hasAT =
      (window.jspdf && window.jspdf.autoTable) ||
      (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable);
    if (!hasAT) {
      await load("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  const tidy = (s) => (s || "").replace(/\s+/g, " ").trim();
  const toNum = (v) => {
    const n = Number(String(v ?? "").replace(/[^\d.-]/g, ""));
    return Number.isFinite(n) ? n : null;
  };
  const isValidScore = (n) => Number.isInteger(n) && n >= 1 && n <= 5;

  function findTable() {
    return (
      document.querySelector("#compatibilityTable") ||
      document.querySelector(".results-table.compat") ||
      document.querySelector("table")
    );
  }

  function extractRows(table) {
    // rows that have <td> cells (some sites use <td> for headers)
    const trs = [...table.querySelectorAll("tr")].filter(
      (tr) => tr.querySelectorAll("td").length > 0
    );

    const isHeaderLike = (cellTexts) => {
      const first = (cellTexts[0] || "").toLowerCase();
      const joined = cellTexts.map((t) => (t || "").toLowerCase()).join(" | ");
      if (first === "category") return true;
      if (/partner a|partner b|match/.test(joined)) return true;
      if (!cellTexts.some((t) => /\S/.test(t))) return true;
      return false;
    };

    const rows = [];
    for (const tr of trs) {
      const cells = [...tr.querySelectorAll("td")].map((td) => tidy(td.textContent));
      if (!cells.length) continue;
      if (isHeaderLike(cells)) continue;

      const category = cells[0] || "â€”";
      const numeric = cells.map(toNum).filter((n) => n !== null);
      const Araw = numeric.length ? numeric[0] : null;
      const Braw = numeric.length ? numeric[numeric.length - 1] : null;

      const aValid = isValidScore(Araw);
      const bValid = isValidScore(Braw);

      let pct = cells.find((c) => /%$/.test(c)) || null;
      if (!pct && aValid && bValid) {
        const p = Math.round(100 - (Math.abs(Araw - Braw) / 5) * 100);
        pct = `${Math.max(0, Math.min(100, p))}%`;
      }
      if (!pct) pct = "â€”";

      rows.push([category, aValid ? Araw : "â€”", pct, bValid ? Braw : "â€”"]);
    }

    return rows;
  }

  async function TKPDF_exportDark() {
    try {
      await ensureLibs();
      const { jsPDF } = window.jspdf;
      const table = findTable();
      if (!table) return alert("No table found.");
      const body = extractRows(table);
      if (!body.length) return alert("No rows to export.");

      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const paintBg = () => {
        doc.setFillColor(0, 0, 0);
        doc.rect(0, 0, pageW, pageH, "F");
        doc.setTextColor(255, 255, 255);
      };

      paintBg();
      doc.setFontSize(24);
      doc.text("Talk Kink â€¢ Compatibility Report", pageW / 2, 42, { align: "center" });

      const marginLR = 30;
      const usable = pageW - marginLR * 2;
      const Awidth = 90, Mwidth = 110, Bwidth = 90;
      const CatWidth = Math.max(220, usable - (Awidth + Mwidth + Bwidth));

      const runAT = (opts) => {
        if (typeof doc.autoTable === "function") return doc.autoTable(opts);
        if (window.jspdf && typeof window.jspdf.autoTable === "function")
          return window.jspdf.autoTable(doc, opts);
        throw new Error("AutoTable not available");
      };

      const originalAddPage = doc.addPage;
      doc.addPage = function patchedAddPage(...args) {
        const result = originalAddPage.apply(this, args);
        paintBg();
        return result;
      };

      try {
        runAT({
          theme: "grid",
          head: [["Category", "Partner A", "Match %", "Partner B"]],
          body,
          startY: 64,
          margin: { left: marginLR, right: marginLR, top: 64, bottom: 40 },
          tableWidth: usable,
          styles: {
            fontSize: 11,
            cellPadding: 6,
            textColor: [255, 255, 255],
            fillColor: [0, 0, 0],
            lineColor: [255, 255, 255],
            lineWidth: 1.2,
            halign: "center",
            valign: "middle",
          },
          headStyles: {
            fillColor: [0, 0, 0],
            textColor: [255, 255, 255],
            fontStyle: "bold",
            lineColor: [255, 255, 255],
            lineWidth: 1.6,
          },
          bodyStyles: {
            fillColor: [0, 0, 0],
            textColor: [255, 255, 255],
          },
          alternateRowStyles: {
            fillColor: [0, 0, 0],
            textColor: [255, 255, 255],
          },
          columnStyles: {
            0: { cellWidth: CatWidth, halign: "left" },
            1: { cellWidth: Awidth, halign: "center" },
            2: { cellWidth: Mwidth, halign: "center" },
            3: { cellWidth: Bwidth, halign: "center" },
          },
          willDrawPage: paintBg,
        });
      } finally {
        doc.addPage = originalAddPage;
      }

      doc.save("compatibility-dark.pdf");
    } catch (err) {
      console.error("[TK-PDF] Export failed:", err);
      alert("PDF export failed: " + (err?.message || err));
    }
  }

  window.TKPDF_forceDark = TKPDF_exportDark;

  const btn = document.querySelector("#downloadBtn");
  if (btn) {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      TKPDF_exportDark();
    });
    console.log("[TK-PDF] Bound Download PDF button");
  }
})();
</script>
