<!-- TalkKink â€“ Question Glow + Guard + 0â€“5 Chips (robust v2) -->
<script>
/* ===========================================================
   TalkKink â€“ Question Glow + Guard + 0â€“5 Chips (robust v2)
   Paste into Codex once. Works across themes, cards, Next/Back.
   Hotkey: Alt+G to re-run.
   =========================================================== */
(function () {
  // --- CSS (once) ---
  if (!document.getElementById('tkQGuardCSSv2')) {
    const style = document.createElement('style');
    style.id = 'tkQGuardCSSv2';
    style.textContent = `
      .tk-question-card {
        position: relative;
        border-radius: 14px;
        background: rgba(10,12,16,.75);
        border: 1px solid rgba(120,200,255,.18);
        box-shadow:
          0 0 0 1px rgba(120,200,255,.18) inset,
          0 10px 28px rgba(0,0,0,.45),
          0 0 18px rgba(50,170,255,.35);
      }
      .tk-guard {
        margin: 10px 0 14px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(12,16,22,.9);
        border: 1px solid rgba(120,200,255,.28);
        box-shadow: 0 0 0 1px rgba(120,200,255,.18) inset, 0 0 16px rgba(50,170,255,.25);
      }
      .tk-guard h4 {
        margin: 0 0 8px 0; font-size: 1.02rem; letter-spacing: .2px;
        color: #e9f4ff; text-shadow: 0 0 8px rgba(120,200,255,.35);
      }
      .tk-guard p { margin: 4px 0; color: #cfe6ff; opacity: .95; }
      .tk-legend-box {
        margin-top: 10px; padding: 10px 12px; border-radius: 12px;
        background: #0c1420; border: 1px solid rgba(120,200,255,.22);
        box-shadow: 0 0 0 1px rgba(120,200,255,.16) inset, 0 0 12px rgba(50,170,255,.22);
      }
      .tk-legend { display:grid; grid-template-columns: repeat(2, minmax(220px,1fr)); gap:10px 14px; }
      .tk-pill {
        display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
        background:#0e1218; color:#dbefff; border:1px solid rgba(255,255,255,.08);
        box-shadow: 0 0 0 1px rgba(255,255,255,.03) inset; font-size:.95rem;
      }
      .tk-dot { width:12px; height:12px; border-radius:999px; box-shadow:0 0 10px currentColor; }
      .tk-red .tk-dot{color:#ff5a6a;background:#ff5a6a;}
      .tk-yellow .tk-dot{color:#ffd34a;background:#ffd34a;}
      .tk-grey .tk-dot{color:#9aa7b1;background:#9aa7b1;}
      .tk-blue .tk-dot{color:#53c0ff;background:#53c0ff;}
      .tk-chip-row{ display:flex; gap:10px; margin:8px 0 6px; }
      .tk-chip{
        display:inline-flex; align-items:center; justify-content:center;
        width:44px; height:44px; border-radius:10px; cursor:pointer; user-select:none;
        background:#0e1218; color:#dbefff; font-weight:700;
        border:1px solid rgba(120,200,255,.22);
        box-shadow: 0 0 10px rgba(80,170,255,.16) inset, 0 0 12px rgba(50,170,255,.22);
        transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
      }
      .tk-chip:hover{ transform:translateY(-1px); box-shadow:0 0 12px rgba(80,170,255,.22) inset, 0 0 16px rgba(50,170,255,.30); }
      .tk-chip.is-active{
        background:#111a24; border-color:rgba(120,200,255,.42);
        box-shadow:0 0 14px rgba(80,170,255,.28) inset, 0 0 18px rgba(50,170,255,.38);
      }
      .tk-chip-anchor{ margin-top:6px; }
    `;
    document.head.appendChild(style);
  }

  // --- helpers ---
  const log = (...a) => console.log('%c[TK]', 'color:#76d1ff', ...a);

  const rateRegex = /rate\s*interest\s*\/\s*comfort\s*\(\s*0\s*[â€“-]?\s*5\s*\)/i;

  function findByText(re) {
    const all = document.querySelectorAll('*');
    for (let i = 0; i < all.length; i++) {
      const n = all[i];
      if (re.test(n.textContent || '')) return n;
    }
    return null;
  }

  // Find numeric buttons 0â€“5 nearest to rating area
  function findNumberButtons(context) {
    const container = context || document;
    const candidates = Array.from(container.querySelectorAll('button, .btn, [role="button"]'))
      .filter(el => /^\s*[0-5]\s*$/.test(el.textContent || ''));
    return candidates;
  }

  function nearestQuestionCard(fromEl) {
    if (!fromEl) return null;
    let el = fromEl;
    for (let i = 0; i < 8 && el; i++) {
      const hasControls = el.querySelector && (
        el.querySelector('button') || el.querySelector('[role="button"]') || el.querySelector('input')
      );
      const hasHeading = el.querySelector && el.querySelector('h1,h2,h3,h4');
      if (hasControls && hasHeading) return el;
      el = el.parentElement;
    }
    return fromEl.parentElement || fromEl;
  }

  function buildGuard() {
    const wrap = document.createElement('div');
    wrap.className = 'tk-guard';
    wrap.innerHTML = `
      <h4>Question Guard: How to use this scale</h4>
      <p><strong>Soft Limit</strong> (yellow): You might do it with conditions â€” slower pace, explicit check-ins, and an easy out.</p>
      <p><strong>Willing to Try</strong> (blue): Youâ€™re open and curious. Boundaries and consent steps still apply; itâ€™s a gentle â€œletâ€™s exploreâ€.</p>
      <div class="tk-legend-box">
        <div class="tk-legend">
          <div class="tk-pill tk-red"><span class="tk-dot"></span><strong>Hard Limit</strong> â€” full stop</div>
          <div class="tk-pill tk-yellow"><span class="tk-dot"></span><strong>Soft Limit</strong> â€” yellow light; go slow & check-in</div>
          <div class="tk-pill tk-grey"><span class="tk-dot"></span><strong>Not Interested</strong> â€” no thanks</div>
          <div class="tk-pill tk-blue"><span class="tk-dot"></span><strong>Willing to Try</strong> â€” curious with care</div>
        </div>
        <div style="margin-top:10px;color:#aacdf3;">
          Tip: <strong>0</strong> = my brain did a cartwheel; I skipped this one ğŸ˜…
        </div>
      </div>
    `;
    return wrap;
  }

  function addChips(anchor, nativeBtns) {
    if (!anchor || anchor.parentElement.querySelector('.tk-chip-row')) return;
    const row = document.createElement('div');
    row.className = 'tk-chip-row tk-chip-anchor';

    // If we canâ€™t see native buttons, synthesize 0â€“5
    const buttons = nativeBtns && nativeBtns.length ? nativeBtns : Array.from({ length: 6 }, (_, i) => {
      const b = document.createElement('button');
      b.type = 'button'; b.textContent = String(i); b.dataset.tkValue = String(i);
      return b;
    });

    buttons.forEach(btn => {
      const v = (btn.dataset?.tkValue ?? btn.textContent ?? '').trim();
      const chip = document.createElement('div');
      chip.className = 'tk-chip';
      chip.textContent = v;
      if (v === '0') chip.title = '0 â€” brain did a cartwheel; skipped this one ğŸ˜…';
      chip.addEventListener('click', () => {
        row.querySelectorAll('.tk-chip').forEach(c => c.classList.remove('is-active'));
        chip.classList.add('is-active');
        if (btn.click) btn.click();
      });
      row.appendChild(chip);
    });

    anchor.insertAdjacentElement('afterend', row);
  }

  function enhance() {
    // 1) Primary anchor: the â€œRate interest/comfort (0â€“5)â€ label
    let rateLabel = findByText(rateRegex);

    // 2) Fallback: if not found, locate any row with 0â€“5 buttons and use the heading above it
    let numberBtns = findNumberButtons(document);
    if (!rateLabel && numberBtns.length) {
      // choose a common ancestor that contains most of the buttons
      let ancestor = numberBtns[0].parentElement;
      for (let i = 1; i < numberBtns.length; i++) {
        ancestor = numberBtns[i].closest('*') || ancestor;
      }
      rateLabel = ancestor || numberBtns[0];
      log('Fallback: using numeric buttons ancestor as label anchor.');
    }

    if (!rateLabel) {
      log('Enhancer: no label or numeric buttons found yet. Will retry on mutations.');
      return;
    }

    // 3) Find and glow the question card
    const card = nearestQuestionCard(rateLabel);
    if (card && !card.classList.contains('tk-question-card')) {
      card.classList.add('tk-question-card');
      log('Card glow applied.');
    }

    // 4) Insert guard (once per card)
    if (card && !card.querySelector('.tk-guard')) {
      const guard = buildGuard();
      rateLabel.insertAdjacentElement('beforebegin', guard);
      log('Question Guard inserted.');
    }

    // 5) Chips: use existing 0â€“5 if present
    numberBtns = findNumberButtons(card || document);
    addChips(rateLabel, numberBtns);
    log(`Chips ready. Native buttons found: ${numberBtns.length}`);
  }

  // Run now and on changes
  let rerunTimer;
  const mo = new MutationObserver(() => {
    clearTimeout(rerunTimer);
    rerunTimer = setTimeout(enhance, 60);
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // Hotkey to force rerun (Alt+G)
  window.addEventListener('keydown', (e) => {
    if (e.altKey && e.key.toLowerCase() === 'g') {
      log('Alt+G: manual re-scan');
      enhance();
    }
  });

  // initial
  enhance();
})();
</script>
