<!-- TalkKink — Glow Card + Question Guard + Traffic-Light Legend + 0–5 Chips -->
<script>
/* ===========================================================
   TalkKink — Glow Card + Question Guard + Traffic-Light Legend + 0–5 Chips
   Drop once into Codex. Enhances the existing question card only.
   =========================================================== */
(function () {
  // ---------- 1) CSS (once) ----------
  if (!document.getElementById('tkQGuardCSS')) {
    const style = document.createElement('style');
    style.id = 'tkQGuardCSS';
    style.textContent = `
      /* Glow around the EXISTING question card */
      .tk-question-card {
        position: relative;
        border-radius: 14px;
        background: rgba(10, 12, 16, 0.75);
        border: 1px solid rgba(120, 200, 255, 0.18);
        box-shadow:
          0 0 0 1px rgba(120, 200, 255, 0.18) inset,
          0 10px 28px rgba(0, 0, 0, 0.45),
          0 0 18px rgba(50, 170, 255, 0.35);
      }

      /* “Question Guard” info box */
      .tk-guard {
        margin: 10px 0 14px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(12, 16, 22, 0.9);
        border: 1px solid rgba(120, 200, 255, 0.28);
        box-shadow:
          0 0 0 1px rgba(120, 200, 255, 0.18) inset,
          0 0 16px rgba(50, 170, 255, 0.25);
      }
      .tk-guard h4 {
        margin: 0 0 8px 0;
        font-size: 1.02rem;
        letter-spacing: .2px;
        color: #e9f4ff;
        text-shadow: 0 0 8px rgba(120, 200, 255, .35);
      }
      .tk-guard p {
        margin: 4px 0;
        color: #cfe6ff;
        opacity: .95;
      }

      .tk-legend-box {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0c1420;
        border: 1px solid rgba(120,200,255,.22);
        box-shadow: 0 0 0 1px rgba(120,200,255,.16) inset, 0 0 12px rgba(50,170,255,.22);
      }
      .tk-legend {
        display: grid;
        grid-template-columns: repeat(2, minmax(220px, 1fr));
        gap: 10px 14px;
      }

      .tk-pill {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 12px; border-radius: 999px;
        background: #0e1218; color: #dbefff;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset;
        font-size: .95rem;
      }
      .tk-dot { width: 12px; height: 12px; border-radius: 999px; box-shadow: 0 0 10px currentColor; }
      .tk-red .tk-dot    { color:#ff5a6a; background:#ff5a6a; }
      .tk-yellow .tk-dot { color:#ffd34a; background:#ffd34a; }
      .tk-grey .tk-dot   { color:#9aa7b1; background:#9aa7b1; }
      .tk-blue .tk-dot   { color:#53c0ff; background:#53c0ff; }

      /* Chips */
      .tk-chip-row { display:flex; gap:10px; margin:8px 0 6px; }
      .tk-chip {
        display:inline-flex; align-items:center; justify-content:center;
        width: 44px; height: 44px;
        border-radius: 10px; cursor:pointer; user-select:none;
        background:#0e1218; color:#dbefff; font-weight:700;
        border:1px solid rgba(120,200,255,.22);
        box-shadow: 0 0 10px rgba(80,170,255,.16) inset, 0 0 12px rgba(50,170,255,.22);
        transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
      }
      .tk-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 12px rgba(80,170,255,.22) inset, 0 0 16px rgba(50,170,255,.30);
      }
      .tk-chip.is-active {
        background:#111a24; border-color:rgba(120,200,255,.42);
        box-shadow: 0 0 14px rgba(80,170,255,.28) inset, 0 0 18px rgba(50,170,255,.38);
      }

      /* Tighten the rating label + chips spacing */
      .tk-chip-anchor { margin-top: 6px; }
    `;
    document.head.appendChild(style);
  }

  // ---------- 2) Utilities ----------
  const findTextNodeEl = (re) =>
    Array.from(document.querySelectorAll('*')).find(n => re.test(n.textContent || ''));

  // Locates the question card wrapper to glow
  function findQuestionCard(anchor) {
    if (!anchor) return null;
    // climb a few levels to the big content container (page markup varies per theme)
    let el = anchor;
    for (let i = 0; i < 6 && el; i++) {
      // choose the first ancestor that looks like the question body area (has buttons etc.)
      if (el.querySelector && (el.querySelector('button') || el.querySelector('[role="button"]'))) {
        return el;
      }
      el = el.parentElement;
    }
    return anchor.parentElement || anchor;
  }

  // Make guard box HTML
  function buildGuardBox() {
    const wrap = document.createElement('div');
    wrap.className = 'tk-guard';
    wrap.innerHTML = `
      <h4>Question Guard: How to use this scale</h4>
      <p><strong>Soft Limit</strong> (yellow): You might do it with conditions — slower pace, explicit check-ins, and an easy out.</p>
      <p><strong>Willing to Try</strong> (blue): You’re open and curious. Boundaries and consent steps still apply; it’s a gentle “let’s explore”.</p>
      <div class="tk-legend-box">
        <div class="tk-legend">
          <div class="tk-pill tk-red"><span class="tk-dot"></span><strong>Hard Limit</strong> — full stop</div>
          <div class="tk-pill tk-yellow"><span class="tk-dot"></span><strong>Soft Limit</strong> — yellow light; go slow & check-in</div>
          <div class="tk-pill tk-grey"><span class="tk-dot"></span><strong>Not Interested</strong> — no thanks</div>
          <div class="tk-pill tk-blue"><span class="tk-dot"></span><strong>Willing to Try</strong> — curious with care</div>
        </div>
        <div style="margin-top:10px;color:#aacdf3;">Tip: <strong>0</strong> = my brain did a cartwheel; I skipped this one 😅</div>
      </div>
    `;
    return wrap;
  }

  // Build 0–5 chips and sync underlying controls if present
  function ensureChips(rateLabelEl) {
    if (!rateLabelEl) return;
    const container = rateLabelEl.parentElement;
    if (!container || container.querySelector('.tk-chip-row')) return;

    // Find existing numeric buttons (0–5) if present
    let nativeBtns = Array.from(container.querySelectorAll('button, .btn, [role="button"]'))
      .filter(b => /^\s*[0-5]\s*$/.test(b.textContent || ''));

    // If the layout isn’t using native numeric buttons, we still render our chips
    if (nativeBtns.length === 0) {
      nativeBtns = Array.from({ length: 6 }, (_, i) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = String(i);
        b.dataset.tkValue = String(i);
        return b;
      });
    }

    const row = document.createElement('div');
    row.className = 'tk-chip-row tk-chip-anchor';

    nativeBtns.forEach(btn => {
      const value = (btn.dataset?.tkValue ?? btn.textContent ?? '').trim();
      const chip = document.createElement('div');
      chip.className = 'tk-chip';
      chip.textContent = value;
      if (value === '0') chip.title = '0 — brain did a cartwheel; skipped this one 😅';
      chip.addEventListener('click', () => {
        row.querySelectorAll('.tk-chip').forEach(c => c.classList.remove('is-active'));
        chip.classList.add('is-active');
        // Reflect into underlying control if it exists
        if (btn.click) btn.click();
      });
      row.appendChild(chip);
    });

    rateLabelEl.insertAdjacentElement('afterend', row);
  }

  // ---------- 3) Enhance current screen ----------
  function enhance() {
    // Flexible match for the label text (dash, parentheses variants)
    const rateRe = /Rate\s*interest\s*\/\s*comfort\s*\(\s*0\s*[–-]?\s*5\s*\)/i;
    const rateLabelEl = findTextNodeEl(rateRe);
    if (!rateLabelEl) return;

    // Glow the card
    const card = findQuestionCard(rateLabelEl);
    if (card && !card.classList.contains('tk-question-card')) {
      card.classList.add('tk-question-card');
    }

    // Insert guard once per card
    if (card && !card.querySelector('.tk-guard')) {
      // slot the guard just above the rating line (keeps it close to the control)
      const guard = buildGuardBox();
      rateLabelEl.insertAdjacentElement('beforebegin', guard);
    }

    // Build chips
    ensureChips(rateLabelEl);
  }

  // Run now and on DOM changes (Next/Back)
  enhance();
  const mo = new MutationObserver(() => {
    clearTimeout(mo._t);
    mo._t = setTimeout(enhance, 60);
  });
  mo.observe(document.body, { childList: true, subtree: true });
})();
</script>
