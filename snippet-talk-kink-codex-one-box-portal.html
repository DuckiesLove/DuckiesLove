<!-- Talk Kink — Kink Survey Portal (Codex one-box: HTML + CSS + JS) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk Kink Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- If your site already loads these, keep them. This one-box works standalone too. -->
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/kinksurvey_overrides.css" />

  <style>
    /* ===========================
       TK: Minimal, safe overrides
       =========================== */

    /* Two-column portal layout for the survey shell */
    #tkPortal.tk-portal.grid-2col {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      align-items: start;
    }

    /* Left column: sticky category panel */
    .category-panel {
      position: sticky;
      top: 16px;
      align-self: start;
      max-height: calc(100vh - 32px);
      overflow: auto;
      padding: 16px;
      border-radius: 12px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 10px;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .category-counter {
      opacity: 0.85;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .category-checklist {
      list-style: none;
      margin: 12px 0 16px;
      padding: 0;
    }

    .category-checklist li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 6px;
      border-radius: 8px;
      cursor: pointer;
    }

    .category-checklist input[type="checkbox"] {
      flex: 0 0 auto;
    }

    .themed-button.start-button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
    }

    .themed-button.start-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Hide app/scorecard until Start */
    #surveyApp[hidden],
    #surveyScoreCard[hidden] {
      display: none !important;
    }

    /* Responsive collapse */
    @media (max-width: 980px) {
      #tkPortal.tk-portal.grid-2col {
        grid-template-columns: 1fr;
      }
      .category-panel {
        position: relative;
        top: 0;
        max-height: none;
      }
    }
  </style>
</head>

<body class="theme-dark">
  <!-- ===========================
       TK: Main portal wrapper
       =========================== -->
  <div id="tkPortal" class="tk-portal grid-2col">
    <!-- Left column: Category Panel (rendered directly in portal markup) -->
    <section id="categoryPanel" class="panel category-panel">
      <header class="panel-header">
        <h2>Categories</h2>
        <div class="category-counter">
          <span id="categorySelectedCount">0</span>
          <span>/</span>
          <span id="categoryTotalCount">0</span>
          <span> selected</span>
        </div>
      </header>

      <ul id="categoryChecklist" class="category-checklist">
        <!-- Populated at runtime -->
      </ul>

      <button id="startSurveyBtn" class="themed-button start-button" disabled>
        Start Survey
      </button>
    </section>

    <!-- Right column: Main content area -->
    <main id="surveyMain" class="portal-main">
      <!-- Landing / intro (shows first) -->
      <section id="surveyIntro" class="intro">
        <h1 class="themed-header">Talk Kink Survey</h1>
        <p>Select one or more categories on the left, then press <em>Start Survey</em>.</p>
      </section>

      <!-- Survey engine mount (hidden until Start) -->
      <section id="surveyApp" class="survey-app" hidden></section>

      <!-- Scorecard (kept hidden until your engine wants to show it) -->
      <aside id="surveyScoreCard" class="scorecard" hidden></aside>
    </main>
  </div>

  <script>
    /* =========================================================
       TK: Data seed — replace or inject from your real source.
       If your app sets window.TK_CATEGORIES earlier, this is ignored.
       ========================================================= */
    window.TK_CATEGORIES = window.TK_CATEGORIES || [
      { id: "appearance",  name: "Appearance Play" },
      { id: "sensation",   name: "Sensation / Impact" },
      { id: "service",     name: "Service & Protocol" },
      { id: "psych",       name: "Psychological / Primal" },
      { id: "bondage",     name: "Bondage / Restraint" },
      { id: "aftercare",   name: "Care & Aftercare" },
    ];

    /* =========================================================
       TK: Survey engine stub — your real app should overwrite
       window.TKSurvey.start. This is only to prove the wiring.
       ========================================================= */
    window.TKSurvey = window.TKSurvey || {
      start: ({ categories }) => {
        const mount = document.getElementById('surveyApp');
        if (!mount) return;
        mount.innerHTML = `
          <div class="panel">
            <h2>Survey</h2>
            <p>Initialized with categories:</p>
            <ul>${categories.map(c => `<li>${c}</li>`).join('')}</ul>
            <p>(Replace this stub with your real survey renderer.)</p>
          </div>
        `;
        // Example: you may choose to reveal the scorecard now or later.
        // document.getElementById('surveyScoreCard').hidden = false;
      }
    };

    /* =========================================================
       TK: Runtime wiring for the category panel + Start gate
       Mirrors your description: grabs #categoryPanel, syncs counts,
       dispatches events, keeps scorecard hidden until Start.
       ========================================================= */
    (function () {
      const panel       = document.getElementById('categoryPanel');
      const checklist   = document.getElementById('categoryChecklist');
      const startBtn    = document.getElementById('startSurveyBtn');
      const countSel    = document.getElementById('categorySelectedCount');
      const countTot    = document.getElementById('categoryTotalCount');
      const surveyIntro = document.getElementById('surveyIntro');
      const surveyApp   = document.getElementById('surveyApp');
      const scoreCard   = document.getElementById('surveyScoreCard');

      if (!panel || !checklist || !startBtn) {
        console.warn('[TK] Category panel missing — verify index.html markup.');
        return;
      }

      // Populate checklist from TK_CATEGORIES
      const CATEGORIES = window.TK_CATEGORIES || [];
      checklist.innerHTML = CATEGORIES.map(cat => `
        <li data-cat="${cat.id}">
          <input type="checkbox" id="cat_${cat.id}" value="${cat.id}" />
          <label for="cat_${cat.id}">${cat.name}</label>
        </li>
      `).join('');

      // Initialize counts
      const total = CATEGORIES.length;
      countTot.textContent = String(total);

      const getSelected = () =>
        Array.from(checklist.querySelectorAll('input[type="checkbox"]:checked'))
          .map(i => i.value);

      const updateState = () => {
        const selected = getSelected();
        countSel.textContent = String(selected.length);
        startBtn.disabled = selected.length === 0;

        // Fire change event for any listeners (progress, analytics, etc.)
        panel.dispatchEvent(new CustomEvent('tk:categories:change', {
          bubbles: true,
          detail: {
            selected,
            total,
            countSelected: selected.length,
            timestamp: Date.now()
          }
        }));
      };

      // Change wiring (delegation)
      checklist.addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateState();
        }
      });

      // Ensure hidden-on-load state (no early scorecard)
      if (surveyApp)   surveyApp.hidden = true;
      if (scoreCard)   scoreCard.hidden = true;

      // Gate: Start Survey
      startBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const selected = getSelected();
        if (selected.length === 0) return;

        // Announce start
        panel.dispatchEvent(new CustomEvent('tk:survey:start', {
          bubbles: true,
          detail: { selected, timestamp: Date.now() }
        }));

        // Swap intro → app and reveal the engine mount
        if (surveyIntro) surveyIntro.remove();
        if (surveyApp)   surveyApp.hidden = false;

        // Your engine decides when to show the scorecard:
        // scoreCard.hidden = false; // leave hidden until engine opts in

        // Initialize the real survey engine
        if (window.TKSurvey && typeof window.TKSurvey.start === 'function') {
          window.TKSurvey.start({ categories: selected });
        } else {
          console.warn('[TK] TKSurvey.start not found — ensure engine is loaded.');
        }
      });

      // Kick initial state
      updateState();
    })();
  </script>
</body>
</html>
