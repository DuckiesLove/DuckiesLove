<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Talk Kink Drop-In Module</title>

  <!--
  ============================================================
  TALK KINK â€“ FULL DROP-IN MODULE (no handâ€‘coded rows needed)
  ============================================================
  What this does (end-to-end):
  1) Adds UI (Survey A/B upload + Download button + status).
  2) Safely parses messy JSON (BOM, smart quotes, trailing commas).
  3) Normalizes many shapes (object maps, arrays, nested).
  4) Builds the ENTIRE table dynamically from the surveys
     (no <tr> boilerplate required).
  5) Fuzzy-matches labels between A/B + optional alias overrides.
  6) Fills Partner A/B, computes Match%, highlights high/low.
  7) Guards PDF export until both surveys are valid.
  8) Optional: include jsPDF + AutoTable (CDN tags below) for PDF.

  HOW TO USE:
  - Paste this block below your page header (it creates the table).
  - (Optional) Uncomment the two <script> CDN tags for PDF export.
  - If any labels are stubborn, add exact pairs in ID_ALIAS below.
  -->

    <!-- Optional PDF libraries (uncomment to enable PDF export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <style>
    .tk-wrap { margin: 1rem 0; display: grid; gap: .5rem; }
    .tk-inline { display:flex; gap:1rem; align-items:center; flex-wrap:wrap }
    .tk-status { font-size:.9rem; color:#9aa4b2 }
    .tk-err { color:#ff6b6b; margin:.5rem 0; display:none }
    .sr-only { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
    table.tk-table { width:100%; border-collapse: collapse; }
    .tk-table th, .tk-table td { padding:.6rem .7rem; border-bottom:1px solid rgba(255,255,255,.08) }
    .tk-table th { text-align:left; font-weight:700 }
    .match-high { outline: 1px solid rgba(0,255,128,.35); background: rgba(0,255,128,.07); }
    .match-low  { outline: 1px solid rgba(255,64,64,.35);  background: rgba(255,64,64,.07); }

    .tk-flagcell{ text-align:center; width:3.5rem }
    .tk-flag{ font-size:1.15em; line-height:1; display:inline-block }
    .tk-flag--star{ color:#ffd166 }
    .tk-flag--flag{ color:#4cc9f0 }
    .tk-flag--low { color:#ff6b6b }

  </style>
</head>
<body>
<div class="tk-wrap" id="tk-module">

  <div id="tk-err" class="tk-err">

  </div>

  <div id="tk-sr" class="sr-only" aria-live="polite" role="status">

  </div>

  <div class="tk-inline">
    <label><strong>Survey A (Partner A):</strong>
      <input id="tk-uploadA" type="file" accept=".json,application/json" aria-label="Upload JSON for Partner A">
    </label>

    <span id="tk-statusA" class="tk-status">No file
    </span>

  </div>

  <div class="tk-inline">
    <label><strong>Survey B (Partner B):</strong>
      <input id="tk-uploadB" type="file" accept=".json,application/json" aria-label="Upload JSON for Partner B">
    </label>

    <span id="tk-statusB" class="tk-status">No file
    </span>

  </div>

  <div class="tk-inline" style="justify-content:space-between">
    <div class="tk-status">Overall match: <strong id="tk-overall">â€”</strong>
    </div>

      <button id="tk-download" data-download-pdf disabled>Download Compatibility Report</button>

  </div>

  <!-- The module will create this table automatically -->
  <table id="tk-table" class="tk-table">
      <thead>
        <tr>
          <th>Category
          </th>
          <th>Partner A
          </th>
          <th>Match
          </th>
          <th>Flag
          </th>
          <th>Partner B
          </th>
        </tr>

      </thead>

    <tbody id="tk-tbody">
      <!-- rows generated at runtime -->
    </tbody>

  </table>

</div>

  <script>
    /* thresholds for icons */
    const TK_FLAG_THRESHOLDS = { star: 90, flag: 60 };

    /* compute percent match from two 0â€“5 scores (or best effort if strings) */
    function tkNumber(v){
      const n = typeof v === 'number' ? v : Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }
    function tkPercent(a, b){
      const A = tkNumber(a), B = tkNumber(b);
      if (A==null || B==null) return null;
      const pct = Math.max(0, 100 - (Math.abs(A - B) / 5) * 100);
      return Math.round(pct);
    }

    /* ensure row has the schema: [Category][A][Match][Flag][B] */
    function tkEnsureCells(tr){
      const need = ['A','Match','Flag','B'];
      const have = new Set(Array.from(tr.querySelectorAll('td[data-cell]')).map(td=>td.getAttribute('data-cell')));
      need.forEach(key=>{
        if (!have.has(key)){
          const td = document.createElement('td');
          td.setAttribute('data-cell', key);
          if (key === 'Flag') td.classList.add('tk-flagcell');
          tr.appendChild(td);
        }
      });
    }

    /* render % + icon, and make sure only A/B are numeric */
    function tkRenderRow(tr){
      tkEnsureCells(tr);

      const aTd = tr.querySelector('td[data-cell="A"]');
      const mTd = tr.querySelector('td[data-cell="Match"]');
      const fTd = tr.querySelector('td[data-cell="Flag"]');
      const bTd = tr.querySelector('td[data-cell="B"]');

      if (aTd && /%$/.test(aTd.textContent.trim())) aTd.textContent = String(tkNumber(aTd.textContent.replace('%','')) ?? '-');
      if (bTd && /%$/.test(bTd.textContent.trim())) bTd.textContent = String(tkNumber(bTd.textContent.replace('%','')) ?? '-');

      const A = tkNumber(aTd?.textContent);
      const B = tkNumber(bTd?.textContent);

      const pct = tkPercent(A, B);
      if (mTd) mTd.textContent = pct == null ? '-' : `${pct}%`;

      if (fTd){
        fTd.classList.add('tk-flagcell');
        fTd.textContent = '';
        if (pct != null){
          const span = document.createElement('span');
          span.classList.add('tk-flag');
          if (pct >= TK_FLAG_THRESHOLDS.star){
            span.classList.add('tk-flag--star');
            span.textContent = 'â˜…';
          } else if (pct >= TK_FLAG_THRESHOLDS.flag){
            span.classList.add('tk-flag--flag');
            span.textContent = 'âš‘';
          } else {
            span.classList.add('tk-flag--low');
            span.textContent = 'âš‘';
          }
          fTd.appendChild(span);
        }
      }
    }

    function tkRenderAll(root=document){
      root.querySelectorAll('#tk-tbody tr').forEach(tkRenderRow);
    }

    const tkBody = document.getElementById('tk-tbody');
    if (tkBody && typeof MutationObserver === 'function'){
      const mo = new MutationObserver(()=>tkRenderAll());
      mo.observe(tkBody,{childList:true});
    }

    if (document.readyState !== 'loading') tkRenderAll();
    else document.addEventListener('DOMContentLoaded', tkRenderAll);

      window.tkRenderRow = tkRenderRow;
      window.tkRenderAll = tkRenderAll;
    </script>

    <script>
    (function installSolidPdfExport(){
      // ---- thresholds/icons
      const TK_THRESH = { star: 90, flag: 60, low: 30 };
      const ICONS = { star: "â˜…", flag: "âš‘", low: "ðŸš©", blank: "" };

      // ---- utils
      const num = v => {
        const n = Number(String(v ?? "").trim());
        return Number.isFinite(n) ? n : null;
      };
      const matchPct = (a, b) => {
        const A = num(a), B = num(b);
        if (A == null || B == null) return null;
        return Math.round(100 - (Math.abs(A - B) / 5) * 100);
      };
      const flagFor = pct => {
        if (pct == null) return ICONS.blank;
        if (pct >= TK_THRESH.star) return ICONS.star;
        if (pct >= TK_THRESH.flag) return ICONS.flag;
        if (pct <= TK_THRESH.low)  return ICONS.low;
        return ICONS.blank;
      };

      // ---- collect rows from DOM
      function collectRows() {
        let trs = Array.from(document.querySelectorAll('tbody tr[data-kink-id]'));
        if (trs.length === 0) {
          trs = Array.from(document.querySelectorAll('tbody tr'))
            .filter(tr => tr.querySelector('td'));
        }
        const rows = [];
        for (const tr of trs) {
          const cat = tr.cells?.[0]?.textContent?.trim() || tr.getAttribute('data-kink-id') || "";
          const aTxt = tr.querySelector('td[data-cell="A"]')?.textContent
                    ?? tr.cells?.[1]?.textContent ?? "";
          const bTxt = tr.querySelector('td[data-cell="B"]')?.textContent
                    ?? tr.cells?.[tr.cells.length - 1]?.textContent ?? "";

          const A = num(aTxt), B = num(bTxt);
          const pct = matchPct(A, B);

          rows.push([
            cat || "â€”",
            (A ?? "â€”"),
            (pct == null ? "â€”" : `${pct}%`),
            flagFor(pct),
            (B ?? "â€”")
          ]);
        }
        return rows;
      }

      // ---- call AutoTable for any UMD/attach style
      function runAutoTable(doc, opts) {
        if (typeof doc.autoTable === "function") {
          doc.autoTable(opts);
        } else if (window.jspdf && typeof window.jspdf.autoTable === "function") {
          window.jspdf.autoTable(doc, opts);
        } else {
          throw new Error("jsPDF-AutoTable not found. Include the plugin before this script.");
        }
      }

      // ---- main export function
      async function exportCompatibilityPDF() {
        try {
          if (!(window.jspdf && window.jspdf.jsPDF)) {
            alert("Missing jsPDF. Add the CDN script before this exporter.");
            return;
          }

          const rows = collectRows();
          if (!rows.length) {
            console.warn("[PDF] No data rows found.");
            alert("No data rows found to export. Make sure the table has rows before exporting.");
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

          doc.setFontSize(18);
          doc.text("Talk Kink â€¢ Compatibility Report", 40, 48);

          runAutoTable(doc, {
            head: [["Category", "Partner A", "Match", "Flag", "Partner B"]],
            body: rows,
            startY: 70,
            styles: { fontSize: 10, cellPadding: 6, overflow: "linebreak" },
            headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontStyle: "bold" },
            columnStyles: {
              0: { halign: "left"  },
              1: { halign: "center" },
              2: { halign: "center" },
              3: { halign: "center" },
              4: { halign: "center" }
            }
          });

          doc.save("compatibility-report.pdf");
        } catch (err) {
          console.error("[PDF] Export failed:", err);
          alert("PDF export failed: " + err.message);
        }
      }

      // ---- bind button
      const btn = document.getElementById("downloadBtn") || document.querySelector("[data-download-pdf]");
      if (btn) btn.onclick = exportCompatibilityPDF;
      window.downloadCompatibilityPDF = exportCompatibilityPDF;

      // Debug info
      (function debugLog(){
        const rows = collectRows();
        console.log(`[PDF] Found ${rows.length} data rows. First row:`, rows[0]);
      })();
    })();
    </script>
    <!-- âœ… 1) Add this *once* near the end of every page that was freezing (before </body>) -->
<script>
/* ---------- TalkKink Safe Bootstrap (drop-in) ---------- */
(function () {
  const LOG = (...a) => console.log("[TK-SAFE]", ...a);

  /* A. QUICK SANITY CHECKS â€” find & warn about merge markers (these often lock pages) */
  try {
    const html = document.documentElement.innerHTML;
    const HEAD = '<'.repeat(7);
    const SEP = '='.repeat(7);
    const TAIL = '>'.repeat(7);
    if (html.includes(HEAD) && html.includes(SEP) && html.includes(TAIL)) {
      const conflictPattern = new RegExp(`${HEAD}[\s\S]*?${SEP}[\s\S]*?${TAIL}`);
      if (conflictPattern.test(html)) {
        console.warn("[TK-SAFE] Merge conflict markers detected in DOM. Remove them to avoid broken JS/CSS.");
      }
    }
  } catch (_) {}

  /* B. ONE-TIME INIT GUARD (prevents duplicate event bind/render loops) */
  if (window.__TK_INITED__) {
    LOG("Init skipped: already initialized.");
    return;
  }
  window.__TK_INITED__ = true;

  /* C. SAFE-MODE FLAGS (use ?safe=1 or ?nopdf=1 or ?noscore=1 to bypass heavy work) */
  const params = new URLSearchParams(location.search);
  const SAFE_MODE  = params.has("safe");
  const NO_PDF     = SAFE_MODE || params.has("nopdf");
  const NO_SCORE   = SAFE_MODE || params.has("noscore");

  if (SAFE_MODE) LOG("SAFE MODE ON: skipping scoring/render and lazy-loading libraries.");

  /* D. SMALL UTILITIES */
  const byId = (id) => document.getElementById(id);
  function once(el, type, handler, opts) {
    // prevent stacked duplicate listeners after HMR/partials
    el && el.addEventListener(type, function f(e) {
      el.removeEventListener(type, f, opts);
      handler(e);
    }, opts);
  }
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src; s.async = true; s.defer = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  function idle(fn) {
    // yield back to the browser to keep UI responsive
    return (window.requestIdleCallback || ((cb)=>setTimeout(cb,0)))(fn);
  }

  /* E. LAZY LOADERS FOR HEAVY LIBS (loaded only on click) */
  async function ensureJsPDF() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
  }
  async function ensureAutoTable() {
    // Only after jsPDF UMD maps window.jspdf.jsPDF
    await ensureJsPDF();
    const hasAT = (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable)
               || (window.jspdf && window.jspdf.autoTable);
    if (!hasAT) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* F. DEFENSIVE BINDINGS (buttons used across pages) */
  idle(() => {
    // PDF buttons (compatibility, IKA, etc.)
    const dl1 = byId("downloadBtn");
    const dl2 = byId("downloadPdfBtn");
    const anyDownload = dl1 || dl2;

    if (anyDownload) {
      const handler = async (e) => {
        e.preventDefault();
        if (NO_PDF) { alert("PDF disabled (safe mode). Add ?safe=0 or remove ?nopdf."); return; }
        try {
          // Lazy load heavy libs only now
          await ensureAutoTable();
          // Yield once more before heavy export:
          await new Promise(r => setTimeout(r, 0));
          // Call your existing exporter (must be defined elsewhere)
          if (typeof window.TKPDF_export === "function") {
            await window.TKPDF_export();
          } else if (typeof window.TKPDF_forceDark === "function") {
            await window.TKPDF_forceDark();
          } else if (typeof window.exportIKAPdf === "function") {
            await window.exportIKAPdf();
          } else {
            alert("Export function not found. Expected TKPDF_export/TKPDF_forceDark/exportIKAPdf.");
          }
        } catch (err) {
          console.error("[TK-SAFE] PDF export failed:", err);
          alert("PDF export failed: " + (err?.message || err));
        }
      };

      // Bind once to whichever exists
      if (dl1) once(dl1, "click", handler);
      if (dl2) once(dl2, "click", handler);
      LOG("Bound PDF button(s).");
    }

    // File upload styled label (IKA)
    const fileInput = byId("ikaFile");
    const fileLabel = document.querySelector('label[for="ikaFile"]');
    if (fileInput && fileLabel) {
      once(fileLabel, "click", () => fileInput.click());
      LOG("Bound Upload Survey labelâ†’input.");
    }
  });

  /* G. STOP RUNNING EXPENSIVE WORK ON LOAD (scoring/rendering) */
  // Wrap your pageâ€™s auto-render or scoring in this gate:
  window.TK_canRunHeavy = function () {
    if (SAFE_MODE) return false;
    // Avoid running more than once
    if (window.__TK_HEAVY_RAN__) return false;
    window.__TK_HEAVY_RAN__ = true;
    return true;
  };

  // Example usage for your pages (leave here; your code can call it):
  // if (window.TK_canRunHeavy()) {
  //   // run scoring/render here or schedule with idle(...)
  //   idle(() => window.renderResults && window.renderResults());
  // }

  /* H. GLOBAL CATCH FOR ACCIDENTAL LONG TASKS */
  // If something still locks the UI, advise safe mode.
  window.addEventListener("error", (e) => {
    console.warn("[TK-SAFE] Window error:", e.message);
  });
})();
</script>
<!-- ---------- End Safe Bootstrap ---------- -->
</body>
    </html>
