<!-- Talk-Kink: console patch for portal/neutralize/wiring -->
<script>
/* TK console patch: portal + neutralize + wiring */
(function () {
  // --- 1) Tiny CSS helper (no <style> tags in console needed) ---
  const css = `
#tkOverlayFix{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;opacity:0;transition:opacity .18s ease;z-index:2147483646;pointer-events:none}
#tkOverlayFix.tk-open{display:block;opacity:1;pointer-events:auto}
#tkPortalFix{position:fixed;inset:0;z-index:2147483647;pointer-events:none}
#tkPortalFix>.tk-shell{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);max-height:85vh;width:min(980px,92vw);background:rgba(10,10,10,.97);border-radius:12px;overflow:auto;pointer-events:auto;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.tk-force{position:fixed!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;display:block!important;visibility:visible!important;opacity:1!important;z-index:2147483647!important;width:min(980px,92vw)!important;max-height:85vh!important;overflow:auto!important;pointer-events:auto!important}`;
  const style = document.getElementById('tkForceStyles') || Object.assign(document.createElement('style'), { id: 'tkForceStyles' });
  style.textContent = css;
  document.head.appendChild(style);

  // --- 2) Grab elements / create portal+overlay if missing ---
  const $ = s => document.querySelector(s);
  const panel = $('#categorySurveyPanel') || document.querySelector('.category-panel');
  if (!panel) { console.warn('[TK] No panel found (#categorySurveyPanel or .category-panel).'); return; }

  let overlay = document.getElementById('tkOverlayFix');
  if (!overlay) { overlay = Object.assign(document.createElement('div'), { id: 'tkOverlayFix' }); document.body.appendChild(overlay); }

  let portal = document.getElementById('tkPortalFix');
  if (!portal) { portal = Object.assign(document.createElement('div'), { id: 'tkPortalFix' }); document.body.appendChild(portal); }

  let restore = null;

  // Remove the usual hide mechanics on the panel and ancestors
  function unhide(node) {
    // Remove attributes that hide
    ['hidden','inert','aria-hidden'].forEach(a => { if (node.hasAttribute && node.hasAttribute(a)) node.removeAttribute(a); });
    // Blast common display/visibility/opacity/transform blockers
    const st = node.style;
    if (st) {
      st.display = 'block';
      st.visibility = 'visible';
      st.opacity = '1';
      st.transform = 'none';
      st.filter = 'none';
    }
  }
  function unhideChain(el) {
    const touched = [];
    for (let n = el; n && n !== document.body; n = n.parentElement) {
      const rec = { n, hidden:n.hidden, inert:n.hasAttribute?.('inert'), ah:n.getAttribute?.('aria-hidden'), ds:n.style?.display || '' };
      unhide(n);
      if (getComputedStyle(n).display === 'none') { if (n.style) n.style.display = 'block'; rec.ds = 'none'; }
      // ensure positioned for stacking if needed
      const cs = getComputedStyle(n);
      if (cs.position === 'static' && n.style) n.style.position = 'relative';
      touched.push(rec);
    }
    return touched;
  }

  function tkOpenPanel() {
    // prepare restore record the first time
    if (!restore) restore = {};
    // make overlay visible
    overlay.classList.add('tk-open');
    document.documentElement.style.overflow = 'hidden';

    // neutralize/hard-unhide ancestors
    restore.chain = unhideChain(panel);

    // move to portal (guarantees top-most stacking and independent layout)
    const shell = document.createElement('div');
    shell.className = 'tk-shell';
    portal.appendChild(shell);

    restore.parent = panel.parentNode;
    restore.sibling = panel.nextSibling;
    restore.moved = true;

    // remove classes that might hide the panel
    (panel.classList || { remove(){} }).remove('is-hidden','hidden','closed','tk-closed','tk-hidden');

    // remove attributes and style blockers
    unhide(panel);

    // put panel into shell and force
    shell.appendChild(panel);
    panel.classList.add('tk-force');

    // last-resort: if some internal wrapper is hiding, unhide first child too
    const inner = panel.firstElementChild;
    if (inner) unhide(inner);

    // focus / center
    try { panel.focus({preventScroll:false}); } catch {}
    try { panel.scrollIntoView({block:'center'}); } catch {}

    const r = panel.getBoundingClientRect();
    console.log('[TK] Forced open; rect =', {x:r.x|0, y:r.y|0, w:r.width|0, h:r.height|0});
  }

  function tkClosePanel() {
    try {
      if (restore?.moved && restore.parent) {
        if (restore.sibling) restore.parent.insertBefore(panel, restore.sibling);
        else restore.parent.appendChild(panel);
      }
      panel.classList.remove('tk-force');
      const shell = portal.querySelector('.tk-shell');
      if (shell) shell.remove();

      if (restore?.chain) {
        // best-effort revert (we only revert obvious attribute flips)
        for (const rec of restore.chain) {
          if (rec.hidden) rec.n.hidden = true;
          if (rec.inert) rec.n.setAttribute('inert','');
          if (rec.ah != null) rec.n.setAttribute('aria-hidden', rec.ah);
          if (rec.ds === 'none' && rec.n.style) rec.n.style.display = 'none';
        }
      }
    } catch (e) { console.warn('[TK] close error', e); }
    overlay.classList.remove('tk-open');
    document.documentElement.style.overflow = '';
    restore = null;
    console.log('[TK] Panel closed.');
  }

  // Wire starts
  const starts = document.querySelectorAll([
    '#startSurveyBtn','#startSurvey','.start-survey-btn',
    'button.themed-button.start-survey-btn','a[href="#start"]'
  ].join(','));
  starts.forEach(btn => btn.addEventListener('click', e => { e.preventDefault(); tkOpenPanel(); }, {passive:false}));
  overlay.addEventListener('click', tkClosePanel, {passive:true});

  // Small probe for you
  window.tkOpenPanel = tkOpenPanel;
  window.tkClosePanel = tkClosePanel;
  window.tkProbe = function(){
    const r = panel.getBoundingClientRect();
    console.table([
      {key:'panel', present:!!panel, visible: (r.width>1 && r.height>1)},
      {key:'overlay', present:!!overlay, visible: overlay.classList.contains('tk-open')}
    ]);
    return {rect:r, moved:!!restore?.moved};
  };

  console.log('[TK] force-opener installed. Click “Start Survey”, or run tkOpenPanel().');
})();
</script>
