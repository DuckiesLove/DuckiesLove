<!-- === One-Box: Fix loadLabels + Force Full-Bleed Black PDF === -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script>
/* 0) Pre-patch: intercept future assignment to window.loadLabels and wrap it so it returns an iterable */
(function interceptLoadLabels(){
  if (!('loadLabels' in window)) {
    Object.defineProperty(window, 'loadLabels', {
      configurable: true,
      set(fn){
        // wrap the real function
        const wrapped = async function(...args){
          const out = await fn(...args);
          // If it's a plain object, return entries so for..of works
          if (out && typeof out === 'object' && !Array.isArray(out)) {
            const byId = {};
            for (const [k,v] of Object.entries(out)) byId[String(k)] = String(v ?? k);
            window.__tkLabelsById = byId;                 // optional map for other code
            return Object.entries(byId);                  // <-- iterable
          }
          return out ?? [];                               // still iterable for for..of
        };
        Object.defineProperty(window, 'loadLabels', { value: wrapped, writable: true, configurable: true });
      }
    });
  } else {
    // If already defined, wrap it immediately
    const orig = window.loadLabels;
    window.loadLabels = async function(...args){
      const out = await orig(...args);
      if (out && typeof out === 'object' && !Array.isArray(out)) {
        const byId = {};
        for (const [k,v] of Object.entries(out)) byId[String(k)] = String(v ?? k);
        window.__tkLabelsById = byId;
        return Object.entries(byId);
      }
      return out ?? [];
    };
  }
})();

/* 1) Kill legacy print/export paths that reintroduce margins/timestamps */
try { window.print = () => console.warn('[tk] window.print() disabled'); } catch(e){}
['downloadCompatibilityPDF','exportCompatibilityPDF','makePDF','createPDF','saveReportPDF','compatPDF','exportPDF','downloadPDF']
  .forEach(n => { try { delete window[n]; } catch(_){} });

/* 2) Consent (always ask) */
async function tkConsent(){ return confirm("Consent check:\nDo you have your partner’s consent to export/share this PDF?"); }

/* 3) Ultra full-bleed black exporter (no title/timestamp/footer/margins/borders/padding) */
async function tkExportPDF_BlackEdge({
  filename='compatibility.pdf',
  columns=[
    { header:'Category', dataKey:'category' },
    { header:'Partner A', dataKey:'a' },
    { header:'Match %',  dataKey:'m' },
    { header:'Partner B',dataKey:'b' },
  ],
  rows=[]
} = {}) {
  if(!(await tkConsent())) return;
  console.log('[tk] USING BlackEdge');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'letter', compress:true, putOnlyUsedFonts:true });

  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const BLEED = 10; // overpaint beyond page to defeat anti-alias halos

  const paint = () => { doc.setFillColor(0,0,0); doc.rect(-BLEED,-BLEED,W+BLEED*2,H+BLEED*2,'F'); };
  paint();
  doc.setTextColor(255,255,255);
  doc.setDrawColor(0,0,0);
  doc.setLineWidth(0);

  // If not provided, scrape the on-page table
  if (!rows.length) {
    const table = document.querySelector('table');
    if (table) {
      const ths = [...table.querySelectorAll('thead th')].map(th => th.textContent.trim());
      const trs = [...table.querySelectorAll('tbody tr')];
      const guessCols = ths.length ? ths : ['Category','Partner A','Match %','Partner B'];
      columns = guessCols.map((h,i)=>({header:h,dataKey:String(i)}));
      rows = trs.map(tr => {
        const cells = [...tr.children].map(td => td.textContent.trim());
        const obj = {};
        cells.forEach((v,i)=> obj[String(i)] = v || '—');
        return obj;
      });
    }
  }

  const head = [columns.map(c => c.header ?? c.title ?? c)];
  const body = rows.map(r => columns.map(c => {
    const k = c.dataKey ?? c.key ?? c;
    const v = r[k];
    return (v===undefined || v===null || v==='') ? '—' : String(v);
  }));

  doc.autoTable({
    head, body,
    startY: -BLEED,
    startX: -BLEED,
    tableWidth: W + BLEED*2,
    margin: { top:0, right:0, bottom:0, left:0 },
    theme: 'plain',
    horizontalPageBreak: true,

    styles: { font:'helvetica', fontSize:10, textColor:[255,255,255], cellPadding:0, lineWidth:0, fillColor:null, overflow:'linebreak', minCellHeight:14 },
    headStyles:{ fontStyle:'bold', textColor:[255,255,255], fillColor:null, cellPadding:0, lineWidth:0, minCellHeight:16 },
    tableLineWidth: 0, tableLineColor: [0,0,0],
    columnStyles:{ 0:{halign:'left'}, 1:{halign:'center'}, 2:{halign:'center'}, 3:{halign:'center'} },

    didParseCell(d){ d.cell.styles.fillColor=null; d.cell.styles.lineWidth=0; d.cell.styles.lineColor=[0,0,0]; },
    didAddPage(){ paint(); doc.setTextColor(255,255,255); doc.setDrawColor(0,0,0); doc.setLineWidth(0); }
  });

  doc.save(filename);
}

/* 4) Rewire the existing “Download PDF” button to this exporter */
(function wireDownloadBtn(){
  const btn = [...document.querySelectorAll('a,button,input[type="button"],input[type="submit"]')]
    .find(el => /download pdf/i.test((el.textContent||el.value||'').trim()));
  if (!btn) { console.warn('[tk] Download PDF button not found'); return; }
  btn.onclick = null;
  btn.removeAttribute('href');
  btn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopImmediatePropagation();
    tkExportPDF_BlackEdge({});
  }, { capture:true });

  // Also alias common globals in case other code calls them
  ['downloadCompatibilityPDF','exportCompatibilityPDF','makePDF','createPDF','saveReportPDF','compatPDF','exportPDF','downloadPDF']
    .forEach(n => { window[n] = tkExportPDF_BlackEdge; });

  console.log('[tk] Button rewired + exporters patched');
})();

/* 5) Optional: solid-black proof. From console, run: tkSolidBlackTest() */
window.tkSolidBlackTest = function(){
  const { jsPDF } = window.jspdf;
  const d = new jsPDF({ unit:'pt', format:'letter' });
  const w = d.internal.pageSize.getWidth(), h = d.internal.pageSize.getHeight();
  d.setFillColor(0,0,0); d.rect(-14,-14,w+28,h+28,'F'); d.save('solid-black.pdf');
  console.log('[tk] solid-black.pdf exported');
};
</script>
