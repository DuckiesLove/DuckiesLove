<!-- === Codex One-Box: Labels + Full-Bleed Black PDF + Button Wiring === -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script>
/* 0) Kill legacy print/export paths that cause borders/timestamps */
try { window.print = () => console.warn('[tk] window.print() disabled'); } catch(e){}
['downloadCompatibilityPDF','exportCompatibilityPDF','makePDF','createPDF','saveReportPDF','compatPDF','exportPDF','downloadPDF']
  .forEach(n => { try { delete window[n]; } catch(_){} });

/* 1) Label map helpers ---------------------------------------------------- */
function normalizeLabelMap(obj){
  const out = {};
  for (const [rawK, rawV] of Object.entries(obj || {})) {
    const k = String(rawK ?? '').trim().toLowerCase();
    if (!k) continue;
    out[k] = String((rawV ?? '').toString().trim() || rawK);
  }
  return out;
}
async function getLabelMap(){
  // Prefer your page's helper if available
  if (typeof window.buildLabelMapSafely === 'function') {
    const out = await window.buildLabelMapSafely();
    return normalizeLabelMap(out || {});
  }
  // Fallback: /data/kinks.json -> /data/labels-overrides.json -> window.tkLabels
  const [base, overrides] = await Promise.all([
    fetch('/data/kinks.json').then(r => r.ok ? r.json() : {}).catch(()=> ({})),
    fetch('/data/labels-overrides.json').then(r => r.ok ? r.json() : {}).catch(()=> ({})),
  ]);
  let map = { ...(base||{}) , ...(overrides||{}) };
  if (window.tkLabels && typeof window.tkLabels === 'object') map = { ...map, ...window.tkLabels };
  return normalizeLabelMap(map);
}
const labelFor = (code, map) => !code ? '' : (map[String(code).toLowerCase()] ?? code);

/* 2) Full-bleed black export (no margins/padding/borders) ----------------- */
async function tkExportPDF_BlackEdge({
  filename='compatibility.pdf',
  columns=[
    { header:'Category', dataKey:'category' },
    { header:'Partner A', dataKey:'a' },
    { header:'Match %',  dataKey:'m' },
    { header:'Partner B', dataKey:'b' },
  ],
  rows=[],
  blank=' '   // use '' for truly empty, or '\u00A0' to keep height
} = {}){
  // Always-ask consent (no remember)
  if (!confirm("Consent check:\nDo you have your partner’s consent to export/share this PDF?")) return;

  const labelMap = await getLabelMap();

  // If rows/cols not provided, read from the visible table
  if (!rows.length) {
    const table = document.querySelector('table');
    if (table) {
      const ths = [...table.querySelectorAll('thead th')].map(th => th.textContent.trim());
      const trs = [...table.querySelectorAll('tbody tr')];
      columns = (ths.length ? ths : ['Category','Partner A','Match %','Partner B'])
        .map((h,i)=>({ header:h, dataKey:String(i) }));
      rows = trs.map(tr => {
        const cells = [...tr.children].map(td => td.textContent.trim());
        const o = {};
        cells.forEach((v,i)=> o[String(i)] = v);
        // also expose category under 'category' if first col
        if (cells.length) o['category'] = cells[0];
        return o;
      });
    }
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'letter', compress:true, putOnlyUsedFonts:true });
  const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();
  const BLEED = 12;

  const paint = () => { doc.setFillColor(0,0,0); doc.rect(-BLEED,-BLEED, W+BLEED*2, H+BLEED*2, 'F'); };
  paint();
  doc.setTextColor(255,255,255);
  doc.setDrawColor(0,0,0);
  doc.setLineWidth(0);

  const head = [columns.map(c => c.header ?? c.title ?? c)];
  const body = rows.map(r => columns.map(c => {
    const key = c.dataKey ?? c.key ?? c;
    let v = r[key];
    // map left column label: by key or header hint
    const isCategory = key === 'category' || /^(category|kink|code)$/i.test(String(c.header||''));
    if (isCategory) v = labelFor(v, labelMap);
    return (v === undefined || v === null || v === '') ? blank : String(v);
  }));

  doc.autoTable({
    head, body,
    startY: -BLEED,
    startX: -BLEED,
    tableWidth: W + BLEED*2,
    margin: { top:0, right:0, bottom:0, left:0 },
    theme: 'plain',
    horizontalPageBreak: true,
    styles: { font:'helvetica', fontSize:10, textColor:[255,255,255], cellPadding:0, lineWidth:0, fillColor:null, overflow:'linebreak', minCellHeight:14 },
    headStyles:{ fontStyle:'bold', textColor:[255,255,255], fillColor:null, cellPadding:0, lineWidth:0, minCellHeight:16 },
    tableLineWidth: 0, tableLineColor: [0,0,0],
    columnStyles:{ 0:{halign:'left'}, 1:{halign:'center'}, 2:{halign:'center'}, 3:{halign:'center'} },
    didParseCell(d){ d.cell.styles.fillColor=null; d.cell.styles.lineWidth=0; d.cell.styles.lineColor=[0,0,0]; },
    didAddPage(){ paint(); doc.setTextColor(255,255,255); doc.setDrawColor(0,0,0); doc.setLineWidth(0); }
  });

  doc.save(filename);
}

/* 3) Wire the visible “Download PDF” button (by text), and alias common globals */
(function wireDownloadButton(){
  const btn = [...document.querySelectorAll('a,button,input[type="button"],input[type="submit"]')]
    .find(el => /download pdf/i.test((el.textContent||el.value||'').trim()));
  if (btn) {
    btn.onclick = null;
    btn.removeAttribute('href');
    btn.addEventListener('click', e => { e.preventDefault(); e.stopImmediatePropagation(); tkExportPDF_BlackEdge({}); }, { capture:true });
    console.log('[tk] Download PDF rewired → BlackEdge exporter');
  } else {
    console.warn('[tk] Download PDF button not found; call tkExportPDF_BlackEdge() manually.');
  }
  // Alias in case other code calls old names
  ['downloadCompatibilityPDF','exportCompatibilityPDF','makePDF','createPDF','saveReportPDF','compatPDF','exportPDF','downloadPDF']
    .forEach(n => { window[n] = tkExportPDF_BlackEdge; });
})();

/* 4) Optional: solid-black proof (no table). Run from console if you want. */
window.tkSolidBlackTest = function(){
  const { jsPDF } = window.jspdf;
  const d = new jsPDF({ unit:'pt', format:'letter' });
  const w = d.internal.pageSize.getWidth(), h = d.internal.pageSize.getHeight();
  d.setFillColor(0,0,0); d.rect(-16,-16,w+32,h+32,'F'); d.save('solid-black.pdf');
  console.log('[tk] solid-black.pdf exported');
};
</script>
