<!-- ================= TALK KINK: Categories-first + Gated Start (run-once) ================= -->
<script>
(() => {
  /* ---------- Base CSS (minimal, non-invasive) ---------- */
  if (!document.getElementById("tk-base-css")) {
    const s = document.createElement("style");
    s.id = "tk-base-css";
    s.textContent = `
      :root{--panel:rgba(255,255,255,.03);--border:rgba(255,255,255,.14)}
      #tk-app{display:grid;grid-template-columns:300px 1fr 340px;gap:16px;max-width:1400px;margin:24px auto;padding:0 16px}
      .tk-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
      #tk-cat-list{display:grid;gap:8px;max-height:70vh;overflow:auto;padding-right:4px}
      .tk-cat{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05)}
      .tk-actions{display:grid;gap:14px;max-width:780px}
      .tk-btn{display:inline-block;text-align:center;padding:16px 20px;border:1px solid var(--border);border-radius:999px;background:transparent;color:inherit}
      .tk-btn[disabled]{opacity:.45;cursor:not-allowed}
      .tk-grid,#tk-scale{display:grid;grid-template-columns:repeat(6,minmax(44px,1fr));gap:10px;margin-top:10px}
      #question-panel{min-height:320px}
      .tk-opt{border:1px solid var(--border);border-radius:12px;padding:10px 0;background:transparent;color:inherit;cursor:pointer}
      .tk-opt.selected{outline:2px solid currentColor}
      @media (max-width:1024px){#tk-app{grid-template-columns:1fr}}
    `;
    document.head.appendChild(s);
  }

  /* ---------- Ensure layout exists ---------- */
  const app = document.getElementById("tk-app") || (() => {
    const m = document.createElement("main"); m.id = "tk-app"; document.body.prepend(m); return m;
  })();

  if (!document.getElementById("tk-categories")) {
    const L = document.createElement("aside");
    L.id = "tk-categories"; L.className = "tk-card";
    L.innerHTML = `<h3>Categories</h3><div id="tk-cat-list" role="listbox" aria-multiselectable="true">Loading…</div>`;
    app.appendChild(L);
  }
  if (!document.getElementById("tk-center")) {
    const C = document.createElement("section");
    C.id = "tk-center"; C.className = "tk-card";
    C.innerHTML = `
      <section id="tk-landing" class="tk-card" style="background:transparent;border:none;padding:0">
        <h2 style="margin:0 0 10px">TalkKink Survey</h2>
        <p style="margin:0 0 10px;color:rgba(255,255,255,.7)">Select at least one category to begin.</p>
        <div class="tk-actions"><button id="btnStart" class="tk-btn" type="button" disabled aria-disabled="true">Start Survey</button></div>
      </section>
      <section id="question-panel" class="tk-card" hidden></section>`;
    app.appendChild(C);
  }
  if (!document.getElementById("tk-right")) {
    const R = document.createElement("aside");
    R.id = "tk-right"; R.className = "tk-card"; R.hidden = true;
    R.innerHTML = `
      <h3>How to score</h3>
      <ul style="list-style:none;margin:0;padding:0;display:grid;gap:8px">
        <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
        <li><b>1</b> — Hard Limit (no-go)</li>
        <li><b>2</b> — Soft Limit (willing to try…)</li>
        <li><b>3</b> — Curious / context-dependent</li>
        <li><b>4</b> — Comfortable / enjoy</li>
        <li><b>5</b> — Favorite / enthusiastic yes</li>
      </ul>
      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px">
        <div>Rate interest/comfort (0–5)</div>
        <div class="tk-grid" id="tk-scale-sidebar" data-group="rating-A"></div>
      </div>`;
    app.appendChild(R);
  }

  /* ---------- ONE fetch for categories (coalesced) ---------- */
  async function tkLoadCategoriesOnce() {
    if (!window.__tkCatsPromise) {
      window.__tkCatsPromise = (async () => {
        const list = document.getElementById("tk-cat-list");
        if (!list) return [];
        try {
          const res = await fetch("/data/kinks.json", { cache: "no-store" });
          const data = await res.json();
          let cats = [];
          if (Array.isArray(data)) cats = data.map(x => x?.name || x?.title || x?.category || String(x));
          else if (Array.isArray(data?.categories)) cats = data.categories.map(x => x?.name || x?.title || x?.category || String(x));
          else if (data && typeof data === "object") cats = Object.keys(data);
          cats = cats.filter(Boolean).sort((a,b)=>a.localeCompare(b));
          list.innerHTML = cats.map((c,i)=>`
            <label class="tk-cat"><input type="checkbox" id="cat_${i}" value="${c}"><span>${c}</span></label>`
          ).join("") || "No categories parsed";
          console.log(`✅ Categories loaded (${cats.length})`);
          return cats;
        } catch (e) {
          console.error("❌ Failed to load categories", e);
          document.getElementById("tk-cat-list").textContent = "Error loading categories.";
          return [];
        }
      })();
    }
    return window.__tkCatsPromise;
  }

  // If survey.js exposes its own loader, make it delegate to ours (prevents duplicate fetches)
  if (typeof window.tkLoadCategories === "function") {
    window.tkLoadCategories = tkLoadCategoriesOnce;
  }

  /* ---------- Gate Start until a category is checked ---------- */
  function gateStartOnce() {
    if (window.__tkGateBound) return; window.__tkGateBound = true;
    const list   = document.getElementById("tk-cat-list");
    const qpanel = document.getElementById("question-panel");
    if (!list || !qpanel) { document.addEventListener("DOMContentLoaded", gateStartOnce, { once:true }); return; }

    const selected = new Set();
    const updateGate = () => {
      const btn = document.getElementById("btnStart");
      if (!btn) return;
      const any = selected.size > 0;
      btn.disabled = !any;
      btn.setAttribute("aria-disabled", String(!any));
    };
    updateGate();

    list.addEventListener("change", (e) => {
      const cb = e.target.closest('input[type="checkbox"]'); if (!cb) return;
      if (cb.checked) selected.add(cb.value || cb.id); else selected.delete(cb.value || cb.id);
      updateGate();
    });

    function makeScale(el, group="rating-A"){
      if(!el) return; el.innerHTML="";
      for(let i=0;i<=5;i++){
        const b=document.createElement("button");
        b.className="tk-opt"; b.type="button"; b.dataset.group=group; b.dataset.value=i;
        b.textContent=i; b.setAttribute("aria-pressed","false"); el.appendChild(b);
      }
    }
    if (!window.__tkScaleSync) {
      window.__tkScaleSync = true;
      document.addEventListener("click",(e)=>{
        const btn = e.target.closest("button.tk-opt"); if(!btn) return;
        const group = btn.dataset.group, val = btn.dataset.value;
        document.querySelectorAll(`button.tk-opt[data-group="${group}"]`).forEach(b=>{
          const on=b.dataset.value===val; b.classList.toggle("selected",on); b.setAttribute("aria-pressed",on?"true":"false");
        });
        document.getElementById("tk-guard")?.replaceChildren(document.createTextNode(`Selected ${val} of 5`));
      });
    }

    function renderQuestion(){
      const panel = document.getElementById("question-panel");
      if (!panel) return;
      panel.classList.add("tk-card");
      panel.hidden=false;
      panel.innerHTML = `
        <div>Appearance Play • Choosing My Partner</div>
        <h2>Giving: Rate interest/comfort (0–5)</h2>
        <div id="tk-guard" aria-live="polite"></div>
        <div id="tk-scale" data-group="rating-A"></div>`;
      makeScale(document.getElementById("tk-scale"), "rating-A");
      makeScale(document.getElementById("tk-scale-sidebar"), "rating-A");
      document.getElementById("tk-right")?.removeAttribute("hidden");
    }

    function stabilizeQuestionCard(){
      renderQuestion();

      const center = document.getElementById("tk-center");
      if (!center || window.__tkQObserver) return;

      const mo = new MutationObserver(() => {
        let qp = document.getElementById("question-panel");
        if (qp && qp.childElementCount > 0) return;

        if (!qp) {
          qp = document.createElement("section");
          qp.id = "question-panel";
          qp.className = "tk-card";
          const anchor = document.getElementById("tk-landing");
          if (anchor && anchor.parentElement) {
            anchor.insertAdjacentElement("afterend", qp);
          } else {
            center.appendChild(qp);
          }
        }

        renderQuestion();
      });

      mo.observe(center, { childList: true, subtree: true });
      window.__tkQObserver = mo;
    }

    function wireStart(){
      const btn = document.getElementById("btnStart");
      if (!btn || btn.__tkStabWired) return;
      btn.__tkStabWired = true;

      updateGate();

      btn.addEventListener("click",(e)=>{
        if (btn.disabled) { e.preventDefault(); return; }
        requestAnimationFrame(() => {
          document.getElementById("tk-landing")?.setAttribute("hidden","hidden");
          stabilizeQuestionCard();
        });
      });
    }

    wireStart();
    document.addEventListener("DOMContentLoaded", wireStart);

    if (!window.__tkStartObserver) {
      const target = document.getElementById("tk-center") || document.body;
      const observer = new MutationObserver(() => wireStart());
      observer.observe(target, { childList: true, subtree: true });
      window.__tkStartObserver = observer;
    }

    // Dev shortcut: ?autostart
    if (new URLSearchParams(location.search).has("autostart")) {
      selected.add("__auto__");
      updateGate();
      document.getElementById("tk-landing")?.setAttribute("hidden","hidden");
      stabilizeQuestionCard();
    }
  }
  gateStartOnce();

  // Kick everything
  tkLoadCategoriesOnce();
})();
</script>
