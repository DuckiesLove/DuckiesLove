<!-- ==============================
TALK KINK • COMPATIBILITY REPORT
PDF EXPORT FIX
=================================

HOW TO USE:
1. Paste this whole block into your page (before <!-- ✅ 1) Add this *once* near the end of every page that was freezing (before </body>) -->
<script>
/* ---------- TalkKink Safe Bootstrap (drop-in) ---------- */
(function () {
  const LOG = (...a) => console.log("[TK-SAFE]", ...a);

  /* A. QUICK SANITY CHECKS — find & warn about merge markers (these often lock pages) */
  try {
    const html = document.documentElement.innerHTML;
    const MERGE_MARKERS = [
      "<".repeat(7),
      "=".repeat(7),
      ">".repeat(7),
    ];
    if (MERGE_MARKERS.some((marker) => html.includes(marker))) {
      console.warn("[TK-SAFE] Merge conflict markers detected in DOM. Remove them to avoid broken JS/CSS.");
    }
  } catch (_) {}

  /* B. ONE-TIME INIT GUARD (prevents duplicate event bind/render loops) */
  if (window.__TK_INITED__) {
    LOG("Init skipped: already initialized.");
    return;
  }
  window.__TK_INITED__ = true;

  /* C. SAFE-MODE FLAGS (use ?safe=1 or ?nopdf=1 or ?noscore=1 to bypass heavy work) */
  const params = new URLSearchParams(location.search);
  const SAFE_MODE  = params.has("safe");
  const NO_PDF     = SAFE_MODE || params.has("nopdf");
  const NO_SCORE   = SAFE_MODE || params.has("noscore");

  if (SAFE_MODE) LOG("SAFE MODE ON: skipping scoring/render and lazy-loading libraries.");

  /* D. SMALL UTILITIES */
  const byId = (id) => document.getElementById(id);
  function once(el, type, handler, opts) {
    // prevent stacked duplicate listeners after HMR/partials
    el && el.addEventListener(type, function f(e) {
      el.removeEventListener(type, f, opts);
      handler(e);
    }, opts);
  }
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src; s.async = true; s.defer = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  function idle(fn) {
    // yield back to the browser to keep UI responsive
    return (window.requestIdleCallback || ((cb)=>setTimeout(cb,0)))(fn);
  }

  /* E. LAZY LOADERS FOR HEAVY LIBS (loaded only on click) */
  async function ensureJsPDF() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
  }
  async function ensureAutoTable() {
    // Only after jsPDF UMD maps window.jspdf.jsPDF
    await ensureJsPDF();
    const hasAT = (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable)
               || (window.jspdf && window.jspdf.autoTable);
    if (!hasAT) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* F. DEFENSIVE BINDINGS (buttons used across pages) */
  idle(() => {
    // PDF buttons (compatibility, IKA, etc.)
    const dl1 = byId("downloadBtn");
    const dl2 = byId("downloadPdfBtn");
    const anyDownload = dl1 || dl2;

    if (anyDownload) {
      const handler = async (e) => {
        e.preventDefault();
        if (NO_PDF) { alert("PDF disabled (safe mode). Add ?safe=0 or remove ?nopdf."); return; }
        try {
          // Lazy load heavy libs only now
          await ensureAutoTable();
          // Yield once more before heavy export:
          await new Promise(r => setTimeout(r, 0));
          // Call your existing exporter (must be defined elsewhere)
          if (typeof window.TKPDF_export === "function") {
            await window.TKPDF_export();
          } else if (typeof window.TKPDF_forceDark === "function") {
            await window.TKPDF_forceDark();
          } else if (typeof window.exportIKAPdf === "function") {
            await window.exportIKAPdf();
          } else {
            alert("Export function not found. Expected TKPDF_export/TKPDF_forceDark/exportIKAPdf.");
          }
        } catch (err) {
          console.error("[TK-SAFE] PDF export failed:", err);
          alert("PDF export failed: " + (err?.message || err));
        }
      };

      // Bind once to whichever exists
      if (dl1) once(dl1, "click", handler);
      if (dl2) once(dl2, "click", handler);
      LOG("Bound PDF button(s).");
    }

    // File upload styled label (IKA)
    const fileInput = byId("ikaFile");
    const fileLabel = document.querySelector('label[for="ikaFile"]');
    if (fileInput && fileLabel) {
      once(fileLabel, "click", () => fileInput.click());
      LOG("Bound Upload Survey label→input.");
    }
  });

  /* G. STOP RUNNING EXPENSIVE WORK ON LOAD (scoring/rendering) */
  // Wrap your page’s auto-render or scoring in this gate:
  window.TK_canRunHeavy = function () {
    if (SAFE_MODE) return false;
    // Avoid running more than once
    if (window.__TK_HEAVY_RAN__) return false;
    window.__TK_HEAVY_RAN__ = true;
    return true;
  };

  // Example usage for your pages (leave here; your code can call it):
  // if (window.TK_canRunHeavy()) {
  //   // run scoring/render here or schedule with idle(...)
  //   idle(() => window.renderResults && window.renderResults());
  // }

  /* H. GLOBAL CATCH FOR ACCIDENTAL LONG TASKS */
  // If something still locks the UI, advise safe mode.
  window.addEventListener("error", (e) => {
    console.warn("[TK-SAFE] Window error:", e.message);
  });
})();
</script>
<!-- ---------- End Safe Bootstrap ---------- -->
</body>).
2. Keep your existing "Download PDF" button with id="downloadBtn"
   (or change the selector inside the script).
3. By default, the PDF will have a WHITE background with BLACK text.
4. To switch themes, override CSS variables:
   <body style="--pdf-bg:#000; --pdf-text:#fff">   (dark)
   <body style="--pdf-bg:#fff; --pdf-text:#000">   (light, default)
5. The script supports BOTH:
   - Canvas snapshot export (WYSIWYG, uses html2canvas)
   - Data-to-PDF export (vector text via jsPDF AutoTable)

Pick which one you want by changing the line near the bottom:
  window.TKPDF.downloadCompatibilityPDFCanvas();
or
  window.TKPDF.downloadCompatibilityPDF();
-->

<style id="tk-pdf-theme-patch">
:root {
  --pdf-bg:  #fff; /* default LIGHT */
  --pdf-text:#000;
}
.pdf-export,
#pdfWrapper,
.pdf-container {
  background: var(--pdf-bg) !important;
  color:      var(--pdf-text) !important;
}
.pdf-export table {
  background: var(--pdf-bg) !important;
  color:      var(--pdf-text) !important;
}
</style>

<script>
(function(){
  // --- Utility loaders ---
  function loadScript(src){
    return new Promise((res, rej) => {
      if (document.querySelector(`script[src="${src}"]`)) return res();
      const s = document.createElement('script');
      s.src = src; s.onload = res; s.onerror = () => rej(new Error('Failed to load '+src));
      document.head.appendChild(s);
    });
  }
  function getJsPDF(){
    return (window.jspdf && window.jspdf.jsPDF) || (window.jsPDF && window.jsPDF.jsPDF);
  }
  async function ensureLibs(){
    if (!window.html2canvas) {
      try { await loadScript('/lib/html2canvas.min.js'); }
      catch { await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'); }
    }
    if (!window.html2canvas) throw new Error('html2canvas failed to load.');
    if (!getJsPDF()) {
      try { await loadScript('/lib/jspdf.umd.min.js'); }
      catch { await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'); }
    }
    const hasAT = (window.jspdf && window.jspdf.autoTable) || (window.jsPDF && window.jsPDF.API?.autoTable);
    if (!hasAT) {
      try { await loadScript('/lib/jspdf.plugin.autotable.min.js'); }
      catch { await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js'); }
    }
  }

  // --- Theme helpers ---
  function cssVar(name, fallback = '') {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name);
    return v ? v.trim() : fallback;
  }

  // === Method 1: CANVAS SNAPSHOT (WYSIWYG, keeps styling) ===
  async function downloadCompatibilityPDFCanvas({
    selector = '#compatibilityTable',
    filename = 'compatibility-report.pdf',
    orientation = 'landscape',
    format = 'a4',
    scale = Math.max(2, Math.floor(window.devicePixelRatio || 2))
  } = {}){
    await ensureLibs();
    const target = document.querySelector(selector)
               || document.querySelector('.results-table.compat')
               || document.body;
    if (!target) { alert('Export target not found'); return; }

    const bg = cssVar('--pdf-bg', '#fff');

    const canvas = await window.html2canvas(target, {
      backgroundColor: bg,
      useCORS: true,
      scale
    });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf || window;
    const doc = new jsPDF({ orientation, unit:'pt', format });

    const pw = doc.internal.pageSize.getWidth();
    const ph = doc.internal.pageSize.getHeight();
    const iw = canvas.width, ih = canvas.height;
    const pageRatio = pw/ph, imgRatio = iw/ih;
    let rw, rh;
    if (imgRatio > pageRatio) { rw = pw; rh = pw/imgRatio; } else { rh = ph; rw = ph*imgRatio; }
    const x = (pw - rw)/2, y = (ph - rh)/2;

    doc.addImage(img, 'PNG', x, y, rw, rh);
    doc.save(filename);
  }

  // === Method 2: DATA EXPORT (AutoTable, vector text, faster) ===
  const tidy = (s) => (s || '').replace(/\s+/g, ' ').trim();
  const toNum = (v) => {
    const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
    return Number.isFinite(n) ? n : null;
  };
  const isValidScore = (n) => Number.isInteger(n) && n >= 1 && n <= 5;
  function extractRows() {
    const table = document.querySelector('#compatibilityTable')
               || document.querySelector('table.results-table.compat')
               || document.querySelector('table');
    if (!table) return [];
    const trs = [...table.querySelectorAll('tr')]
      .filter(tr => tr.querySelectorAll('td').length > 0);

    const isHeaderLike = (cellTexts) => {
      const first = (cellTexts[0] || '').toLowerCase();
      const joined = cellTexts.map(t => (t || '').toLowerCase()).join(' | ');
      if (first === 'category') return true;
      if (/partner a|partner b|match/.test(joined)) return true;
      if (!cellTexts.some(t => /\S/.test(t))) return true;
      return false;
    };

    const rows = [];
    for (const tr of trs) {
      const cells = [...tr.querySelectorAll('td')].map(td => tidy(td.textContent));
      if (!cells.length) continue;
      if (isHeaderLike(cells)) continue;

      const category = cells[0] || '—';
      const numeric = cells.map(toNum).filter(n => n !== null);
      const Araw = numeric.length ? numeric[0] : null;
      const Braw = numeric.length ? numeric[numeric.length - 1] : null;

      const aValid = isValidScore(Araw);
      const bValid = isValidScore(Braw);

      let pct = cells.find(c => /%$/.test(c)) || null;
      if (!pct && aValid && bValid) {
        const p = Math.round(100 - (Math.abs(Araw - Braw) / 5) * 100);
        pct = `${Math.max(0, Math.min(100, p))}%`;
      }
      if (!pct) pct = '—';

      rows.push([category, aValid ? Araw : '—', pct, bValid ? Braw : '—']);
    }
    return rows;
  }

  async function downloadCompatibilityPDF({
    filename='compatibility-report.pdf',
    orientation='landscape',
    format='a4'
  }={}){
    await ensureLibs();
    const rows = extractRows();
    if (!rows.length) { alert('No data rows'); return; }
    const { jsPDF } = window.jspdf || window;
    const doc = new jsPDF({ orientation, unit:'pt', format });
    const pw = doc.internal.pageSize.getWidth();
    doc.setTextColor(0,0,0);
    doc.setFontSize(28);
    doc.text('Talk Kink • Compatibility Report', pw/2, 48, { align:'center' });
    doc.autoTable({
      head: [['Category','Partner A','Match %','Partner B']],
      body: rows,
      startY: 70,
      margin: { left:30, right:30 },
      styles: { fontSize:12, cellPadding:6 }
    });
    doc.save(filename);
  }

  // --- Expose both ---
  window.TKPDF = { downloadCompatibilityPDFCanvas, downloadCompatibilityPDF };

  // --- Auto-bind to Download button ---
  const btn = document.querySelector('#downloadBtn');
  if (btn) {
    btn.addEventListener('click', () => {
      // Choose ONE of these:
      // window.TKPDF.downloadCompatibilityPDF();        // data export
      window.TKPDF.downloadCompatibilityPDFCanvas();    // canvas export
    });
  }
})();
</script>
