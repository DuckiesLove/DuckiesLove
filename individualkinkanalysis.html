<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Individual Kink Analysis</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/theme.css">
<link rel="stylesheet" href="/css/font-failopen.css">

</head>
<body class="theme-dark" data-page="ika">

<!-- Individual Kink Analysis — compact, centered UI -->
<div class="ika-page">
<div class="ika-container">
  <h1 class="ika-title">Individual Kink Analysis</h1>
  <p class="ika-instructions">
    Upload your survey data and generate a personal PDF report.
  </p>

  <div class="tk-menu">
    <!-- Upload (keeps the same input id expected by your JS) -->
    <label for="ikaFile" class="tk-btn">Upload Survey</label>

    <!-- Download (keeps the same button id expected by your JS) -->
    <button id="downloadPdfBtn" class="tk-btn">Download PDF</button>
  </div>

  <a href="/kinksurvey/" class="tk-btn back">← Back</a>

  <input id="ikaFile" type="file" accept="application/json" style="display:none" />

  <!-- Optional: where you render preview/results -->
  <div id="ikaResults"></div>
</div>
</div>

<style>
/* ===== Full-page centered layout ===== */
.ika-page {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: #000;
}

/* ===== Compact layout & typography (dark theme friendly) ===== */
.ika-container {
  text-align: center;
  max-width: 600px;
  width: 100%;
}

.ika-title{
  font-family: var(--tk-font-display, system-ui, -apple-system, 'Segoe UI', sans-serif);
  font-size: 2rem;           /* smaller title */
  line-height: 1.2;
  margin: 0 0 8px 0;
  color: #22d3ee;            /* cyan to match theme */
}

.ika-instructions {
  margin-bottom: 20px;
  font-family: var(--tk-font-display, system-ui, -apple-system, 'Segoe UI', sans-serif);
  color: #fff;
  font-size: 1.1em;
}

/* Buttons: consistent look */
.tk-menu {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.tk-btn {
  display: block;
  margin: 12px auto;
  padding: 12px 24px;
  font-family: var(--tk-font-display, system-ui, -apple-system, 'Segoe UI', sans-serif);
  font-size: 1.1em;
  background: #000;
  border: 2px solid cyan;
  border-radius: 16px;
  color: #fff;
  cursor: pointer;
}

.tk-btn:hover {
  background: #00f0ff;
  color: #000;
}

/* Rendered results section */
#ikaResults{
  margin-top: 16px;
  text-align: left;
  font-family: Inter, system-ui, -apple-system, sans-serif;
  color: #e5e7eb;
  font-size: .95rem;
  line-height: 1.5;
}

label[for="ikaFile"]{ user-select: none; }

/* Individual Kink Analysis — normalize button sizes */
body[data-page="ika"] .tk-menu { gap: 18px; }

/* Same size for Upload + Download (medium, not huge) */
body[data-page="ika"] .tk-btn {
  width: min(420px, 80vw);   /* consistent width */
  height: 52px;              /* medium height */
  font-size: 16px;           /* readable but not oversized */
  border-radius: 14px;       /* tighter pill */
  border-width: 2px;         /* slimmer outline */
}

/* Keep back button compact */
body[data-page="ika"] .tk-btn.back{
  width: min(220px, 60vw);
  height: 42px;
  font-size: 15px;
  border-radius: 12px;
  border-width: 2px;
  margin-top: 12px;
}

/* Optional: smaller on very small screens */
@media (max-width: 420px){
  body[data-page="ika"] .tk-btn { height: 48px; font-size: 15px; }
  body[data-page="ika"] .tk-btn.back { height: 40px; font-size: 14px; }
}
</style>
<script>
/* =========================
 * 1) Role catalog (canonical names)
 * ========================= */
window.IKA_ROLES = [
  // Core dynamics
  "Dominant","Submissive","Switch",

  // Bedroom dynamics
  "Bedroom Dom","Bedroom Submissive","Bottom",
  "Dom-Leaning Switch","Bottom-Leaning Switch","Service Top","Service Switch",
  "Service Submissive","Service Slave","Master","Slave","Owner","Sir","Prince","Princess",

  // Brat ecosystem
  "Brat","Brat Tamer","Brat Enabler","Brat Handler",

  // Primal / predator–prey
  "Primal Predator","Primal Prey","Primal Switch",
  "Primal Sadist","Primal Sadomasochist",

  // Impact / pain
  "Impact Top","Impact Bottom","Impact Switch",
  "Sadist","Emotional Sadist","Intellectual Sadist","Emotional Masochist",
  "Emotional Sadomasochist",

  // Bondage / rope
  "Bondage Top","Bondage Bottom","Bondage Switch",
  "Rope Top","Rope Bottom","Rope Switch",

  // Sensation & specialties
  "Electro Top","Hypno Top","Hypno Bottom","Fire Top","Fire Bottom","Fire Switch",
  "Needle Top","Needle Bottom","Needle Switch",
  "Fisting Top","Fisting Bottom",

  // Fetish families
  "Foot Top","Foot Bottom","Foot Switch",
  "Latex Top","Latex Bottom","Latex Switch",
  "Leather Top","Leather Bottom",

  // Fluids / body play
  "Watersports Top","Watersports Bottom","Watersports Switch",
  "Cum Princess","Cum Slut","Cock Worshipper",

  // Relationship / scene attitudes
  "Experimentalist","Voyeur","Exhibitionist","Non-monogamist","Vanilla",
  "Cuckold","Edge Player","Pleasure Dom","Pleasure Sadist",

  // Pet/age roles
  "Pet","Caregiver","Ageplayer","Age Regressor","Little",

  // Rope bunny (commonly used)
  "Rope bunny"
];

/* ==========================================================
 * 2) QUESTION → ROLE MAP (THIS IS WHAT YOU CUSTOMIZE)
 *    Map either by stable question id OR by a unique substring
 *    of the question text (engine will match either).
 *    weight: how strongly this question contributes to the role.
 *    Multiple roles per question supported.
 * ========================================================== */
window.IKA_ROLE_MAP = [
  /* EXAMPLES — replace "Qxx" or "textIncludes" with YOUR survey’s keys/texts */

  // Submissive & Service Submissive
  { id: "Q12", roles: [{name:"Submissive", weight:1.0}, {name:"Service Submissive", weight:0.6}] },
  { textIncludes: "Following rules or protocol", roles: [{name:"Submissive", weight:0.8}] },

  // Dominant
  { id: "Q07", roles: [{name:"Dominant", weight:1.0}] },
  { textIncludes: "I enjoy being in charge", roles: [{name:"Dominant", weight:0.9}] },

  // Brat & Brat Tamer
  { textIncludes: "I like to playfully resist", roles: [{name:"Brat", weight:1.0}] },
  { textIncludes: "I enjoy taming brats", roles: [{name:"Brat Tamer", weight:1.0}] },

  // Impact
  { id: "Q21", roles: [{name:"Impact Top", weight:1.0}] },
  { textIncludes: "spanking or paddling", roles: [{name:"Impact Bottom", weight:1.0}] },

  // Rope / bondage
  { textIncludes: "being tied", roles: [{name:"Rope Bottom", weight:1.0},{name:"Bondage Bottom", weight:0.7}] },
  { textIncludes: "tying others", roles: [{name:"Rope Top", weight:1.0},{name:"Bondage Top", weight:0.7}] },

  // Primal
  { textIncludes: "predator", roles: [{name:"Primal Predator", weight:1.0}] },
  { textIncludes: "prey", roles: [{name:"Primal Prey", weight:1.0}] },

  // Fetish examples
  { textIncludes: "feet", roles: [{name:"Foot Bottom", weight:1.0}] },
  { textIncludes: "latex", roles: [{name:"Latex Bottom", weight:1.0}] },
  { textIncludes: "leather", roles: [{name:"Leather Bottom", weight:1.0}] },

  // Exhibition/Voyeur
  { textIncludes: "being watched", roles: [{name:"Exhibitionist", weight:1.0}] },
  { textIncludes: "watching others", roles: [{name:"Voyeur", weight:1.0}] },

  // Pet/age dynamics
  { textIncludes: "pet play", roles: [{name:"Pet", weight:1.0}] },
  { textIncludes: "age regress", roles: [{name:"Age Regressor", weight:1.0}] },
  { textIncludes: "caregiver", roles: [{name:"Caregiver", weight:1.0}] },

  // Vanilla / Experimentalist
  { textIncludes: "I prefer gentle, non-kinky", roles: [{name:"Vanilla", weight:1.0}] },
  { textIncludes: "I love trying new kinks", roles: [{name:"Experimentalist", weight:1.0}] },
];

/* Optional: Likert text → number (edit to match your survey) */
const IKA_LIKERT = {
  "strongly disagree": 1, "disagree": 2, "neutral": 3, "agree": 4, "strongly agree": 5,
  "never": 1, "rarely": 2, "sometimes": 3, "often": 4, "always": 5
};

/* ===================================
 * 3) Survey extraction helpers
 *    We support several JSON shapes:
 *    A) { answers: [{id:"Q1", value: 1..5|text, question:"..."}, ...] }
 *    B) { answers: { Q1: 1..5|text, ... }, questions: {Q1:"..."} }
 *    C) Any flat array of {question|label|text, value}
 * =================================== */
function toNumberLike(v) {
  if (v == null) return null;
  if (typeof v === "number") return v;
  const s = String(v).trim().toLowerCase();
  // direct number in string
  const n = Number(s);
  if (Number.isFinite(n)) return n;
  // Likert mapping
  if (IKA_LIKERT[s] != null) return IKA_LIKERT[s];
  // pull digits if present (e.g., "5 - strongly agree")
  const m = s.match(/(-?\d+(\.\d+)?)/);
  if (m) return Number(m[1]);
  return null; // not parseable
}

function extractAnswers(raw) {
  const out = []; // [{id, text, value}]
  if (!raw) return out;

  // A) array of answers
  if (Array.isArray(raw.answers)) {
    for (const a of raw.answers) {
      const id = a.id ?? a.qid ?? a.key ?? null;
      const text = a.question ?? a.label ?? a.text ?? "";
      const value = toNumberLike(a.value ?? a.answer ?? a.score);
      if (id || text) out.push({ id, text, value });
    }
    return out;
  }

  // B) map answers + questions
  if (raw.answers && typeof raw.answers === "object") {
    const qmap = raw.questions || {};
    for (const k of Object.keys(raw.answers)) {
      const id = k;
      const text = qmap[k] ?? "";
      const value = toNumberLike(raw.answers[k]);
      out.push({ id, text, value });
    }
    return out;
  }

  // C) flat array
  if (Array.isArray(raw)) {
    for (const a of raw) {
      const id = a.id ?? a.qid ?? a.key ?? null;
      const text = a.question ?? a.label ?? a.text ?? "";
      const value = toNumberLike(a.value ?? a.answer ?? a.score);
      if (id || text) out.push({ id, text, value });
    }
    return out;
  }

  return out;
}

/* ===================================
 * 4) Scoring engine (exported)
 * =================================== */
window.IKA_scoreRoles = function scoreRoles(rawSurvey, opts = {}) {
  const answers = extractAnswers(rawSurvey);
  const byId = new Map();
  const byText = [];
  for (const a of answers) {
    if (a.id) byId.set(String(a.id).trim(), a);
    if (a.text) byText.push(a);
  }

  // init accumulators
  const acc = new Map();    // role → actual points
  const maxAcc = new Map(); // role → max possible points (weight * 5)

  function bump(role, pts, maxPts) {
    acc.set(role, (acc.get(role) || 0) + pts);
    maxAcc.set(role, (maxAcc.get(role) || 0) + maxPts);
  }

  for (const rule of window.IKA_ROLE_MAP) {
    const weightRoles = (rule.roles || []).map(r => ({ name: r.name, w: r.weight ?? 1 }));
    if (weightRoles.length === 0) continue;

    // find a matching answer
    let a = null;

    // prefer id
    if (rule.id && byId.has(String(rule.id).trim())) {
      a = byId.get(String(rule.id).trim());
    }

    // else, try unique substring match
    if (!a && rule.textIncludes) {
      const needle = String(rule.textIncludes).toLowerCase();
      a = byText.find(x => (x.text || "").toLowerCase().includes(needle));
    }

    // if no answer found, still add to max (user could score up to 5)
    const v = a ? (a.value ?? null) : null;
    const val = (v == null ? null : Math.max(1, Math.min(5, Number(v)))); // clamp 1..5 if provided
    for (const { name, w } of weightRoles) {
      // Always grow the denominator by 5 * weight (so % stays comparable).
      bump(name, (val ? val * w : 0), 5 * w);
    }
  }

  // Convert to sorted result list
  const results = [];
  const catalog = new Set(window.IKA_ROLES);
  // Include only roles we actually mapped or that received any max points
  for (const [role, maxPts] of maxAcc.entries()) {
    const pts = acc.get(role) || 0;
    const pct = maxPts > 0 ? Math.round((pts / maxPts) * 100) : 0;
    results.push({ role, pct, points: pts, max: maxPts });
    // In case role wasn’t in the catalog, keep it anyway (mapping is source of truth)
    catalog.add(role);
  }

  results.sort((a, b) => b.pct - a.pct || a.role.localeCompare(b.role));
  window.IKA_lastResults = results; // let the PDF exporter consume it
  return results;
};

// Alias so drop-in integrations can find the scorer
window.calculateRoleScores = window.IKA_scoreRoles;
</script>

<!-- =========================================================
INDIVIDUAL KINK ANALYSIS – “MAKE IT WORK” DROP-IN INTEGRATION
Paste this ONCE, near the end of /individualkinkanalysis.html,
right before </body>. It wires the existing UI (upload + button)
to your scoring + PDF export. If your project already provides
calculateRoleScores() and downloadPdf(), those will be used.
Otherwise, safe fallbacks included below will run.
========================================================= -->

<!-- (1) OPTIONAL: reuse your own scoring / pdf utilities if you have them -->
<!-- <script src="js/calculateRoleScores.js"></script> -->
<!-- <script src="js/pdfDownload.js"></script> -->

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const fileInput   = $('ikaFile');
  const downloadBtn = $('downloadPdfBtn');
  const resultsBox  = $('ikaResults');

  // Keep the last computed results here so the PDF button can use them.
  // Shape: [{ role: "Brat", scorePct: 87 }, ...] sorted desc
  let LAST_RESULTS = [];

  /* ----------------------------- (2) SCORING -----------------------------
     If you already ship a project function `calculateRoleScores(rawJson)`
     that returns [{role, scorePct}], it will be used. Otherwise we fall back
     to a very simple demo scorer that looks for a field `raw.roles` like:
       { roles: { "Brat": 0.87, "Exhibitionist": 0.65, ... } }
     and converts those to percents.
  ------------------------------------------------------------------------ */
  function haveProjectScorer() {
    return typeof window.calculateRoleScores === 'function';
  }

  function demoCalculateRoleScores(raw) {
    const out = [];
    // Example expected input: { roles: { "Brat": 0.87, "Exhibitionist": 0.65, ... } }
    const roles = raw && raw.roles && typeof raw.roles === 'object' ? raw.roles : {};
    for (const [role, val] of Object.entries(roles)) {
      const pct = Math.max(0, Math.min(100, Math.round(Number(val) * 100)));
      out.push({ role, scorePct: pct });
    }
    // Sort high → low and cap at 100
    out.sort((a,b) => b.scorePct - a.scorePct);
    return out;
  }

  async function scoreFromRaw(raw) {
    const scorer = haveProjectScorer() ? window.calculateRoleScores : demoCalculateRoleScores;
    const results = await Promise.resolve(scorer(raw));
    // Normalize defensively
    const clean = (Array.isArray(results) ? results : [])
      .map(r => ({ role: String(r.role || ''), scorePct: Math.max(0, Math.min(100, Number(r.scorePct)||0)) }))
      .sort((a,b) => b.scorePct - a.scorePct);
    return clean;
  }

  /* --------------------------- (3) RENDER PREVIEW --------------------------- */
  function renderResultsPreview(list) {
    if (!resultsBox) return;
    if (!list.length) {
      resultsBox.innerHTML = '<em>No results yet. Upload a survey JSON first.</em>';
      return;
    }
    const rows = list.slice(0, 15) // keep preview compact
      .map((r,i) => `<tr><td>${i+1}</td><td>${escapeHtml(r.role)}</td><td>${r.scorePct}%</td></tr>`)
      .join('');
    resultsBox.innerHTML = `
      <table style="width:100%;border-collapse:collapse;margin-top:12px">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid #444;padding:.35rem">#</th>
            <th style="text-align:left;border-bottom:1px solid #444;padding:.35rem">Role</th>
            <th style="text-align:right;border-bottom:1px solid #444;padding:.35rem">%</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }
  function escapeHtml(s){return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));}

  /* ----------------------- (4) FILE → SCORE PIPELINE ----------------------- */
  if (fileInput) {
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        const raw = JSON.parse(await f.text());
        LAST_RESULTS = await scoreFromRaw(raw);
        renderResultsPreview(LAST_RESULTS);
      } catch (err) {
        console.error('[IKA] Failed to parse/score JSON:', err);
        alert('Could not read this file as JSON. Please choose a valid survey export.');
      }
    });
  }

  /* ---------------------------- (5) PDF EXPORT ---------------------------- */
  // If your project defines window.downloadPdf(list), we use it; otherwise, we
  // create a dark-mode jsPDF export (self-contained loader).
  async function ensurePdfLibs() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    const hasAT =
      (window.jspdf && window.jspdf.autoTable) ||
      (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable);
    if (!hasAT) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js');
    }
  }
  function loadScript(src) {
    return new Promise((res, rej) => {
      if (document.querySelector(`script[src="${src}"]`)) return res();
      const s = document.createElement('script');
      s.src = src;
      s.onload = res;
      s.onerror = () => rej(new Error('Failed to load ' + src));
      document.head.appendChild(s);
    });
  }

  async function fallbackDownloadPdf(list) {
    await ensurePdfLibs();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const paintBg = () => { doc.setFillColor(0,0,0); doc.rect(0,0,pageW,pageH,'F'); doc.setTextColor(255,255,255); };
    paintBg();

    doc.setFontSize(16);
    doc.text('Individual Kink Analysis', pageW/2, 42, { align: 'center' });
    doc.setFontSize(10);
    doc.text(new Date().toLocaleString(), pageW/2, 58, { align: 'center' });

    const head = [['Rank','Role','%']];
    const body = (list && list.length ? list : []).map((r,i) => [String(i+1), r.role, r.scorePct + '%']);

    // Use autotable, dark styling
    const marginLR = 40;
    const usable = pageW - marginLR * 2;
    const runAT = (opts) =>
      (typeof doc.autoTable === 'function') ? doc.autoTable(opts)
      : (window.jspdf && typeof window.jspdf.autoTable === 'function') ? window.jspdf.autoTable(doc, opts)
      : (() => { throw new Error('AutoTable not available'); })();

    const originalAddPage = doc.addPage;
    doc.addPage = function patchedAddPage(...args) {
      const result = originalAddPage.apply(this, args);
      paintBg();
      return result;
    };

    try {
      runAT({
        head, body,
        startY: 74,
        margin: { left: marginLR, right: marginLR, top: 74, bottom: 32 },
        styles: {
          fontSize: 11,
          cellPadding: 6,
          textColor: [255,255,255],
          fillColor: [0,0,0],
          lineColor: [255,255,255],
          lineWidth: 1,
          halign: 'left',
          valign: 'middle'
        },
        headStyles: {
          fillColor: [0,0,0],
          textColor: [255,255,255],
          fontStyle: 'bold',
          lineColor: [255,255,255],
          lineWidth: 1.4
        },
        columnStyles: {
          0: { cellWidth: 60,  halign: 'left'  },
          1: { cellWidth: usable - 140, halign: 'left'  },
          2: { cellWidth: 80,  halign: 'right' }
        },
        willDrawPage: paintBg
      });
    } finally {
      doc.addPage = originalAddPage;
    }

    doc.save('individual-kink-analysis.pdf');
  }

  function haveProjectPdf() {
    return typeof window.downloadPdf === 'function';
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      if (!LAST_RESULTS.length) {
        alert('Upload a survey JSON first, so we can compute your role percentages.');
        return;
      }
      try {
        if (haveProjectPdf()) {
          // Use your project’s implementation if present
          await Promise.resolve(window.downloadPdf(LAST_RESULTS));
        } else {
          // self-contained dark-mode PDF
          await fallbackDownloadPdf(LAST_RESULTS);
        }
      } catch (err) {
        console.error('[IKA] PDF export failed:', err);
        alert('PDF export failed: ' + (err && err.message ? err.message : err));
      }
    });
  }
})();
</script>

<script>
(function(){
  const fileSel = document.querySelector('#ikaFile') || document.querySelector('#uploadSurvey') || document.querySelector('#uploadSurveyA');
  const resultsBox = document.querySelector('#ikaResults');

  function renderPreview(list) {
    if (!resultsBox) return;
    const top = list.slice(0, 15);
    const rows = top.map((r,i)=>`<tr><td>${i+1}</td><td>${r.role || r.name}</td><td style="text-align:right">${r.pct ?? r.percent}%</td></tr>`).join('');
    resultsBox.innerHTML = `
      <div style="margin:16px auto;max-width:820px;">
        <h3 style="color:#fff;margin:0 0 8px;font-weight:600;">Top Roles</h3>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr>
            <th style="color:#fff;border-bottom:1px solid #666;text-align:left;padding:6px 8px;width:60px;">#</th>
            <th style="color:#fff;border-bottom:1px solid #666;text-align:left;padding:6px 8px;">Role</th>
            <th style="color:#fff;border-bottom:1px solid #666;text-align:right;padding:6px 8px;width:80px;">%</th>
          </tr></thead>
          <tbody>${rows || `<tr><td colspan="3" style="color:#bbb;padding:8px;">No scored roles yet</td></tr>`}</tbody>
        </table>
      </div>`;
  }

  async function onUpload(e){
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    let data;
    try { data = JSON.parse(await f.text()); }
    catch { alert('Invalid JSON file'); return; }

    if (typeof window.IKA_scoreRoles !== 'function') {
      alert('Scoring engine not found. Ensure calculateRoleScores.js is loaded before this block.');
      return;
    }

    const scored = window.IKA_scoreRoles(data);
    renderPreview(scored);
  }

  if (fileSel) fileSel.addEventListener('change', onUpload);
})();
</script>
<!-- ✅ 1) Add this *once* near the end of every page that was freezing (before </body>) -->
<script>
/* ---------- TalkKink Safe Bootstrap (drop-in) ---------- */
(function () {
  const LOG = (...a) => console.log("[TK-SAFE]", ...a);

  /* A. QUICK SANITY CHECKS — find & warn about merge markers (these often lock pages) */
  try {
    const html = document.documentElement.innerHTML;
    const HEAD = '<'.repeat(7);
    const SEP = '='.repeat(7);
    const TAIL = '>'.repeat(7);
    if (html.includes(HEAD) && html.includes(SEP) && html.includes(TAIL)) {
      const conflictPattern = new RegExp(`${HEAD}[\s\S]*?${SEP}[\s\S]*?${TAIL}`);
      if (conflictPattern.test(html)) {
        console.warn("[TK-SAFE] Merge conflict markers detected in DOM. Remove them to avoid broken JS/CSS.");
      }
    }
  } catch (_) {}

  /* B. ONE-TIME INIT GUARD (prevents duplicate event bind/render loops) */
  if (window.__TK_INITED__) {
    LOG("Init skipped: already initialized.");
    return;
  }
  window.__TK_INITED__ = true;

  /* C. SAFE-MODE FLAGS (use ?safe=1 or ?nopdf=1 or ?noscore=1 to bypass heavy work) */
  const params = new URLSearchParams(location.search);
  const SAFE_MODE  = params.has("safe");
  const NO_PDF     = SAFE_MODE || params.has("nopdf");
  const NO_SCORE   = SAFE_MODE || params.has("noscore");

  if (SAFE_MODE) LOG("SAFE MODE ON: skipping scoring/render and lazy-loading libraries.");

  /* D. SMALL UTILITIES */
  const byId = (id) => document.getElementById(id);
  function once(el, type, handler, opts) {
    // prevent stacked duplicate listeners after HMR/partials
    el && el.addEventListener(type, function f(e) {
      el.removeEventListener(type, f, opts);
      handler(e);
    }, opts);
  }
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src; s.async = true; s.defer = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  function idle(fn) {
    // yield back to the browser to keep UI responsive
    return (window.requestIdleCallback || ((cb)=>setTimeout(cb,0)))(fn);
  }

  /* E. LAZY LOADERS FOR HEAVY LIBS (loaded only on click) */
  async function ensureJsPDF() {
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
  }
  async function ensureAutoTable() {
    // Only after jsPDF UMD maps window.jspdf.jsPDF
    await ensureJsPDF();
    const hasAT = (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable)
               || (window.jspdf && window.jspdf.autoTable);
    if (!hasAT) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* F. DEFENSIVE BINDINGS (buttons used across pages) */
  idle(() => {
    // PDF buttons (compatibility, IKA, etc.)
    const dl1 = byId("downloadBtn");
    const dl2 = byId("downloadPdfBtn");
    const anyDownload = dl1 || dl2;

    if (anyDownload) {
      const handler = async (e) => {
        e.preventDefault();
        if (NO_PDF) { alert("PDF disabled (safe mode). Add ?safe=0 or remove ?nopdf."); return; }
        try {
          // Lazy load heavy libs only now
          await ensureAutoTable();
          // Yield once more before heavy export:
          await new Promise(r => setTimeout(r, 0));
          // Call your existing exporter (must be defined elsewhere)
          if (typeof window.TKPDF_export === "function") {
            await window.TKPDF_export();
          } else if (typeof window.TKPDF_forceDark === "function") {
            await window.TKPDF_forceDark();
          } else if (typeof window.exportIKAPdf === "function") {
            await window.exportIKAPdf();
          } else {
            alert("Export function not found. Expected TKPDF_export/TKPDF_forceDark/exportIKAPdf.");
          }
        } catch (err) {
          console.error("[TK-SAFE] PDF export failed:", err);
          alert("PDF export failed: " + (err?.message || err));
        }
      };

      // Bind once to whichever exists
      if (dl1) once(dl1, "click", handler);
      if (dl2) once(dl2, "click", handler);
      LOG("Bound PDF button(s).");
    }

    // File upload styled label (IKA)
    const fileInput = byId("ikaFile");
    const fileLabel = document.querySelector('label[for="ikaFile"]');
    if (fileInput && fileLabel) {
      once(fileLabel, "click", () => fileInput.click());
      LOG("Bound Upload Survey label→input.");
    }
  });

  /* G. STOP RUNNING EXPENSIVE WORK ON LOAD (scoring/rendering) */
  // Wrap your page’s auto-render or scoring in this gate:
  window.TK_canRunHeavy = function () {
    if (SAFE_MODE) return false;
    // Avoid running more than once
    if (window.__TK_HEAVY_RAN__) return false;
    window.__TK_HEAVY_RAN__ = true;
    return true;
  };

  // Example usage for your pages (leave here; your code can call it):
  // if (window.TK_canRunHeavy()) {
  //   // run scoring/render here or schedule with idle(...)
  //   idle(() => window.renderResults && window.renderResults());
  // }

  /* H. GLOBAL CATCH FOR ACCIDENTAL LONG TASKS */
  // If something still locks the UI, advise safe mode.
  window.addEventListener("error", (e) => {
    console.warn("[TK-SAFE] Window error:", e.message);
  });
})();
</script>
<!-- ---------- End Safe Bootstrap ---------- -->
</body>
</html>
