<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Individual Kink Analysis</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=EB+Garamond&display=swap" rel="stylesheet">
</head>
<body class="theme-dark">

<!-- ✅ INDIVIDUAL KINK ANALYSIS — FIXED MARKUP + CENTERED CONTROLS + WORKING PDF EXPORT
Paste this whole block near the end of /individualkinkanalysis.html (right before <!--
INDIVIDUAL KINK ANALYSIS — QUESTION→ROLE MAPPING + SCORING (drop-in)
Paste this WHOLE block near the end of /individualkinkanalysis.html (right before </body>).

What you get
- A clean, explicit “question → role(s)” mapping template (with weights).
- A robust scoring engine that:
    • reads your uploaded JSON (various shapes supported),
    • converts Likert text to numbers (e.g., “Strongly agree” → 5),
    • totals weighted points per role,
    • returns normalized percentages (0–100%),
    • stores results in window.IKA_lastResults (so your PDF exporter can consume them).
- Minimal UI glue to render a quick preview list (optional) and keep your Download PDF flow working.

HOW TO USE
1) Paste this script.
2) Fill out IKA_ROLE_MAP with your survey’s question IDs (or unique question text) and the roles they influence.
   - Use the provided role catalog so names are consistent.
   - Each mapping entry supports one or more roles with weights (default 1).
3) Upload a survey JSON on the page and click “Download PDF” as usual.
   - Your existing PDF exporter that calls window.IKA_scoreRoles(...) will now get real percentages.

Tip: Start with 10–20 key questions, then expand the map over time. The engine auto-normalizes by total possible points, so different numbers of mappings still yield proper 0–100%.

----------------------------------------------------------------------->
<script>
/* =========================
 * 1) Role catalog (canonical names)
 * ========================= */
window.IKA_ROLES = [
  // Core dynamics
  "Dominant","Submissive","Switch",

  // Bedroom dynamics
  "Bedroom Dom","Bedroom Submissive","Bottom",
  "Dom-Leaning Switch","Bottom-Leaning Switch","Service Top","Service Switch",
  "Service Submissive","Service Slave","Master","Slave","Owner","Sir","Prince","Princess",

  // Brat ecosystem
  "Brat","Brat Tamer","Brat Enabler","Brat Handler",

  // Primal / predator–prey
  "Primal Predator","Primal Prey","Primal Switch",
  "Primal Sadist","Primal Sadomasochist",

  // Impact / pain
  "Impact Top","Impact Bottom","Impact Switch",
  "Sadist","Emotional Sadist","Intellectual Sadist","Emotional Masochist",
  "Emotional Sadomasochist",

  // Bondage / rope
  "Bondage Top","Bondage Bottom","Bondage Switch",
  "Rope Top","Rope Bottom","Rope Switch",

  // Sensation & specialties
  "Electro Top","Hypno Top","Hypno Bottom","Fire Top","Fire Bottom","Fire Switch",
  "Needle Top","Needle Bottom","Needle Switch",
  "Fisting Top","Fisting Bottom",

  // Fetish families
  "Foot Top","Foot Bottom","Foot Switch",
  "Latex Top","Latex Bottom","Latex Switch",
  "Leather Top","Leather Bottom",

  // Fluids / body play
  "Watersports Top","Watersports Bottom","Watersports Switch",
  "Cum Princess","Cum Slut","Cock Worshipper",

  // Relationship / scene attitudes
  "Experimentalist","Voyeur","Exhibitionist","Non-monogamist","Vanilla",
  "Cuckold","Edge Player","Pleasure Dom","Pleasure Sadist",

  // Pet/age roles
  "Pet","Caregiver","Ageplayer","Age Regressor","Little",

  // Rope bunny (commonly used)
  "Rope bunny"
];

/* ==========================================================
 * 2) QUESTION → ROLE MAP (THIS IS WHAT YOU CUSTOMIZE)
 *    Map either by stable question id OR by a unique substring
 *    of the question text (engine will match either).
 *    weight: how strongly this question contributes to the role.
 *    Multiple roles per question supported.
 * ========================================================== */
window.IKA_ROLE_MAP = [
  /* EXAMPLES — replace "Qxx" or "textIncludes" with YOUR survey’s keys/texts */

  // Submissive & Service Submissive
  { id: "Q12", roles: [{name:"Submissive", weight:1.0}, {name:"Service Submissive", weight:0.6}] },
  { textIncludes: "Following rules or protocol", roles: [{name:"Submissive", weight:0.8}] },

  // Dominant
  { id: "Q07", roles: [{name:"Dominant", weight:1.0}] },
  { textIncludes: "I enjoy being in charge", roles: [{name:"Dominant", weight:0.9}] },

  // Brat & Brat Tamer
  { textIncludes: "I like to playfully resist", roles: [{name:"Brat", weight:1.0}] },
  { textIncludes: "I enjoy taming brats", roles: [{name:"Brat Tamer", weight:1.0}] },

  // Impact
  { id: "Q21", roles: [{name:"Impact Top", weight:1.0}] },
  { textIncludes: "spanking or paddling", roles: [{name:"Impact Bottom", weight:1.0}] },

  // Rope / bondage
  { textIncludes: "being tied", roles: [{name:"Rope Bottom", weight:1.0},{name:"Bondage Bottom", weight:0.7}] },
  { textIncludes: "tying others", roles: [{name:"Rope Top", weight:1.0},{name:"Bondage Top", weight:0.7}] },

  // Primal
  { textIncludes: "predator", roles: [{name:"Primal Predator", weight:1.0}] },
  { textIncludes: "prey", roles: [{name:"Primal Prey", weight:1.0}] },

  // Fetish examples
  { textIncludes: "feet", roles: [{name:"Foot Bottom", weight:1.0}] },
  { textIncludes: "latex", roles: [{name:"Latex Bottom", weight:1.0}] },
  { textIncludes: "leather", roles: [{name:"Leather Bottom", weight:1.0}] },

  // Exhibition/Voyeur
  { textIncludes: "being watched", roles: [{name:"Exhibitionist", weight:1.0}] },
  { textIncludes: "watching others", roles: [{name:"Voyeur", weight:1.0}] },

  // Pet/age dynamics
  { textIncludes: "pet play", roles: [{name:"Pet", weight:1.0}] },
  { textIncludes: "age regress", roles: [{name:"Age Regressor", weight:1.0}] },
  { textIncludes: "caregiver", roles: [{name:"Caregiver", weight:1.0}] },

  // Vanilla / Experimentalist
  { textIncludes: "I prefer gentle, non-kinky", roles: [{name:"Vanilla", weight:1.0}] },
  { textIncludes: "I love trying new kinks", roles: [{name:"Experimentalist", weight:1.0}] },
];

/* Optional: Likert text → number (edit to match your survey) */
const IKA_LIKERT = {
  "strongly disagree": 1, "disagree": 2, "neutral": 3, "agree": 4, "strongly agree": 5,
  "never": 1, "rarely": 2, "sometimes": 3, "often": 4, "always": 5
};

/* ===================================
 * 3) Survey extraction helpers
 *    We support several JSON shapes:
 *    A) { answers: [{id:"Q1", value: 1..5|text, question:"..."}, ...] }
 *    B) { answers: { Q1: 1..5|text, ... }, questions: {Q1:"..."} }
 *    C) Any flat array of {question|label|text, value}
 * =================================== */
function toNumberLike(v) {
  if (v == null) return null;
  if (typeof v === "number") return v;
  const s = String(v).trim().toLowerCase();
  // direct number in string
  const n = Number(s);
  if (Number.isFinite(n)) return n;
  // Likert mapping
  if (IKA_LIKERT[s] != null) return IKA_LIKERT[s];
  // pull digits if present (e.g., "5 - strongly agree")
  const m = s.match(/(-?\d+(\.\d+)?)/);
  if (m) return Number(m[1]);
  return null; // not parseable
}

function extractAnswers(raw) {
  const out = []; // [{id, text, value}]
  if (!raw) return out;

  // A) array of answers
  if (Array.isArray(raw.answers)) {
    for (const a of raw.answers) {
      const id = a.id ?? a.qid ?? a.key ?? null;
      const text = a.question ?? a.label ?? a.text ?? "";
      const value = toNumberLike(a.value ?? a.answer ?? a.score);
      if (id || text) out.push({ id, text, value });
    }
    return out;
  }

  // B) map answers + questions
  if (raw.answers && typeof raw.answers === "object") {
    const qmap = raw.questions || {};
    for (const k of Object.keys(raw.answers)) {
      const id = k;
      const text = qmap[k] ?? "";
      const value = toNumberLike(raw.answers[k]);
      out.push({ id, text, value });
    }
    return out;
  }

  // C) flat array
  if (Array.isArray(raw)) {
    for (const a of raw) {
      const id = a.id ?? a.qid ?? a.key ?? null;
      const text = a.question ?? a.label ?? a.text ?? "";
      const value = toNumberLike(a.value ?? a.answer ?? a.score);
      if (id || text) out.push({ id, text, value });
    }
    return out;
  }

  return out;
}

/* ===================================
 * 4) Scoring engine (exported)
 * =================================== */
window.IKA_scoreRoles = function scoreRoles(rawSurvey, opts = {}) {
  const answers = extractAnswers(rawSurvey);
  const byId = new Map();
  const byText = [];
  for (const a of answers) {
    if (a.id) byId.set(String(a.id).trim(), a);
    if (a.text) byText.push(a);
  }

  // init accumulators
  const acc = new Map();    // role → actual points
  const maxAcc = new Map(); // role → max possible points (weight * 5)

  function bump(role, pts, maxPts) {
    acc.set(role, (acc.get(role) || 0) + pts);
    maxAcc.set(role, (maxAcc.get(role) || 0) + maxPts);
  }

  for (const rule of window.IKA_ROLE_MAP) {
    const weightRoles = (rule.roles || []).map(r => ({ name: r.name, w: r.weight ?? 1 }));
    if (weightRoles.length === 0) continue;

    // find a matching answer
    let a = null;

    // prefer id
    if (rule.id && byId.has(String(rule.id).trim())) {
      a = byId.get(String(rule.id).trim());
    }

    // else, try unique substring match
    if (!a && rule.textIncludes) {
      const needle = String(rule.textIncludes).toLowerCase();
      a = byText.find(x => (x.text || "").toLowerCase().includes(needle));
    }

    // if no answer found, still add to max (user could score up to 5)
    const v = a ? (a.value ?? null) : null;
    const val = (v == null ? null : Math.max(1, Math.min(5, Number(v)))); // clamp 1..5 if provided
    for (const { name, w } of weightRoles) {
      // Always grow the denominator by 5 * weight (so % stays comparable).
      bump(name, (val ? val * w : 0), 5 * w);
    }
  }

  // Convert to sorted result list
  const results = [];
  const catalog = new Set(window.IKA_ROLES);
  // Include only roles we actually mapped or that received any max points
  for (const [role, maxPts] of maxAcc.entries()) {
    const pts = acc.get(role) || 0;
    const pct = maxPts > 0 ? Math.round((pts / maxPts) * 100) : 0;
    results.push({ role, pct, points: pts, max: maxPts });
    // In case role wasn’t in the catalog, keep it anyway (mapping is source of truth)
    catalog.add(role);
  }

  results.sort((a, b) => b.pct - a.pct || a.role.localeCompare(b.role));
  window.IKA_lastResults = results; // let the PDF exporter consume it
  return results;
};

/* ===================================
 * 5) Small preview renderer (optional)
 * =================================== */
function renderPreview(targetEl, results) {
  if (!targetEl) return;
  if (!results || !results.length) { targetEl.innerHTML = ""; return; }
  const top = results.slice(0, 10);
  targetEl.innerHTML = `
    <div style="margin:20px auto;max-width:900px">
      <h3 style="color:#fff;font-family:'Fredoka One',cursive;margin-bottom:10px;">
        Top Matches
      </h3>
      <div style="border:1px solid #22d3ee;border-radius:14px;padding:12px;">
        ${top.map(r => `
          <div style="display:flex;justify-content:space-between;color:#fff;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.1)">
            <span>${r.role}</span><strong>${r.pct}%</strong>
          </div>
        `).join("")}
      </div>
    </div>
  `;
}

/* ===================================
 * 6) Hook the file input to compute results immediately after upload
 *    (keeps your “Download PDF” flow working — exporter will reuse IKA_lastResults)
 * =================================== */
(function bindIKAnalysis() {
  const fileEl = document.getElementById("ikaFile");
  const previewEl = document.getElementById("ikaResults"); // optional container

  if (!fileEl) return;
  fileEl.addEventListener("change", async () => {
    const f = fileEl.files && fileEl.files[0];
    if (!f) return;
    try {
      const raw = JSON.parse(await f.text());
      const results = window.IKA_scoreRoles(raw);
      renderPreview(previewEl, results);
      console.log("[IKA] scored", results);
    } catch (e) {
      console.error("[IKA] Bad survey JSON:", e);
      alert("Could not read that JSON file. Please export the survey data and try again.");
    }
  });
})();
</script>
</body>).
It replaces any broken/conflicted code that was printing JavaScript on the page. -->

<!-- Individual Kink Analysis — compact, centered UI -->
<div class="ika-container">
  <h1 class="ika-title">Individual Kink Analysis</h1>
  <p class="ika-instructions">
    Upload your survey data and generate a personal PDF report.
  </p>

  <!-- Upload (keeps the same input id expected by your JS) -->
  <label for="ikaFile" class="ika-btn">Upload Survey</label>
  <input id="ikaFile" type="file" accept="application/json" style="display:none" />

  <!-- Download (keeps the same button id expected by your JS) -->
  <button id="downloadPdfBtn" class="ika-btn">Download PDF</button>

  <!-- Optional: where you render preview/results -->
  <div id="ikaResults"></div>
</div>

<style>
/* ===== Compact layout & typography (dark theme friendly) ===== */
.ika-container{
  max-width: 640px;          /* narrower content */
  margin: 40px auto;         /* centered on page */
  padding: 0 20px;
  text-align: center;
}

.ika-title{
  font-family: 'Fredoka One', cursive, system-ui, -apple-system, sans-serif;
  font-size: 2rem;           /* smaller title */
  line-height: 1.2;
  margin: 0 0 8px 0;
  color: #22d3ee;            /* cyan to match theme */
}

.ika-instructions{
  font-family: 'Fredoka One', cursive, system-ui, -apple-system, sans-serif;
  font-size: 1rem;
  color: #fff;
  margin: 0 0 22px 0;
}

/* Buttons: consistent look, slightly smaller */
.ika-btn{
  display: block;
  width: 100%;
  max-width: 320px;
  margin: 12px auto;
  padding: 12px 18px;
  border-radius: 12px;
  border: 2px solid #22d3ee;
  background: transparent;
  color: #fff;
  font-family: 'Fredoka One', cursive, system-ui, -apple-system, sans-serif;
  font-size: 1rem;
  cursor: pointer;
  transition: background .15s ease, transform .03s ease;
}
.ika-btn:hover{ background: rgba(34,211,238,.16); }
.ika-btn:active{ transform: translateY(1px); }

/* Rendered results section */
#ikaResults{
  margin-top: 16px;
  text-align: left;
  font-family: Inter, system-ui, -apple-system, sans-serif;
  color: #e5e7eb;
  font-size: .95rem;
  line-height: 1.5;
}

label[for="ikaFile"]{ user-select: none; }
</style>

<!-- ✅ FIX: Define the scoring engine BEFORE the PDF exporter on /individualkinkanalysis.html
Place this <script> block ABOVE your exporter. It provides:
  • window.BANK
  • window.IKA__scoreRoles  (and alias window.IKA_scoreRoles)
  • wires #ikaFile to compute and cache window.IKA__lastResults
If this block loads first, the exporter will stop throwing:
“Scoring engine not found …”. -->

<script>
(function () {
  // If a scoring engine is already present, do nothing.
  if (typeof window.IKA__scoreRoles === "function" && window.BANK) return;

  /* ----------------------------- ROLE KEYWORD BANK ----------------------------- */
  window.BANK = {
    "Dominant": ["dominant","dom ","being in control","take control","giving orders","command"],
    "Submissive": ["submissive","sub ","following orders","obedience","serve","serving"],
    "Switch": ["switch","both dom and sub","either role"],

    "Bedroom Dom": ["bedroom dom","taking the lead in bed","lead in the bedroom"],
    "Bedroom Submissive": ["bedroom sub","being led in bed","led in the bedroom"],
    "service submissive": ["service submissive","service sub","service tasks","acts of service"],
    "service slave": ["service slave","slave tasks","household service","protocol service"],
    "Service Top": ["service top","service giver","providing service (top)"],
    "Service Switch": ["service switch"],

    "Brat": ["brat","bratting","playfully disobey"],
    "Brat Tamer": ["brat tamer","taming brats","tame a brat"],
    "Brat Enabler": ["brat enabler","encourage bratting","enable brats"],
    "Brat Handler": ["brat handler","handling brats"],

    "Caregiver": ["caregiver","cg/l","caretaker","aftercare giver","nurture"],
    "little": ["little","age regression","cgl","little space","coloring","stuffies"],
    "Ageplayer": ["ageplay","age player","roleplay age","playing younger"],
    "Age Regressor": ["age regress","regression","little space (non sexual)"],

    "Degrader": ["degrade","insulting","humiliat","call them names"],
    "degradee": ["being degraded","being insulted","being humiliated"],

    "Exhibitionist": ["exhibition","public","being watched","in public"],
    "Voyeur": ["voyeur","watching others","watch them"],

    "Pet": ["pet play","petplay","puppy","kitten","pet role"],
    "Master": ["master","owner (person)","owning a slave"],
    "Slave": ["slave","being owned","total power exchange"],

    "Primal Predator": ["primal predator","hunt partner","predator energy"],
    "Primal Prey": ["primal prey","being hunted","prey energy"],
    "Primal Switch": ["primal switch"],
    "Primal Sadist": ["primal sadist","rough primal hurting"],
    "Primal Sadomasochist": ["primal sadomasochist"],

    "Impact Top": ["spank","impact top","paddle","flogging","caning","whip (impact)"],
    "Impact Bottom": ["spanked","impact bottom","taking impact","receive impact"],
    "Impact Switch": ["impact switch"],

    "Rope Top": ["rope top","rigger","tying rope","shibari"],
    "Rope Bottom": ["rope bottom","rope bunny","being tied"],
    "Rope Switch": ["rope switch"],
    "Bondage Top": ["bondage top","restrain","tie them"],
    "Bondage Bottom": ["bondage bottom","being restrained","being tied"],
    "Bondage Switch": ["bondage switch"],

    "Sadist": ["sadist","enjoy hurting (consensual)","inflict pain"],
    "Masochist": ["masochist","enjoy pain","receiving pain"],
    "Emotional Sadist": ["emotional sadist","emotional pain play"],
    "Emotional Masochist": ["emotional masochist","emotional pain received"],
    "Emotional Sadomasochist": ["emotional sadomasochist"],
    "Intellectual Sadist": ["intellectual sadist","mind games"],
    "Intellectual Sadomasochist": ["intellectual sadomasochist"],

    "Edge Player": ["edge play","knife play","breath control","risky consensual"],
    "Electro Top": ["electro top","estim","violet wand (top)"],
    "Electro Bottom": ["electro bottom","estim on me","violet wand on me"],
    "Needle Top": ["needle top","play piercing","needles (top)"],
    "Needle Bottom": ["needle bottom","being pierced","needles (bottom)"],
    "Needle Switch": ["needle switch"],
    "Fire Top": ["fire top","fire cupping","fire play (top)"],
    "Fire Bottom": ["fire bottom","fire cupping on me","fire play (bottom)"],
    "Fire Switch": ["fire switch"],

    "Watersports Top": ["watersports top","pee on someone","urination (top)"],
    "Watersports Bottom": ["watersports bottom","being peed on","urination (bottom)"],
    "Watersports Switch": ["watersports switch"],

    "Hypno Top": ["hypnosis top","hypno top","trance top"],
    "hypno bottom": ["hypnosis bottom","hypno bottom","trance bottom"],

    "Latex Top": ["latex top","latex dominator"],
    "Latex Bottom": ["latex bottom","wear latex (bottom)"],
    "Latex Switch": ["latex switch"],
    "Leather Top": ["leather top","old guard top","leather daddy"],
    "Leather bottom": ["leather bottom","wear leather (bottom)"],

    "Sir": ["call me sir","sir "],
    "Daddy Dom": ["daddy dom","daddy","mommy domme"],
    "Prince": ["prince role"],
    "Princess": ["princess role"],
    "Domme": ["domme","female dom"],

    "Pleasure Dom": ["pleasure dom","focus on partner pleasure (dom)"],
    "Pleasure Sadist": ["pleasure sadist"],
    "Cock Worshipper": ["cock worship","worship cock"],
    "Cum Slut": ["cum slut","covered in cum"],
    "Cum Princess": ["cum princess","cum focused"],

    "Foot Top": ["foot top","foot worship (giving)"],
    "Foot Bottom": ["foot bottom","foot worship (receiving)"],
    "Foot Switch": ["foot switch"],
    "Fisting Top": ["fisting top","fist someone"],
    "Fisting Bottom": ["fisting bottom","take a fist"],

    "Experimentalist": ["experiment","try anything once","new kinks"]
  };

  /* --------------------------- SCORING IMPLEMENTATION --------------------------- */
  function normalizeAnswers(raw) {
    // → [{ text, score }] with scores clamped 0..5
    let list = [];
    if (Array.isArray(raw)) {
      list = raw.map(a => ({
        text: String(a?.question ?? a?.q ?? a?.text ?? a?.label ?? "").trim(),
        score: Number(a?.score ?? a?.value ?? a?.answer ?? a?.rating ?? 0)
      }));
    } else if (raw && typeof raw === "object") {
      const maybe = raw.answers ?? raw;
      if (Array.isArray(maybe)) {
        list = maybe.map(a => ({
          text: String(a?.question ?? a?.q ?? a?.text ?? a?.label ?? "").trim(),
          score: Number(a?.score ?? a?.value ?? a?.answer ?? a?.rating ?? 0)
        }));
      } else {
        list = Object.entries(maybe).map(([k,v]) => ({ text: String(k).trim(), score: Number(v ?? 0) }));
      }
    }
    for (const a of list) {
      if (!Number.isFinite(a.score)) a.score = 0;
      a.score = Math.max(0, Math.min(5, a.score));
    }
    return list;
  }

  window.IKA__scoreRoles = function IKA__scoreRoles(answers, BANK) {
    const list = normalizeAnswers(answers);
    const roles = Object.keys(BANK || {});
    const compiled = {};
    for (const r of roles) compiled[r] = (BANK[r]||[]).map(kw => new RegExp(String(kw).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), "i"));

    const totals = {}, maxes = {};
    for (const r of roles) { totals[r]=0; maxes[r]=0; }

    for (const a of list) {
      const t = (a.text||"").toLowerCase();
      for (const r of roles) {
        const hit = compiled[r].some(rx => rx.test(t));
        if (hit) { totals[r]+=a.score; maxes[r]+=5; }
      }
    }
    const out = roles.map(r => ({
      role: r,
      pct: maxes[r] ? Math.round(100 * (totals[r]/maxes[r])) : 0,
      total: totals[r], max: maxes[r]
    })).sort((a,b)=> b.pct - a.pct || a.role.localeCompare(b.role));
    return out;
  };

  // Back-compat alias for exporters that look for IKA_scoreRoles
  window.IKA_scoreRoles = window.IKA__scoreRoles;

  /* ------------------------------ FILE INTEGRATION ------------------------------ */
  function wireUpload() {
    const file = document.getElementById("ikaFile");
    if (!file) return;
    file.addEventListener("change", async () => {
      try {
        const f = file.files && file.files[0];
        if (!f) return;
        const raw = JSON.parse(await f.text());
        const answers = raw?.answers ?? raw;
        const results = window.IKA__scoreRoles(answers, window.BANK);
        window.IKA__lastResults = results;
        console.log("[IKA] Scored", results.length, "roles; cached in window.IKA__lastResults.");
        
      } catch (e) {
        console.error("[IKA] Could not score file:", e);
        alert("Could not read that JSON. Please export your survey and try again.");
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wireUpload);
  } else {
    wireUpload();
  }
})();
</script>
<script>
(() => {
  const LOG = (...a) => console.log("[IKA-PDF]", ...a);
  const $  = (sel) => document.querySelector(sel);

  /* ------------------- loader helpers ------------------- */
  function loadScript(src){
    return new Promise((res, rej) => {
      if (document.querySelector(`script[src="${src}"]`)) return res();
      const s = document.createElement("script");
      s.src = src;
      s.onload = res;
      s.onerror = () => rej(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  async function ensureLibs(){
    // jsPDF UMD
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
    // AutoTable (works with UMD)
    if (!((window.jspdf && window.jspdf.autoTable) ||
          (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable))) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* ------------- get role scores for PDF output ------------- */
  async function getResultsForPdf(){
    // 1) If your renderer already set results:
    if (Array.isArray(window.IKA__lastResults) && window.IKA__lastResults.length) {
      return window.IKA__lastResults;
    }
    // 2) Try from uploaded file using your scoring engine (if present)
    const fileEl = $("#ikaFile");
    if (!(fileEl && fileEl.files && fileEl.files[0])) {
      throw new Error("No results in memory and no file selected. Upload your survey JSON first.");
    }
    if (typeof window.IKA__scoreRoles !== "function" || !window.BANK) {
      throw new Error("Scoring engine not found. Make sure the Individual Kink Analysis scoring script loads before this exporter.");
    }
    const raw = JSON.parse(await fileEl.files[0].text());
    const answers = raw.answers || raw;       // tolerate either structure
    const results = window.IKA__scoreRoles(answers, window.BANK); // [{role, pct}, ...]
    window.IKA__lastResults = results;        // cache for later
    return results;
  }

  /* ------------------- PDF Export (dark) ------------------- */
  async function exportPDF(){
    try {
      await ensureLibs();
      const { jsPDF } = window.jspdf;
      const rows = await getResultsForPdf();
      if (!rows || !rows.length) throw new Error("No role results to export.");

      // Defensive sort: highest % first
      rows.sort((a,b) => (b.pct ?? 0) - (a.pct ?? 0));

      const doc = new jsPDF({ orientation:"portrait", unit:"pt", format:"letter" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const paintBg = () => { doc.setFillColor(0,0,0); doc.rect(0,0,pageW,pageH,"F"); doc.setTextColor(255,255,255); };
      paintBg();

      // Title
      doc.setFontSize(28);
      doc.text("Individual Kink Analysis", pageW/2, 60, { align:"center" });
      doc.setFontSize(12);
      doc.text(new Date().toLocaleString(), pageW/2, 80, { align:"center" });

      // Build table body
      const body = rows.map((r, idx) => [String(idx+1), String(r.role || r.name || "—"), `${Math.round(r.pct ?? 0)}%`]);

      // AutoTable
      const marginLR = 40;
      const usableW  = pageW - marginLR*2;
      doc.autoTable({
        head: [["Rank","Role","%"]],
        body,
        startY: 110,
        margin: { left: marginLR, right: marginLR, top: 110, bottom: 40 },
        tableWidth: usableW,
        styles: {
          fontSize: 11,
          cellPadding: 6,
          textColor: [255,255,255],
          fillColor: [0,0,0],
          lineColor: [255,255,255],
          lineWidth: 1.2,
          halign: "left",
          overflow: "linebreak",
        },
        headStyles: {
          fillColor: [0,0,0],
          textColor: [255,255,255],
          fontStyle: "bold",
          lineColor: [255,255,255],
          lineWidth: 1.6,
          halign: "center",
        },
        columnStyles: {
          0: { cellWidth: 60,  halign: "center" },       // Rank
          1: { cellWidth: usableW - 160, halign: "left" }, // Role
          2: { cellWidth: 100, halign: "center" },        // %
        },
        willDrawPage: paintBg
      });

      doc.save("individual-kink-analysis.pdf");
      LOG("Saved individual-kink-analysis.pdf");
    } catch (err) {
      console.error("[IKA-PDF] Export failed:", err);
      alert("PDF export failed: " + (err?.message || err));
    }
  }

  /* ------------------- wire up UI ------------------- */
  function bind(){
    const label = document.querySelector('label[for="ikaFile"]');
    const file  = $("#ikaFile");
    const btn   = $("#downloadPdfBtn");
    // Clicking the label opens the file picker (native behavior).
    if (file) file.addEventListener("change", () => LOG("Survey selected:", file.files?.[0]?.name || "(none)"));
    if (btn)  btn.addEventListener("click", (e) => { e.preventDefault(); exportPDF(); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bind, { once:true });
  } else {
    bind();
  }
})();
</script>

<!--
INDIVIDUAL KINK ANALYSIS — QUESTION→ROLE MAPPING + SCORING (drop-in)
Paste this WHOLE block near the end of /individualkinkanalysis.html (right before </body>).

What you get
- A clean, explicit “question → role(s)” mapping template (with weights).
- A robust scoring engine that:
    • reads your uploaded JSON (various shapes supported),
    • converts Likert text to numbers (e.g., “Strongly agree” → 5),
    • totals weighted points per role,
    • returns normalized percentages (0–100%),
    • stores results in window.IKA_lastResults (so your PDF exporter can consume them).
- Minimal UI glue to render a quick preview list (optional) and keep your Download PDF flow working.

HOW TO USE
1) Paste this script.
2) Fill out IKA_ROLE_MAP with your survey’s question IDs (or unique question text) and the roles they influence.
   - Use the provided role catalog so names are consistent.
   - Each mapping entry supports one or more roles with weights (default 1).
3) Upload a survey JSON on the page and click “Download PDF” as usual.
   - Your existing PDF exporter that calls window.IKA_scoreRoles(...) will now get real percentages.

Tip: Start with 10–20 key questions, then expand the map over time. The engine auto-normalizes by total possible points, so different numbers of mappings still yield proper 0–100%.

----------------------------------------------------------------------->
<script>
/* =========================
 * 1) Role catalog (canonical names)
 * ========================= */
window.IKA_ROLES = [
  // Core dynamics
  "Dominant","Submissive","Switch",

  // Bedroom dynamics
  "Bedroom Dom","Bedroom Submissive","Bottom",
  "Dom-Leaning Switch","Bottom-Leaning Switch","Service Top","Service Switch",
  "Service Submissive","Service Slave","Master","Slave","Owner","Sir","Prince","Princess",

  // Brat ecosystem
  "Brat","Brat Tamer","Brat Enabler","Brat Handler",

  // Primal / predator–prey
  "Primal Predator","Primal Prey","Primal Switch",
  "Primal Sadist","Primal Sadomasochist",

  // Impact / pain
  "Impact Top","Impact Bottom","Impact Switch",
  "Sadist","Emotional Sadist","Intellectual Sadist","Emotional Masochist",
  "Emotional Sadomasochist",

  // Bondage / rope
  "Bondage Top","Bondage Bottom","Bondage Switch",
  "Rope Top","Rope Bottom","Rope Switch",

  // Sensation & specialties
  "Electro Top","Hypno Top","Hypno Bottom","Fire Top","Fire Bottom","Fire Switch",
  "Needle Top","Needle Bottom","Needle Switch",
  "Fisting Top","Fisting Bottom",

  // Fetish families
  "Foot Top","Foot Bottom","Foot Switch",
  "Latex Top","Latex Bottom","Latex Switch",
  "Leather Top","Leather Bottom",

  // Fluids / body play
  "Watersports Top","Watersports Bottom","Watersports Switch",
  "Cum Princess","Cum Slut","Cock Worshipper",

  // Relationship / scene attitudes
  "Experimentalist","Voyeur","Exhibitionist","Non-monogamist","Vanilla",
  "Cuckold","Edge Player","Pleasure Dom","Pleasure Sadist",

  // Pet/age roles
  "Pet","Caregiver","Ageplayer","Age Regressor","Little",

  // Rope bunny (commonly used)
  "Rope bunny"
];

/* ==========================================================
 * 2) QUESTION → ROLE MAP (THIS IS WHAT YOU CUSTOMIZE)
 *    Map either by stable question id OR by a unique substring
 *    of the question text (engine will match either).
 *    weight: how strongly this question contributes to the role.
 *    Multiple roles per question supported.
 * ========================================================== */
window.IKA_ROLE_MAP = [
  /* EXAMPLES — replace "Qxx" or "textIncludes" with YOUR survey’s keys/texts */

  // Submissive & Service Submissive
  { id: "Q12", roles: [{name:"Submissive", weight:1.0}, {name:"Service Submissive", weight:0.6}] },
  { textIncludes: "Following rules or protocol", roles: [{name:"Submissive", weight:0.8}] },

  // Dominant
  { id: "Q07", roles: [{name:"Dominant", weight:1.0}] },
  { textIncludes: "I enjoy being in charge", roles: [{name:"Dominant", weight:0.9}] },

  // Brat & Brat Tamer
  { textIncludes: "I like to playfully resist", roles: [{name:"Brat", weight:1.0}] },
  { textIncludes: "I enjoy taming brats", roles: [{name:"Brat Tamer", weight:1.0}] },

  // Impact
  { id: "Q21", roles: [{name:"Impact Top", weight:1.0}] },
  { textIncludes: "spanking or paddling", roles: [{name:"Impact Bottom", weight:1.0}] },

  // Rope / bondage
  { textIncludes: "being tied", roles: [{name:"Rope Bottom", weight:1.0},{name:"Bondage Bottom", weight:0.7}] },
  { textIncludes: "tying others", roles: [{name:"Rope Top", weight:1.0},{name:"Bondage Top", weight:0.7}] },

  // Primal
  { textIncludes: "predator", roles: [{name:"Primal Predator", weight:1.0}] },
  { textIncludes: "prey", roles: [{name:"Primal Prey", weight:1.0}] },

  // Fetish examples
  { textIncludes: "feet", roles: [{name:"Foot Bottom", weight:1.0}] },
  { textIncludes: "latex", roles: [{name:"Latex Bottom", weight:1.0}] },
  { textIncludes: "leather", roles: [{name:"Leather Bottom", weight:1.0}] },

  // Exhibition/Voyeur
  { textIncludes: "being watched", roles: [{name:"Exhibitionist", weight:1.0}] },
  { textIncludes: "watching others", roles: [{name:"Voyeur", weight:1.0}] },

  // Pet/age dynamics
  { textIncludes: "pet play", roles: [{name:"Pet", weight:1.0}] },
  { textIncludes: "age regress", roles: [{name:"Age Regressor", weight:1.0}] },
  { textIncludes: "caregiver", roles: [{name:"Caregiver", weight:1.0}] },

  // Vanilla / Experimentalist
  { textIncludes: "I prefer gentle, non-kinky", roles: [{name:"Vanilla", weight:1.0}] },
  { textIncludes: "I love trying new kinks", roles: [{name:"Experimentalist", weight:1.0}] },
];

/* Optional: Likert text → number (edit to match your survey) */
const IKA_LIKERT = {
  "strongly disagree": 1, "disagree": 2, "neutral": 3, "agree": 4, "strongly agree": 5,
  "never": 1, "rarely": 2, "sometimes": 3, "often": 4, "always": 5
};

/* ===================================
 * 3) Survey extraction helpers
 *    We support several JSON shapes:
 *    A) { answers: [{id:"Q1", value: 1..5|text, question:"..."}, ...] }
 *    B) { answers: { Q1: 1..5|text, ... }, questions: {Q1:"..."} }
 *    C) Any flat array of {question|label|text, value}
 * =================================== */
function toNumberLike(v) {
  if (v == null) return null;
  if (typeof v === "number") return v;
  const s = String(v).trim().toLowerCase();
  // direct number in string
  const n = Number(s);
  if (Number.isFinite(n)) return n;
  // Likert mapping
  if (IKA_LIKERT[s] != null) return IKA_LIKERT[s];
  // pull digits if present (e.g., "5 - strongly agree")
  const m = s.match(/(-?\d+(\.\d+)?)/);
  if (m) return Number(m[1]);
  return null; // not parseable
}

function extractAnswers(raw) {
  const out = []; // [{id, text, value}]
  if (!raw) return out;

  // A) array of answers
  if (Array.isArray(raw.answers)) {
    for (const a of raw.answers) {
      const id = a.id ?? a.qid ?? a.key ?? null;
      const text = a.question ?? a.label ?? a.text ?? "";
      const value = toNumberLike(a.value ?? a.answer ?? a.score);
      if (id || text) out.push({ id, text, value });
    }
    return out;
  }

  // B) map answers + questions
  if (raw.answers && typeof raw.answers === "object") {
    const qmap = raw.questions || {};
    for (const k of Object.keys(raw.answers)) {
      const id = k;
      const text = qmap[k] ?? "";
      const value = toNumberLike(raw.answers[k]);
      out.push({ id, text, value });
    }
    return out;
  }

  // C) flat array
  if (Array.isArray(raw)) {
    for (const a of raw) {
      const id = a.id ?? a.qid ?? a.key ?? null;
      const text = a.question ?? a.label ?? a.text ?? "";
      const value = toNumberLike(a.value ?? a.answer ?? a.score);
      if (id || text) out.push({ id, text, value });
    }
    return out;
  }

  return out;
}

/* ===================================
 * 4) Scoring engine (exported)
 * =================================== */
window.IKA_scoreRoles = function scoreRoles(rawSurvey, opts = {}) {
  const answers = extractAnswers(rawSurvey);
  const byId = new Map();
  const byText = [];
  for (const a of answers) {
    if (a.id) byId.set(String(a.id).trim(), a);
    if (a.text) byText.push(a);
  }

  // init accumulators
  const acc = new Map();    // role → actual points
  const maxAcc = new Map(); // role → max possible points (weight * 5)

  function bump(role, pts, maxPts) {
    acc.set(role, (acc.get(role) || 0) + pts);
    maxAcc.set(role, (maxAcc.get(role) || 0) + maxPts);
  }

  for (const rule of window.IKA_ROLE_MAP) {
    const weightRoles = (rule.roles || []).map(r => ({ name: r.name, w: r.weight ?? 1 }));
    if (weightRoles.length === 0) continue;

    // find a matching answer
    let a = null;

    // prefer id
    if (rule.id && byId.has(String(rule.id).trim())) {
      a = byId.get(String(rule.id).trim());
    }

    // else, try unique substring match
    if (!a && rule.textIncludes) {
      const needle = String(rule.textIncludes).toLowerCase();
      a = byText.find(x => (x.text || "").toLowerCase().includes(needle));
    }

    // if no answer found, still add to max (user could score up to 5)
    const v = a ? (a.value ?? null) : null;
    const val = (v == null ? null : Math.max(1, Math.min(5, Number(v)))); // clamp 1..5 if provided
    for (const { name, w } of weightRoles) {
      // Always grow the denominator by 5 * weight (so % stays comparable).
      bump(name, (val ? val * w : 0), 5 * w);
    }
  }

  // Convert to sorted result list
  const results = [];
  const catalog = new Set(window.IKA_ROLES);
  // Include only roles we actually mapped or that received any max points
  for (const [role, maxPts] of maxAcc.entries()) {
    const pts = acc.get(role) || 0;
    const pct = maxPts > 0 ? Math.round((pts / maxPts) * 100) : 0;
    results.push({ role, pct, points: pts, max: maxPts });
    // In case role wasn’t in the catalog, keep it anyway (mapping is source of truth)
    catalog.add(role);
  }

  results.sort((a, b) => b.pct - a.pct || a.role.localeCompare(b.role));
  window.IKA_lastResults = results; // let the PDF exporter consume it
  return results;
};

/* ===================================
 * 5) Small preview renderer (optional)
 * =================================== */
function renderPreview(targetEl, results) {
  if (!targetEl) return;
  if (!results || !results.length) { targetEl.innerHTML = ""; return; }
  const top = results.slice(0, 10);
  targetEl.innerHTML = `
    <div style="margin:20px auto;max-width:900px">
      <h3 style="color:#fff;font-family:'Fredoka One',cursive;margin-bottom:10px;">
        Top Matches
      </h3>
      <div style="border:1px solid #22d3ee;border-radius:14px;padding:12px;">
        ${top.map(r => `
          <div style="display:flex;justify-content:space-between;color:#fff;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.1)">
            <span>${r.role}</span><strong>${r.pct}%</strong>
          </div>
        `).join("")}
      </div>
    </div>
  `;
}

/* ===================================
 * 6) Hook the file input to compute results immediately after upload
 *    (keeps your “Download PDF” flow working — exporter will reuse IKA_lastResults)
 * =================================== */
(function bindIKAnalysis() {
  const fileEl = document.getElementById("ikaFile");
  const previewEl = document.getElementById("ikaResults"); // optional container

  if (!fileEl) return;
  fileEl.addEventListener("change", async () => {
    const f = fileEl.files && fileEl.files[0];
    if (!f) return;
    try {
      const raw = JSON.parse(await f.text());
      const results = window.IKA_scoreRoles(raw);
      renderPreview(previewEl, results);
      console.log("[IKA] scored", results);
    } catch (e) {
      console.error("[IKA] Bad survey JSON:", e);
      alert("Could not read that JSON file. Please export the survey data and try again.");
    }
  });
})();
</script>
</body>
</html>
