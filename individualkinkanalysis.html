<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Individual Kink Analysis</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=EB+Garamond&display=swap" rel="stylesheet">
</head>
<body class="theme-dark">

<!-- ✅ INDIVIDUAL KINK ANALYSIS — FIXED MARKUP + CENTERED CONTROLS + WORKING PDF EXPORT
Paste this whole block near the end of /individualkinkanalysis.html (right before </body>).
It replaces any broken/conflicted code that was printing JavaScript on the page. -->

<!-- UI (centered) -->
<style>
  .ika-wrap{max-width:1100px;margin:0 auto;padding:24px 16px;text-align:center}
  .ika-title{font-size:clamp(30px,5vw,64px);margin:8px 0 6px}
  .ika-instructions{font-size:clamp(16px,2.2vw,24px);opacity:.9;margin:0 0 28px}
  .ika-row{display:flex;flex-direction:column;gap:22px;align-items:center;justify-content:center}
  .ika-btn{display:inline-block;min-width:min(680px,85vw);padding:18px 28px;border-radius:18px;
           border:2px solid var(--accent,#00e6ff);background:transparent;color:#fff;
           font-weight:800;font-size:clamp(18px,2.6vw,32px);cursor:pointer}
  .ika-btn:hover{transform:translateY(-1px)}
  /* make label look like the other buttons */
  label.ika-btn{user-select:none}
  /* hide the real file input */
  #ikaFile{display:none}
</style>

<div class="ika-wrap">
  <h1 class="ika-title">Individual Kink Analysis</h1>
  <p class="ika-instructions">Upload your survey data and generate a personal PDF report.</p>

  <div class="ika-row">
    <!-- Upload (styled label drives the hidden file input) -->
    <label for="ikaFile" class="ika-btn">Upload Survey</label>
    <input id="ikaFile" type="file" accept="application/json">

    <!-- Download -->
    <button id="downloadPdfBtn" class="ika-btn">Download PDF</button>
  </div>

  <!-- Optional place your page renderer puts results; exporter will use it if present -->
  <div id="ikaResults" hidden></div>
</div>

<script>
(() => {
  const LOG = (...a) => console.log("[IKA-PDF]", ...a);
  const $  = (sel) => document.querySelector(sel);

  /* ------------------- loader helpers ------------------- */
  function loadScript(src){
    return new Promise((res, rej) => {
      if (document.querySelector(`script[src="${src}"]`)) return res();
      const s = document.createElement("script");
      s.src = src;
      s.onload = res;
      s.onerror = () => rej(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }
  async function ensureLibs(){
    // jsPDF UMD
    if (!(window.jspdf && window.jspdf.jsPDF)) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
    }
    // AutoTable (works with UMD)
    if (!((window.jspdf && window.jspdf.autoTable) ||
          (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable))) {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js");
    }
  }

  /* ------------- get role scores for PDF output ------------- */
  async function getResultsForPdf(){
    // 1) If your renderer already set results:
    if (Array.isArray(window.IKA__lastResults) && window.IKA__lastResults.length) {
      return window.IKA__lastResults;
    }
    // 2) Try from uploaded file using your scoring engine (if present)
    const fileEl = $("#ikaFile");
    if (!(fileEl && fileEl.files && fileEl.files[0])) {
      throw new Error("No results in memory and no file selected. Upload your survey JSON first.");
    }
    if (typeof window.IKA__scoreRoles !== "function" || !window.BANK) {
      throw new Error("Scoring engine not found. Make sure the Individual Kink Analysis scoring script loads before this exporter.");
    }
    const raw = JSON.parse(await fileEl.files[0].text());
    const answers = raw.answers || raw;       // tolerate either structure
    const results = window.IKA__scoreRoles(answers, window.BANK); // [{role, pct}, ...]
    window.IKA__lastResults = results;        // cache for later
    return results;
  }

  /* ------------------- PDF Export (dark) ------------------- */
  async function exportPDF(){
    try {
      await ensureLibs();
      const { jsPDF } = window.jspdf;
      const rows = await getResultsForPdf();
      if (!rows || !rows.length) throw new Error("No role results to export.");

      // Defensive sort: highest % first
      rows.sort((a,b) => (b.pct ?? 0) - (a.pct ?? 0));

      const doc = new jsPDF({ orientation:"portrait", unit:"pt", format:"letter" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const paintBg = () => { doc.setFillColor(0,0,0); doc.rect(0,0,pageW,pageH,"F"); doc.setTextColor(255,255,255); };
      paintBg();

      // Title
      doc.setFontSize(28);
      doc.text("Individual Kink Analysis", pageW/2, 60, { align:"center" });
      doc.setFontSize(12);
      doc.text(new Date().toLocaleString(), pageW/2, 80, { align:"center" });

      // Build table body
      const body = rows.map((r, idx) => [String(idx+1), String(r.role || r.name || "—"), `${Math.round(r.pct ?? 0)}%`]);

      // AutoTable
      const marginLR = 40;
      const usableW  = pageW - marginLR*2;
      doc.autoTable({
        head: [["Rank","Role","%"]],
        body,
        startY: 110,
        margin: { left: marginLR, right: marginLR, top: 110, bottom: 40 },
        tableWidth: usableW,
        styles: {
          fontSize: 11,
          cellPadding: 6,
          textColor: [255,255,255],
          fillColor: [0,0,0],
          lineColor: [255,255,255],
          lineWidth: 1.2,
          halign: "left",
          overflow: "linebreak",
        },
        headStyles: {
          fillColor: [0,0,0],
          textColor: [255,255,255],
          fontStyle: "bold",
          lineColor: [255,255,255],
          lineWidth: 1.6,
          halign: "center",
        },
        columnStyles: {
          0: { cellWidth: 60,  halign: "center" },       // Rank
          1: { cellWidth: usableW - 160, halign: "left" }, // Role
          2: { cellWidth: 100, halign: "center" },        // %
        },
        willDrawPage: paintBg
      });

      doc.save("individual-kink-analysis.pdf");
      LOG("Saved individual-kink-analysis.pdf");
    } catch (err) {
      console.error("[IKA-PDF] Export failed:", err);
      alert("PDF export failed: " + (err?.message || err));
    }
  }

  /* ------------------- wire up UI ------------------- */
  function bind(){
    const label = document.querySelector('label[for="ikaFile"]');
    const file  = $("#ikaFile");
    const btn   = $("#downloadPdfBtn");
    // Clicking the label opens the file picker (native behavior).
    if (file) file.addEventListener("change", () => LOG("Survey selected:", file.files?.[0]?.name || "(none)"));
    if (btn)  btn.addEventListener("click", (e) => { e.preventDefault(); exportPDF(); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bind, { once:true });
  } else {
    bind();
  }
})();
</script>

</body>
</html>
