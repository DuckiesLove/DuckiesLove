<!-- TK: Panel + Right-Rail Buttons -->
<style>
  :root {
    --tk-panel-width: clamp(680px, 74vw, 1080px);
    --tk-rail-gap: clamp(20px, 2.6vw, 32px);
    --tk-rail-maxw: 420px;
    --tk-rail-minw: 240px;
    --tk-cat-border: rgba(0, 229, 255, .55);
    --tk-cat-bg: rgba(0, 0, 0, .65);
    --tk-cat-bg-hover: rgba(0, 229, 255, .18);
  }

  /* --- Left survey panel sizing (¾ width) --- */
  #categorySurveyPanel,
  .category-panel,
  .tk-dock-card {
    max-width: var(--tk-panel-width);
    width: var(--tk-panel-width);
  }
  #categorySurveyPanel .panel,
  .category-panel .panel,
  .tk-dock-card .panel {
    width: 100%;
    max-width: 100%;
  }

  #categorySurveyPanel .category-list,
  .category-panel .category-list,
  #categorySurveyPanel #categoryList,
  .category-panel #categoryList {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(240px, 1fr));
    gap: clamp(12px, 2vw, 18px);
    padding: clamp(6px, 1vw, 10px) 0 clamp(6px, 1vw, 10px);
    margin: 0;
  }

  #categorySurveyPanel .category-list label,
  .category-panel .category-list label,
  #categorySurveyPanel #categoryList label,
  .category-panel #categoryList label {
    display: flex;
    align-items: center;
    gap: clamp(12px, 1.8vw, 16px);
    padding: clamp(12px, 1.6vw, 18px);
    border-radius: 16px;
    border: 2px solid var(--tk-cat-border);
    background: var(--tk-cat-bg);
    box-shadow: 0 0 0 1px rgba(0,229,255,.08) inset;
    font-weight: 700;
    letter-spacing: .2px;
    cursor: pointer;
    transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
  }

  #categorySurveyPanel .category-list label:hover,
  .category-panel .category-list label:hover,
  #categorySurveyPanel #categoryList label:hover,
  .category-panel #categoryList label:hover {
    transform: translateY(-1px);
    background: var(--tk-cat-bg-hover);
    box-shadow: 0 8px 20px rgba(0, 229, 255, .18);
  }

  #categorySurveyPanel .category-list input[type="checkbox"],
  .category-panel .category-list input[type="checkbox"],
  #categorySurveyPanel #categoryList input[type="checkbox"],
  .category-panel #categoryList input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: rgba(0,229,255,.95);
  }

  #categorySurveyPanel .category-list label span,
  .category-panel .category-list label span,
  #categorySurveyPanel #categoryList label span,
  .category-panel #categoryList label span {
    font-size: clamp(0.95rem, 1.9vw, 1.15rem);
    color: #ecffff;
  }

  @media (max-width: 980px) {
    #categorySurveyPanel .category-list,
    .category-panel .category-list,
    #categorySurveyPanel #categoryList,
    .category-panel #categoryList {
      grid-template-columns: 1fr;
    }
  }

  /* --- Right rail container --- */
  #tkRightRail {
    position: fixed;
    top: 28px;
    right: max(16px, env(safe-area-inset-right));
    z-index: 2147483647;
    display: flex;
    flex-direction: column;
    gap: 16px;
    width: clamp(var(--tk-rail-minw), calc(100vw - var(--tk-panel-width) - var(--tk-rail-gap)), var(--tk-rail-maxw));
    min-width: var(--tk-rail-minw);
    pointer-events: none; /* rail itself ignores clicks; buttons re-enable */
  }

  #tkRightRail .tk-card {
    pointer-events: auto;
    border: 2px solid #00e5ffcc;
    border-radius: 14px;
    padding: 18px 20px;
    background: rgba(0,0,0,.72);
    box-shadow: 0 10px 30px rgba(0,0,0,.45);
    backdrop-filter: blur(2px);
  }

  #tkRightRail .tk-heading {
    margin: 0 0 8px 0;
    font-weight: 700;
    font-size: 18px;
    color: #00e5ff;
  }

  #tkRightRail .tk-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #00e5ff;
    border-radius: 12px;
    background: #000;
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    text-decoration: none;
    transition: transform .06s ease, box-shadow .12s ease, background .12s ease;
    box-shadow: 0 4px 14px rgba(0,229,255,.15);
    cursor: pointer;
  }
  #tkRightRail .tk-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,229,255,.22); }
  #tkRightRail .tk-btn:active { transform: translateY(0); }

  /* keep rail clear of the panel on very small screens */
  @media (max-width: 980px) {
    :root { --tk-panel-width: 100vw; }
    #tkRightRail { display: none; } /* hide rail on small screens */
  }
</style>

<script>
(() => {
  const log = (...a) => console.log('[TK]', ...a);
  const gridSelectors = [
    '#categorySurveyPanel .category-list',
    '.category-panel .category-list',
    '#categorySurveyPanel #categoryList',
    '.category-panel #categoryList'
  ];
  const listFingerprints = new WeakMap();

  function normalizeLabelText(label) {
    return label?.textContent?.replace(/\s+/g, ' ').trim() || '';
  }

  function updateCounts(list) {
    const statusTargets = [
      document.getElementById('statusMsg'),
      document.getElementById('selectedCountBadge'),
      document.querySelector('[data-tk-cat-status]')
    ].filter(Boolean);
    if (!statusTargets.length) return;
    const boxes = Array.from(list.querySelectorAll('input[type="checkbox"]'));
    const total = boxes.length;
    const selected = boxes.filter(cb => cb.checked).length;
    const msg = `${selected} selected / ${total} total`;
    statusTargets.forEach(node => { node.textContent = msg; });
  }

  function wireSelectionUpdates(list) {
    if (!list || list.dataset.tkSelectionWired) return;
    list.dataset.tkSelectionWired = '1';
    list.addEventListener('change', () => updateCounts(list));

    const selectAllSelectors = ['#selectAll', '#btnSelectAll', '[data-action="select-all"]'];
    const deselectSelectors = ['#deselectAll', '#btnDeselectAll', '[data-action="deselect-all"]'];
    const afterToggle = () => requestAnimationFrame(() => updateCounts(list));
    selectAllSelectors
      .flatMap(sel => Array.from(document.querySelectorAll(sel)))
      .forEach(btn => btn.addEventListener('click', afterToggle));
    deselectSelectors
      .flatMap(sel => Array.from(document.querySelectorAll(sel)))
      .forEach(btn => btn.addEventListener('click', afterToggle));
  }

  function styleCategoryGrid() {
    const lists = gridSelectors
      .map(sel => Array.from(document.querySelectorAll(sel)))
      .flat();

    lists.forEach(list => {
      const labels = Array.from(list.querySelectorAll('label'));
      if (!labels.length) return;

      const fingerprint = labels.map(normalizeLabelText).join('|');
      if (listFingerprints.get(list) === fingerprint) {
        updateCounts(list);
        return;
      }
      listFingerprints.set(list, fingerprint);

      labels.sort((a, b) => normalizeLabelText(a).localeCompare(normalizeLabelText(b), 'en', { sensitivity: 'base' }));
      labels.forEach(label => {
        if (!label.dataset.tkCatStyled) {
          label.dataset.tkCatStyled = '1';
        }
        list.appendChild(label);
      });

      updateCounts(list);
      wireSelectionUpdates(list);
    });
  }

  function ensureRightRail() {
    if (document.getElementById('tkRightRail')) return;

    const rail = document.createElement('aside');
    rail.id = 'tkRightRail';
    rail.setAttribute('aria-label', 'Quick links');

    // Card 1: Individual Kink Analysis
    const card1 = document.createElement('div');
    card1.className = 'tk-card';
    card1.innerHTML = `
      <h3 class="tk-heading">Individual Kink Analysis</h3>
      <button type="button" class="tk-btn" id="tkBtnIndiv">Open Individual Kink Analysis</button>
    `;

    // Card 2: Compatibility Page
    const card2 = document.createElement('div');
    card2.className = 'tk-card';
    card2.innerHTML = `
      <h3 class="tk-heading">Compatibility Page</h3>
      <button type="button" class="tk-btn" id="tkBtnCompat">Open Compatibility Page</button>
    `;

    rail.append(card1, card2);
    document.body.appendChild(rail);

    // Wire buttons (use absolute URLs you requested)
    document.getElementById('tkBtnIndiv').onclick = () =>
      location.assign('https://talkkink.org/individualkinkanalysis.html');
    document.getElementById('tkBtnCompat').onclick = () =>
      location.assign('/compatibility.html');

    log('Right rail installed.');
  }

  function sizePanelToThreeQuarters() {
    // Try a few likely hosts for the panel
    const hosts = [
      document.getElementById('categorySurveyPanel'),
      document.querySelector('.category-panel'),
      document.querySelector('.tk-dock-card'),
    ].filter(Boolean);

    if (!hosts.length) {
      log('Panel host not found yet; will retry after load.');
      return;
    }

    // If the inner .panel exists, we size it; else size the host directly
    hosts.forEach(host => {
      const inner = host.querySelector('.panel') || host;
      inner.style.width = getComputedStyle(document.documentElement)
        .getPropertyValue('--tk-panel-width') || '74vw';
      inner.style.maxWidth = inner.style.width;
    });

    log('Panel set to ~¾ width.');
  }

  // Run after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      sizePanelToThreeQuarters();
      ensureRightRail();
      styleCategoryGrid();
    });
  } else {
    sizePanelToThreeQuarters();
    ensureRightRail();
    styleCategoryGrid();
  }

  // Also react if your app dynamically mounts the panel later
  const mo = new MutationObserver(() => {
    sizePanelToThreeQuarters();
    ensureRightRail();
    styleCategoryGrid();
  });
  mo.observe(document.documentElement, { subtree: true, childList: true });
})();
</script>
