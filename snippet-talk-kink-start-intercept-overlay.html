<!-- ========= TalkKink: Hard-stop navigation + overlay survey UI (final) ========= -->
<script>
(() => {
  const TK = { active:false };

  /* ---------- Hard navigation locks while our UI is active ---------- */
  const _pushState = history.pushState.bind(history);
  const _replaceState = history.replaceState.bind(history);

  function lockNavigation() {
    if (TK.navLocked) return;
    TK.navLocked = true;

    history.pushState = function(...a) {
      if (TK.active) { console.debug("[TK] blocked pushState"); return; }
      return _pushState(...a);
    };
    history.replaceState = function(...a) {
      if (TK.active) { console.debug("[TK] blocked replaceState"); return; }
      return _replaceState(...a);
    };

    // Block hash changes while active
    window.addEventListener("hashchange", (e) => {
      if (TK.active) { console.debug("[TK] blocked hashchange"); e.stopImmediatePropagation(); e.preventDefault(); history.replaceState(history.state, "", location.href); }
    }, true);

    // Block programmatic navigations
    const assign = Object.getOwnPropertyDescriptor(window.Location.prototype, "assign");
    const href   = Object.getOwnPropertyDescriptor(window.Location.prototype, "href");
    Object.defineProperty(window.location.__proto__, "assign", {
      configurable:true,
      value: function(url){ if (TK.active) { console.debug("[TK] blocked location.assign", url); return; } return assign.value.call(this, url); }
    });
    Object.defineProperty(window.location.__proto__, "href", {
      configurable:true,
      get: href.get,
      set: function(url){ if (TK.active) { console.debug("[TK] blocked location.href", url); return; } return href.set.call(this, url); }
    });

    // Block unload prompts while active
    window.addEventListener("beforeunload", (e) => { if (TK.active) { e.preventDefault(); e.returnValue=""; }}, true);
  }

  function unlockNavigation() {
    if (!TK.navLocked) return;
    history.pushState = _pushState;
    history.replaceState = _replaceState;
    TK.navLocked = false;
  }

  /* ---------- CSS + overlay ---------- */
  const CSS = `
  #tk-overlay{position:fixed;inset:0;z-index:2147483647;display:none}
  #tk-overlay.tk-show{display:block}
  #tk-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(1.1) blur(2px)}
  #tk-shell{position:relative;display:grid;grid-template-columns:1fr 340px;gap:16px;max-width:1200px;
    margin:40px auto;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.18);
    border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.5);padding:18px}
  #tk-center,#tk-right{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.14);
    border-radius:14px;padding:14px;min-height:320px}
  .tk-grid{display:grid;grid-template-columns:repeat(6,minmax(44px,1fr));gap:10px;margin-top:10px}
  .tk-opt{border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:10px 0;background:transparent;color:inherit;cursor:pointer}
  .tk-opt.selected{outline:2px solid currentColor}
  #tk-close{position:absolute;top:8px;right:10px;border:1px solid rgba(255,255,255,.2);background:transparent;color:inherit;border-radius:10px;padding:6px 10px;cursor:pointer}
  @media(max-width:1024px){#tk-shell{grid-template-columns:1fr}}
  `;
  if (!document.getElementById("tk-overlay-css")) {
    const s=document.createElement("style"); s.id="tk-overlay-css"; s.textContent=CSS; document.head.appendChild(s);
  }

  function ensureOverlay(){
    if (document.getElementById("tk-overlay")) return;
    const wrap=document.createElement("div");
    wrap.id="tk-overlay";
    wrap.innerHTML = `
      <div id="tk-backdrop"></div>
      <div id="tk-shell">
        <button id="tk-close" type="button" aria-label="Close">Close</button>
        <section id="tk-center">
          <div style="opacity:.8">Appearance Play • Choosing My Partner</div>
          <h2 style="margin:6px 0 10px">Giving: Rate interest/comfort (0–5)</h2>
          <div id="tk-guard" aria-live="polite"></div>
          <div id="tk-scale" class="tk-grid" data-group="rating-A"></div>
        </section>
        <aside id="tk-right">
          <h3>How to score</h3>
          <ul style="list-style:none;margin:0;padding:0;display:grid;gap:8px">
            <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
            <li><b>1</b> — Hard Limit (no-go)</li>
            <li><b>2</b> — Soft Limit (willing to try…)</li>
            <li><b>3</b> — Curious / context-dependent</li>
            <li><b>4</b> — Comfortable / enjoy</li>
            <li><b>5</b> — Favorite / enthusiastic yes</li>
          </ul>
          <div style="margin-top:12px;border-top:1px solid rgba(255,255,255,.14);padding-top:10px">
            <div>Rate interest/comfort (0–5)</div>
            <div id="tk-scale-sidebar" class="tk-grid" data-group="rating-A"></div>
          </div>
        </aside>
      </div>
    `;
    document.body.appendChild(wrap);

    // Close handlers
    const close = ()=>{ TK.active=false; unlockNavigation(); wrap.classList.remove("tk-show"); document.documentElement.style.overflow=""; };
    wrap.querySelector("#tk-close").addEventListener("click", close);
    wrap.querySelector("#tk-backdrop").addEventListener("click", close);

    // Reassert overlay if DOM tries to remove/empty it
    const mo = new MutationObserver(() => {
      const ov = document.getElementById("tk-overlay");
      if (TK.active && (!ov || !ov.classList.contains("tk-show"))) {
        ensureOverlay(); showOverlay(); // re-create fast
      }
    });
    mo.observe(document.body, { childList:true, subtree:true });
  }

  function makeScale(el, group="rating-A"){
    if(!el) return; el.innerHTML="";
    for(let i=0;i<=5;i++){
      const b=document.createElement("button");
      b.className="tk-opt"; b.type="button"; b.dataset.group=group; b.dataset.value=i;
      b.textContent=i; b.setAttribute("aria-pressed","false"); el.appendChild(b);
    }
  }
  function buildScales(){
    makeScale(document.getElementById("tk-scale"), "rating-A");
    makeScale(document.getElementById("tk-scale-sidebar"), "rating-A");
    if(!window.__tkScaleSync){
      window.__tkScaleSync=true;
      document.addEventListener("click",(e)=>{
        const btn=e.target.closest("button.tk-opt"); if(!btn) return;
        const group=btn.dataset.group, val=btn.dataset.value;
        document.querySelectorAll(`button.tk-opt[data-group="${group}"]`).forEach(b=>{
          const on=b.dataset.value===val;
          b.classList.toggle("selected",on);
          b.setAttribute("aria-pressed", on?"true":"false");
        });
        document.getElementById("tk-guard")?.replaceChildren(document.createTextNode(`Selected ${val} of 5`));
      });
    }
  }

  function hasAnyCategorySelected(){
    const checks=[...document.querySelectorAll('input[type="checkbox"], [role="checkbox"][aria-checked]')];
    return checks.some(cb => cb.checked || cb.getAttribute?.("aria-checked")==="true");
  }

  function showOverlay(){
    ensureOverlay();
    buildScales();
    const ov=document.getElementById("tk-overlay");
    TK.active=true;
    lockNavigation();
    ov.classList.add("tk-show");
    document.documentElement.style.overflow="hidden";
  }

  /* ---------- Capture Start clicks & block app handlers/navigation ---------- */
  function isStart(el){ return el && /start\s*survey/i.test((el.textContent||"").trim()); }

  function startCapture(e){
    const t = e.target.closest('button, a, [role="button"]');
    if(!t || !isStart(t)) return;
    // Require a category first
    if(!hasAnyCategorySelected()){
      e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
      const n=document.createElement("div");
      n.textContent="Pick at least one category to begin.";
      n.style.cssText="position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#222;border:1px solid rgba(255,255,255,.2);padding:10px 14px;border-radius:10px;z-index:2147483647";
      document.body.appendChild(n); setTimeout(()=>n.remove(),1600);
      return;
    }
    // Hard stop *all* site handlers and any navigation
    e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
    showOverlay();
  }

  ["click","mousedown","mouseup","touchstart","touchend"].forEach(ev=>{
    window.addEventListener(ev, startCapture, true);   // capture on window
    document.addEventListener(ev, startCapture, true); // and on document
    document.body.addEventListener(ev, startCapture, true);
  });

})();
</script>
<!-- ====================== /final ====================== -->
