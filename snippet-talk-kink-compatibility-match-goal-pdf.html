<!-- ‚ú® TalkKink Compatibility PDF Generator ‚Äì Landscape layout with summary tiles
   Instructions:
   1. Place this full block in your Codex editor.
   2. Call generateCompatibilityPDF(selfData, partnerData, comparisonRows) after both surveys are parsed.
   3. comparisonRows = [{ label, scoreA, scoreB, compatibility }]
   4. Requires jsPDF (and autoTable only if you extend it to use tables).
-->

<script>
function generateCompatibilityPDF(selfData, partnerData, comparison) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
  const pageWidth = doc.internal.pageSize.getWidth();

  const headerFont = "helvetica";
  const bodyFont = "helvetica";
  const headingColor = "#22d3ee";

  // Page Title
  doc.setFont(headerFont, "bold");
  doc.setFontSize(32);
  doc.setTextColor(headingColor);
  doc.text("TalkKink Compatibility", pageWidth / 2, 50, { align: "center" });

  // Timestamp
  const timestamp = new Date().toLocaleString();
  doc.setFontSize(12);
  doc.setTextColor("#ccc");
  doc.text(`Generated ${timestamp}`, pageWidth / 2, 70, { align: "center" });

  // Divider Line
  doc.setDrawColor(headingColor);
  doc.setLineWidth(2);
  doc.line(60, 80, pageWidth - 60, 80);

  // Summary Boxes
  const boxes = [
    { title: "Items Compared", value: comparison.length },
    { title: "Avg Match", value: `${comparison.length ? Math.round((comparison.reduce((sum, item) => sum + (item.compatibility || 0), 0) / comparison.length)) : 0}%` },
    { title: "80%+ Alignments", value: comparison.filter(c => c.compatibility >= 80).length }
  ];

  doc.setFont(bodyFont, "bold");
  doc.setFontSize(24);

  const boxWidth = 200;
  const boxHeight = 90;
  const boxSpacing = 40;
  const startX = (pageWidth - (boxWidth * boxes.length + boxSpacing * (boxes.length - 1))) / 2;
  let boxY = 100;

  boxes.forEach((box, i) => {
    const x = startX + i * (boxWidth + boxSpacing);
    const centerY = boxY + boxHeight / 2;
    doc.setFillColor("#111827");
    doc.rect(x, boxY, boxWidth, boxHeight, "F");
    doc.setTextColor(headingColor);
    doc.text(`${box.value}`, x + boxWidth / 2, centerY - 8, { align: "center" });
    doc.setFont(bodyFont, "normal");
    doc.setFontSize(14);
    doc.setTextColor("#ddd");
    doc.text(box.title, x + boxWidth / 2, centerY + 18, { align: "center" });
  });

  // Table
  const tableY = 230;
  const colWidths = [210, 90, 90, 90]; // Total width = 480
  const tableX = (pageWidth - colWidths.reduce((a, b) => a + b)) / 2;

  // Header Row
  doc.setFont(bodyFont, "bold");
  doc.setFontSize(16);
  doc.setTextColor(headingColor);

  const headers = ["Category", "Partner A", "Match", "Partner B"];
  let x = tableX;
  headers.forEach((h, i) => {
    doc.text(h, x + colWidths[i] / 2, tableY, { align: "center" });
    x += colWidths[i];
  });

  // Rows
  let y = tableY + 30;
  doc.setFont(bodyFont, "normal");
  doc.setFontSize(14);
  doc.setTextColor("#eee");

  comparison.forEach(item => {
    const category = shortenLabel(item.label || "", 30);
    const a = item.scoreA ?? "‚Äî";
    const b = item.scoreB ?? "‚Äî";

    let matchText = "‚Äî";
    if (typeof item.compatibility === "number") {
      matchText = `${item.compatibility}%`;
      if (item.compatibility >= 90) matchText += " ‚≠ê";
      if (item.compatibility <= 30) matchText += " üö©";
      if ((item.scoreA === 5 && item.scoreB !== 5) || (item.scoreB === 5 && item.scoreA !== 5)) matchText += " üü®";
    }

    const cells = [category, a, matchText, b];
    let x = tableX;

    cells.forEach((val, i) => {
      const align = i === 0 ? "left" : "center";
      const textX = i === 0 ? x + 5 : x + colWidths[i] / 2;
      doc.text(String(val), textX, y, { align });
      x += colWidths[i];
    });

    y += 24;
  });

  doc.save("TalkKink_Compatibility.pdf");

  function shortenLabel(text, maxLength) {
    if (!text) return "‚Äî";
    return text.length > maxLength ? text.slice(0, maxLength - 3) + "..." : text;
  }
}
</script>
