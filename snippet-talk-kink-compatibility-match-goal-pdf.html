<!-- ‚ú® TalkKink Compatibility PDF Generator ‚Äì Match Goal Layout
   Instructions:
   1. Place this full block in your Codex editor.
   2. Run generateCompatibilityPDF(selfData, partnerData) after both files are loaded and parsed.
   3. Requires jsPDF and jsPDF-AutoTable.
-->

<script>
function generateCompatibilityPDF(self, partner) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();

  // 1. Header
  doc.setFontSize(18);
  doc.text("TalkKink Compatibility Report", pageWidth / 2, 20, { align: 'center' });

  // 2. Timestamp
  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, 28, { align: 'center' });

  // 3. Compatibility Table Setup
  const categories = Object.keys(self.answers);
  const tableData = [];

  for (const key of categories) {
    const a = self.answers[key]?.value ?? "N/A";
    const b = partner.answers[key]?.value ?? "N/A";
    const match = typeof a === 'number' && typeof b === 'number'
      ? Math.round(100 - (Math.abs(a - b) * 20))
      : "N/A";

    // 4. Emoji Flags
    let flag = "";
    if (match >= 90) flag = "‚≠ê";
    else if (match <= 30) flag = "üö©";
    else if ((a === 5 || b === 5) && Math.abs(a - b) >= 1) flag = "üü®";

    const shortLabel = key.length > 28 ? key.slice(0, 25) + "‚Ä¶" : key;

    tableData.push([
      shortLabel,
      a,
      `${match}%`,
      flag,
      b
    ]);
  }

  // 5. Table Columns
  const columns = [
    { header: "Kink", dataKey: "label" },
    { header: "A", dataKey: "a" },
    { header: "Match", dataKey: "match" },
    { header: "", dataKey: "flag" },
    { header: "B", dataKey: "b" },
  ];

  // 6. Draw Table
  doc.autoTable({
    head: [columns.map(c => c.header)],
    body: tableData.map(row => ({
      label: row[0],
      a: row[1],
      match: row[2],
      flag: row[3],
      b: row[4]
    })),
    startY: 35,
    theme: "grid",
    styles: {
      fontSize: 10,
      cellPadding: 2,
      halign: "center"
    },
    headStyles: {
      fillColor: [30, 30, 30],
      textColor: 255
    },
    columnStyles: {
      label: { halign: "left" },
      a: { cellWidth: 10 },
      match: { cellWidth: 22 },
      flag: { cellWidth: 8 },
      b: { cellWidth: 10 }
    }
  });

  // 7. Save
  doc.save("talkkink-compatibility.pdf");
}

// 8. Example usage:
// generateCompatibilityPDF(tk_compat.self, tk_compat.partner);
</script>
