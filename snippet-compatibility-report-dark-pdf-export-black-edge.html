<!-- Force-takeover ultra full-bleed black PDF (no margins/padding/borders). Always asks consent. -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script>
/* 0) Disable all legacy paths that cause white borders */
try { window.print = () => console.warn('[patched] window.print() disabled'); } catch (e) {}
(function killOld() {
  const names = [
    'downloadCompatibilityPDF',
    'exportCompatibilityPDF',
    'makePDF',
    'createPDF',
    'saveReportPDF',
    'compatPDF',
    'exportPDF',
    'downloadPDF'
  ];
  names.forEach((n) => {
    try {
      delete window[n];
    } catch (_) {}
  });
})();

/* 1) Minimal consent (always ask) */
async function __tkConsent() {
  return confirm('Consent check:\nDo you have your partner\'s consent to export/share this PDF?');
}

/* 2) Final black-edge exporter */
async function __exportCompatPDF_vBlackEdge({
  filename = 'compatibility.pdf',
  columns = [
    { header: 'Category', dataKey: 'category' },
    { header: 'Partner A', dataKey: 'a' },
    { header: 'Match %', dataKey: 'm' },
    { header: 'Partner B', dataKey: 'b' }
  ],
  rows = []
} = {}) {
  if (!(await __tkConsent())) return;

  console.log('[patched] USING vBlackEdge');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'letter', compress: true, putOnlyUsedFonts: true });

  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const BLEED = 6; // paint beyond page to kill anti-alias rims

  const paint = () => {
    doc.setFillColor(0, 0, 0);
    doc.rect(-BLEED, -BLEED, W + BLEED * 2, H + BLEED * 2, 'F');
  };
  paint();
  doc.setTextColor(255, 255, 255);
  doc.setDrawColor(0, 0, 0);
  doc.setLineWidth(0);

  const head = [columns.map((c) => c.header ?? c.title ?? c)];
  const body = rows.map((r) =>
    columns.map((c) => {
      const k = c.dataKey ?? c.key ?? c;
      const v = r[k];
      return v === undefined || v === null || v === '' ? 'â€”' : String(v);
    })
  );

  doc.autoTable({
    head,
    body,
    startY: -BLEED,
    startX: -BLEED,
    tableWidth: W + BLEED * 2,
    margin: { top: 0, right: 0, bottom: 0, left: 0 },
    theme: 'plain',
    horizontalPageBreak: true,
    styles: {
      font: 'helvetica',
      fontSize: 10,
      textColor: [255, 255, 255],
      cellPadding: 0,
      lineWidth: 0,
      fillColor: null,
      overflow: 'linebreak',
      minCellHeight: 14
    },
    headStyles: {
      fontStyle: 'bold',
      textColor: [255, 255, 255],
      fillColor: null,
      cellPadding: 0,
      lineWidth: 0,
      minCellHeight: 16
    },
    tableLineWidth: 0,
    tableLineColor: [0, 0, 0],
    columnStyles: {
      0: { halign: 'left' },
      1: { halign: 'center' },
      2: { halign: 'center' },
      3: { halign: 'center' }
    },
    didParseCell(d) {
      d.cell.styles.fillColor = null;
      d.cell.styles.lineWidth = 0;
      d.cell.styles.lineColor = [0, 0, 0];
    },
    didAddPage() {
      paint();
      doc.setTextColor(255, 255, 255);
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0);
    }
  });

  doc.save(filename);
}

/* 3) HARD WIRE our exporter to every common name so existing buttons call this version */
(function takeover() {
  const fn = __exportCompatPDF_vBlackEdge;
  const names = [
    'downloadCompatibilityPDF',
    'exportCompatibilityPDF',
    'makePDF',
    'createPDF',
    'saveReportPDF',
    'compatPDF',
    'exportPDF',
    'downloadPDF'
  ];
  names.forEach((n) => {
    window[n] = fn;
  });
  window.exportCompatPDF_vBlackEdge = fn;
  console.log('[patched] PDF exporters wired:', names.join(', '));
})();
</script>
