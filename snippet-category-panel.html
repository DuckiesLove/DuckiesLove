<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TK Category Panel</title>
  <link rel="stylesheet" href="css/theme.css">
</head>
<body>
<!-- === TK Category Panel (drop-in block) ================================= -->
<section id="tk-category-panel" style="max-width:980px;">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin:12px 0 18px;">
    <h2 style="margin:0;font-weight:800;color:#17e5e5;letter-spacing:.2px">Select categories</h2>
    <div id="selectedCountBadge" style="opacity:.9">0 selected / 0 total</div>
  </header>

  <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:18px">
    <button id="btnSelectAll"   type="button" class="tk-btn">Select All</button>
    <button id="btnDeselectAll" type="button" class="tk-btn">Deselect All</button>
  </div>

  <!-- Where the category checkboxes will be rendered -->
  <div id="categoryChecklist" aria-live="polite"></div>

  <div style="display:flex;gap:14px;margin-top:22px">
    <button type="button" class="tk-btn tk-btn-ghost" onclick="history.back()">Close âœ•</button>
    <button type="button" class="tk-btn" id="tkStartSurvey">Start Survey</button>
  </div>
</section>

<!-- Optional light styles (uses your neon vibe and rounded cards) -->
<style>
  .tk-btn{
    padding:12px 18px;border:1px solid #088e8e;border-radius:12px;background:#0b0b0b;
    color:#fff;font-weight:800;letter-spacing:.2px;box-shadow:0 0 0 1px rgba(23,229,229,.25) inset;
  }
  .tk-btn:hover{ box-shadow:0 0 0 2px rgba(23,229,229,.45) inset; }
  .tk-btn-ghost{ background:#0a0a0a;border-color:#2a2a2a;box-shadow:none; }
  #tk-category-panel{ border:1px solid rgba(23,229,229,.6); border-radius:12px; padding:18px; }
  /* The checkbox rows are created by the script, but we style them here */
  #categoryChecklist label{
    display:flex;align-items:center;gap:12px;
    padding:11px 14px;border:1px solid #2a2a2a;border-radius:12px;background:#0a0a0a;cursor:pointer;
  }
  #categoryChecklist input[type="checkbox"]{ width:18px;height:18px; }
</style>

<script>
(() => {
  const SCRIPT_FLAG='__tkCategoryPanelBooted';
  if (window[SCRIPT_FLAG]) return; window[SCRIPT_FLAG]=true;

  // ðŸ”— Adjust if your data lives somewhere else:
  const DATA_URL='https://talkkink.org/data/kinks.json';
  const STORAGE_KEY='__TK_SELECTED_CATEGORIES';

  const host=document.getElementById('categoryChecklist');
  const badge=document.getElementById('selectedCountBadge');
  if(!host){ console.warn('[TK] Missing #categoryChecklist'); return; }

  // Default 2-column grid layout for items
  Object.assign(host.style,{display:'grid',gap:'12px',gridTemplateColumns:'repeat(2,minmax(0,1fr))'});

  const $  =(s,r=document)=>r.querySelector(s);
  const $$ =(s,r=document)=>Array.from(r.querySelectorAll(s));

  // Find the first plausible array of items in any reasonable shape
  function findItemArray(root,depth=6){
    if(!root||depth<0) return null;
    if(Array.isArray(root)){
      const ok=root.length&&root.every(i=>i&&typeof i==='object'&&('name'in i||'label'in i||'title'in i||'slug'in i));
      if(ok) return root;
    }
    if(typeof root==='object'){
      for(const k of ['items','categories','data','kinks','results','payload']){
        if(Array.isArray(root[k])){ const hit=findItemArray(root[k],depth-1); if(hit) return hit; }
      }
      for(const v of Object.values(root)){ const hit=findItemArray(v,depth-1); if(hit) return hit; }
    }
    return null;
  }

  function normalize(raw){
    const arr=findItemArray(raw) || (Array.isArray(raw)?raw:[]);
    const out=arr.map((it,i)=>{
      const id=it?.id??it?.value??it?.slug??it?.key??`item-${i}`;
      const name=it?.name??it?.label??it?.title??it?.slug??String(id);
      return {id:String(id),name:String(name)};
    });
    out.sort((a,b)=>a.name.localeCompare(b.name)); // alphabetical
    return out;
  }

  async function loadData(){
    if(Array.isArray(window.__TK_KINK_DATA)&&window.__TK_KINK_DATA.length) return window.__TK_KINK_DATA;
    try{
      const res=await fetch(DATA_URL,{cache:'no-store'});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const json=await res.json();
      const items=normalize(json);
      window.__TK_KINK_DATA=items;
      return items;
    }catch(e){ console.error('[TK] Failed to load categories:',e); return []; }
  }

  function updateBadge(){
    const total=$$('input[type="checkbox"]',host).length;
    const selected=$$('input[type="checkbox"]:checked',host).length;
    if(badge) badge.textContent=`${selected} selected / ${total} total`;
    localStorage.setItem(STORAGE_KEY,JSON.stringify($$('input[type="checkbox"]:checked',host).map(n=>n.value)));
  }

  function restore(){
    let saved=[]; try{ saved=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{}
    saved.forEach(id=>{
      const v=String(id??''); const esc=(window.CSS&&CSS.escape)?CSS.escape(v):v.replace(/"/g,'\\"');
      const cb=host.querySelector(`input[type="checkbox"][value="${esc}"]`); if(cb) cb.checked=true;
    });
    updateBadge();
  }

  function render(items){
    host.innerHTML='';
    if(!items.length){
      host.innerHTML=`<div style="opacity:.75;padding:16px;border:1px dashed #2a2a2a;border-radius:10px">
        No categories found. Check <code>${DATA_URL}</code>.
      </div>`;
      if(badge) badge.textContent='0 selected / 0 total';
      return;
    }
    const frag=document.createDocumentFragment();
    for(const {id,name} of items){
      const row=document.createElement('label');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.value=id; cb.addEventListener('change',updateBadge);
      const span=document.createElement('span'); span.textContent=name;
      row.append(cb,span); frag.append(row);
    }
    host.append(frag);
    if(badge) badge.textContent=`0 selected / ${items.length} total`;
    restore();
  }

  async function boot(){
    if(host.dataset.tkPopulated==='1') return; host.dataset.tkPopulated='1';
    const items=await loadData(); render(items);
    $('#btnSelectAll')?.addEventListener('click',()=>{ $$('input[type="checkbox"]',host).forEach(cb=>cb.checked=true); updateBadge(); });
    $('#btnDeselectAll')?.addEventListener('click',()=>{ $$('input[type="checkbox"]',host).forEach(cb=>cb.checked=false); updateBadge(); });
    // (Optional) Hook your Start Survey button
    $('#tkStartSurvey')?.addEventListener('click',()=>{ /* navigate or dispatch event */ });
  }

  document.readyState==='loading'?document.addEventListener('DOMContentLoaded',boot,{once:true}):boot();
})();
</script>
<!-- ====================================================================== -->
</body>
</html>
