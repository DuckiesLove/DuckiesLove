<!-- Talk Kink survey: hard overlay that rehosts the category panel on top -->
<script>
(() => {
  // ===== 1) Build an overlay that blocks the page behind =====
  let blocker = document.getElementById('__tk_blocker');
  if (!blocker) {
    blocker = document.createElement('div');
    blocker.id = '__tk_blocker';
    Object.assign(blocker.style, {
      position: 'fixed',
      inset: '0',
      background: 'rgba(0,0,0,.7)',   // dim the background
      zIndex: '2147483646',
      pointerEvents: 'auto'
    });
    document.body.appendChild(blocker);
  }

  let overlay = document.getElementById('__tk_overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = '__tk_overlay';
    Object.assign(overlay.style, {
      position: 'fixed',
      top: '6vh',
      left: '6vw',
      width: '70vw',
      maxWidth: '1100px',
      maxHeight: '80vh',
      overflow: 'auto',
      background: '#000',
      border: '2px solid #00e6e6',
      borderRadius: '16px',
      boxShadow: '0 10px 40px rgba(0,0,0,.6)',
      padding: '16px',
      zIndex: '2147483647',
      pointerEvents: 'auto',
      color: '#fff'
    });
    document.body.appendChild(overlay);
  }

  // Stop clicks to everything except the overlay & blocker
  const styleId = '__tk_backdrop_css';
  if (!document.getElementById(styleId)) {
    const st = document.createElement('style');
    st.id = styleId;
    st.textContent = `
      body[data-tk-backdrop="1"] > *:not(#__tk_overlay):not(#__tk_blocker) {
        pointer-events: none !important;
      }
      /* ensure overlay content isn't clipped by transforms on ancestors */
      #__tk_overlay, #__tk_blocker { transform: none !important; }
    `;
    document.head.appendChild(st);
  }
  document.body.setAttribute('data-tk-backdrop', '1');

  // ===== 2) Move the existing panel content into the overlay =====
  // Try to grab your current panel; fallbacks included
  let panel =
    document.querySelector('#categorySurveyPanel, .category-panel, #tkDockCard, #tkDockHard') ||
    document.getElementById('categoryChecklist')?.parentElement;

  if (!panel) {
    // As a last resort, make a container so you can see something to attach to
    panel = document.createElement('div');
    panel.className = 'category-panel';
    overlay.appendChild(panel);
  } else {
    overlay.appendChild(panel); // Reparent into our fixed overlay
  }

  // Make sure the checklist host exists inside the panel
  let host = document.getElementById('categoryChecklist');
  if (!host) {
    host = document.createElement('div');
    host.id = 'categoryChecklist';
    panel.appendChild(host);
  }

  // ===== 3) Force the checklist to be visible and up-front =====
  Object.assign(host.style, {
    display: 'grid',
    gridTemplateColumns: 'repeat(2, minmax(0, 1fr))',
    gap: '12px',
    background: '#020202',
    border: '2px solid #00e6e6',
    borderRadius: '12px',
    padding: '14px',
    color: '#fff',
    maxHeight: '60vh',
    overflow: 'auto',
    zIndex: '2147483647',
  });

  // ===== 4) If categories didn’t render, inject demo items so you can SEE rows =====
  if (!host.querySelector('label')) {
    const demo = Array.from({ length: 12 }, (_, i) => ({
      id: `demo-${i + 1}`,
      name: `Demo Category ${String(i + 1).padStart(2, '0')}`
    }));
    host.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (const { id, name } of demo) {
      const row = document.createElement('label');
      row.style.cssText =
        'display:flex;align-items:center;gap:12px;padding:11px 14px;' +
        'border:1px solid #2a2a2a;border-radius:12px;background:#0a0a0a;cursor:pointer;' +
        'user-select:none;font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = id;
      cb.style.width = cb.style.height = '18px';
      const span = document.createElement('span');
      span.textContent = name;
      row.append(cb, span);
      frag.append(row);
    }
    host.append(frag);
  }

  // ===== 5) Keep the “selected / total” badge correct (if present) =====
  const badge = document.getElementById('selectedCountBadge');
  const updateBadge = () => {
    const total = host.querySelectorAll('input[type=checkbox]').length;
    const sel = host.querySelectorAll('input[type=checkbox]:checked').length;
    if (badge) badge.textContent = `${sel} selected / ${total} total`;
  };
  host.addEventListener('change', (e) => e.target?.type === 'checkbox' && updateBadge());
  updateBadge();

  console.log('%c[TK] Overlay active. Background is blocked; panel is on top.',
              'color:#0ff');
})();
</script>
