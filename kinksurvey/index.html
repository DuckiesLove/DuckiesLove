<!doctype html>
<html lang="en" class="theme-dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Talk Kink — Kink Survey</title>

    <!-- =====================  TalkKink • CODEx PASTE BLOCK  =====================
    Goal: Kill the overlay/portal that causes the page to flash, and keep the
    question/rating cards in normal page flow. Paste this ENTIRE block into
    /kinksurvey/ HTML <head>, ABOVE your normal survey script(s).
    ============================================================================= -->

    <!-- 1) Inline runtime: disables & hides any overlay/portal and prevents re-parenting -->
    <script>
    (() => {
      /* Persist flag so your app can skip overlay bootstrap entirely */
      try { localStorage.setItem('__TK_DISABLE_OVERLAY', '1'); } catch {}

      /* CSS: hide any overlay shells, disable animations to prevent flicker */
      const css = document.createElement('style');
      css.id = 'tk-no-overlay-css';
      css.textContent = `
        #tkPortal, #tkOverlay, .tkPortal, .tkOverlay, .tkDockShell,
        #tkDevOverlay, .tkDevOverlay, [data-tk-overlay], [data-portal] {
          display: none !important; opacity: 0 !important; visibility: hidden !important;
          pointer-events: none !important;
        }
        /* reduce the chance of a visible flash while layout settles */
        * { transition: none !important; animation: none !important; }
      `;
      document.head.appendChild(css);

      /* Remove any overlay nodes already in the DOM */
      const SEL = [
        '#tkPortal', '#tkOverlay', '.tkPortal', '.tkOverlay', '.tkDockShell',
        '#tkDevOverlay', '.tkDevOverlay', '[data-tk-overlay]', '[data-portal]'
      ].join(',');
      document.querySelectorAll(SEL).forEach(n => { try { n.remove(); } catch {} });

      /* Ensure the main app stays on top of any leftover artifacts */
      const app = document.querySelector('#surveyApp') || document.querySelector('main');
      if (app) { app.style.position = 'relative'; app.style.zIndex = '2147483640'; }

      /* Soft-block aggressive MutationObservers that try to portal content */
      (function guardMOs(root = window) {
        const MO = root.MutationObserver || root.WebKitMutationObserver;
        if (!MO || !MO.prototype) return;
        const _observe = MO.prototype.observe;
        MO.prototype.observe = function (target, config) {
          try {
            if ((target === document || target === document.body) &&
                config && (config.childList || config.subtree)) {
              return; // refuse whole-document childList observers that often portal
            }
          } catch {}
          return _observe.apply(this, arguments);
        };
      })();

      console.info('[TK] no-overlay inline runtime active (overlay disabled)');
    })();
    </script>

    <!-- 2) OPTIONAL: Let your own survey code read the flag and skip overlay bootstrap.
         Add the following guard at the VERY TOP of your main survey JS (survey.js):

         if (localStorage.getItem('__TK_DISABLE_OVERLAY') === '1') {
           console.info('[TK] Overlay bootstrap skipped');
           // Ensure panel wiring never uses overlay/drawer
           window.TK_PANEL_OPTS = { overlay: false, drawer: false, locked: false };
           // If your file has an explicit overlay init, return early before it runs:
           // return;
         }

         Also force your panel options where you build the UI:
         const PANEL_OPTS = Object.assign({ overlay:false, drawer:false, locked:false }, window.TK_PANEL_OPTS || {});
    -->

    <!-- 3) Load your normal survey script(s) AFTER the block above -->
    <!-- <script src="/assets/survey.js?v=..."></script> -->

    <!-- ====================  End • TalkKink CODEx Paste Block  ==================== -->
    <script>
      // hard reset flags that old code checks
      window.__TK_DISABLE_OVERLAY = true;
      window.__TK_DISABLE_PORTAL = true;
      window.__TK_DISABLE_DRAWER = true;

      // if a legacy boot still runs, neutralize its methods safely
      (function(){
        const noop = ()=>{};
        const g = window;
        const suspects = [
          'tkPanelBoot','tkPortalBoot','tkOverlayBoot',
          'tkDockLayout','tkLockPanel','tkOpenPanel','tkWirePanel'
        ];
        suspects.forEach(k => { if (k in g) g[k] = noop; });
        // remove any pre-existing overlay nodes if injected before this executes
        const killNodes = () => {
          document.querySelectorAll('#tkPortal,.tk-overlay,.tk-drawer,.tk-panel,.portal-overlay')
            .forEach(n => n.remove());
        };
        document.addEventListener('DOMContentLoaded', killNodes);
        new MutationObserver(killNodes).observe(document.documentElement,{childList:true,subtree:true});
      })();
    </script>

    <link rel="stylesheet" href="/assets/css/kinksurvey/survey.css?v=2025-10-15">
    <script defer src="/assets/js/kinksurvey/survey.js?v=2025-10-15"></script>
    <script defer src="/assets/js/kinksurvey/start-after-selection.js?v=2025-10-16"></script>
    <script defer src="/assets/js/tk-enhancer.js?v=2"></script>
  </head>
  <body>
    <div class="tk-page">
      <header id="tkHeader" class="tk-header">
        <h1 id="pageTitle" class="glow-title">Talk Kink Survey</h1>
      </header>

      <main id="surveyApp" class="survey-root is-prestart" aria-live="polite" data-tk-ready="false">
        <div class="tk-wrap">
          <div id="tkPortal">
            <div class="tk-left">
              <section id="categoryPanel" class="panel category-panel" aria-label="Categories">
                <div class="panelHeader">
                  <div>
                    <h2 class="tk-side-title">Categories</h2>
                    <div class="tk-cat-count" aria-live="polite"><span id="tkCatSel">0</span> selected</div>
                  </div>
                </div>
                <div class="panelBody">
                  <ul id="categoryChecklist" class="tk-catlist" role="list"></ul>
                </div>
              </section>
            </div>

            <div class="tk-right">
              <nav id="ctaStack" class="tk-stack" aria-label="Survey actions">
                <button
                  id="btnStart"
                  class="btn xl tk-disabled"
                  disabled
                  title="Select at least one category to start"
                >Start Survey</button>
                <a class="btn" href="https://talkkink.org/individualkinkanalysis.html" aria-label="Individual Kink Analysis">Individual Kink Analysis</a>
                <a class="btn" href="https://talkkink.org/compatibility.html" aria-label="Compatibility Page">Compatibility Page</a>
              </nav>

              <div class="tk-meta" aria-label="Theme controls">
                <span class="tk-meta-label">Theme</span>
                <div id="themeControls" class="theme-controls-inline">
                  <button class="theme-btn" data-theme="dark">Dark</button>
                  <button class="theme-btn" data-theme="lipstick">Lipstick</button>
                  <button class="theme-btn" data-theme="forest">Forest</button>
                  <button class="theme-btn" data-theme="azure">Blue Glow</button>
                </div>
              </div>

              <section class="tk-survey-shell">
                <section id="controls" class="tk-controls">
                  <div id="prestartNotice" class="prestart-notice" role="status" aria-live="polite">
                    <h2>Select categories to begin</h2>
                    <p>
                      <span id="prestartCount">0</span>
                      selected so far. Pick at least one category on the left, then press
                      <strong>Start Survey</strong>.
                    </p>
                  </div>
                  <div id="ndProgress" class="tk-progress-shell">
                    <div id="progressBar"><span id="progressPct">0%</span></div>
                    <div id="progressText">Question 0 of 0</div>
                  </div>
                </section>

                <div class="tk-question-layout">
                  <section id="tk-question-host" class="tk-question-host">
                    <div id="tk-progress" class="tk-progress">0%</div>
                    <!-- Ensure these containers exist for JS to target -->
                    <div id="tk-question-card" class="question-card"></div>
                    <aside id="tk-score-rail" class="score-rail"></aside>
                  </section>

                  <aside class="score-sidebar" data-sticky="score">
                    <section class="how-to-score how-to-score--sidebar">
                      <h3>How to score</h3>
                      <ul class="legend">
                        <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
                        <li><b>1</b> — Hard Limit (no-go)</li>
                        <li><b>2</b> — Soft Limit (willing to try…)</li>
                        <li><b>3</b> — Curious / context-dependent</li>
                        <li><b>4</b> — Comfortable / enjoy</li>
                        <li><b>5</b> — Favorite / enthusiastic yes</li>
                      </ul>
                      <div class="rating-box">
                        <div class="label">Rate interest/comfort (0–5)</div>
                        <div class="rating-grid" id="tk-scale-sidebar" data-group="rating-A"></div>
                      </div>
                    </section>
                  </aside>
                </div>

                <script>
                  // ===== TK: hard guarantee that a question renders =====
                  (() => {
                    const q = (sel, root = document) => root.querySelector(sel);

                    document.addEventListener('DOMContentLoaded', () => {
                      tkForceRender();
                      document.addEventListener('change', (event) => {
                        const target = event.target;
                        if (!target) return;
                        if (target.matches('.tk-cat-input, .tk-cat-input *')) tkForceRender();
                      });
                    });

                    async function tkForceRender() {
                      try {
                        const res = await fetch(`/data/kinks.json?v=${Date.now()}`);
                        if (!res.ok) return;
                        const raw = await res.json();

                        const catalog = normalizeCatalog(raw);
                        if (!catalog.length) return;

                        const selectedCats = Array.from(document.querySelectorAll('.tk-cat-input:checked'))
                          .map((node) => node.dataset.cat || node.value || '')
                          .filter(Boolean);

                        const selectedName = selectedCats[0] || catalog[0].name;
                        const activeCat = catalog.find((entry) => entry.name === selectedName) || catalog[0];
                        const categoryTitle = activeCat?.name || selectedName || 'Category';
                        const items = Array.isArray(activeCat?.items) ? activeCat.items : [];

                        const first = items[0] ?? 'First item';
                        const label = typeof first === 'string'
                          ? first
                          : first?.label || first?.name || first?.title || first?.prompt || JSON.stringify(first);

                        const host = q('#tk-question-host');
                        if (!host) return;

                        let card = q('#tk-question-card');
                        if (!card) {
                          card = document.createElement('div');
                          card.id = 'tk-question-card';
                          card.className = 'question-card';
                          host.appendChild(card);
                        }
                        card.classList.add('tk-question-card');

                        let rail = q('#tk-score-rail');
                        if (!rail) {
                          rail = document.createElement('aside');
                          rail.id = 'tk-score-rail';
                          rail.className = 'score-rail';
                          host.appendChild(rail);
                        }

                        card.classList.remove('sr-only', 'is-hidden');
                        rail.classList.remove('sr-only', 'is-hidden');

                        const total = items.length || 1;
                        const progress = q('#tk-progress');
                        if (progress) {
                          progress.textContent = '0%';
                          progress.setAttribute('aria-valuenow', '0');
                        }

                        card.innerHTML = `
        <div class="tk-question-title">
          <strong>${categoryTitle}</strong>
          <small>${label}</small>
        </div>
        <div class="tk-scale" id="tk-scale">
          ${[0, 1, 2, 3, 4, 5].map((n) => `<button type="button" data-val="${n}">${n}</button>`).join('')}
        </div>
        <div class="tk-meta">Question 1 of ${total}</div>
      `.trim();

                        const scale = q('#tk-scale');
                        if (scale && !scale.dataset.wired) {
                          scale.dataset.wired = '1';
                          scale.addEventListener('click', (event) => {
                            const button = event.target?.closest('button');
                            if (!button) return;
                            scale.querySelectorAll('button').forEach((el) => {
                              el.classList.toggle('is-active', el === button);
                            });
                          });
                        }
                      } catch (err) {
                        console.error('[TK] force render failed:', err);
                      }
                    }

                    function normalizeCatalog(raw) {
                      const entries = [];

                      if (Array.isArray(raw?.categories)) {
                        raw.categories.forEach((cat) => {
                          const name = tidyName(cat?.name || cat?.title || cat?.category);
                          if (!name) return;
                          entries.push({ name, items: Array.isArray(cat.items) ? cat.items : [] });
                        });
                      } else if (Array.isArray(raw)) {
                        raw.forEach((cat) => {
                          if (typeof cat === 'string') {
                            const name = tidyName(cat);
                            if (!name) return;
                            entries.push({ name, items: [] });
                          } else if (cat && typeof cat === 'object') {
                            const name = tidyName(cat.name || cat.title || cat.category);
                            if (!name) return;
                            entries.push({ name, items: Array.isArray(cat.items) ? cat.items : [] });
                          }
                        });
                      } else if (raw && typeof raw === 'object') {
                        Object.entries(raw).forEach(([key, value]) => {
                          if (key === 'labels') return;
                          if (Array.isArray(value)) {
                            const name = tidyName(key);
                            if (!name) return;
                            entries.push({ name, items: value });
                          }
                        });
                      }

                      return entries;

                      function tidyName(name) {
                        return typeof name === 'string' ? name.trim() : '';
                      }
                    }

                    window.TK_FORCE = tkForceRender;
                  })();
                </script>

                <section id="questionArea" class="tk-question-area">
                  <div id="roleTabs" role="tablist" aria-label="Roles">
                    <button role="tab" data-role="Giving" aria-selected="true">Giving</button>
                    <button role="tab" data-role="Receiving">Receiving</button>
                    <button role="tab" data-role="General">General</button>
                  </div>
                  <section id="question-panel" class="survey-question-panel"></section>

                  <div id="navRow">
                    <button id="prevBtn">Back</button>
                    <button id="skipBtn">Skip</button>
                    <button id="nextBtn">Next</button>
                  </div>
                </section>
              </section>
            </div>
          </div>
        </div>
      </main>

      <script>
        // reveal the chrome once survey.js marks readiness
        const readyTick = setInterval(() => {
          if (window.__TK_SCORE_RAIL_READY__ === true) {
            document.getElementById('surveyApp')?.setAttribute('data-tk-ready', 'true');
            clearInterval(readyTick);
          }
        }, 50);
      </script>
      <section id="exportPayload" hidden aria-hidden="true">
        <table id="compatibilityTable"></table>
      </section>
    </div>

    <script>
      /* ------------------------------------------------------------------
         TK /kinksurvey bootstrap — robust wait + optional enhancer inject
         This runs ONLY on /kinksurvey/ and leaves the landing page alone.
      ------------------------------------------------------------------- */
      (function () {
        if (!location.pathname.startsWith('/kinksurvey/')) return;

        // 1) Version token for cache busting (keep this in sync for /kinksurvey)
        const VER = 'ks-20241020d';

        // 2) Where the enhancer lives (adjust if your path differs)
        const ENHANCER_SRC = '/assets/js/tk-enhancer.js?v=' + encodeURIComponent(VER);

        // 3) Small utilities
        function onReady(fn) {
          document.readyState !== 'loading'
            ? fn()
            : document.addEventListener('DOMContentLoaded', fn);
        }

        function sleep(ms) {
          return new Promise((r) => setTimeout(r, ms));
        }

        function exists(fnName) {
          return typeof window[fnName] === 'function';
        }

        function findEnhancerScript() {
          return Array.from(document.scripts).find((s) => (s.src || '').includes('/assets/js/tk-enhancer.js'));
        }

        async function ensureEnhancerLoaded() {
          // Already present and loaded?
          if (exists('setupDockedSurveyLayout')) return true;

          // If script tag exists but may not have executed yet, wait briefly
          const tag = findEnhancerScript();
          if (tag && !tag.dataset.tkLoadedOnce) {
            for (let i = 0; i < 40; i++) {
              // ~2s max
              if (exists('setupDockedSurveyLayout')) return true;
              await sleep(50);
            }
          }

          // If still not present, inject it now and wait for load
          if (!findEnhancerScript()) {
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = ENHANCER_SRC;
              s.async = true;
              s.onload = () => resolve();
              s.onerror = () => reject(new Error('Failed to load enhancer: ' + ENHANCER_SRC));
              document.head.appendChild(s);
            }).catch((err) => {
              console.warn('[TK] Could not inject enhancer:', err);
            });
          }

          // Final wait loop after injection (or if it existed but was slow)
          for (let i = 0; i < 100; i++) {
            // ~5s max
            if (exists('setupDockedSurveyLayout')) return true;
            await sleep(50);
          }
          return false;
        }

        // 4) Attempt to mount using whatever API is available
        function mountDockNow() {
          // Preferred single entry-point (exported by tk-enhancer.js per prior instructions)
          if (exists('setupDockedSurveyLayout')) {
            try {
              window.setupDockedSurveyLayout();
              return true;
            } catch (e) {
              console.error('[TK] setupDockedSurveyLayout threw:', e);
              return false;
            }
          }

          // Fallback: some builds expose the pieces separately on window or TK
          const NS = window.TK || window;
          const a = NS.ensureDockLayoutNodes;
          const b = NS.mountDockPanel;
          const c = NS.mountDockActions;
          if ([a, b, c].every((fn) => typeof fn === 'function')) {
            try {
              a();
              b();
              c();
              return true;
            } catch (e) {
              console.error('[TK] Dock pieces threw:', e);
              return false;
            }
          }
          return false;
        }

        // 5) Full boot sequence: after DOM, ensure enhancer, then mount
        onReady(async function () {
          // Give survey.js a tiny head-start to build initial DOM
          await sleep(0);

          const ok = await ensureEnhancerLoaded();
          if (!ok) {
            console.warn('[TK] Enhancer not ready – cannot mount docked layout.');
            return;
          }

          // Try mounting immediately
          if (mountDockNow()) return;

          // If mount fails because survey content hasn’t painted yet, retry shortly
          for (let i = 0; i < 40; i++) {
            // ~2s
            await sleep(50);
            if (mountDockNow()) return;
          }

          console.warn('[TK] Dock mount gave up after retries.');
        });
      })();
    </script>
  </body>
</html>
