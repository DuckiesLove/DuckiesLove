<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Talk Kink — Survey</title>
<base href="/" />
<meta http-equiv="Cache-Control" content="no-store, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<!-- Reuse site styles for familiar look; local CSS below makes panel behave like /kinks/ -->
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/theme.css">
<link rel="stylesheet" href="/css/kinksurvey_overrides.css?v=ks-20240927b">

<!-- TK /kinksurvey: keep hero accessible when the panel opens -->
<style id="tk-kinksurvey-hero-adjustments">
  body.panel-open #tk-hero,
  body.panel-open .tk-hero,
  body.drawer-open #tk-hero,
  body.drawer-open .tk-hero{
    margin-left:auto;
    margin-right:clamp(16px, 4vw, 48px);
    max-width:min(460px, 38vw);
    text-align:right;
    align-items:flex-end;
    position:relative;
    z-index:201;
  }

  body.panel-open #tk-hero .row,
  body.panel-open .tk-hero .row,
  body.drawer-open #tk-hero .row,
  body.drawer-open .tk-hero .row{
    justify-content:flex-end;
    gap:20px;
  }

  @media (max-width: 900px){
    body.panel-open #tk-hero,
    body.panel-open .tk-hero,
    body.drawer-open #tk-hero,
    body.drawer-open .tk-hero{
      margin:18px auto;
      max-width:min(92vw, 520px);
      text-align:center;
      align-items:center;
    }

    body.panel-open #tk-hero .row,
    body.panel-open .tk-hero .row,
    body.drawer-open #tk-hero .row,
    body.drawer-open .tk-hero .row{
      justify-content:center;
    }
  }
</style>

<!-- TK /kinksurvey — center landing & ignore hidden drawer offset -->
<style>
  /* Scope to /kinksurvey only */
  body.tk-kinksurvey { overflow-x: hidden; }

  /* Center the landing stack */
  body.tk-kinksurvey .landing-wrapper,
  body.tk-kinksurvey #kinksLanding {
    width: min(1100px, 92vw);
    margin: 8vh auto 0;
    display: grid;
    place-items: center;
    gap: 26px;
    text-align: center;
  }

  /* ROW for the 2 secondary buttons (if you’re grouping them) */
  body.tk-kinksurvey .kinksurvey-actions {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  /* --------- Drawer offset fix ---------
     While the category drawer is CLOSED, kill any reserved left space
     some layouts add for the panel (margin-left / width calc / transforms). */
  body.tk-kinksurvey:not(.tk-drawer-open) #app,
  body.tk-kinksurvey:not(.tk-drawer-open) main,
  body.tk-kinksurvey:not(.tk-drawer-open) .page,
  body.tk-kinksurvey:not(.tk-drawer-open) .kinks-root,
  body.tk-kinksurvey:not(.tk-drawer-open) .survey-wrapper,
  body.tk-kinksurvey:not(.tk-drawer-open) .compat-container,
  body.tk-kinksurvey:not(.tk-drawer-open) .with-panel,
  body.tk-kinksurvey:not(.tk-drawer-open) .landing-wrapper {
    margin-left: 0 !important;
    padding-left: 0 !important;
    width: 100% !important;
    transform: none !important;
  }

  /* Keep the drawer visually off-canvas when closed (don’t let it nudge layout) */
  body.tk-kinksurvey:not(.tk-drawer-open) #categorySurveyPanel,
  body.tk-kinksurvey:not(.tk-drawer-open) .category-panel {
    transform: translateX(-110%) !important;
    visibility: hidden;
  }
</style>

<style>
  :root { --panel-w: 320px; --tk-drawer-w: clamp(340px, 92vw, 980px); --bg:#000; --fg:#e6ffff; --accent:#00e6ff; --line:#00e5ff33; }
  html,body{height:100%}
  body{
    margin:0;
    background:#000;
    color:var(--fg);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
  }

  /* LEFT SIDE PANEL (classic /kinks/ feel) */
  #panelToggle{
    position:fixed; left:12px; top:12px; z-index:2147483648;
    background:#06161a; border:1px solid var(--line); color:var(--fg);
    border-radius:10px; padding:8px 12px; cursor:pointer;
  }
  .category-panel{
    position:relative;
    width:100%;
    max-width:none;
    min-height:100%;
    background:#071317;
    padding:14px 14px 18px;
    overflow:auto;
    text-align:center;
  }

  body.panel-open, body.drawer-open, body.tk-drawer-open{ overflow:hidden; }

  body.tk-drawer-ready:not(.tk-drawer-open) #categorySurveyPanel{
    visibility:hidden;
    pointer-events:none;
  }

  body.tk-drawer-open #categorySurveyPanel{
    visibility:visible;
    pointer-events:auto;
  }

  .category-panel.tk-as-drawer{
    position:fixed !important;
    top:0; left:0; right:auto; bottom:0;
    width:var(--tk-drawer-w);
    max-width:var(--tk-drawer-w);
    border-right:1px solid #00e6ff55;
    box-shadow:0 0 0 1px #00e6ff22 inset;
    transform:translateX(-104%);
    transition:transform .28s ease;
    z-index:10000;
  }

  body.tk-drawer-open .category-panel.tk-as-drawer{ transform:translateX(0); }

  #tkScrim{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    backdrop-filter:blur(1px);
    opacity:0;
    pointer-events:none;
    transition:opacity .2s ease;
    z-index:9999;
  }

  body.tk-drawer-open #tkScrim{
    opacity:1;
    pointer-events:auto;
  }

  .tk-close-drawer{
    position:sticky;
    top:0;
    margin:10px 10px 8px auto;
    padding:.55rem .9rem;
    border-radius:10px;
    cursor:pointer;
    background:#0a0f14;
    color:#aefcff;
    border:1px solid #00e6ff55;
  }

  /* Shift content when panel open */
  .content{
    margin:0 auto;
    padding:24px 16px;
    max-width:1000px;
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
  }
  .content.full{ margin:0 auto; }

  .themed-button, .category-button{
    padding:12px 18px; border:2px solid rgba(0,230,255,.55);
    border-radius:10px; background:transparent; color:#eaffff;
    font-weight:700; letter-spacing:.2px; cursor:pointer;
  }
  .themed-button:hover, .category-button:hover{
    border-color:rgba(0,230,255,.9); box-shadow:0 0 0 2px rgba(0,230,255,.18) inset;
  }

  .category-list{ display:grid; grid-template-columns:1fr; gap:10px; justify-items:center; }
  .category-list label{
    display:flex; gap:10px; align-items:center; justify-content:center; padding:8px 10px;
    border:1px solid var(--line); border-radius:10px; background:#060b0f; cursor:pointer;
    text-align:center;
  }

  .panel-title{ margin:6px 0 10px; font-weight:800; color:#7ef9ff; }
  .top-buttons{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }

  .panel-title, #statusMsg, #diag{ text-align:center; }

  .survey-box{
    border:1px solid var(--line); border-radius:12px; background:#0a0f14; padding:16px;
    max-width:1000px; margin:0 auto;
    text-align:center;
  }
  .catTitle{ margin:0 0 8px; color:#7ef9ff }
  .item{ display:flex; align-items:center; justify-content:center; gap:10px; padding:8px 0; border-top:1px dashed #00e5ff22; text-align:center; flex-wrap:wrap; }
  .item:first-child{ border-top:0; }
  select,input[type=text]{ padding:6px 8px; border:1px solid #115; border-radius:8px; background:#06161a; color:var(--fg); }

  .notice{ margin:14px 0; padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#071317; text-align:center; }
</style>
</head>
<body class="theme-dark has-category-panel">

<button id="panelToggle" class="panel-toggle" aria-controls="categorySurveyPanel" aria-expanded="false">☰</button>

<aside id="categorySurveyPanel" class="category-panel" role="region" aria-label="Category selection" aria-hidden="true">
  <h2 class="panel-title">Select categories</h2>
  <div class="top-buttons">
    <button id="selectAll" class="themed-button category-button">Select All</button>
    <button id="deselectAll" class="themed-button category-button">Deselect All</button>
  </div>
  <div id="statusMsg" class="themed-text" style="opacity:.85;margin:10px 0 8px">Loading categories…</div>
  <div id="categoryList" class="category-list" role="list"></div>
  <div style="display:flex;justify-content:center;margin-top:12px">
    <button id="start" class="themed-button start-survey-btn" disabled>Start Survey</button>
  </div>
  <div id="diag" class="notice" style="display:none"></div>
</aside>

<main id="content" class="content full">
  <div class="survey-box" id="survey" style="display:none">
    <h2 class="catTitle" id="catTitle"></h2>
    <div id="items"></div>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:12px">
      <button class="themed-button" id="skip">Skip Category</button>
      <button class="themed-button" id="next">Next Category</button>
    </div>
  </div>

  <div id="done" class="notice" style="display:none; max-width:1000px; margin:18px auto 0">
    <h3>Survey complete!</h3>
    <p>You’ve reached the end of the selected categories. <a href="/" style="color:#00e6ff">Back to home</a></p>
  </div>
</main>

<script>
(async function(){
  // Keep your existing data sources (will use your published dataset when present)
  const DATA_URLS=['/data/kinks.json','/kinks.json','./data/kinks.json','./kinks.json'];

  // Elements
  const $ = (id)=>document.getElementById(id);
  const panel = $('categorySurveyPanel');
  const toggle = $('panelToggle');
  const list = $('categoryList');
  const status = $('statusMsg');
  const startBtn = $('start');
  const diag = $('diag');
  const survey = $('survey');
  const title = $('catTitle');
  const items = $('items');
  const done = $('done');

  let scrim = document.getElementById('tkScrim');
  if (!scrim){
    scrim = document.createElement('div');
    scrim.id = 'tkScrim';
    document.body.appendChild(scrim);
  }

  if (panel){
    panel.classList.add('tk-as-drawer');
    panel.setAttribute('aria-expanded','false');
    if (!panel.querySelector('.tk-close-drawer')){
      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = 'tk-close-drawer';
      closeBtn.textContent = 'Close ✕';
      closeBtn.addEventListener('click', ()=>closeDrawer({ focusToggle: true }));
      panel.prepend(closeBtn);
    }
  }

  const triggerSelectors = '#startSurvey,#startSurveyBtn,#start,#tkHeroStart,[data-start-survey="1"]';

  function setDrawerState(open){
    const want = Boolean(open);
    if (panel){
      panel.classList.toggle('open', want);
      panel.setAttribute('aria-expanded', want ? 'true' : 'false');
      panel.setAttribute('aria-hidden', want ? 'false' : 'true');
    }
    document.body.classList.toggle('panel-open', want);
    document.body.classList.toggle('tk-drawer-open', want);
    toggle?.setAttribute('aria-expanded', want ? 'true' : 'false');
    if (scrim){
      scrim.style.opacity = want ? '1' : '0';
      scrim.style.pointerEvents = want ? 'auto' : 'none';
    }
  }

  function openDrawer(options = {}){
    const { focusFirst = true } = options;
    setDrawerState(true);
    if (focusFirst){
      const focusTarget = panel?.querySelector('input,button,select,textarea,[tabindex]:not([tabindex="-1"])');
      if (focusTarget){
        setTimeout(()=>focusTarget.focus({ preventScroll: true }), 60);
      }
    }
  }

  function closeDrawer(options = {}){
    const { focusToggle = false } = options;
    setDrawerState(false);
    if (focusToggle && toggle){
      setTimeout(()=>toggle.focus({ preventScroll: true }), 60);
    }
  }

  window.tkKinksurveyOpenPanel = (opts) => openDrawer(opts || {});
  window.tkKinksurveyClosePanel = (opts) => closeDrawer(opts || {});

  document.body.classList.add('tk-drawer-ready');
  setDrawerState(false);

  if (scrim && !scrim.dataset.tkBind){
    scrim.dataset.tkBind = '1';
    scrim.addEventListener('click', ()=>closeDrawer({ focusToggle: true }));
  }

  window.addEventListener('keydown', (event)=>{
    if (event.key === 'Escape') closeDrawer({ focusToggle: true });
  });

  // Toggle panel open/closed (like /kinks/)
  if (toggle && !toggle.dataset.tkBind){
    toggle.dataset.tkBind = '1';
    toggle.addEventListener('click', (event)=>{
      event.preventDefault();
      const isOpen = document.body.classList.contains('tk-drawer-open');
      if (isOpen) closeDrawer({ focusToggle: false });
      else openDrawer({ focusFirst: true });
    });
  }

  document.addEventListener('click', (event)=>{
    const trigger = event.target.closest(triggerSelectors);
    if (!trigger || !panel || panel.contains(trigger)) return;
    event.preventDefault();
    openDrawer({ focusFirst: true });
  });

  const S = { cats:[], sel:[], i:0 };

  const tidy = s=>String(s??'').replace(/\s+/g,' ').trim();
  const looksHTML = t => /^\s*<!doctype html/i.test(t) || /<html[\s>]/i.test(t);

  async function fetchData(){
    const errs=[];
    for (const u of DATA_URLS){
      try{
        const r = await fetch(u,{cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const txt = await r.text();
        if (looksHTML(txt)) throw new Error('HTML fallback');
        return { json: JSON.parse(txt), src:u, errs };
      }catch(e){ errs.push(u+': '+(e?.message||e)); }
    }
    throw new Error('All dataset fetches failed:\n- '+errs.join('\n- '));
  }

  function normalize(raw){
    const out=[];
    const push=(name,items)=>{
      const cat=tidy(name); if(!cat) return;
      const arr=[];
      (items||[]).forEach(it=>{
        const id=tidy(it?.id||it?.key||it?.name||'');
        const label=tidy(it?.label||it?.text||'');
        const type=tidy(it?.type||'scale');
        if(id && label) arr.push({id,label,type});
      });
      if(arr.length) out.push({category:cat, items:arr});
    };
    if (Array.isArray(raw)) raw.forEach(x=>push(x?.category ?? x?.name, x?.items));
    else if (raw && typeof raw==='object') Object.entries(raw).forEach(([k,v])=>push(k,v));
    return out;
  }

  function renderPanel(cats){
    list.innerHTML='';
    cats.forEach(c=>{
      const id='cb_'+Math.random().toString(36).slice(2,7);
      const row=document.createElement('label');
      row.setAttribute('role','listitem');
      row.innerHTML = `<input class="category-checkbox" type="checkbox" id="${id}" value="${c.category}"> <span>${c.category}</span>`;
      list.appendChild(row);
    });
    updateStart();
  }

  const selected = () => Array.from(document.querySelectorAll('.category-checkbox')).filter(cb=>cb.checked).map(cb=>cb.value);

  function updateStart(){
    const n = selected().length;
    startBtn.disabled = !n;
    status.textContent = n ? `${n} selected` : 'Choose one or more categories';
  }

  function showDiag(msg){ diag.style.display='block'; diag.textContent=msg; }

  function renderCat(i){
    const c = S.sel[i];
    if(!c){
      survey.style.display='none';
      done.style.display='block';
      return;
    }
    done.style.display='none';
    survey.style.display='block';
    title.textContent=c.category;
    items.innerHTML='';
    c.items.forEach(it=>{
      const row=document.createElement('div'); row.className='item';
      const id='k_'+it.id;
      let ctl='';
      const t=(it.type||'').toLowerCase();
      if (t==='bool') ctl = `<input type="checkbox" id="${id}" name="${it.id}">`;
      else if (t==='text') ctl = `<input type="text" id="${id}" name="${it.id}" placeholder="Your note">`;
      else ctl = `<select id="${id}" name="${it.id}">${[1,2,3,4,5].map(v=>`<option>${v}</option>`).join('')}</select>`;
      row.innerHTML = `${ctl} <label for="${id}">${it.label}</label>`;
      items.appendChild(row);
    });
  }

  // Bindings
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.classList && e.target.classList.contains('category-checkbox')) updateStart();
  });
  document.getElementById('selectAll').addEventListener('click', ()=>{
    document.querySelectorAll('.category-checkbox').forEach(cb=>cb.checked=true); updateStart();
  });
  document.getElementById('deselectAll').addEventListener('click', ()=>{
    document.querySelectorAll('.category-checkbox').forEach(cb=>cb.checked=false); updateStart();
  });

  startBtn.addEventListener('click', ()=>{
    const want = new Set(selected().map(s=>s.toLowerCase()));
    S.sel = S.cats.filter(c=>want.has(c.category.toLowerCase()));
    S.i = 0;
    if (!S.sel.length){ showDiag('No matching categories in dataset.'); return; }
    // Collapse the panel like the classic page
    closeDrawer({ focusToggle: false });
    renderCat(S.i);
  });
  document.getElementById('skip').addEventListener('click', ()=>{ S.i++; renderCat(S.i); });
  document.getElementById('next').addEventListener('click', ()=>{ S.i++; renderCat(S.i); });

  // Boot
  try{
    const {json,src,errs} = await fetchData();
    S.cats = normalize(json);
    renderPanel(S.cats);
    status.textContent = `Loaded ${S.cats.length} categories`;
    if (errs?.length) showDiag('Fetch notes:\n- ' + errs.join('\n- '));
  }catch(e){
    showDiag((e?.message||e) + '\nThis page will populate once /data/kinks.json is published.');
    status.textContent = 'Dataset unavailable';
  }
})();
</script>
<!-- One-time SW/cache buster (also triggers when ?tkreset=1) -->
<script>
(function(){
  const VER = 'ks-20240927b';
  try {
    const k = 'tk_ks_ver';
    const sp = new URL(location.href).searchParams;
    const mustReset = sp.has('tkreset') || localStorage.getItem(k) !== VER;
    if (mustReset) {
      if ('caches' in window) {
        caches.keys().then(ks => Promise.all(ks.map(n => caches.delete(n))));
      }
      if (navigator.serviceWorker && navigator.serviceWorker.getRegistration) {
        navigator.serviceWorker.getRegistration().then(r => r && r.unregister());
      }
      localStorage.setItem(k, VER);
    }
  } catch (_) {}
})();
</script>
<!-- TK /kinksurvey — center landing content -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  (function () {
    // Only act on /kinksurvey/
    if (!/^\/kinksurvey\/?$/i.test(location.pathname)) return;
    document.body.classList.add('tk-kinksurvey');

    const startSelectors = '#startSurvey, .start-survey-btn, button.start-survey';
    const startTrigger = document.querySelector(startSelectors);
    if (startTrigger) {
      startTrigger.addEventListener('click', () => {
        document.body.classList.add('tk-drawer-open');
        // Your existing code that actually opens the drawer continues to run as before.
      });
    }

    // Find the main area (works with either .landing-wrapper or a generic container)
    const landing =
      document.querySelector('.landing-wrapper') ||
      document.querySelector('#kinksLanding') ||
      (function () {
        // last resort: build a wrapper around the first <h1> + buttons we find
        const h1 = document.querySelector('h1');
        if (!h1) return null;
        const wrap = document.createElement('div');
        wrap.className = 'landing-wrapper';
        h1.before(wrap);
        wrap.appendChild(h1);
        // move following siblings (likely the start button + links) into the wrapper
        const toMove = [];
        let n = wrap.nextElementSibling;
        while (n && toMove.length < 10) { toMove.push(n); n = n.nextElementSibling; }
        toMove.forEach(el => wrap.appendChild(el));
        return wrap;
      })();

    if (!landing) return;

    // Group the two secondary buttons into a centered row below "Start Survey"
    const startBtn =
      landing.querySelector(startSelectors) ||
      landing.querySelector('button, a[href*="start"]');
    if (!startBtn) return;

    // Collect likely secondary actions by their text (compat + individual analysis)
    const candidates = Array.from(
      landing.querySelectorAll('a,button')
    ).filter(el =>
      el !== startBtn &&
      /compat|individual/i.test(el.textContent || '')
    );

    if (candidates.length && !landing.querySelector('.kinksurvey-actions')) {
      const row = document.createElement('div');
      row.className = 'kinksurvey-actions';
      // insert row right after the Start button
      startBtn.insertAdjacentElement('afterend', row);
      candidates.forEach(btn => row.appendChild(btn));
    }
  })();
});
</script>
<!-- load enhancer last so it can find the existing DOM (versioned URL to beat stale caches) -->
<script type="module" src="/js/tk_kinksurvey_enhance.js?v=ks-20240927b"></script>
<!-- Self-heal: if hero didn't appear quickly (stale inline/partial), retry loading once -->
<script>
setTimeout(() => {
  if (!document.getElementById('tk-hero')) {
    const s = document.createElement('script');
    s.type = 'module';
    s.src = '/js/tk_kinksurvey_enhance.js?v=ks-20240927b&retry=1';
    document.head.appendChild(s);
  }
}, 800);
</script>
</body>
</html>
