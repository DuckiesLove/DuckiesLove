<!doctype html>
<html lang="en" class="theme-dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Talk Kink — Kink Survey</title>

    <!-- ===== TK EARLY-BOOT FIX: make page show without DevTools, and kill stale cached JSON ===== -->
    <style>
      /* Never allow a theme "prestart" to blank the page */
      html, body { background: #0b1418; }
      body.tk-prestart { opacity: 1 !important; visibility: visible !important; }
    </style>
    <script>
      /* 1) Unblank ASAP (DOM can still be loading) */
      (function unblank() {
        document.documentElement.classList.remove('tk-prestart');
        document.body && document.body.classList.remove('tk-prestart');
        const show = () => {
          document.documentElement.classList.remove('tk-prestart');
          document.body && document.body.classList.remove('tk-prestart');
        };
        document.addEventListener('DOMContentLoaded', show, {once: true});
        window.addEventListener('load', show, {once: true});
      })();

      /* 2) Service-worker & cache one-time nuke (prevents “works only with DevTools” due to stale assets) */
      (function nukeSWOnce() {
        if (!('serviceWorker' in navigator)) return;
        const FLAG = 'tk-sw-nuked';
        if (sessionStorage.getItem(FLAG)) return;
        Promise.all([
          navigator.serviceWorker.getRegistrations().then(rs => Promise.all(rs.map(r => r.unregister()))),
          ('caches' in window) ? caches.keys().then(ks => Promise.all(ks.map(k => caches.delete(k)))) : Promise.resolve()
        ]).finally(() => sessionStorage.setItem(FLAG, '1'));
      })();

      /* 3) Force-fresh JSON (DevTools disables cache; mimic that here for our data files) */
      (function monkeypatchFetch() {
        const ORIG = window.fetch;
        const STAMP = String(Date.now());
        window.fetch = function(input, init) {
          try {
            const u = new URL(input, location.origin);
            // Bust cache for our survey data files
            if (/^\/?kinksurvey\/data\/.+\.json$/i.test(u.pathname)) {
              u.searchParams.set('v', STAMP);
              init = Object.assign({cache: 'no-store'}, init || {});
              return ORIG.call(this, u.toString(), init);
            }
          } catch (_) {}
          return ORIG.call(this, input, init);
        };
      })();

      /* 4) Make sure late scripts don’t re-hide CTAs/panel */
      (function keepVisible() {
        const keep = (id) => {
          const el = document.getElementById(id);
          if (!el) return;
          const show = () => { el.style.display = ''; };
          new MutationObserver(() => { if (getComputedStyle(el).display === 'none') show(); })
            .observe(el, {attributes: true, attributeFilter: ['style', 'class']});
        };
        ['ctaStack', 'categoryPanel'].forEach(keep);
      })();
    </script>
    <!-- ===== /TK EARLY-BOOT FIX ===== -->

    <!-- =====================  TalkKink • CODEx PASTE BLOCK  =====================
    Goal: Kill the overlay/portal that causes the page to flash, and keep the
    question/rating cards in normal page flow. Paste this ENTIRE block into
    /kinksurvey/ HTML <head>, ABOVE your normal survey script(s).
    ============================================================================= -->

    <!-- 1) Inline runtime: disables & hides any overlay/portal and prevents re-parenting -->
    <script>
    (() => {
      /* Persist flag so your app can skip overlay bootstrap entirely */
      try { localStorage.setItem('__TK_DISABLE_OVERLAY', '1'); } catch {}

      /* CSS: hide any overlay shells, disable animations to prevent flicker */
      const css = document.createElement('style');
      css.id = 'tk-no-overlay-css';
      css.textContent = `
        #tkOverlay, .tkOverlay, .tkDockShell,
        #tkDevOverlay, .tkDevOverlay, [data-tk-overlay], [data-portal] {
          display: none !important; opacity: 0 !important; visibility: hidden !important;
          pointer-events: none !important;
        }
        /* reduce the chance of a visible flash while layout settles */
        * { transition: none !important; animation: none !important; }
      `;
      document.head.appendChild(css);

      /* Remove any overlay nodes already in the DOM */
      const SEL = [
        '#tkPortal', '#tkOverlay', '.tkPortal', '.tkOverlay', '.tkDockShell',
        '#tkDevOverlay', '.tkDevOverlay', '[data-tk-overlay]', '[data-portal]'
      ].join(',');
      const keepPortal = (node) => {
        if (!node || node.id !== 'tkPortal') return false;
        const host = document.getElementById('surveyApp');
        return !!(host && host.contains(node));
      };

      document.querySelectorAll(SEL).forEach(n => {
        try {
          if (!keepPortal(n)) n.remove();
        } catch {}
      });

      /* Ensure the main app stays on top of any leftover artifacts */
      const app = document.querySelector('#surveyApp') || document.querySelector('main');
      if (app) { app.style.position = 'relative'; app.style.zIndex = '2147483640'; }

      /* Soft-block aggressive MutationObservers that try to portal content */
      (function guardMOs(root = window) {
        const MO = root.MutationObserver || root.WebKitMutationObserver;
        if (!MO || !MO.prototype) return;
        const _observe = MO.prototype.observe;
        MO.prototype.observe = function (target, config) {
          try {
            if ((target === document || target === document.body) &&
                config && (config.childList || config.subtree)) {
              return; // refuse whole-document childList observers that often portal
            }
          } catch {}
          return _observe.apply(this, arguments);
        };
      })();

      console.info('[TK] no-overlay inline runtime active (overlay disabled)');
    })();
    </script>

    <!-- 2) OPTIONAL: Let your own survey code read the flag and skip overlay bootstrap.
         Add the following guard at the VERY TOP of your main survey JS (survey.js):

         if (localStorage.getItem('__TK_DISABLE_OVERLAY') === '1') {
           console.info('[TK] Overlay bootstrap skipped');
           // Ensure panel wiring never uses overlay/drawer
           window.TK_PANEL_OPTS = { overlay: false, drawer: false, locked: false };
           // If your file has an explicit overlay init, return early before it runs:
           // return;
         }

         Also force your panel options where you build the UI:
         const PANEL_OPTS = Object.assign({ overlay:false, drawer:false, locked:false }, window.TK_PANEL_OPTS || {});
    -->

    <!-- 3) Load your normal survey script(s) AFTER the block above -->
    <!-- <script src="/assets/survey.js?v=..."></script> -->

    <!-- ====================  End • TalkKink CODEx Paste Block  ==================== -->
    <script>
      // hard reset flags that old code checks
      window.__TK_DISABLE_OVERLAY = true;
      window.__TK_DISABLE_PORTAL = true;
      window.__TK_DISABLE_DRAWER = true;

      // if a legacy boot still runs, neutralize its methods safely
      (function(){
        const noop = ()=>{};
        const g = window;
        const suspects = [
          'tkPanelBoot','tkPortalBoot','tkOverlayBoot',
          'tkDockLayout','tkLockPanel','tkOpenPanel','tkWirePanel'
        ];
        suspects.forEach(k => { if (k in g) g[k] = noop; });
        // remove any pre-existing overlay nodes if injected before this executes
        const keepPortal = (node) => {
          if (!node || node.id !== 'tkPortal') return false;
          const host = document.getElementById('surveyApp');
          return !!(host && host.contains(node));
        };

        const killNodes = () => {
          document.querySelectorAll('#tkPortal,.tk-overlay,.tk-drawer,.tk-panel,.portal-overlay')
            .forEach(n => { if (!keepPortal(n)) n.remove(); });
        };
        document.addEventListener('DOMContentLoaded', killNodes);
        new MutationObserver(killNodes).observe(document.documentElement,{childList:true,subtree:true});
      })();
    </script>

    <link rel="stylesheet" href="/assets/css/kinksurvey/survey.css?v=2025-10-24">
    <script defer src="/assets/js/kinksurvey/survey.js?v=2025-10-24"></script>
    <script defer src="/assets/js/tk-enhancer.js?v=2"></script>

    <style id="tkPrestartStyles">
      /* Categories-only until Start (adapted for docked layout) */
      body.tk-prestart #categoryPanel { display: block !important; }
      body.tk-prestart #tkPortal > :not(.tk-cat-host) { display: none !important; }
      body.tk-prestart .tk-cat-host { display: block !important; }
      body.tk-prestart .tk-cat-host ~ * { display: none !important; }
      body.tk-prestart #tkPortal .tk-left > :not(#categoryPanel) { display: none !important; }
      #surveyApp[hidden], #surveyScoreCard[hidden] { display: none !important; }
    </style>
  </head>
  <body class="tk-prestart">
    <div class="tk-page">
      <header id="tkHeader" class="tk-header">
        <h1 id="pageTitle" class="glow-title">Talk Kink Survey</h1>
      </header>

      <main id="surveyApp" class="survey-root is-prestart" aria-live="polite" data-tk-ready="false">
        <div class="tk-wrap">
          <div id="tkPortal">
            <div class="tk-left tk-cat-host">
              <section id="categoryPanel" class="panel category-panel" aria-label="Categories">
                <div class="panelHeader">
                  <div>
                    <h2 class="tk-side-title">Categories</h2>
                    <div class="tk-cat-count" aria-live="polite"><span id="tkCatSel">0</span> selected</div>
                  </div>
                </div>
                <div class="panelBody">
                  <ul id="categoryChecklist" class="tk-catlist" role="list"></ul>
                </div>
              </section>
            </div>

            <div class="tk-right">
              <div class="tk-meta" aria-label="Theme controls">
                <span class="tk-meta-label">Theme</span>
                <div id="themeControls" class="theme-controls-inline">
                  <button class="theme-btn" data-theme="dark">Dark</button>
                  <button class="theme-btn" data-theme="lipstick">Lipstick</button>
                  <button class="theme-btn" data-theme="forest">Forest</button>
                  <button class="theme-btn" data-theme="azure">Blue Glow</button>
                </div>
              </div>

              <section class="tk-survey-shell">
                <section id="controls" class="tk-controls">
                  <div id="prestartNotice" class="prestart-notice" role="status" aria-live="polite">
                    <h2>Select categories to begin</h2>
                    <p>
                      <span id="prestartCount">0</span>
                      selected so far. Pick at least one category on the left, then press
                      <strong>Start Survey</strong>.
                    </p>
                  </div>
                  <div id="ndProgress" class="tk-progress-shell">
                    <div id="progressBar"><span id="progressPct">0%</span></div>
                    <div id="progressText">Question 0 of 0</div>
                  </div>
                </section>

                <div class="tk-question-layout">
                  <section id="tk-question-host" class="tk-question-host">
                    <div id="tk-progress" class="tk-progress">0%</div>
                    <!-- Ensure these containers exist for JS to target -->
                    <div id="tk-question-card" class="question-card"></div>
                    <aside id="tk-score-rail" class="score-rail"></aside>
                  </section>

                  <aside class="score-sidebar" data-sticky="score">
                    <section class="how-to-score how-to-score--sidebar">
                      <h3>How to score</h3>
                      <ul class="legend">
                        <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
                        <li><b>1</b> — Hard Limit (no-go)</li>
                        <li><b>2</b> — Soft Limit (willing to try…)</li>
                        <li><b>3</b> — Curious / context-dependent</li>
                        <li><b>4</b> — Comfortable / enjoy</li>
                        <li><b>5</b> — Favorite / enthusiastic yes</li>
                      </ul>
                      <div class="rating-box">
                        <div class="label">Rate interest/comfort (0–5)</div>
                        <div class="rating-grid" id="tk-scale-sidebar" data-group="rating-A"></div>
                      </div>
                    </section>
                  </aside>
                </div>

                <script>
                  // ===== TK: hard guarantee that a question renders =====
                  (() => {
                    const q = (sel, root = document) => root.querySelector(sel);

                    document.addEventListener('DOMContentLoaded', () => {
                      tkForceRender();
                      document.addEventListener('change', (event) => {
                        const target = event.target;
                        if (!target) return;
                        if (target.matches('.tk-cat-input, .tk-cat-input *')) tkForceRender();
                      });
                    });

                    async function tkForceRender() {
                      try {
                        const res = await fetch(`/data/kinks.json?v=${Date.now()}`);
                        if (!res.ok) return;
                        const raw = await res.json();

                        const catalog = normalizeCatalog(raw);
                        if (!catalog.length) return;

                        const selectedCats = Array.from(document.querySelectorAll('.tk-cat-input:checked'))
                          .map((node) => node.dataset.cat || node.value || '')
                          .filter(Boolean);

                        const selectedName = selectedCats[0] || catalog[0].name;
                        const activeCat = catalog.find((entry) => entry.name === selectedName) || catalog[0];
                        const categoryTitle = activeCat?.name || selectedName || 'Category';
                        const items = Array.isArray(activeCat?.items) ? activeCat.items : [];

                        const first = items[0] ?? 'First item';
                        const label = typeof first === 'string'
                          ? first
                          : first?.label || first?.name || first?.title || first?.prompt || JSON.stringify(first);

                        const host = q('#tk-question-host');
                        if (!host) return;

                        let card = q('#tk-question-card');
                        if (!card) {
                          card = document.createElement('div');
                          card.id = 'tk-question-card';
                          card.className = 'question-card';
                          host.appendChild(card);
                        }
                        card.classList.add('tk-question-card');

                        let rail = q('#tk-score-rail');
                        if (!rail) {
                          rail = document.createElement('aside');
                          rail.id = 'tk-score-rail';
                          rail.className = 'score-rail';
                          host.appendChild(rail);
                        }

                        card.classList.remove('sr-only', 'is-hidden');
                        rail.classList.remove('sr-only', 'is-hidden');

                        const total = items.length || 1;
                        const progress = q('#tk-progress');
                        if (progress) {
                          progress.textContent = '0%';
                          progress.setAttribute('aria-valuenow', '0');
                        }

                        card.innerHTML = `
        <div class="tk-question-title">
          <strong>${categoryTitle}</strong>
          <small>${label}</small>
        </div>
        <div class="tk-scale" id="tk-scale">
          ${[0, 1, 2, 3, 4, 5].map((n) => `<button type="button" data-val="${n}">${n}</button>`).join('')}
        </div>
        <div class="tk-meta">Question 1 of ${total}</div>
      `.trim();

                        const scale = q('#tk-scale');
                        if (scale && !scale.dataset.wired) {
                          scale.dataset.wired = '1';
                          scale.addEventListener('click', (event) => {
                            const button = event.target?.closest('button');
                            if (!button) return;
                            scale.querySelectorAll('button').forEach((el) => {
                              el.classList.toggle('is-active', el === button);
                            });
                          });
                        }
                      } catch (err) {
                        console.error('[TK] force render failed:', err);
                      }
                    }

                    function normalizeCatalog(raw) {
                      const entries = [];

                      if (Array.isArray(raw?.categories)) {
                        raw.categories.forEach((cat) => {
                          const name = tidyName(cat?.name || cat?.title || cat?.category);
                          if (!name) return;
                          entries.push({ name, items: Array.isArray(cat.items) ? cat.items : [] });
                        });
                      } else if (Array.isArray(raw)) {
                        raw.forEach((cat) => {
                          if (typeof cat === 'string') {
                            const name = tidyName(cat);
                            if (!name) return;
                            entries.push({ name, items: [] });
                          } else if (cat && typeof cat === 'object') {
                            const name = tidyName(cat.name || cat.title || cat.category);
                            if (!name) return;
                            entries.push({ name, items: Array.isArray(cat.items) ? cat.items : [] });
                          }
                        });
                      } else if (raw && typeof raw === 'object') {
                        Object.entries(raw).forEach(([key, value]) => {
                          if (key === 'labels') return;
                          if (Array.isArray(value)) {
                            const name = tidyName(key);
                            if (!name) return;
                            entries.push({ name, items: value });
                          }
                        });
                      }

                      return entries;

                      function tidyName(name) {
                        return typeof name === 'string' ? name.trim() : '';
                      }
                    }

                    window.TK_FORCE = tkForceRender;
                  })();
                </script>

                <section id="questionArea" class="tk-question-area">
                  <div id="roleTabs" role="tablist" aria-label="Roles">
                    <button role="tab" data-role="Giving" aria-selected="true">Giving</button>
                    <button role="tab" data-role="Receiving">Receiving</button>
                    <button role="tab" data-role="General">General</button>
                  </div>
                  <section id="question-panel" class="survey-question-panel"></section>

                  <div id="navRow">
                    <button id="prevBtn">Back</button>
                    <button id="skipBtn">Skip</button>
                    <button id="nextBtn">Next</button>
                  </div>
                </section>
              </section>
            </div>
          </div>
        </div>
      </main>

      <script>
        // reveal the chrome once survey.js marks readiness
        const readyTick = setInterval(() => {
          if (window.__TK_SCORE_RAIL_READY__ === true) {
            document.getElementById('surveyApp')?.setAttribute('data-tk-ready', 'true');
            clearInterval(readyTick);
          }
        }, 50);
      </script>
      <section id="exportPayload" hidden aria-hidden="true">
        <table id="compatibilityTable"></table>
      </section>
    </div>

    <!-- ================== TK RESCUE ONE-BOX (added 2025-02-15) ================== -->
    <style>
      /* Unhide critical UI even if an old stylesheet hid it */
      body.tk-prestart #tkPortal,
      body.tk-prestart #categoryPanel,
      body.tk-prestart .category-panel,
      body.tk-prestart #ctaStack { display: revert !important; }

      /* Two-column shell: LEFT = categories, RIGHT = CTAs/content */
      #tkPortal{ display:grid; grid-template-columns:380px 1fr; gap:28px; align-items:start; }
      @media (max-width:980px){ #tkPortal{ grid-template-columns:1fr; } }

      /* LEFT: tall, sticky categories */
      #categoryPanel, .category-panel{
        position:sticky; top:16px;
        max-height:calc(100dvh - 32px);
        overflow:auto; scroll-behavior:smooth;
      }
      .tk-left{ max-height:calc(100vh - 5rem); overflow:auto; }  /* relax any older cap */
      @media (max-width:980px){ #categoryPanel, .category-panel{ position:relative; top:0; max-height:none; } }

      /* RIGHT: top-right CTA stack */
      #tkPortal #ctaStack{ grid-column:2; grid-row:1; align-self:start; justify-self:start; max-width:560px; }
      #ctaStack.tk-stack{ display:grid; gap:14px; justify-items:stretch; }
      #ctaStack .btn{ width:100%; text-align:center; padding:14px 16px; border-radius:12px; font-weight:700; }
      #ctaStack .btn-ghost{ background:transparent; border:2px solid var(--tk-accent,#39e3ff); }
      #ctaStack .btn[disabled]{ opacity:.55; cursor:not-allowed; }

      /* Keep engine mounts hidden until shown */
      #surveyApp[hidden], #surveyScoreCard[hidden]{ display:none !important; }
    </style>

    <!-- CTA stack (safe if it already exists) -->
    <nav id="ctaStack" class="tk-stack" style="display:grid;gap:14px;max-width:560px;">
      <button id="btnStart" class="btn btn-primary">Start Survey</button>
      <a id="btnKinkAnalysis" class="btn btn-ghost" href="/kinksurvey/analysis/">Individual Kink Analysis</a>
      <a id="btnCompatibility" class="btn btn-ghost" href="/kinksurvey/compat/">Compatibility Page</a>
    </nav>

    <script>
    /* 0) Never allow “prestart” to blank the page */
    document.body.classList.remove('tk-prestart');

    /* 1) Put CTAs top-right, beside Categories */
    (function placeCTAs(){
      const portal = document.getElementById('tkPortal');
      const cta    = document.getElementById('ctaStack');
      if (!portal || !cta) return;
      const main = document.getElementById('surveyMain') || document.querySelector('.portal-main');
      if (main && main.parentElement === portal) portal.insertBefore(cta, main);
      else if (cta.parentElement !== portal) portal.appendChild(cta);
      cta.classList.add('tk-stack');
    })();

    /* 2) Keep CTAs visible even if another script hides them */
    (function keepCTAs(){
      const cta = document.getElementById('ctaStack'); if (!cta) return;
      const show = () => { cta.style.display=''; cta.classList.add('tk-stack'); };
      new MutationObserver(() => { if (getComputedStyle(cta).display === 'none') show(); })
        .observe(cta, { attributes:true, attributeFilter:['style','class'] });
      const startBtn = document.getElementById('btnStart');
      if (startBtn){ startBtn.addEventListener('click', () => { requestAnimationFrame(show); setTimeout(show,0); setTimeout(show,250); }); }
    })();

    /* 3) (Optional) Gate Start until a category is checked */
    (function gateStart(){
      const list = document.getElementById('categoryChecklist');
      const start = document.getElementById('btnStart');
      if (!list || !start) return;
      const enable = () => start.toggleAttribute('disabled', !list.querySelector('input[type="checkbox"]:checked'));
      list.addEventListener('change', e => { if (e.target?.matches('input[type="checkbox"]')) enable(); });
      requestAnimationFrame(enable);
    })();

    /* 4) Keep category panel height synced to viewport on resize */
    (function sizePanel(){
      const panel = document.getElementById('categoryPanel') || document.querySelector('.category-panel');
      if (!panel) return;
      const update = () => {
        const r = panel.getBoundingClientRect();
        const vh = Math.max(document.documentElement.clientHeight, window.innerHeight||0);
        panel.style.maxHeight = Math.max(260, vh - r.top - 16) + 'px';
      };
      requestAnimationFrame(update); addEventListener('resize', update);
    })();

    /* 5) Cache-bust critical assets so non-DevTools loads pick up changes */
    (function bustCache(){
      const bump = String(Date.now());
      const targets = [
        /\/kinksurvey\/assets\/js\/kinksurvey\/survey\.js/i,
        /\/kinksurvey\/assets\/js\/kinksurvey\/tk\-enhancer\.js/i,
        /\/kinksurvey\/css\/kinksurvey_overrides\.css/i
      ];
      document.querySelectorAll('script[src],link[rel="stylesheet"][href]').forEach(el=>{
        const attr = el.tagName==='SCRIPT' ? 'src' : 'href';
        const url  = el.getAttribute(attr); if (!url) return;
        if (targets.some(rx=>rx.test(url))){
          const u = new URL(url, location.origin);
          u.searchParams.set('v', bump);
          el.setAttribute(attr, u.pathname + '?' + u.searchParams.toString());
        }
      });
    })();

    /* 6) First-load safety: if a service worker cached an old broken build, unregister once */
    (function swOnce(){
      if (!('serviceWorker' in navigator)) return;
      const FLAG = 'tk-sw-cleared';
      if (sessionStorage.getItem(FLAG)) return;
      navigator.serviceWorker.getRegistrations().then(regs => {
        if (regs.length){ regs.forEach(r=>r.unregister()); caches && caches.keys().then(k=>k.forEach(c=>caches.delete(c))); }
        sessionStorage.setItem(FLAG, '1');
      }).catch(()=>{});
    })();
    </script>
    <!-- ================== /TK ONE-BOX ================== -->

    <script>
      (function () {
        if (window.__TK_CATEGORY_PRESTART__) return;
        window.__TK_CATEGORY_PRESTART__ = true;

        const log = (...a) => console.info("[TK:cat-bootstrap]", ...a);
        const warn = (...a) => console.warn("[TK:cat-bootstrap]", ...a);

        const ensurePrestart = () => document.body.classList.add("tk-prestart");
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", ensurePrestart, { once: true });
        } else {
          ensurePrestart();
        }

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        let catByValue = new Map();

        function cssEscape(value) {
          if (window.CSS && typeof window.CSS.escape === "function") {
            return window.CSS.escape(value);
          }
          return String(value).replace(/["\\]/g, "\\$&");
        }

        function escapeHtml(value) {
          return String(value ?? "").replace(/[&<>"']/g, (ch) => {
            switch (ch) {
              case "&": return "&amp;";
              case "<": return "&lt;";
              case ">": return "&gt;";
              case '"': return "&quot;";
              case "'": return "&#39;";
              default: return ch;
            }
          });
        }

        function slugify(value, fallback = "") {
          const base = value ?? fallback ?? "";
          return String(base)
            .toLowerCase()
            .replace(/&/g, "and")
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "");
        }

        function toName(entry, index) {
          if (entry && typeof entry === "object") {
            for (const key of ["name", "title", "label", "category", "cat", "Category"]) {
              if (entry[key]) return String(entry[key]).trim();
            }
          }
          if (typeof entry === "string" || typeof entry === "number") {
            return String(entry).trim();
          }
          if (entry) return String(entry).trim();
          return `Category ${index + 1}`;
        }

        function toValue(entry, fallbackName, index) {
          if (entry && typeof entry === "object") {
            for (const key of ["id", "value", "slug", "key", "code"]) {
              if (entry[key]) return String(entry[key]);
            }
          }
          const fallback = fallbackName || `cat-${index}`;
          const slug = slugify(fallback, `cat-${index}`);
          return slug || `cat-${index}`;
        }

        function captureFromDom(ul) {
          catByValue = new Map();
          const inputs = $$('input[type="checkbox"]', ul);
          inputs.forEach((input) => {
            const id = input.id;
            let labelText = "";
            if (id) {
              const label = ul.querySelector(`label[for="${cssEscape(id)}"]`);
              if (label) labelText = label.textContent.trim();
            }
            if (!labelText) {
              labelText = input.getAttribute("data-label") || input.dataset?.label || input.value;
            }
            catByValue.set(String(input.value), labelText || input.value);
          });
          return inputs.length;
        }

        function render(ul, entries) {
          catByValue = new Map();
          ul.innerHTML = entries.map((entry, idx) => {
            const name = entry.name;
            const rawValue = entry.value ?? name;
            const value = String(rawValue);
            const slug = slugify(value, name) || slugify(name, `cat-${idx}`) || `cat-${idx}`;
            const id = `cat_${slug}`;
            catByValue.set(value, name);
            const safeValue = escapeHtml(value);
            const safeName = escapeHtml(name);
            return `<li data-cat="${safeValue}">
              <input type="checkbox" id="${id}" value="${safeValue}">
              <label for="${id}">${safeName}</label>
            </li>`;
          }).join("");
        }

        function selectedValues(list) {
          return $$('input[type="checkbox"]:checked', list).map((input) => input.value);
        }

        function exitPrestart() {
          if (!document.body.classList.contains("tk-prestart")) return;
          document.body.classList.remove("tk-prestart");
          const app = $("#surveyApp");
          if (app) {
            app.hidden = false;
            app.classList.remove("is-prestart");
          }
          log("exited prestart");
        }

        function getHost() {
          const panel = $("#categoryPanel") || document.body;
          const host = panel.closest(".tk-left") || panel;
          host.classList.add("tk-cat-host");
          if (host !== panel) panel.classList.add("tk-cat-host");
          let tkDiv = $("#tk-cat-list", panel);
          if (!tkDiv) {
            tkDiv = document.createElement("div");
            tkDiv.id = "tk-cat-list";
            panel.appendChild(tkDiv);
          }
          let ul = $("#categoryChecklist", panel);
          if (!ul) {
            ul = document.createElement("ul");
            ul.id = "categoryChecklist";
            ul.className = "category-checklist";
            tkDiv.appendChild(ul);
          }
          return { panel, ul };
        }

        async function tryFetchJSON(urls) {
          for (const url of urls) {
            if (!url) continue;
            try {
              const res = await fetch(url, { credentials: "same-origin" });
              if (!res.ok) {
                log("skip", url, res.status);
                continue;
              }
              const json = await res.json();
              log("loaded", url);
              return json;
            } catch (err) {
              log("fail", url, err.message);
            }
          }
          return null;
        }

        function parseCategoryArray(maybe) {
          if (!maybe) return [];
          if (Array.isArray(maybe)) return maybe;
          if (Array.isArray(maybe.categories)) return maybe.categories;
          if (maybe.data && Array.isArray(maybe.data.categories)) return maybe.data.categories;
          if (Array.isArray(maybe.data)) return maybe.data;
          return [];
        }

        function deriveCategoriesFromKinks(source) {
          if (!source) return [];
          const collected = new Set();
          const push = (value) => {
            if (value != null) {
              const trimmed = String(value).trim();
              if (trimmed) collected.add(trimmed);
            }
          };
          const visit = (arr) => {
            if (!Array.isArray(arr)) return;
            arr.forEach((item) => {
              if (item && typeof item === "object") {
                push(item.category || item.cat || item.Category || item.group);
              } else {
                push(item);
              }
            });
          };
          if (Array.isArray(source)) {
            visit(source);
          } else if (typeof source === "object") {
            visit(source.items);
            visit(source.kinks);
            visit(source.data);
            if (!collected.size) {
              Object.keys(source).forEach((key) => {
                const maybeArr = source[key];
                if (Array.isArray(maybeArr)) {
                  push(key);
                }
              });
            }
          }
          return Array.from(collected).sort();
        }

        function wire(panel) {
          const ul = $("#categoryChecklist", panel);
          if (!ul) return;

          const btn = $("#startSurveyBtn") || $("#btnStart") || $("[data-tk-start]");
          const selEl = $("#categorySelectedCount") || $("#tkCatSel");
          const totEl = $("#categoryTotalCount");
          const prestartCount = $("#prestartCount");

          const total = captureFromDom(ul);
          const totalCount = catByValue.size || total;
          if (totEl && totalCount) totEl.textContent = String(totalCount);

          const update = () => {
            const values = selectedValues(ul);
            const count = values.length;
            if (selEl) selEl.textContent = String(count);
            if (prestartCount) prestartCount.textContent = String(count);
            if (btn) {
              btn.disabled = count === 0;
              if ("classList" in btn) {
                btn.classList.toggle("tk-disabled", count === 0);
              }
              btn.setAttribute("aria-disabled", count === 0 ? "true" : "false");
            }
            panel.dispatchEvent(new CustomEvent("tk:categories:change", {
              bubbles: true,
              detail: {
                selected: values,
                labels: values.map((v) => catByValue.get(v) || v),
                countSelected: count,
                total: totalCount
              }
            }));
          };

          ul.addEventListener("change", (event) => {
            if (event.target?.matches('input[type="checkbox"]')) update();
          });

          if (btn) {
            btn.addEventListener("click", (event) => {
              if (btn.disabled) {
                event.preventDefault();
                return;
              }
              const values = selectedValues(ul);
              const detail = {
                selected: values,
                labels: values.map((v) => catByValue.get(v) || v),
                countSelected: values.length,
                total: totalCount
              };
              exitPrestart();
              panel.dispatchEvent(new CustomEvent("tk:survey:start", {
                bubbles: true,
                detail
              }));
            });
          }

          if (!window.__TK_PRESTART_EXIT_WIRED__) {
            window.__TK_PRESTART_EXIT_WIRED__ = true;
            document.addEventListener("tk:survey:start", exitPrestart);
          }
          panel.addEventListener("tk:survey:start", exitPrestart);

          update();
        }

        async function main() {
          const { panel, ul } = getHost();
          await sleep(200);

          if (ul.children.length > 0) {
            log("Existing bootstrap populated; wiring only.");
            wire(panel);
            return;
          }

          const catsJson = await tryFetchJSON(["/kinksurvey/data/categories.json", "/data/categories.json"]);
          let entries = parseCategoryArray(catsJson);

          if (!entries.length) {
            const kinksJson = await tryFetchJSON(["/kinksurvey/data/kinks.json", "/data/kinks.json"]);
            entries = deriveCategoriesFromKinks(kinksJson);
          }

          if (!entries.length) {
            warn("No categories found (both categories.json & kinks.json empty/unavailable).");
            return;
          }

          const normalized = [];
          const seen = new Set();
          entries.forEach((entry, idx) => {
            const name = toName(entry, idx).trim();
            if (!name) return;
            const key = name.toLowerCase();
            if (seen.has(key)) return;
            seen.add(key);
            const value = toValue(entry, name, normalized.length);
            normalized.push({ name, value });
          });

          normalized.sort((a, b) => a.name.localeCompare(b.name));
          render(ul, normalized);
          wire(panel);
          log(`Rendered ${normalized.length} categories.`);
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", main, { once: true });
        } else {
          main();
        }
      })();
    </script>

    <script>
      /* ------------------------------------------------------------------
         TK /kinksurvey bootstrap — robust wait + optional enhancer inject
         This runs ONLY on /kinksurvey/ and leaves the landing page alone.
      ------------------------------------------------------------------- */
      (function () {
        if (!location.pathname.startsWith('/kinksurvey/')) return;

        // 1) Version token for cache busting (keep this in sync for /kinksurvey)
        const VER = 'ks-20241020d';

        // 2) Where the enhancer lives (adjust if your path differs)
        const ENHANCER_SRC = '/assets/js/tk-enhancer.js?v=' + encodeURIComponent(VER);

        // 3) Small utilities
        function onReady(fn) {
          document.readyState !== 'loading'
            ? fn()
            : document.addEventListener('DOMContentLoaded', fn);
        }

        function sleep(ms) {
          return new Promise((r) => setTimeout(r, ms));
        }

        function exists(fnName) {
          return typeof window[fnName] === 'function';
        }

        function findEnhancerScript() {
          return Array.from(document.scripts).find((s) => (s.src || '').includes('/assets/js/tk-enhancer.js'));
        }

        async function ensureEnhancerLoaded() {
          // Already present and loaded?
          if (exists('setupDockedSurveyLayout')) return true;

          // If script tag exists but may not have executed yet, wait briefly
          const tag = findEnhancerScript();
          if (tag && !tag.dataset.tkLoadedOnce) {
            for (let i = 0; i < 40; i++) {
              // ~2s max
              if (exists('setupDockedSurveyLayout')) return true;
              await sleep(50);
            }
          }

          // If still not present, inject it now and wait for load
          if (!findEnhancerScript()) {
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = ENHANCER_SRC;
              s.async = true;
              s.onload = () => resolve();
              s.onerror = () => reject(new Error('Failed to load enhancer: ' + ENHANCER_SRC));
              document.head.appendChild(s);
            }).catch((err) => {
              console.warn('[TK] Could not inject enhancer:', err);
            });
          }

          // Final wait loop after injection (or if it existed but was slow)
          for (let i = 0; i < 100; i++) {
            // ~5s max
            if (exists('setupDockedSurveyLayout')) return true;
            await sleep(50);
          }
          return false;
        }

        // 4) Attempt to mount using whatever API is available
        function mountDockNow() {
          // Preferred single entry-point (exported by tk-enhancer.js per prior instructions)
          if (exists('setupDockedSurveyLayout')) {
            try {
              window.setupDockedSurveyLayout();
              return true;
            } catch (e) {
              console.error('[TK] setupDockedSurveyLayout threw:', e);
              return false;
            }
          }

          // Fallback: some builds expose the pieces separately on window or TK
          const NS = window.TK || window;
          const a = NS.ensureDockLayoutNodes;
          const b = NS.mountDockPanel;
          const c = NS.mountDockActions;
          if ([a, b, c].every((fn) => typeof fn === 'function')) {
            try {
              a();
              b();
              c();
              return true;
            } catch (e) {
              console.error('[TK] Dock pieces threw:', e);
              return false;
            }
          }
          return false;
        }

        // 5) Full boot sequence: after DOM, ensure enhancer, then mount
        onReady(async function () {
          // Give survey.js a tiny head-start to build initial DOM
          await sleep(0);

          const ok = await ensureEnhancerLoaded();
          if (!ok) {
            console.warn('[TK] Enhancer not ready – cannot mount docked layout.');
            return;
          }

          // Try mounting immediately
          if (mountDockNow()) return;

          // If mount fails because survey content hasn’t painted yet, retry shortly
          for (let i = 0; i < 40; i++) {
            // ~2s
            await sleep(50);
            if (mountDockNow()) return;
          }

          console.warn('[TK] Dock mount gave up after retries.');
        });
      })();
  </script>

<!-- ================== TK ONE-BOX (paste at the VERY BOTTOM of /kinksurvey/index.html, before </body>) ==================
Adds/keeps the 3 stacked buttons at the TOP-RIGHT (under the title, beside Categories),
makes the LEFT category panel longer & sticky, defeats any “prestart hide”, and cache-busts
critical assets so the page doesn’t go blank when DevTools is closed.
======================================================================================================================== -->

<!-- ===== FINAL TK ONE-BOX PATCH (drop at the VERY BOTTOM of /kinksurvey/index.html, before </body>) =====
What this does:
• Puts the 3 stacked buttons at the TOP-RIGHT under the title (beside Categories)
• Makes the LEFT category panel tall & sticky
• POPULATES the category checklist at load from /kinksurvey/data/categories.json
  (falls back to deriving names from /kinksurvey/data/kinks.json)
• Keeps buttons visible after Start; enables Start when ≥1 category selected
======================================================================================================== -->

<style>
  /* two-column shell */
  #tkPortal{ display:grid; grid-template-columns:380px 1fr; gap:28px; align-items:start; }
  @media (max-width:980px){ #tkPortal{ grid-template-columns:1fr; } }

  /* left: tall sticky category panel */
  #categoryPanel, .category-panel{
    grid-column:1; grid-row:1;
    position:sticky; top:16px;
    max-height:calc(100dvh - 32px);
    overflow:auto; scroll-behavior:smooth;
  }
  /* if a wrapper caps height, relax it */
  .tk-left{ max-height:calc(100vh - 5rem); overflow:auto; }
  @media (max-width:980px){ #categoryPanel, .category-panel{ position:relative; top:0; max-height:none; } }

  /* right: CTA stack */
  #tkPortal #ctaStack{ grid-column:2; grid-row:1; align-self:start; justify-self:start; max-width:560px; }
  #ctaStack.tk-stack{ display:grid; gap:14px; justify-items:stretch; }
  #ctaStack .btn{ width:100%; text-align:center; padding:14px 16px; border-radius:12px; font-weight:700; }
  #ctaStack .btn-ghost{ background:transparent; border:2px solid var(--tk-accent,#39e3ff); }
  #ctaStack .btn[disabled]{ opacity:.55; cursor:not-allowed; }

  /* list styles */
  #categoryChecklist{ list-style:none; margin:12px 0 16px; padding:0; }
  #categoryChecklist li{ display:flex; align-items:center; gap:10px; padding:8px 6px; border-radius:8px; cursor:pointer; }
</style>

<!-- CTA stack (safe if it already exists) -->
<nav id="ctaStack" class="tk-stack" style="display:grid;gap:14px;max-width:560px;">
  <button id="btnStart" class="btn btn-primary" disabled>Start Survey</button>
  <a id="btnKinkAnalysis" class="btn btn-ghost" href="/kinksurvey/analysis/">Individual Kink Analysis</a>
  <a id="btnCompatibility" class="btn btn-ghost" href="/kinksurvey/compat/">Compatibility Page</a>
</nav>

<script>
/* ---------- helpers ---------- */
const $ = sel => document.querySelector(sel);
const byId = id => document.getElementById(id);

/* keep CTAs visible even if another script hides them */
(function keepCTAs(){
  const cta=byId('ctaStack'); if(!cta) return;
  const show=()=>{cta.style.display=''; cta.classList.add('tk-stack');};
  new MutationObserver(()=>{ if(getComputedStyle(cta).display==='none') show(); })
    .observe(cta,{attributes:true,attributeFilter:['style','class']});
  const start=byId('btnStart'); if(start){ start.addEventListener('click',()=>{requestAnimationFrame(show); setTimeout(show,0);});}
})();

/* ---------- populate category checklist ---------- */
(async function buildCategoryPanel(){
  const panel = byId('categoryPanel') || $('.category-panel');
  const list  = byId('categoryChecklist') || (()=>{
    // create a UL if the theme didn't include one
    const ul = document.createElement('ul'); ul.id='categoryChecklist';
    (panel || document.body).appendChild(ul); return ul;
  })();
  const countSel = byId('categorySelectedCount') || (()=>{
    const span=document.createElement('span'); span.id='categorySelectedCount'; span.textContent='0'; return span;
  })();
  const countTot = byId('categoryTotalCount') || (()=>{
    const span=document.createElement('span'); span.id='categoryTotalCount'; span.textContent='0'; return span;
  })();

  // Try canonical list first
  async function fetchJSON(url){
    const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error(url+': '+res.status);
    return res.json();
  }
  let categories = [];
  try {
    // canonical names
    const cats = await fetchJSON('/kinksurvey/data/categories.json');
    categories = (Array.isArray(cats)?cats:cats.categories||[]).map(String);
  } catch(e1){
    try {
      // fallback: derive unique category names from kinks dataset
      const data = await fetchJSON('/kinksurvey/data/kinks.json');
      const names = new Set();
      (Array.isArray(data)?data:(data.kinks||[])).forEach(k=>{
        const c = (k.category||k.Category||'').toString().trim();
        if(c) names.add(c);
      });
      categories = Array.from(names).sort((a,b)=>a.localeCompare(b));
    } catch(e2){
      console.warn('[TK] categories load failed', e1, e2);
    }
  }

  // render list
  list.innerHTML='';
  const frag = document.createDocumentFragment();
  categories.forEach(name=>{
    const li = document.createElement('li');
    const id = 'tk-cat-' + name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
    li.innerHTML = `<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
      <input type="checkbox" id="${id}" value="${name}">
      <span>${name}</span>
    </label>`;
    frag.appendChild(li);
  });
  list.appendChild(frag);
  countTot.textContent = String(categories.length);

  // selection logic
  const startBtn = byId('btnStart');
  function recount(){
    const n = list.querySelectorAll('input[type="checkbox"]:checked').length;
    countSel.textContent = String(n);
    if(startBtn) startBtn.disabled = n === 0;
  }
  list.addEventListener('change', e=>{
    if(e.target && e.target.matches('input[type="checkbox"]')) recount();
  });
  recount(); // initial

  // expose selected categories when Start is clicked
  if(startBtn){
    startBtn.addEventListener('click', ()=>{
      const selected = Array.from(list.querySelectorAll('input:checked')).map(i=>i.value);
      document.dispatchEvent(new CustomEvent('tk:survey:start',{detail:{categories:selected}}));
      // if your runtime expects window.TKSurvey.start, call it
      if(window.TKSurvey?.start){ window.TKSurvey.start({categories:selected}); }
    });
  }
})();

/* ---------- keep panel tall on resize (fallback) ---------- */
(function keepTall(){
  const panel = byId('categoryPanel') || $('.category-panel'); if(!panel) return;
  const update = () => {
    const r = panel.getBoundingClientRect();
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight||0);
    panel.style.maxHeight = Math.max(260, vh - r.top - 16) + 'px';
  };
  requestAnimationFrame(update); addEventListener('resize', update);
})();
</script>

<!-- ==== TK LAYOUT UPDATE: Move theme selector under title + full-height category panel ==== -->
<style>
  /* --- Grid shell stays two columns; left = categories, right = CTAs/content --- */
  #tkPortal{
    display:grid;
    grid-template-columns:380px 1fr;
    gap:28px;
    align-items:start;
  }
  @media (max-width:980px){ #tkPortal{ grid-template-columns:1fr; } }

  /* --- FULL category panel (no sticky, no max-height cap) --- */
  #categoryPanel, .category-panel{
    grid-column:1;
    grid-row:auto;
    position:static !important;
    top:auto !important;
    max-height:none !important;
    overflow:visible !important;   /* the page scrolls instead of the panel */
  }

  /* Optional: make the inner list itself scroll if it’s extremely long on small screens */
  @media (max-height:680px){
    #categoryChecklist{ max-height:70vh; overflow:auto; }
  }

  /* --- CTA stack remains in the right column --- */
  #ctaStack{ grid-column:2; grid-row:auto; max-width:560px; }
  #ctaStack.tk-stack{ display:grid; gap:14px; justify-items:stretch; }

  /* --- THEME bar directly under the title (full-width row) --- */
  .tk-theme-row{
    grid-column:1 / -1;         /* span both columns */
    display:flex; flex-wrap:wrap;
    gap:12px; align-items:center; justify-content:center;
    margin:-6px 0 18px;          /* snuggle up under the title */
  }
  .tk-theme-row .tk-theme-label{
    opacity:.9; font-weight:700; letter-spacing:.02em; margin-right:6px;
  }
</style>

<script>
(function moveThemeBarUnderTitle(){
  const theme =
    document.querySelector('#themePicker, #themeSwitch, #themeBar, [data-theme-picker], .theme-picker')
    || (() => {
         const candidates = Array.from(document.querySelectorAll('nav, .toolbar, .controls, .theme, .themes, .btn-row, .button-row'));
         return candidates.find(el => /dark|forest|lipstick|blue/i.test(el.textContent || ''));
       })();
  if (!theme) return;

  const title = document.querySelector('#tkTitle, .portal-title, header h1, main h1, h1');
  if (!title) return;

  let row = theme.closest('.tk-theme-row');
  if (!row){
    row = document.createElement('div');
    row.className = 'tk-theme-row';
    if (!/theme/i.test(theme.textContent)) {
      const lbl = document.createElement('span');
      lbl.className = 'tk-theme-label';
      lbl.textContent = 'THEME';
      row.appendChild(lbl);
    }
    theme.parentElement.insertBefore(row, theme);
    row.appendChild(theme);
  }

  title.parentElement.insertBefore(row, title.nextSibling);
})();

(function unlockCategoryPanel(){
  const panel = document.getElementById('categoryPanel') || document.querySelector('.category-panel');
  if (!panel) return;
  const unlock = () => {
    panel.style.position   = 'static';
    panel.style.top        = 'auto';
    panel.style.maxHeight  = 'none';
    panel.style.overflow   = 'visible';
  };
  unlock();
  new MutationObserver(unlock).observe(panel, { attributes:true, attributeFilter:['style','class'] });
})();
</script>

  </body>
</html>
