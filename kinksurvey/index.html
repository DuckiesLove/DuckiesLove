<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Talk Kink</title>
<base href="/" />
<meta http-equiv="Cache-Control" content="no-store, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<!-- Reuse site styles for familiar look; local CSS below makes panel behave like /kinks/ -->
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/theme.css">
<link rel="stylesheet" href="/css/kinksurvey_overrides.css?v=ks-20240927b">

<!-- TK/kinksurvey: center hero + real off-canvas panel -->
<style>
  /* Scope to this page only */
  body.tk-ksv { overflow-x: hidden; }

  /* Hero section */
  #ksvHeroStack{
    display:grid;
    place-items:center;
    gap: clamp(18px, 2.6vh, 28px);
    margin: clamp(28px, 6vh, 72px) auto 4vh;
    padding: 0 4vw;
    max-width: 1100px;
    transition: transform 280ms ease;
  }
  #ksvHeroStack h1{
    margin:0 0 clamp(16px, 2.4vw, 28px) 0;
    font-size: clamp(36px, 5.2vw, 72px);
    line-height: 1.06;
    font-weight: 800;
    letter-spacing:.02em;
    color:#fff;
    text-align:center;
  }
  .ksvButtons{
    display:grid;
    width:100%;
    max-width:none;
    margin:0 auto;
    gap: clamp(14px, 1.8vh, 18px);
  }
  .ksvBtn{
    display:flex; align-items:center; justify-content:center;
    box-sizing:border-box;
    width: clamp(260px, 46vw, 620px);
    max-width:620px;
    margin-left:auto;
    margin-right:auto;
    padding: clamp(10px, 1.2vw, 16px) clamp(16px, 2.2vw, 22px);
    border-radius: 16px;
    border: 2px solid rgba(0,230,255,.9);
    background: rgba(0,0,0,.25);
    box-shadow: 0 0 0 2px rgba(0,230,255,.15) inset, 0 6px 24px rgba(0,0,0,.35);
    color:#d9ffff; font-weight:800;
    font-size: clamp(18px, 2.1vw, 28px);
    line-height:1; text-decoration:none; text-align:center;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .ksvBtn:hover{ transform: translateY(-1px); background: rgba(0,230,255,.08); }
  .ksvBtn:active{ transform: translateY(0); }

  .ksvThemeRow{
    display:flex;
    flex-wrap:wrap;
    gap: 12px;
    justify-content:center;
    width: min(920px, 92vw);
  }
  .ksvThemeRow label{
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:center;
    font-weight:600;
    color:#d9ffff;
  }

  /* OFF-CANVAS CATEGORY PANEL (real off-canvas so it doesn't push hero) */
  .category-panel{
    position: fixed !important; top:0; left:0;
    height:100vh; width: clamp(320px, 36vw, 520px); max-width:92vw;
    background: var(--tk-panel-bg, rgba(5,18,24,.98));
    border-right: 1px solid rgba(0,230,255,.35);
    overflow:auto; -webkit-overflow-scrolling:touch;
    transform: translateX(-110%); visibility:hidden; pointer-events:none;
    transition: transform 280ms ease, visibility 0s linear 280ms;
    z-index: 2147483000;
  }
  .category-panel.open{ transform: translateX(0); visibility:visible; pointer-events:auto; transition: transform 280ms ease; }

  /* Slight nudge so hero isn’t tucked under the open panel edge */
  body.tk-panel-open #ksvHeroStack{ transform: translateX(clamp(8px, 1.6vw, 22px)); }

  /* Small screens */
  @media (max-width: 720px) {
    #ksvHeroStack{ gap: 18px; margin-top: 6vh; }
    .ksvThemeRow{ flex-direction:column; align-items:center; }
  }
</style>

<style>
  :root { --panel-w: 320px; --tk-drawer-w: clamp(340px, 92vw, 980px); --bg:#000; --fg:#e6ffff; --accent:#00e6ff; --line:#00e5ff33; }
  html,body{height:100%}
  body{
    margin:0;
    background:#000;
    color:var(--fg);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
  }

  /* LEFT SIDE PANEL (classic /kinks/ feel) */
  #panelToggle{
    position:fixed; left:12px; top:12px; z-index:2147483648;
    background:#06161a; border:1px solid var(--line); color:var(--fg);
    border-radius:10px; padding:8px 12px; cursor:pointer;
  }
  .category-panel{
    background:#071317;
    padding:14px 14px 18px;
    overflow:auto;
    text-align:center;
  }

  body.panel-open,
  body.drawer-open,
  body.tk-drawer-open,
  body.tk-panel-open { overflow:hidden; }

  .category-panel .ksv-close{
    position:sticky;
    top:0;
    z-index:1;
    display:flex;
    justify-content:flex-end;
    padding:12px 12px 0 12px;
    background:linear-gradient(180deg, rgba(10,15,20,1) 70%, rgba(10,15,20,0) 100%);
  }

  [data-ksv-close]{
    -webkit-tap-highlight-color:transparent;
    appearance:none;
    border:2px solid rgba(0,255,255,.55);
    color:#a9fbff;
    background:rgba(0,255,255,.08);
    font:700 16px/1.1 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
    border-radius:14px;
    padding:10px 14px;
    cursor:pointer;
    box-shadow:0 0 0 0 rgba(0,255,255,.35);
    transition:box-shadow .15s ease, transform .05s ease, background .15s ease;
  }
  [data-ksv-close]:hover{ background:rgba(0,255,255,.12); }
  [data-ksv-close]:active{ transform:translateY(1px); }
  [data-ksv-close]:focus-visible{
    outline:none;
    box-shadow:0 0 0 3px rgba(0,255,255,.35);
  }

  #tkScrim{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    backdrop-filter:blur(1px);
    opacity:0;
    pointer-events:none;
    transition:opacity .2s ease;
    z-index:9999;
  }

  body.tk-drawer-open #tkScrim,
  body.tk-panel-open #tkScrim{
    opacity:1;
    pointer-events:auto;
  }

  .tk-close-drawer{
    position:sticky;
    top:0;
    margin:10px 10px 8px auto;
    padding:.55rem .9rem;
    border-radius:10px;
    cursor:pointer;
    background:#0a0f14;
    color:#aefcff;
    border:1px solid #00e6ff55;
  }

  /* Shift content when panel open */
  .content{
    margin:0 auto;
    padding:24px 16px;
    max-width:1000px;
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
  }
  .content.full{ margin:0 auto; }

  .themed-button, .category-button{
    padding:12px 18px; border:2px solid rgba(0,230,255,.55);
    border-radius:10px; background:transparent; color:#eaffff;
    font-weight:700; letter-spacing:.2px; cursor:pointer;
  }
  .themed-button:hover, .category-button:hover{
    border-color:rgba(0,230,255,.9); box-shadow:0 0 0 2px rgba(0,230,255,.18) inset;
  }

  .category-list{ display:grid; grid-template-columns:1fr; gap:10px; justify-items:center; }
  .category-list label{
    display:flex; gap:10px; align-items:center; justify-content:center; padding:8px 10px;
    border:1px solid var(--line); border-radius:10px; background:#060b0f; cursor:pointer;
    text-align:center;
  }

  .panel-title{ margin:6px 0 10px; font-weight:800; color:#7ef9ff; }
  .top-buttons{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }

  .panel-title, #statusMsg, #diag{ text-align:center; }

  .survey-box{
    border:1px solid var(--line); border-radius:12px; background:#0a0f14; padding:16px;
    max-width:1000px; margin:0 auto;
    text-align:center;
  }
  .catTitle{ margin:0 0 8px; color:#7ef9ff }
  .item{ display:flex; align-items:center; justify-content:center; gap:10px; padding:8px 0; border-top:1px dashed #00e5ff22; text-align:center; flex-wrap:wrap; }
  .item:first-child{ border-top:0; }
  select,input[type=text]{ padding:6px 8px; border:1px solid #115; border-radius:8px; background:#06161a; color:var(--fg); }

  .notice{ margin:14px 0; padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#071317; text-align:center; }
</style>
</head>
<body class="theme-dark has-category-panel">

<button id="panelToggle" class="panel-toggle" aria-controls="categorySurveyPanel" aria-expanded="false">☰</button>

<aside id="categorySurveyPanel" class="category-panel" role="region" aria-label="Category selection" aria-hidden="true" data-ksv-panel>
  <h2 class="panel-title">Select categories</h2>
  <div class="top-buttons">
    <button id="selectAll" class="themed-button category-button">Select All</button>
    <button id="deselectAll" class="themed-button category-button">Deselect All</button>
  </div>
  <div id="statusMsg" class="themed-text" style="opacity:.85;margin:10px 0 8px">Loading categories…</div>
  <div id="categoryList" class="category-list" role="list"></div>
  <div style="display:flex;justify-content:center;margin-top:12px">
    <button id="start" class="themed-button start-survey-btn" disabled>Start Survey</button>
  </div>
  <div id="diag" class="notice" style="display:none"></div>
</aside>

<main id="content" class="content full">
  <div class="survey-box" id="survey" style="display:none">
    <h2 class="catTitle" id="catTitle"></h2>
    <div id="items"></div>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:12px">
      <button class="themed-button" id="skip">Skip Category</button>
      <button class="themed-button" id="next">Next Category</button>
    </div>
  </div>

  <div id="done" class="notice" style="display:none; max-width:1000px; margin:18px auto 0">
    <h3>Survey complete!</h3>
    <p>You’ve reached the end of the selected categories. <a href="/" style="color:#00e6ff">Back to home</a></p>
  </div>
</main>

<script>
(async function(){
  // Keep your existing data sources (will use your published dataset when present)
  const DATA_URLS=['/data/kinks.json','/kinks.json','./data/kinks.json','./kinks.json'];

  // Elements
  const $ = (id)=>document.getElementById(id);
  const panel = $('categorySurveyPanel');
  const toggle = $('panelToggle');
  const list = $('categoryList');
  const status = $('statusMsg');
  const startBtn = $('start');
  const diag = $('diag');
  const survey = $('survey');
  const title = $('catTitle');
  const items = $('items');
  const done = $('done');

  let scrim = document.getElementById('tkScrim');
  if (!scrim){
    scrim = document.createElement('div');
    scrim.id = 'tkScrim';
    document.body.appendChild(scrim);
  }
  scrim.setAttribute('data-ksv-backdrop','');

  if (panel){
    panel.setAttribute('aria-expanded','false');
    panel.setAttribute('data-ksv-panel','');
    if (!panel.querySelector('[data-ksv-close]')){
      const stickyRow = document.createElement('div');
      stickyRow.className = 'ksv-close';
      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = 'tk-close-drawer';
      closeBtn.setAttribute('data-ksv-close','');
      closeBtn.setAttribute('aria-label','Close categories panel');
      closeBtn.textContent = 'Close ✕';
      closeBtn.addEventListener('click', ()=>closeDrawer({ focusToggle: true }));
      stickyRow.appendChild(closeBtn);
      panel.prepend(stickyRow);
    }
  }

  const triggerSelectors = ['#startSurvey','#startSurveyBtn','#start','#tkHeroStart','[data-start-survey="1"]'];
  const triggerSelectorList = triggerSelectors.join(',');
  const findOpenTrigger = () => {
    const explicit = document.querySelector('[data-ksv-start]');
    if (explicit) return explicit;
    for (const sel of triggerSelectors){
      const node = document.querySelector(sel);
      if (node) return node;
    }
    return null;
  };

  let lastOpenTrigger = null;

  function setDrawerState(open){
    const want = Boolean(open);
    if (panel){
      panel.classList.toggle('open', want);
      panel.classList.toggle('is-open', want);
      panel.setAttribute('aria-expanded', want ? 'true' : 'false');
      panel.setAttribute('aria-hidden', want ? 'false' : 'true');
    }
    document.body.classList.toggle('panel-open', want);
    document.body.classList.toggle('tk-panel-open', want);
    document.body.classList.toggle('tk-drawer-open', want);
    document.body.classList.toggle('ksv-lock', want);
    toggle?.setAttribute('aria-expanded', want ? 'true' : 'false');
    if (scrim){
      scrim.style.opacity = want ? '1' : '0';
      scrim.style.pointerEvents = want ? 'auto' : 'none';
      scrim.classList.toggle('is-open', want);
    }
  }

  function openDrawer(options = {}){
    const { focusFirst = true, trigger = null, focusTarget = null } = options;
    lastOpenTrigger = trigger || focusTarget || lastOpenTrigger || findOpenTrigger();
    setDrawerState(true);
    if (focusFirst){
      const focusTarget = panel?.querySelector('input,button,select,textarea,[tabindex]:not([tabindex="-1"])');
      if (focusTarget){
        setTimeout(()=>focusTarget.focus({ preventScroll: true }), 60);
      }
    }
  }

  function closeDrawer(options = {}){
    const { focusToggle = false } = options;
    setDrawerState(false);
    if (focusToggle){
      const focusReturn = options.focusTarget || lastOpenTrigger || findOpenTrigger() || toggle;
      if (focusReturn){
        setTimeout(()=>focusReturn.focus({ preventScroll: true }), 60);
      }
    }
    lastOpenTrigger = null;
  }

  window.tkKinksurveyOpenPanel = (opts) => openDrawer(opts || {});
  window.tkKinksurveyClosePanel = (opts) => closeDrawer(opts || {});

  setDrawerState(false);

  if (scrim && !scrim.dataset.tkBind){
    scrim.dataset.tkBind = '1';
    scrim.addEventListener('click', ()=>closeDrawer({ focusToggle: true }));
  }

  if (panel && !panel.dataset.tkStopProp){
    panel.dataset.tkStopProp = '1';
    panel.addEventListener('click', (event)=>event.stopPropagation());
  }

  window.addEventListener('keydown', (event)=>{
    if (event.key === 'Escape' && panel?.classList.contains('open')) closeDrawer({ focusToggle: true });
  });

  // Toggle panel open/closed (like /kinks/)
  if (toggle && !toggle.dataset.tkBind){
    toggle.dataset.tkBind = '1';
    toggle.addEventListener('click', (event)=>{
      event.preventDefault();
      const isOpen = panel?.classList.contains('open');
      if (isOpen) closeDrawer({ focusToggle: true, focusTarget: toggle });
      else openDrawer({ focusFirst: true, trigger: toggle });
    });
  }

  document.addEventListener('click', (event)=>{
    const trigger = event.target.closest(triggerSelectorList);
    if (!trigger || !panel || panel.contains(trigger)) return;
    event.preventDefault();
    openDrawer({ focusFirst: true, trigger });
  });

  const S = { cats:[], sel:[], i:0 };

  const tidy = s=>String(s??'').replace(/\s+/g,' ').trim();
  const looksHTML = t => /^\s*<!doctype html/i.test(t) || /<html[\s>]/i.test(t);

  async function fetchData(){
    const errs=[];
    for (const u of DATA_URLS){
      try{
        const r = await fetch(u,{cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const txt = await r.text();
        if (looksHTML(txt)) throw new Error('HTML fallback');
        return { json: JSON.parse(txt), src:u, errs };
      }catch(e){ errs.push(u+': '+(e?.message||e)); }
    }
    throw new Error('All dataset fetches failed:\n- '+errs.join('\n- '));
  }

  function normalize(raw){
    const out=[];
    const push=(name,items)=>{
      const cat=tidy(name); if(!cat) return;
      const arr=[];
      (items||[]).forEach(it=>{
        const id=tidy(it?.id||it?.key||it?.name||'');
        const label=tidy(it?.label||it?.text||'');
        const type=tidy(it?.type||'scale');
        if(id && label) arr.push({id,label,type});
      });
      if(arr.length) out.push({category:cat, items:arr});
    };
    if (Array.isArray(raw)) raw.forEach(x=>push(x?.category ?? x?.name, x?.items));
    else if (raw && typeof raw==='object') Object.entries(raw).forEach(([k,v])=>push(k,v));
    return out;
  }

  function renderPanel(cats){
    list.innerHTML='';
    cats.forEach(c=>{
      const id='cb_'+Math.random().toString(36).slice(2,7);
      const row=document.createElement('label');
      row.setAttribute('role','listitem');
      row.innerHTML = `<input class="category-checkbox" type="checkbox" id="${id}" value="${c.category}"> <span>${c.category}</span>`;
      list.appendChild(row);
    });
    updateStart();
  }

  const selected = () => Array.from(document.querySelectorAll('.category-checkbox')).filter(cb=>cb.checked).map(cb=>cb.value);

  function updateStart(){
    const n = selected().length;
    startBtn.disabled = !n;
    status.textContent = n ? `${n} selected` : 'Choose one or more categories';
  }

  function showDiag(msg){ diag.style.display='block'; diag.textContent=msg; }

  function renderCat(i){
    const c = S.sel[i];
    if(!c){
      survey.style.display='none';
      done.style.display='block';
      return;
    }
    done.style.display='none';
    survey.style.display='block';
    title.textContent=c.category;
    items.innerHTML='';
    c.items.forEach(it=>{
      const row=document.createElement('div'); row.className='item';
      const id='k_'+it.id;
      let ctl='';
      const t=(it.type||'').toLowerCase();
      if (t==='bool') ctl = `<input type="checkbox" id="${id}" name="${it.id}">`;
      else if (t==='text') ctl = `<input type="text" id="${id}" name="${it.id}" placeholder="Your note">`;
      else ctl = `<select id="${id}" name="${it.id}">${[1,2,3,4,5].map(v=>`<option>${v}</option>`).join('')}</select>`;
      row.innerHTML = `${ctl} <label for="${id}">${it.label}</label>`;
      items.appendChild(row);
    });
  }

  // Bindings
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.classList && e.target.classList.contains('category-checkbox')) updateStart();
  });
  document.getElementById('selectAll').addEventListener('click', ()=>{
    document.querySelectorAll('.category-checkbox').forEach(cb=>cb.checked=true); updateStart();
  });
  document.getElementById('deselectAll').addEventListener('click', ()=>{
    document.querySelectorAll('.category-checkbox').forEach(cb=>cb.checked=false); updateStart();
  });

  startBtn.addEventListener('click', ()=>{
    const want = new Set(selected().map(s=>s.toLowerCase()));
    S.sel = S.cats.filter(c=>want.has(c.category.toLowerCase()));
    S.i = 0;
    if (!S.sel.length){ showDiag('No matching categories in dataset.'); return; }
    // Collapse the panel like the classic page
    closeDrawer({ focusToggle: false });
    renderCat(S.i);
  });
  document.getElementById('skip').addEventListener('click', ()=>{ S.i++; renderCat(S.i); });
  document.getElementById('next').addEventListener('click', ()=>{ S.i++; renderCat(S.i); });

  // Boot
  try{
    const {json,src,errs} = await fetchData();
    S.cats = normalize(json);
    renderPanel(S.cats);
    status.textContent = `Loaded ${S.cats.length} categories`;
    if (errs?.length) showDiag('Fetch notes:\n- ' + errs.join('\n- '));
  }catch(e){
    showDiag((e?.message||e) + '\nThis page will populate once /data/kinks.json is published.');
    status.textContent = 'Dataset unavailable';
  }
})();
</script>
<!-- One-time SW/cache buster (also triggers when ?tkreset=1) -->
<script>
(function(){
  const VER = 'ks-20240927b';
  try {
    const k = 'tk_ks_ver';
    const sp = new URL(location.href).searchParams;
    const mustReset = sp.has('tkreset') || localStorage.getItem(k) !== VER;
    if (mustReset) {
      if ('caches' in window) {
        caches.keys().then(ks => Promise.all(ks.map(n => caches.delete(n))));
      }
      if (navigator.serviceWorker && navigator.serviceWorker.getRegistration) {
        navigator.serviceWorker.getRegistration().then(r => r && r.unregister());
      }
      localStorage.setItem(k, VER);
    }
  } catch (_) {}
})();
</script>
<!-- load enhancer last so it can find the existing DOM (versioned URL to beat stale caches) -->
<script type="module" src="/js/tk_kinksurvey_enhance.js?v=ks-20240927b"></script>
<!-- Self-heal: if hero didn't appear quickly (stale inline/partial), retry loading once -->
<script>
setTimeout(() => {
  if (!document.getElementById('ksvHeroStack')) {
    const s = document.createElement('script');
    s.type = 'module';
    s.src = '/js/tk_kinksurvey_enhance.js?v=ks-20240927b&retry=1';
    document.head.appendChild(s);
  }
}, 800);
</script>

<style id="ksv-overrides">
  /* Backdrop */
  #ksv-backdrop{
    position:fixed; inset:0; z-index:2147483646;
    background:rgba(0,0,0,.55);
    opacity:0; pointer-events:none; transition:opacity .18s ease;
  }
  #ksv-backdrop.is-open{ opacity:1; pointer-events:auto; }

  /* Slide-out panel */
  #ksv-panel{
    position:fixed; top:0; right:0; height:100dvh;
    width:min(620px,92vw); max-width:620px;
    z-index:2147483647; background:#0c0f10; color:#dffcff;
    transform:translateX(110%); transition:transform .24s ease;
    box-shadow:-2px 0 24px rgba(0,0,0,.45);
    border-left:2px solid rgba(0,255,255,.25);
    display:flex; flex-direction:column; overflow:auto; -webkit-overflow-scrolling:touch;
  }
  #ksv-panel.is-open{ transform:translateX(0); }

  /* If any stylesheet tries to blur/dim/disable the panel, kill it */
  #ksv-panel.is-open,
  #ksv-panel.is-open *{
    opacity:1 !important;
    filter:none !important;
    -webkit-filter:none !important;
    pointer-events:auto !important;
    user-select:auto !important;
  }

  /* Some themes “fold” panels on focus-within; keep it open */
  :where(#ksv-panel:focus-within, .ksv-shell:focus-within #ksv-panel){ transform:translateX(0)!important; }

  /* Prevent body scroll while open */
  body.ksv-lock{ overflow:hidden; }

  /* Header + Close button */
  #ksv-header{
    position:sticky; top:0; z-index:1; display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding:12px 12px 10px;
    background:linear-gradient(180deg, rgba(12,15,16,1) 70%, rgba(12,15,16,0) 100%);
    border-bottom:1px solid rgba(0,255,255,.15);
  }
  #ksv-title{ font:700 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; letter-spacing:.2px; color:#dffcff; }
  #ksv-close{
    -webkit-tap-highlight-color:transparent;
    appearance:none; cursor:pointer;
    border:2px solid rgba(0,255,255,.55); color:#a9fbff; background:rgba(0,255,255,.08);
    font:700 16px/1.1 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    border-radius:14px; padding:10px 14px;
    transition:box-shadow .15s ease, transform .05s ease, background .15s ease;
  }
  #ksv-close:hover{ background:rgba(0,255,255,.12); }
  #ksv-close:active{ transform:translateY(1px); }
  #ksv-close:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(0,255,255,.35); }

  #ksv-content{ padding:8px 12px 20px; }
  #ksv-panel .ksv-soft-card{ background:rgba(255,255,255,.02); border-radius:12px; border:1px solid rgba(0,255,255,.15); }

  /* >>> HARD OVERRIDES against site-level blur/dim layers <<< */
  html.ksv-open, body.ksv-open{
    filter:none !important; -webkit-filter:none !important; opacity:1 !important;
    pointer-events:auto !important;
  }
  html.ksv-open *, body.ksv-open *{
    filter:none !important; -webkit-filter:none !important; opacity:1 !important;
  }
  /* Hide common “dim/scrim/backdrop” elements except our own */
  html.ksv-open .modal-backdrop:not(#ksv-backdrop),
  html.ksv-open .overlay:not(#ksv-backdrop),
  html.ksv-open .dimmer:not(#ksv-backdrop),
  html.ksv-open .scrim:not(#ksv-backdrop),
  html.ksv-open [data-overlay]:not(#ksv-backdrop),
  html.ksv-open [data-dimmer]:not(#ksv-backdrop){
    display:none !important;
  }
</style>

<script>
(function(){
  const d = document;

  // Locate the "Start Survey" trigger
  const startBtn = [...d.querySelectorAll('a,button,input[type="button"],input[type="submit"]')]
    .find(el => /start\s*survey/i.test((el.textContent || el.value || '').trim()));

  // Find the existing categories UI
  function findCategoriesContainer(){
    const head = [...d.querySelectorAll('h1,h2,h3,legend,[role="heading"],.heading,.title,section,div')]
      .find(el => /select\s+categories/i.test((el.textContent || '').trim()));
    if (!head) return null;

    const count = el => el.querySelectorAll('input[type="checkbox"]').length;
    let node = head.closest('section,form,article,div') || head, hops = 0;
    while (node && count(node) < 5 && hops++ < 8) node = node.parentElement;

    if (node && count(node) >= 5) return node;

    let best = null, max = 0;
    for (const el of d.querySelectorAll('section,form,article,div')){
      const c = count(el); if (c > max){ max = c; best = el; }
    }
    return max >= 5 ? best : null;
  }

  const cats = findCategoriesContainer();
  if (!cats) return;

  // Build overlay once
  let backdrop = d.getElementById('ksv-backdrop');
  if (!backdrop){
    backdrop = d.createElement('div');
    backdrop.id = 'ksv-backdrop';
    d.body.appendChild(backdrop);
  }

  let panel = d.getElementById('ksv-panel');
  if (!panel){
    panel = d.createElement('div');
    panel.id = 'ksv-panel';
    panel.setAttribute('aria-hidden','true');

    const header = d.createElement('div');
    header.id = 'ksv-header';

    const title = d.createElement('div');
    title.id = 'ksv-title';
    title.textContent = 'Select categories';

    const close = d.createElement('button');
    close.id = 'ksv-close';
    close.type = 'button';
    close.setAttribute('aria-label','Close categories panel');
    close.textContent = 'Close ✕';

    const content = d.createElement('div');
    content.id = 'ksv-content';

    header.appendChild(title); header.appendChild(close);
    panel.appendChild(header); panel.appendChild(content);
    d.body.appendChild(panel);
  }
  const content = d.getElementById('ksv-content');
  const closeBtn = d.getElementById('ksv-close');

  // Move the existing categories UI into the panel
  if (!content.contains(cats)){
    cats.classList.add('ksv-soft-card');
    content.appendChild(cats);
  }

  /* ————— Hard kill any page-level blur/dim that affects the whole document ————— */
  function forceUndim(){
    document.documentElement.classList.add('ksv-open');
    document.body.classList.add('ksv-open');

    // In case a theme sets inline styles with !important on body/html
    [document.documentElement, document.body].forEach(el => {
      el.removeAttribute('inert');
      el.style.setProperty('filter','none','important');
      el.style.setProperty('-webkit-filter','none','important');
      el.style.setProperty('opacity','1','important');
      el.style.setProperty('pointer-events','auto','important');
    });

    // Strip “blur/dim/disabled” classes from body if present
    [...document.body.classList].forEach(c => {
      if (/(blur|dim|disabled|inactive)/i.test(c)) document.body.classList.remove(c);
    });
  }
  function relaxUndim(){
    document.documentElement.classList.remove('ksv-open');
    document.body.classList.remove('ksv-open');
    [document.documentElement, document.body].forEach(el => {
      el.style.removeProperty('filter');
      el.style.removeProperty('-webkit-filter');
      el.style.removeProperty('opacity');
      el.style.removeProperty('pointer-events');
    });
  }

  function scrubInteractivityBlocks(root){
    root.removeAttribute('inert');
    root.querySelectorAll('[inert]').forEach(n => n.removeAttribute('inert'));
    root.querySelectorAll('[aria-disabled="true"]').forEach(n => n.removeAttribute('aria-disabled'));
    root.querySelectorAll('[style]').forEach(n => {
      const s = n.getAttribute('style');
      if (/pointer-events\s*:\s*none/i.test(s)) n.style.pointerEvents = 'auto';
      if (/opacity\s*:\s*0\.\d+/i.test(s)) n.style.opacity = '1';
      if (/filter\s*:/i.test(s)) { n.style.filter = 'none'; n.style.webkitFilter = 'none'; }
    });
  }

  const legacyOpen = typeof window.tkKinksurveyOpenPanel === 'function'
    ? window.tkKinksurveyOpenPanel
    : null;
  const legacyClose = typeof window.tkKinksurveyClosePanel === 'function'
    ? window.tkKinksurveyClosePanel
    : null;

  function openPanel(){
    forceUndim();
    scrubInteractivityBlocks(panel);
    panel.classList.add('is-open');
    backdrop.classList.add('is-open');
    panel.setAttribute('aria-hidden','false');
    document.body.classList.add('ksv-lock');
    setTimeout(() => {
      (
        panel.querySelector('input[type="checkbox"]:not([disabled])') ||
        panel.querySelector('input,select,textarea,button,[tabindex]:not([tabindex="-1"])') ||
        closeBtn
      )?.focus({preventScroll:true});
    }, 10);
  }

  function closePanel(){
    panel.classList.remove('is-open');
    backdrop.classList.remove('is-open');
    panel.setAttribute('aria-hidden','true');
    document.body.classList.remove('ksv-lock');
    relaxUndim();
    startBtn?.focus?.({preventScroll:true});
  }

  const overlayAwareOpen = (opts) => {
    if (panel){
      openPanel(opts);
    }else if (legacyOpen){
      legacyOpen(opts);
    }
  };

  const overlayAwareClose = (opts) => {
    if (panel){
      closePanel(opts);
    }else if (legacyClose){
      legacyClose(opts);
    }
  };

  window.tkKinksurveyOpenPanel = overlayAwareOpen;
  window.tkKinksurveyClosePanel = overlayAwareClose;

  startBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopImmediatePropagation();
    overlayAwareOpen({ trigger: startBtn });
  });
  closeBtn.addEventListener('click', closePanel);
  backdrop.addEventListener('click', closePanel);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && backdrop.classList.contains('is-open')) closePanel(); });

  // Guard against global click-away handlers
  panel.addEventListener('click', (e) => e.stopPropagation());
  document.addEventListener('click', (e) => {
    if (!backdrop.classList.contains('is-open')) return;
    if (panel.contains(e.target)) e.stopPropagation();
  }, true);
})();
</script>
<!-- 🔧 HOTFIX: put this at the very BOTTOM of /kinksurvey/ (right before </body>)
     Goal: make the categories panel sit ABOVE the full-screen #tkScrim overlay.
     Why: when <body> gets .tk-panel-open the site shows #tkScrim (z-index: 9999, pointer-events: auto),
           but .category-panel is only z-index: 200 → the scrim captures all clicks and the panel
           looks “slightly transparent / unusable”.
     Fix: raise the panel’s stacking context (or, optionally, lower the scrim on this page). -->

<style id="tk-panel-zfix">
  /* ✅ Raise the categories panel above the scrim (target common selectors) */
  body.tk-panel-open .category-panel,
  body.tk-panel-open #categoryPanel,
  body.tk-panel-open .kink-categories-panel {
    /* keep it clickable and fully opaque even if global styles try to dim/blur */
    position: relative;                  /* ensure z-index creates a stacking context */
    z-index: 2147483000 !important;      /* higher than any app overlay/scrim */
    opacity: 1 !important;
    filter: none !important;
    -webkit-filter: none !important;
    pointer-events: auto !important;
  }

  /* (Optional) also make all children fully interactive if any dim/blur is inherited */
  body.tk-panel-open .category-panel *,
  body.tk-panel-open #categoryPanel *,
  body.tk-panel-open .kink-categories-panel * {
    opacity: 1 !important;
    filter: none !important;
    -webkit-filter: none !important;
    pointer-events: auto !important;
  }

  /* 🧯 Safety: if any framework adds 'inert' during open, neutralize it */
  body.tk-panel-open .category-panel[inert],
  body.tk-panel-open #categoryPanel[inert],
  body.tk-panel-open .kink-categories-panel[inert] {
    inert: false;
  }

  /* ———————————————————————————————————————————————————————————————
     (OPTION B – use ONE of these, only if you prefer lowering the scrim)
     This keeps the scrim visible but ensures it’s below the panel on this page.
     Comment OUT the block above if you choose this approach exclusively.
  -------------------------------------------------------------------- */
  /*
  body.tk-panel-open #tkScrim {
    z-index: 500 !important;   // lower than the panel but still above page content
  }
  */
</style>

<!-- Drop this near the end of /kinksurvey/index.html (right before </body>).
     It does all of the following in one go:

     1) Keeps the category panel ABOVE the scrim so it’s fully clickable.
     2) Locks the page while the panel is open (no scroll; scrim clicks/ESC won’t close).
     3) Hides the big landing buttons while the panel is open.
     4) On desktop, shows a compact 3-button rail in the blank space to the RIGHT of the panel.
     5) Mobile stays full-width (no right rail).
-->

<style>
  :root{
    --tk-rail-w: clamp(220px, 24vw, 340px); /* right rail width on desktop */
    --tk-cyan: #09d0d6;
  }

  /* 1) & 2) general page + scrim behavior while the panel is open */
  body.kinksurvey-page.tk-panel-open { overflow: hidden; }
  #tkScrim{ z-index: 9999 !important; }                    /* scrim high… */

  /* …but the actual category panel sits even higher and is fully opaque/clickable */
  body.kinksurvey-page.tk-panel-open .category-panel{
    position: fixed !important;
    inset: 0 auto 0 0 !important;                          /* left-aligned, full height */
    width: calc(100vw - var(--tk-rail-w)) !important;      /* leave room for right rail */
    height: 100vh !important;
    overflow: auto !important;
    z-index: 2147483000 !important;                        /* >> scrim */
    background: rgba(0,0,0,0.90) !important;               /* avoid “greyed/see-through” look */
    pointer-events: auto !important;                       /* ensure clicks land */
    box-shadow: 1px 0 0 0 rgba(9,208,214,.25);
  }

  /* 4) right-side compact actions rail (desktop only, visible only when panel is open) */
  #tkSideActions{
    position: fixed; right: 0; top: 0; height: 100vh;
    width: var(--tk-rail-w);
    padding: 1rem .9rem;
    display: none;                                         /* toggled by .tk-panel-open */
    flex-direction: column; gap: .8rem;
    background: rgba(0,0,0,.30);
    box-shadow: inset 0 0 0 1px rgba(9,208,214,.20);
    z-index: 2147483000;                                   /* >> scrim */
  }
  body.kinksurvey-page.tk-panel-open #tkSideActions{ display: flex; }
  #tkSideActions .tk-side-stack{
    margin-top: 5.25rem;                                   /* clear page title/header */
    display:flex; flex-direction:column; gap:.8rem;
  }

  /* compact button styling (kept independent from landing button CSS) */
  #tkSideActions .tk-mini-btn{
    all: unset;
    width: 100%;
    min-height: 44px;
    padding: .75rem .9rem;
    border-radius: 12px;
    border: 2px solid var(--tk-cyan);
    background: rgba(0,0,0,.22);
    color: var(--tk-cyan);
    font: 800 clamp(14px,1.25vw,17px)/1.15 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    letter-spacing: .02em;
    text-align: center;
    cursor: pointer;
    transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
  }
  #tkSideActions .tk-mini-btn:hover{
    transform: translateY(-1px);
    box-shadow: 0 0 0 3px rgba(9,208,214,.18);
  }
  #tkSideActions .tk-mini-btn.primary{
    background: var(--tk-cyan);
    color: #001315;
  }
  #tkSideActions .tk-mini-btn.primary:hover{
    box-shadow: 0 0 0 5px rgba(9,208,214,.22);
  }

  /* 3) hide the big landing buttons while the panel is open (no accidental clicks) */
  body.kinksurvey-page.tk-panel-open .tk-hide-when-panel{ display: none !important; }
  body.kinksurvey-page.tk-panel-open .tk-landing-actions{ display: none !important; }

  /* 5) mobile/tablet: panel uses full width; no right rail */
  @media (max-width: 1100px){
    body.kinksurvey-page.tk-panel-open .category-panel{ width: 100vw !important; }
    body.kinksurvey-page.tk-panel-open #tkSideActions{ display: none !important; }
  }
</style>

<!-- Right-side compact actions rail (desktop). Hidden on mobile.
     Shown only while the panel is open. -->
<div id="tkSideActions" aria-hidden="true">
  <div class="tk-side-stack">
    <button id="tkSideStart" class="tk-mini-btn primary">Start Survey</button>
    <a id="tkSideCompat" class="tk-mini-btn" href="/compatibility/">Compatibility Page</a>
    <a id="tkSideIndiv"  class="tk-mini-btn" href="/individualkinkanalysis.html">Individual Kink Analysis</a>
  </div>
</div>

<script>
/* Behavior glue:
   - Raises the panel above the scrim (fixes “grey/unclickable”).
   - Locks page while open; scrim clicks & ESC are ignored (panel is “locked”).
   - Hides the big landing buttons while the panel is open.
   - Right rail appears only while open (desktop). */
(function(){
  document.body.classList.add('kinksurvey-page');

  const HIDE_LABELS = ['Start Survey','Compatibility Page','Individual Kink Analysis'];

  function raisePanel(){
    const panel = document.querySelector('.category-panel');
    if(panel){
      panel.style.zIndex = '2147483000';
      panel.style.pointerEvents = 'auto';
      panel.style.opacity = '1';
    }
  }

  /* Tag the big landing buttons so we can hide them when panel opens */
  function tagLandingButtons(){
    const nodes = Array.from(document.querySelectorAll('a,button'));
    nodes.forEach(el=>{
      const txt = (el.textContent||'').replace(/\s+/g,' ').trim();
      if(HIDE_LABELS.some(lbl => txt.includes(lbl))){
        el.classList.add('tk-hide-when-panel');
        // compactly hide their nearest “group” wrapper so spacing collapses nicely
        let wrap = el.parentElement, hops = 0;
        while(wrap && hops<4){
          if(wrap.children.length>1){ wrap.classList.add('tk-landing-actions'); break; }
          wrap = wrap.parentElement; hops++;
        }
      }
    });
  }

  /* Click the real Start Survey (or dispatch a generic event hook) */
  function clickRealStart(){
    const real =
      document.querySelector('[data-start-survey]') ||
      document.querySelector('[data-action="start-survey"]') ||
      document.getElementById('startSurveyBtn') ||
      document.querySelector('button.start-survey, .start-survey');
    if(real){ real.click(); }
    else { window.dispatchEvent(new CustomEvent('tk:start-survey')); }
  }
  document.getElementById('tkSideStart').addEventListener('click', clickRealStart);

  /* Prevent scrim click & ESC from closing (panel stays until explicit Close) */
  const scrim = document.getElementById('tkScrim');
  if(scrim){
    scrim.addEventListener('click', e => { 
      if(document.body.classList.contains('tk-panel-open')){ e.stopPropagation(); e.preventDefault(); }
    }, true);
  }
  window.addEventListener('keydown', e => {
    if(document.body.classList.contains('tk-panel-open') && e.key === 'Escape'){ e.preventDefault(); }
  }, true);

  /* Ensure Close buttons actually close the panel */
  function closePanel(){
    document.body.classList.remove('tk-panel-open');
    const p = document.querySelector('.category-panel');
    if(p) p.style.zIndex = '200';
  }
  const closeCandidates = [
    '#tkPanelClose','[data-action="close-panel"]','.tk-panel-close',
    '.category-panel .close','.category-panel [aria-label="Close"]'
  ];
  closeCandidates.forEach(sel=>{
    document.querySelectorAll(sel).forEach(btn=>btn.addEventListener('click', closePanel));
  });

  /* Watch the body class so we re-raise the panel every time it opens */
  const watcher = new MutationObserver(() => {
    if(document.body.classList.contains('tk-panel-open')) raisePanel();
  });
  watcher.observe(document.body, { attributes:true, attributeFilter:['class'] });

  /* Initial tagging + initial raise if already open */
  tagLandingButtons();
  if(document.body.classList.contains('tk-panel-open')) raisePanel();

  /* In case DOM is injected a bit later */
  setTimeout(tagLandingButtons, 500);
})();
</script>
</body>
</html>
