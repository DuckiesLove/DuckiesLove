<!doctype html>
<html lang="en" class="theme-dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Talk Kink — Kink Survey</title>

    <!-- =====================  TalkKink • CODEx PASTE BLOCK  =====================
    Goal: Kill the overlay/portal that causes the page to flash, and keep the
    question/rating cards in normal page flow. Paste this ENTIRE block into
    /kinksurvey/ HTML <head>, ABOVE your normal survey script(s).
    ============================================================================= -->

    <!-- 1) Inline runtime: disables & hides any overlay/portal and prevents re-parenting -->
    <script>
    (() => {
      /* Persist flag so your app can skip overlay bootstrap entirely */
      try { localStorage.setItem('__TK_DISABLE_OVERLAY', '1'); } catch {}

      /* CSS: hide any overlay shells, disable animations to prevent flicker */
      const css = document.createElement('style');
      css.id = 'tk-no-overlay-css';
      css.textContent = `
        #tkPortal, #tkOverlay, .tkPortal, .tkOverlay, .tkDockShell,
        #tkDevOverlay, .tkDevOverlay, [data-tk-overlay], [data-portal] {
          display: none !important; opacity: 0 !important; visibility: hidden !important;
          pointer-events: none !important;
        }
        /* reduce the chance of a visible flash while layout settles */
        * { transition: none !important; animation: none !important; }
      `;
      document.head.appendChild(css);

      /* Remove any overlay nodes already in the DOM */
      const SEL = [
        '#tkPortal', '#tkOverlay', '.tkPortal', '.tkOverlay', '.tkDockShell',
        '#tkDevOverlay', '.tkDevOverlay', '[data-tk-overlay]', '[data-portal]'
      ].join(',');
      document.querySelectorAll(SEL).forEach(n => { try { n.remove(); } catch {} });

      /* Ensure the main app stays on top of any leftover artifacts */
      const app = document.querySelector('#surveyApp') || document.querySelector('main');
      if (app) { app.style.position = 'relative'; app.style.zIndex = '2147483640'; }

      /* Soft-block aggressive MutationObservers that try to portal content */
      (function guardMOs(root = window) {
        const MO = root.MutationObserver || root.WebKitMutationObserver;
        if (!MO || !MO.prototype) return;
        const _observe = MO.prototype.observe;
        MO.prototype.observe = function (target, config) {
          try {
            if ((target === document || target === document.body) &&
                config && (config.childList || config.subtree)) {
              return; // refuse whole-document childList observers that often portal
            }
          } catch {}
          return _observe.apply(this, arguments);
        };
      })();

      console.info('[TK] no-overlay inline runtime active (overlay disabled)');
    })();
    </script>

    <!-- 2) OPTIONAL: Let your own survey code read the flag and skip overlay bootstrap.
         Add the following guard at the VERY TOP of your main survey JS (survey.js):

         if (localStorage.getItem('__TK_DISABLE_OVERLAY') === '1') {
           console.info('[TK] Overlay bootstrap skipped');
           // Ensure panel wiring never uses overlay/drawer
           window.TK_PANEL_OPTS = { overlay: false, drawer: false, locked: false };
           // If your file has an explicit overlay init, return early before it runs:
           // return;
         }

         Also force your panel options where you build the UI:
         const PANEL_OPTS = Object.assign({ overlay:false, drawer:false, locked:false }, window.TK_PANEL_OPTS || {});
    -->

    <!-- 3) Load your normal survey script(s) AFTER the block above -->
    <!-- <script src="/assets/survey.js?v=..."></script> -->

    <!-- ====================  End • TalkKink CODEx Paste Block  ==================== -->

    <script src="/js/no-overlay.js" type="module"></script>

    <script>
      // hard reset flags that old code checks
      window.__TK_DISABLE_OVERLAY = true;
      window.__TK_DISABLE_PORTAL = true;
      window.__TK_DISABLE_DRAWER = true;

      // if a legacy boot still runs, neutralize its methods safely
      (function(){
        const noop = ()=>{};
        const g = window;
        const suspects = [
          'tkPanelBoot','tkPortalBoot','tkOverlayBoot',
          'tkDockLayout','tkLockPanel','tkOpenPanel','tkWirePanel'
        ];
        suspects.forEach(k => { if (k in g) g[k] = noop; });
        // remove any pre-existing overlay nodes if injected before this executes
        const killNodes = () => {
          document.querySelectorAll('#tkPortal,.tk-overlay,.tk-drawer,.tk-panel,.portal-overlay')
            .forEach(n => n.remove());
        };
        document.addEventListener('DOMContentLoaded', killNodes);
        new MutationObserver(killNodes).observe(document.documentElement,{childList:true,subtree:true});
      })();
    </script>

    <link rel="stylesheet" href="/assets/css/kinksurvey/survey.css?v=2025-10-15">
    <script defer src="/assets/js/kinksurvey/survey.js?v=2025-10-15"></script>
    <script defer src="/assets/js/tk-enhancer.js?v=2"></script>
  </head>
  <body>
    <header id="tkHeader" class="header-grid">
      <!-- spacer that matches the fixed left panel width so title never overlaps -->
      <div class="header-spacer" aria-hidden="true"></div>

      <!-- centered title -->
      <h1 id="pageTitle" class="glow-title">Talk Kink Survey</h1>

      <!-- theme controls (unchanged buttons) -->
      <div id="themeControls" class="theme-controls">
        <button class="theme-btn" data-theme="dark">Dark</button>
        <button class="theme-btn" data-theme="lipstick">Lipstick</button>
        <button class="theme-btn" data-theme="forest">Forest</button>
        <button class="theme-btn" data-theme="azure">Blue Glow</button>
      </div>
    </header>

    <!-- CTA stack (links to your other pages) -->
    <nav id="ctaStack" class="cta-stack" aria-label="Survey navigation">
      <button id="btnStart" class="cta primary" disabled title="Select at least one category to start">Start Survey</button>
      <a class="cta" href="https://talkkink.org/individualkinkanalysis.html" aria-label="Individual Kink Analysis">Individual Kink Analysis</a>
      <a class="cta" href="https://talkkink.org/compatibility.html" aria-label="Compatibility Page">Compatibility Page</a>
    </nav>

    <main id="surveyApp" class="survey-root is-prestart" aria-live="polite">
      <aside id="categoryPanel" aria-label="Categories">
        <h2 class="tk-side-title">Categories</h2>
        <div class="tk-cat-count" aria-live="polite"><span id="tkCatSel">0</span> selected</div>
        <ul id="categoryChecklist" class="tk-catlist" role="list"></ul>
      </aside>

      <section class="survey-center">
        <section id="controls">
          <div id="prestartNotice" class="prestart-notice" role="status" aria-live="polite">
            <h2>Select categories to begin</h2>
            <p>
              <span id="prestartCount">0</span>
              selected so far. Pick at least one category on the left, then press
              <strong>Start Survey</strong>.
            </p>
          </div>
          <div id="ndProgress">
            <div id="progressBar"><span id="progressPct">0%</span></div>
            <div id="progressText">Question 0 of 0</div>
          </div>
        </section>

        <section id="questionArea">
          <div id="roleTabs" role="tablist" aria-label="Roles">
            <button role="tab" data-role="Giving" aria-selected="true">Giving</button>
            <button role="tab" data-role="Receiving">Receiving</button>
            <button role="tab" data-role="General">General</button>
          </div>
          <section id="question-panel" class="survey-question-panel"></section>

          <div id="navRow">
            <button id="prevBtn">Back</button>
            <button id="skipBtn">Skip</button>
            <button id="nextBtn">Next</button>
          </div>
        </section>
      </section>

      <aside class="score-sidebar" data-sticky="score">
        <section class="how-to-score how-to-score--sidebar">
          <h3>How to score</h3>
          <ul class="legend">
            <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
            <li><b>1</b> — Hard Limit (no-go)</li>
            <li><b>2</b> — Soft Limit (willing to try…)</li>
            <li><b>3</b> — Curious / context-dependent</li>
            <li><b>4</b> — Comfortable / enjoy</li>
            <li><b>5</b> — Favorite / enthusiastic yes</li>
          </ul>
          <div class="rating-box">
            <div class="label">Rate interest/comfort (0–5)</div>
            <div class="rating-grid" id="tk-scale-sidebar" data-group="rating-A"></div>
          </div>
        </section>
      </aside>
    </main>
    <section id="exportPayload" hidden aria-hidden="true">
      <table id="compatibilityTable"></table>
    </section>

    <!-- ============== TalkKink • CODEx PASTE BLOCK (no overlay + fixed right panel) ==============
    WHAT THIS DOES
    1) Kills the overlay/portal (removes the flash).
    2) Builds a 2-column layout INSIDE the page: left = question card, right = compact sticky panel.
    3) Ensures there is ONLY ONE “How to score” card, moves it into the right panel, and
       (optionally) mirrors the 0-5 rating row on the right for quick taps.
    Paste this whole block near the end of <body> on /kinksurvey/ (after your survey HTML),
    or in a site footer that loads on this page.
    =============================================================================================== -->
    <style id="tk-fixed-panel-css">
      /* Turn the survey content into a two-column grid */
      #tkQuestionLayout{
        display:grid;
        grid-template-columns:minmax(520px,1fr) 340px;
        gap:24px;
        align-items:start;
        margin-top:12px;
      }
      /* Left question card host */
      #tkQuestionHost > .card {
        /* your cards already look good; this is just a safety if needed */
      }
      /* Right sticky panel */
      #tkRightPanel{
        position:relative;
      }
      #tkRightPanelInner{
        position:sticky;
        top:88px;                 /* adjust if your header gets taller */
        display:flex;
        flex-direction:column;
        gap:16px;
      }
      /* Compact “How to score” look */
      .tk-compact .score-item{
        display:flex; align-items:center; gap:12px;
        padding:10px 12px; border-radius:12px; background:#0f1216; border:1px solid #1d2a30;
      }
      .tk-compact .score-badge{
        width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
        font-weight:700; font-size:14px; color:#fff;
      }
      .tk-b0{ background:#59a5ff;}
      .tk-b1{ background:#ff4d5a;}
      .tk-b2{ background:#ffd44d; color:#1b1b1b;}
      .tk-b3{ background:#4cd378;}
      .tk-b4{ background:#36c36e;}
      .tk-b5{ background:#2fbf63;}
      /* Mini rating row on the right */
      .tk-quick-rate{
        padding:12px; border:1px solid #1d2a30; background:#0b0e12; border-radius:14px;
      }
      .tk-quick-rate h5{ margin:0 0 8px 0; font-weight:700; font-size:14px; opacity:.85;}
      .tk-quick-row{ display:flex; gap:8px; flex-wrap:wrap;}
      .tk-chip{
        min-width:36px; height:36px; border-radius:10px; border:1px solid #1f2f35;
        display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700;
        background:#0f1318;
      }
      .tk-chip:hover{ outline:2px solid #2ed0ff22; }
      .tk-chip.active{ outline:2px solid #2ed0ff; }
      /* Hide duplicate big “How to score” cards that might remain in-flow */
      .tk-hidden{ display:none !important; }
      /* Safety: disable overlay remnants if any slip in */
      #tkPortal, #tkOverlay, .tkPortal, .tkOverlay, .tkDockShell, [data-tk-overlay], [data-portal]{
        display:none !important; opacity:0 !important; visibility:hidden !important; pointer-events:none !important;
      }
    </style>

    <script id="tk-fixed-panel-js">
    (() => {
      /* 1) Disable overlay/portal at runtime (prevents flicker) */
      try { localStorage.setItem('__TK_DISABLE_OVERLAY','1'); } catch {}

      /* 2) Helpers */
      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const byText = (root, txt) =>
        $$('*', root).find(n => (n.textContent||'').trim().toLowerCase().includes(txt.toLowerCase()));

      /* 3) Build the two-column layout once, then re-hydrate each time the question changes */
      function ensureLayout(){
        const app = $('#surveyApp') || $('main');
        if (!app) return null;

        // Create wrapper grid once
        let shell = $('#tkQuestionLayout');
        if (!shell) {
          shell = document.createElement('div');
          shell.id = 'tkQuestionLayout';
          // Find your current question container/card
          const firstCard = byText(app, 'Rate interest/comfort')?.closest('.card') ||
                            byText(app, 'Giving: Rate interest/comfort')?.closest('.card') ||
                            $('.card', app);
          if (!firstCard) return null;

          // Create left/right columns
          const left  = document.createElement('div'); left.id = 'tkQuestionHost';
          const right = document.createElement('aside'); right.id = 'tkRightPanel';
          right.innerHTML = `<div id="tkRightPanelInner"></div>`;

          // Place the first visible question card into left column
          left.appendChild(firstCard);

          // Insert grid before firstCard’s old parent flow
          firstCard.parentElement.insertBefore(shell, firstCard);
          shell.appendChild(left);
          shell.appendChild(right);
        }
        return shell;
      }

      function moveHowToScore(){
        const shell = ensureLayout();
        if (!shell) return;

        const left   = $('#tkQuestionHost');
        const rightI = $('#tkRightPanelInner');

        // Find any existing card that looks like "How to score"
        // Prefer the compact custom one if you've rendered it; otherwise wrap the original.
        let scoreCard = byText(document, 'How to score');
        if (!scoreCard) return;

        // If scoreCard is already inside our right panel, keep it; otherwise move it.
        if (!rightI.contains(scoreCard)){
          // Hide any duplicates (older copies lingering in DOM)
          $$('.tk-score-dupe').forEach(n => n.remove());

          // If the card is a full-size .card, make a compact copy and hide the original
          const isBigCard = scoreCard.classList.contains('card') || scoreCard.closest('.card');
          let compact;
          if (isBigCard) {
            // Clone the essential lines into a compact presentation
            compact = document.createElement('section');
            compact.className = 'tk-compact';
            compact.innerHTML = `<h4 style="margin:0 0 8px 0;">How to score</h4>`;
            // Pull rows 0..5 from the big card by scanning for badges/text
            const lines = $$('.score-item, .tk-score-row, .list-item, .badge-row', scoreCard.closest('.card') || scoreCard);
            if (lines.length){
              lines.forEach(row => {
                // simple heuristic: keep text & a small number badge if present
                const text = row.textContent.trim();
                const num  = (text.match(/^[0-5]/) || [null])[0];
                if (!num) return;
                const el = document.createElement('div');
                el.className = 'score-item';
                el.innerHTML = `
                  <span class="score-badge tk-b${num}">${num}</span>
                  <span>${text.replace(/^[0-5]\s*[-–—]?\s*/,'')}</span>
                `;
                compact.appendChild(el);
              });
            } else {
              // fallback: just move the original if no row structure detected
              compact = scoreCard;
            }
            // Hide original if we made a compact version
            if (compact !== scoreCard) (scoreCard.closest('.card')||scoreCard).classList.add('tk-hidden');
          } else {
            compact = scoreCard;
          }

          // Mount compact into right panel
          compact.classList.add('tk-score-mounted');
          rightI.prepend(compact);
        }

        // Build/refresh the quick-rate block (mirrors 0–5 row) if the row exists on the left
        const rateRow = byText(left, 'Rate interest/comfort')?.parentElement ||
                        byText(left, 'interest/comfort (0–5)')?.parentElement;
        let quick = $('#tkQuickRate');
        if (!quick) {
          quick = document.createElement('section');
          quick.id = 'tkQuickRate';
          quick.className = 'tk-quick-rate';
          quick.innerHTML = `
            <h5>Quick rate</h5>
            <div class="tk-quick-row">
              <button class="tk-chip" data-v="0">0</button>
              <button class="tk-chip" data-v="1">1</button>
              <button class="tk-chip" data-v="2">2</button>
              <button class="tk-chip" data-v="3">3</button>
              <button class="tk-chip" data-v="4">4</button>
              <button class="tk-chip" data-v="5">5</button>
            </div>`;
          rightI.appendChild(quick);

          // Wire: when a chip is clicked, click the matching left-side button if present
          quick.addEventListener('click', (e) => {
            const btn = e.target.closest('.tk-chip');
            if (!btn) return;
            $$('.tk-chip', quick).forEach(c => c.classList.toggle('active', c===btn));
            const v = btn.getAttribute('data-v');
            // try to click the original 0–5 button
            const leftBtn = $$('button, .btn, .chip', left)
              .find(b => (b.textContent||'').trim() === v);
            if (leftBtn) leftBtn.click();
          });
        }
      }

      /* 4) First run */
      function boot(){
        const shell = ensureLayout();
        if (!shell) return;
        moveHowToScore();
      }
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', boot, { once:true });
      } else {
        boot();
      }

      /* 5) Re-run when question changes (survey navigation) */
      let raf = 0;
      const mo = new MutationObserver(() => {
        cancelAnimationFrame(raf);
        raf = requestAnimationFrame(moveHowToScore);
      });
      mo.observe(document.body, {childList:true, subtree:true});

      console.info('[TK] Fixed right panel active (overlay disabled + single score card)');
    })();
    </script>
  </body>
</html>
