<!-- ================= TALK KINK — CATEGORIES ON LOAD + SURVEY FLOW ================= -->
<style>
  /* 3-column app shell */
  .survey-root {
    display: grid;
    grid-template-columns: 320px 1fr 340px; /* left categories • center • right */
    gap: 16px;
    align-items: start;
  }
  /* Cards & basics */
  .card {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 16px;
    padding: 14px;
  }
  .list { display: grid; gap: 8px; }
  .cat-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 12px;
    background: rgba(255,255,255,.04);
  }

  /* Question card */
  .question-card { composes: card; }
  .q-head { margin-bottom: 8px; }
  .q-path { opacity:.75; font-size:.9rem; margin-bottom: 4px; }
  .q-title { margin:0 0 8px; font-size:1.25rem; }
  .label { font-weight: 600; }
  #tk-guard { margin-top:6px; min-height: 1.2em; opacity:.85; }

  /* Keep ONLY sidebar How-to-score visible; hide any inline copy */
  .score-sidebar .how-to-score,
  .how-to-score--sidebar { display:block; }
  .survey-question-panel .how-to-score,
  #question-panel .how-to-score,
  .how-to-score--inline { display:none !important; }

  /* Rating grids */
  .rating-grid, #tk-scale {
    display:grid;
    grid-template-columns: repeat(6, minmax(42px, 1fr));
    gap:10px; margin-top:10px;
  }
  .rating-grid button, #tk-scale button {
    border:1px solid rgba(255,255,255,.14);
    border-radius:12px; padding:10px 0;
    background:transparent; color:inherit; cursor:pointer; font-size:16px;
  }
  button.tk-opt.selected { outline:2px solid currentColor; transform: translateY(-1px); }
  button.tk-opt[aria-pressed="true"] { font-weight:700; }

  /* Landing buttons container (center) */
  #tk-landing .actions { display:grid; gap:16px; max-width: 720px; margin: 0 auto; }
  #tk-landing .actions a, #tk-landing .actions button {
    padding:18px 20px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.02); color: inherit; font-size:1.05rem; cursor:pointer;
  }
</style>

<main class="survey-root" id="tk-app">
  <!-- LEFT: CATEGORIES (visible on load) -->
  <aside id="tk-categories" class="card" aria-label="Categories">
    <h3 style="margin:0 0 8px;">Categories</h3>
    <div id="tk-cat-list" class="list" role="listbox" aria-multiselectable="true">
      <!-- Filled by JS from /data/kinks.json -->
    </div>
  </aside>

  <!-- CENTER: landing first; question card replaces this when started -->
  <section id="tk-center">
    <section id="tk-landing" class="card">
      <h2 style="margin-top:0;">TalkKink Survey</h2>
      <div class="actions">
        <button id="btnStart" type="button" disabled aria-disabled="true">Start Survey</button>
        <a href="#" id="btnAnalysis">Individual Kink Analysis</a>
        <a href="#" id="btnCompat">Compatibility Page</a>
      </div>
    </section>
    <section id="question-panel" class="survey-question-panel" hidden></section>
  </section>

  <!-- RIGHT: score guide (hidden until Start) -->
  <aside class="score-sidebar" id="tk-score" hidden>
    <section class="how-to-score how-to-score--sidebar card">
      <h3 style="margin:0 0 8px;">How to score</h3>
      <ul class="legend" style="list-style:none;padding:0;margin:0;display:grid;gap:8px;">
        <li><b>0</b> — Brain did a cartwheel (skip for now)</li>
        <li><b>1</b> — Hard Limit (no-go)</li>
        <li><b>2</b> — Soft Limit (willing to try…)</li>
        <li><b>3</b> — Curious / context-dependent</li>
        <li><b>4</b> — Comfortable / enjoy</li>
        <li><b>5</b> — Favorite / enthusiastic yes</li>
      </ul>
      <div class="rating-box" style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,.08);">
        <div class="label">Rate interest/comfort (0–5)</div>
        <div class="rating-grid" id="tk-scale-sidebar" data-group="rating-A"></div>
      </div>
    </section>
  </aside>
</main>

<script>
/* =================== CATEGORY PANEL (visible on load) =================== */
async function tkRenderCategories() {
  const wrap = document.getElementById('tk-cat-list');
  if (!wrap) return;
  wrap.innerHTML = '<div style="opacity:.7">Loading…</div>';
  try {
    const res = await fetch('/data/kinks.json', { cache: 'no-store' });
    const data = await res.json();

    // Be flexible about shape: array of objects, or object of arrays, etc.
    let cats = [];
    if (Array.isArray(data)) {
      cats = data.map(x => x?.name || x?.title || x?.category || String(x));
    } else if (data?.categories && Array.isArray(data.categories)) {
      cats = data.categories.map(x => x?.name || x?.title || x?.category || String(x));
    } else {
      cats = Object.keys(data || {});
    }
    cats = cats.filter(Boolean).sort((a,b)=>a.localeCompare(b));

    // render
    wrap.innerHTML = '';
    cats.forEach((name, idx) => {
      const id = 'cat_' + idx;
      const row = document.createElement('label');
      row.className = 'cat-item';
      row.setAttribute('role','option');
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-cat="${name}" value="${name}">
        <span>${name}</span>
      `;
      wrap.appendChild(row);
    });
  } catch (e) {
    console.error('[Categories] load error', e);
    wrap.innerHTML = '<div style="color:#f66">Failed to load categories.</div>';
  }
}

/* =================== QUESTION + SCORE GUIDE AFTER START =================== */
function tkBuildScale(container, group = 'rating-A') {
  if (!container) return;
  container.dataset.group = group;
  container.innerHTML = '';
  for (let i = 0; i <= 5; i++) {
    const button = document.createElement('button');
    button.className = 'tk-opt';
    button.type = 'button';
    button.dataset.group = group;
    button.dataset.value = String(i);
    button.textContent = String(i);
    button.setAttribute('aria-pressed', 'false');
    container.appendChild(button);
  }
}

function tkRenderQuestionCard({ category = 'Appearance Play', prompt = 'Choosing My Partner', role = 'Giving' } = {}) {
  const panel = document.getElementById('question-panel');
  if (!panel) return;
  panel.hidden = false;
  panel.innerHTML = `
    <article class="question-card card">
      <header class="q-head">
        <div class="q-path">${category} • ${prompt}</div>
        <h2 class="q-title">${role}: Rate interest/comfort (0–5)</h2>
      </header>
      <div id="ratingRow" class="single">
        <div class="col">
          <div class="label">Rate interest/comfort (0–5)</div>
          <div id="tk-guard" aria-live="polite"></div>
          <div id="tk-scale" data-group="rating-A"></div>
          <div class="scoreRow" data-partner="A" data-group="rating-A"></div>
        </div>
      </div>
      <!-- inline guide (hidden via CSS to keep only the sidebar copy) -->
      <section class="how-to-score how-to-score--inline"></section>
    </article>
  `;
  tkBuildScale(document.getElementById('tk-scale'), 'rating-A');
  tkBuildScale(document.getElementById('tk-scale-sidebar'), 'rating-A');
  const sidebar = document.getElementById('tk-score');
  if (sidebar) sidebar.hidden = false;
}

/* =================== RATING CLICK SYNC (both grids) =================== */
(function tkBindRatingClicks() {
  if (window.__tkRatingSyncBound) return;
  window.__tkRatingSyncBound = true;
  document.addEventListener('click', (event) => {
    const button = event.target.closest('button.tk-opt');
    if (!button) return;
    const group = button.dataset.group || button.closest('[data-group]')?.dataset.group || 'rating-A';
    const value = button.dataset.value ?? button.textContent.trim();
    document.querySelectorAll(`button.tk-opt[data-group="${group}"]`).forEach((peer) => {
      const on = peer.dataset.value === value;
      peer.classList.toggle('selected', on);
      peer.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
    const guard = document.getElementById('tk-guard');
    if (guard) {
      const message = `Selected ${value} of 5`;
      if (typeof guard.replaceChildren === 'function') guard.replaceChildren(document.createTextNode(message));
      else guard.textContent = message;
    }
  });
})();

function tkShowSurveyScreen() {
  document.getElementById('tk-landing')?.setAttribute('hidden', 'hidden');
  tkRenderQuestionCard();
}

function tkSetupStartGate() {
  if (window.__tkStartGateReady) return;
  const list = document.getElementById('tk-cat-list');
  const start = document.getElementById('btnStart');
  const qpanel = document.getElementById('question-panel');
  if (!list || !start || !qpanel) {
    if (typeof requestAnimationFrame === 'function') requestAnimationFrame(tkSetupStartGate);
    else setTimeout(tkSetupStartGate, 0);
    return;
  }
  window.__tkStartGateReady = true;
  const selected = new Set();
  const updateGate = () => {
    const any = selected.size > 0;
    start.disabled = !any;
    start.setAttribute('aria-disabled', String(!any));
  };
  updateGate();
  list.addEventListener('change', (event) => {
    const cb = event.target.closest('input[type="checkbox"]');
    if (!cb) return;
    const key = cb.value || cb.id;
    if (cb.checked) selected.add(key);
    else selected.delete(key);
    updateGate();
  });
  start.addEventListener('click', (event) => {
    if (start.disabled) {
      if (start.animate) {
        start.animate(
          [
            { transform: 'translateX(0)' },
            { transform: 'translateX(-5px)' },
            { transform: 'translateX(5px)' },
            { transform: 'translateX(0)' }
          ],
          { duration: 250 }
        );
      }
      event.preventDefault();
      return;
    }
    event.preventDefault();
    tkShowSurveyScreen();
  });

  const params = new URLSearchParams(location.search);
  if (params.has('autostart')) {
    start.disabled = false;
    start.setAttribute('aria-disabled', 'false');
    tkShowSurveyScreen();
  }
}

document.addEventListener('DOMContentLoaded', () => {
  tkRenderCategories(); // ← Categories visible on load
  tkSetupStartGate();
});

// expose helpers for integration hooks
window.tkRenderQuestionCard = tkRenderQuestionCard;
window.tkShowSurveyScreen = tkShowSurveyScreen;
window.startSurvey = tkShowSurveyScreen;
</script>
<!-- ================= END — CATEGORIES ON LOAD + SURVEY FLOW ================= -->
